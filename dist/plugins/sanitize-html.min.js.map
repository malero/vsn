{"version":3,"sources":["../../src/plugins/sanitize-html.ts"],"sourcesContent":["import type { Engine } from \"../runtime/engine\";\n\ntype SanitizerOptions = {\n  dompurifyConfig?: Record<string, any>;\n  sanitizer?: (html: string) => string;\n};\n\ntype HtmlBinding = { expr: string; trusted: boolean };\ntype TrustedHtmlValue = { __vsnTrustedHtml: true; value: any };\n\nconst TRUSTED_HTML_KEY = \"__vsnTrustedHtml\";\n\nexport function registerSanitizeHtml(engine: Engine, options: SanitizerOptions = {}): void {\n  const htmlBindings = new WeakMap<Element, HtmlBinding>();\n  const trustedElements = new WeakSet<Element>();\n  const sanitizer = resolveSanitizer(options);\n  const handleHtmlBehaviors = (engine as any).handleHtmlBehaviors?.bind(engine);\n\n  engine.registerFlag(\"trusted\", {\n    transformValue: ({ declaration }, value) => {\n      const target = (declaration as any)?.target;\n      if (target?.type === \"Directive\" && target?.name === \"html\") {\n        return { [TRUSTED_HTML_KEY]: true, value } as TrustedHtmlValue;\n      }\n      return value;\n    }\n  });\n\n  patchAttributeHandlers(engine, htmlBindings, trustedElements, sanitizer, handleHtmlBehaviors);\n  patchDirectiveSetter(engine, trustedElements, sanitizer, handleHtmlBehaviors);\n  patchEvaluate(engine, htmlBindings, trustedElements, sanitizer, handleHtmlBehaviors);\n  patchBehaviorDeclarations(engine, trustedElements);\n}\n\nexport default registerSanitizeHtml;\n\nconst globals = globalThis as Record<string, any>;\nconst plugins = globals.VSNPlugins ?? {};\nplugins.sanitizeHtml = (instance: Engine) => registerSanitizeHtml(instance);\nglobals.VSNPlugins = plugins;\n\nconst autoEngine = globals.VSNEngine;\nif (autoEngine && typeof autoEngine.registerFlag === \"function\") {\n  registerSanitizeHtml(autoEngine as Engine);\n}\n\nfunction patchAttributeHandlers(\n  engine: Engine,\n  htmlBindings: WeakMap<Element, HtmlBinding>,\n  trustedElements: WeakSet<Element>,\n  sanitizer: (html: string) => string,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  const handlers: any[] = (engine as any).attributeHandlers ?? [];\n  (engine as any).attributeHandlers = handlers.filter((handler) => handler?.id !== \"vsn-html\" && handler?.id !== \"vsn-get\");\n\n  engine.registerAttributeHandler({\n    id: \"vsn-html\",\n    match: (name) => name.startsWith(\"vsn-html\"),\n    handle: (element, name, value, scope) => {\n      const trusted = name.includes(\"!trusted\");\n      htmlBindings.set(element, { expr: value, trusted });\n      if ((engine as any).markInlineDeclaration) {\n        (engine as any).markInlineDeclaration(element, \"attr:html\");\n      }\n      const apply = () => {\n        const html = scope.get(value);\n        const raw = html == null ? \"\" : String(html);\n        element.innerHTML = trusted ? raw : sanitizer(raw);\n        if (trusted) {\n          trustedElements.add(element);\n          handleHtmlBehaviors?.(element);\n        }\n      };\n      apply();\n      if ((engine as any).watch) {\n        (engine as any).watch(scope, value, apply, element);\n      }\n      return true;\n    }\n  });\n\n  engine.registerAttributeHandler({\n    id: \"vsn-get\",\n    match: (name) => name.startsWith(\"vsn-get\"),\n    handle: (element, name) => {\n      const trusted = name.includes(\"!trusted\");\n      const autoLoad = name.includes(\"!load\");\n      const url = element.getAttribute(name) ?? \"\";\n      const target = element.getAttribute(\"vsn-target\") ?? undefined;\n      const swap = (element.getAttribute(\"vsn-swap\") as \"inner\" | \"outer\" | null) ?? \"inner\";\n      const targetSelector = target ?? undefined;\n\n      const run = async () => {\n        try {\n          await applyGetWithSanitize(\n            engine,\n            element,\n            {\n              url,\n              swap,\n              trusted,\n              ...(targetSelector ? { targetSelector } : {})\n            },\n            sanitizer,\n            handleHtmlBehaviors,\n            trustedElements\n          );\n        } catch (error) {\n          console.warn(\"vsn:getError\", error);\n          element.dispatchEvent(new CustomEvent(\"vsn:getError\", { detail: { error }, bubbles: true }));\n        }\n      };\n\n      element.addEventListener(\"click\", (event) => {\n        if (event.target !== element) {\n          return;\n        }\n        void run();\n      });\n      if (autoLoad) {\n        Promise.resolve().then(run);\n      }\n      return true;\n    }\n  });\n}\n\nfunction patchDirectiveSetter(\n  engine: Engine,\n  trustedElements: WeakSet<Element>,\n  sanitizer: (html: string) => string,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  const originalSet = (engine as any).setDirectiveValue?.bind(engine);\n  if (!originalSet) {\n    return;\n  }\n  (engine as any).setDirectiveValue = (element: Element, target: any, value: any) => {\n    if (target?.kind === \"attr\" && target?.name === \"html\" && element instanceof HTMLElement) {\n      const { html, trusted } = unwrapTrustedHtml(value, element, trustedElements);\n      element.innerHTML = trusted ? html : sanitizer(html);\n      if (trusted) {\n        handleHtmlBehaviors?.(element);\n      }\n      return;\n    }\n    return originalSet(element, target, value);\n  };\n}\n\nfunction patchEvaluate(\n  engine: Engine,\n  htmlBindings: WeakMap<Element, HtmlBinding>,\n  trustedElements: WeakSet<Element>,\n  sanitizer: (html: string) => string,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  const originalEvaluate = engine.evaluate.bind(engine);\n  engine.evaluate = (element: Element) => {\n    originalEvaluate(element);\n    const binding = htmlBindings.get(element);\n    if (!binding || !(element instanceof HTMLElement)) {\n      return;\n    }\n    const scope = engine.getScope(element);\n    const html = scope.get(binding.expr);\n    const raw = html == null ? \"\" : String(html);\n    element.innerHTML = binding.trusted ? raw : sanitizer(raw);\n    if (binding.trusted) {\n      trustedElements.add(element);\n      handleHtmlBehaviors?.(element);\n    }\n  };\n}\n\nfunction patchBehaviorDeclarations(engine: Engine, trustedElements: WeakSet<Element>): void {\n  const originalApply = (engine as any).applyBehaviorDeclaration?.bind(engine);\n  if (!originalApply) {\n    return;\n  }\n  (engine as any).applyBehaviorDeclaration = async (\n    element: Element,\n    scope: any,\n    declaration: any,\n    rootScope?: any\n  ) => {\n    const target = declaration?.target;\n    if (declaration?.flags?.trusted && target?.type === \"Directive\" && target?.name === \"html\") {\n      trustedElements.add(element);\n    }\n    return originalApply(element, scope, declaration, rootScope);\n  };\n}\n\nfunction unwrapTrustedHtml(\n  value: any,\n  element: Element,\n  trustedElements: WeakSet<Element>\n): { html: string; trusted: boolean } {\n  if (value && typeof value === \"object\" && value[TRUSTED_HTML_KEY]) {\n    const html = value.value == null ? \"\" : String(value.value);\n    return { html, trusted: true };\n  }\n  const html = value == null ? \"\" : String(value);\n  return { html, trusted: trustedElements.has(element) };\n}\n\nasync function applyGetWithSanitize(\n  engine: Engine,\n  element: Element,\n  config: { url: string; targetSelector?: string; swap?: \"inner\" | \"outer\"; trusted: boolean },\n  sanitizer: (html: string) => string,\n  handleHtmlBehaviors?: (root: Element) => void,\n  trustedElements?: WeakSet<Element>\n): Promise<void> {\n  if (!globalThis.fetch) {\n    throw new Error(\"fetch is not available\");\n  }\n\n  const response = await globalThis.fetch(config.url);\n  if (!response || !response.ok) {\n    return;\n  }\n\n  const html = await response.text();\n  const target = resolveTarget(element, config.targetSelector);\n  if (!target) {\n    element.dispatchEvent(new CustomEvent(\"vsn:targetError\", { detail: { selector: config.targetSelector } }));\n    return;\n  }\n\n  const output = config.trusted ? html : sanitizer(html);\n  if (config.swap === \"outer\") {\n    const wrapper = document.createElement(\"div\");\n    wrapper.innerHTML = output;\n    const replacement = wrapper.firstElementChild;\n    if (replacement && target.parentNode) {\n      target.parentNode.replaceChild(replacement, target);\n      if (config.trusted) {\n        trustedElements?.add(replacement);\n        handleHtmlBehaviors?.(replacement);\n      }\n    }\n    return;\n  }\n\n  (target as HTMLElement).innerHTML = output;\n  if (config.trusted) {\n    trustedElements?.add(target);\n    handleHtmlBehaviors?.(target);\n  }\n}\n\nfunction resolveTarget(element: Element, selector?: string): Element | null {\n  if (!selector) {\n    return element;\n  }\n  return element.ownerDocument.querySelector(selector);\n}\n\nfunction resolveSanitizer(options: SanitizerOptions): (html: string) => string {\n  if (options.sanitizer) {\n    return options.sanitizer;\n  }\n  const purifier = (globalThis as any).DOMPurify;\n  if (purifier && typeof purifier.sanitize === \"function\") {\n    return (html) => purifier.sanitize(html, options.dompurifyConfig ?? {});\n  }\n  return fallbackSanitize;\n}\n\nfunction fallbackSanitize(html: string): string {\n  if (typeof document === \"undefined\") {\n    return html.replace(/<script\\b[^>]*>[\\s\\S]*?<\\/script>/gi, \"\");\n  }\n  const template = document.createElement(\"template\");\n  template.innerHTML = html;\n  const scripts = template.content.querySelectorAll(\"script\");\n  scripts.forEach((script) => script.remove());\n  const elements = template.content.querySelectorAll(\"*\");\n  for (const element of Array.from(elements)) {\n    for (const attr of Array.from(element.attributes)) {\n      const name = attr.name.toLowerCase();\n      const value = attr.value;\n      if (name.startsWith(\"on\")) {\n        element.removeAttribute(attr.name);\n        continue;\n      }\n      if ((name === \"href\" || name === \"src\") && value.trim().toLowerCase().startsWith(\"javascript:\")) {\n        element.removeAttribute(attr.name);\n      }\n    }\n  }\n  return template.innerHTML;\n}\n"],"mappings":"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","names":["TRUSTED_HTML_KEY","registerSanitizeHtml","engine","options","htmlBindings","trustedElements","sanitizer","resolveSanitizer","handleHtmlBehaviors","declaration","value","target","patchAttributeHandlers","patchDirectiveSetter","patchEvaluate","patchBehaviorDeclarations","sanitize_html_default","globals","plugins","instance","autoEngine","handlers","handler","name","element","scope","trusted","apply","html","raw","autoLoad","url","swap","targetSelector","run","applyGetWithSanitize","error","event","originalSet","unwrapTrustedHtml","originalEvaluate","binding","originalApply","rootScope","config","response","resolveTarget","output","wrapper","replacement","selector","purifier","fallbackSanitize","template","script","elements","attr"]}