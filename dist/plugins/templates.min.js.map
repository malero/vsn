{"version":3,"sources":["../../src/plugins/templates.ts"],"sourcesContent":["import type { Engine } from \"../runtime/engine\";\n\ntype TemplateResult = {\n  __vsnTemplate: true;\n  strings: string[];\n  values: any[];\n};\n\ntype TemplateInstance = {\n  strings: string[];\n  textParts: Map<number, PartSlot>;\n  attrParts: AttributePart[];\n};\n\ntype PartSlot = {\n  marker: Comment;\n  nodes: Node[];\n};\n\ntype AttributePart = {\n  element: Element;\n  name: string;\n  strings: string[];\n  indices: number[];\n};\n\nexport function registerTemplates(engine: Engine): void {\n  const htmlBindings = new WeakMap<Element, string>();\n  const templateInstances = new WeakMap<Element, TemplateInstance>();\n  const handleHtmlBehaviors = (engine as any).handleHtmlBehaviors?.bind(engine);\n\n  engine.registerGlobal(\"html\", html);\n\n  patchAttributeHandlers(engine, htmlBindings, templateInstances, handleHtmlBehaviors);\n  patchDirectiveSetter(engine, templateInstances, handleHtmlBehaviors);\n  patchEvaluate(engine, htmlBindings, templateInstances, handleHtmlBehaviors);\n}\n\nexport default registerTemplates;\n\nconst globals = globalThis as Record<string, any>;\nconst plugins = globals.VSNPlugins ?? {};\nplugins.templates = (instance: Engine) => registerTemplates(instance);\nglobals.VSNPlugins = plugins;\n\nconst autoEngine = globals.VSNEngine;\nif (autoEngine && typeof autoEngine.registerGlobal === \"function\") {\n  registerTemplates(autoEngine as Engine);\n}\n\nfunction html(stringsOrValue: TemplateStringsArray | string, ...values: any[]): TemplateResult {\n  if (Array.isArray(stringsOrValue)) {\n    return {\n      __vsnTemplate: true,\n      strings: Array.from(stringsOrValue),\n      values\n    };\n  }\n  return {\n    __vsnTemplate: true,\n    strings: [String(stringsOrValue)],\n    values: []\n  };\n}\n\nfunction isTemplate(value: any): value is TemplateResult {\n  return Boolean(value && typeof value === \"object\" && value.__vsnTemplate);\n}\n\nfunction renderValue(value: any): string {\n  if (value == null) {\n    return \"\";\n  }\n  if (isTemplate(value)) {\n    return renderTemplate(value);\n  }\n  if (Array.isArray(value)) {\n    return value.map(renderValue).join(\"\");\n  }\n  if (value instanceof Element) {\n    return value.outerHTML;\n  }\n  return String(value);\n}\n\nfunction renderTemplate(template: TemplateResult): string {\n  const { strings, values } = template;\n  let output = \"\";\n  for (let i = 0; i < strings.length; i += 1) {\n    output += strings[i] ?? \"\";\n    if (i < values.length) {\n      output += renderValue(values[i]);\n    }\n  }\n  return output;\n}\n\nfunction renderToString(value: any): string {\n  if (isTemplate(value) || Array.isArray(value) || value instanceof Element) {\n    return renderValue(value);\n  }\n  return value == null ? \"\" : String(value);\n}\n\nfunction renderHtml(\n  element: Element,\n  value: any,\n  instances: WeakMap<Element, TemplateInstance>,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  if (!(element instanceof HTMLElement)) {\n    return;\n  }\n  if (isTemplate(value)) {\n    const instance = instances.get(element);\n    if (instance && sameTemplate(instance.strings, value.strings)) {\n      updateInstance(instance, value);\n      return;\n    }\n    const next = buildInstance(value);\n    instances.set(element, next);\n    element.innerHTML = \"\";\n    element.appendChild(next.fragment);\n    updateInstance(next, value);\n    handleHtmlBehaviors?.(element);\n    return;\n  }\n  instances.delete(element);\n  element.innerHTML = renderToString(value);\n  handleHtmlBehaviors?.(element);\n}\n\nfunction sameTemplate(a: string[], b: string[]): boolean {\n  if (a.length !== b.length) {\n    return false;\n  }\n  for (let i = 0; i < a.length; i += 1) {\n    if (a[i] !== b[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction buildInstance(template: TemplateResult): TemplateInstance & { fragment: DocumentFragment } {\n  const strings = template.strings.slice();\n  const textParts = new Map<number, PartSlot>();\n  const attrParts: AttributePart[] = [];\n  const html = buildTemplateHtml(strings);\n  const container = document.createElement(\"template\");\n  container.innerHTML = html;\n  const fragment = container.content;\n  collectTextParts(fragment, textParts);\n  collectAttributeParts(fragment, attrParts);\n  return { strings, textParts, attrParts, fragment };\n}\n\nfunction buildTemplateHtml(strings: string[]): string {\n  let output = strings[0] ?? \"\";\n  for (let i = 1; i < strings.length; i += 1) {\n    output += `__vsn-part-${i - 1}__${strings[i] ?? \"\"}`;\n  }\n  return output;\n}\n\nfunction parsePartIndexToken(value: string): number | undefined {\n  const match = value.match(/^__vsn-part-(\\d+)__$/);\n  if (!match) {\n    return undefined;\n  }\n  return Number(match[1]);\n}\n\nfunction collectTextParts(fragment: DocumentFragment, textParts: Map<number, PartSlot>): void {\n  const walker = document.createTreeWalker(fragment, NodeFilter.SHOW_TEXT, null);\n  let node = walker.nextNode();\n  while (node) {\n    const textNode = node as Text;\n    const value = textNode.textContent ?? \"\";\n    if (value.includes(\"__vsn-part-\")) {\n      const pieces = splitByPartTokens(value);\n      if (pieces) {\n        const replacement = document.createDocumentFragment();\n        for (const piece of pieces) {\n          if (piece.type === \"text\") {\n            replacement.appendChild(document.createTextNode(piece.value));\n          } else {\n            const marker = document.createComment(`vsn-part-${piece.index}`);\n            textParts.set(piece.index, { marker, nodes: [] });\n            replacement.appendChild(marker);\n          }\n        }\n        const next = walker.nextNode();\n        textNode.replaceWith(replacement);\n        node = next;\n        continue;\n      }\n    }\n    node = walker.nextNode();\n  }\n}\n\nfunction collectAttributeParts(fragment: DocumentFragment, attrParts: AttributePart[]): void {\n  const walker = document.createTreeWalker(fragment, NodeFilter.SHOW_ELEMENT, null);\n  let node = walker.nextNode();\n  while (node) {\n    const element = node as Element;\n    for (const attr of Array.from(element.attributes)) {\n      if (!attr.value.includes(\"__vsn-part-\")) {\n        continue;\n      }\n      const parsed = parseAttributeParts(attr.value);\n      if (!parsed) {\n        continue;\n      }\n      attrParts.push({ element, name: attr.name, strings: parsed.strings, indices: parsed.indices });\n    }\n    node = walker.nextNode();\n  }\n}\n\nfunction splitByPartTokens(value: string):\n  | { type: \"text\"; value: string }[]\n  | { type: \"part\"; index: number }[]\n  | ( { type: \"text\"; value: string } | { type: \"part\"; index: number } )[]\n  | null {\n  const parts: Array<{ type: \"text\"; value: string } | { type: \"part\"; index: number }> = [];\n  const regex = /__vsn-part-(\\d+)__/g;\n  let lastIndex = 0;\n  let match: RegExpExecArray | null;\n  while ((match = regex.exec(value))) {\n    const start = match.index;\n    if (start > lastIndex) {\n      parts.push({ type: \"text\", value: value.slice(lastIndex, start) });\n    }\n    const index = Number(match[1]);\n    if (Number.isFinite(index)) {\n      parts.push({ type: \"part\", index });\n    }\n    lastIndex = regex.lastIndex;\n  }\n  if (parts.length === 0) {\n    return null;\n  }\n  if (lastIndex < value.length) {\n    parts.push({ type: \"text\", value: value.slice(lastIndex) });\n  }\n  return parts;\n}\n\nfunction parseAttributeParts(value: string): { strings: string[]; indices: number[] } | null {\n  const regex = /__vsn-part-(\\d+)__/g;\n  let lastIndex = 0;\n  const strings: string[] = [];\n  const indices: number[] = [];\n  let match: RegExpExecArray | null;\n  while ((match = regex.exec(value))) {\n    strings.push(value.slice(lastIndex, match.index));\n    indices.push(Number(match[1]));\n    lastIndex = regex.lastIndex;\n  }\n  if (indices.length === 0) {\n    return null;\n  }\n  strings.push(value.slice(lastIndex));\n  return { strings, indices };\n}\n\nfunction updateInstance(instance: TemplateInstance, template: TemplateResult): void {\n  for (const [index, slot] of instance.textParts.entries()) {\n    const value = template.values[index];\n    updatePart(slot, value);\n  }\n  for (const part of instance.attrParts) {\n    let value = part.strings[0] ?? \"\";\n    for (let i = 0; i < part.indices.length; i += 1) {\n      const index = part.indices[i];\n      if (index === undefined) {\n        continue;\n      }\n      const nextValue = template.values[index];\n      value += renderValue(nextValue);\n      value += part.strings[i + 1] ?? \"\";\n    }\n    part.element.setAttribute(part.name, value);\n  }\n}\n\nfunction updatePart(slot: PartSlot, value: any): void {\n  if (!slot.marker.parentNode) {\n    return;\n  }\n  for (const node of slot.nodes) {\n    node.parentNode?.removeChild(node);\n  }\n  slot.nodes = [];\n  const fragment = document.createDocumentFragment();\n  if (value == null) {\n    // no-op\n  } else if (isTemplate(value)) {\n    const html = renderTemplate(value);\n    slot.nodes = appendHtml(fragment, html);\n  } else if (Array.isArray(value)) {\n    const html = value.map(renderValue).join(\"\");\n    slot.nodes = appendHtml(fragment, html);\n  } else if (value instanceof Element) {\n    fragment.appendChild(value);\n    slot.nodes = [value];\n  } else {\n    const text = document.createTextNode(String(value));\n    fragment.appendChild(text);\n    slot.nodes = [text];\n  }\n  slot.marker.after(fragment);\n}\n\nfunction appendHtml(fragment: DocumentFragment, html: string): Node[] {\n  const container = document.createElement(\"template\");\n  container.innerHTML = html;\n  const nodes = Array.from(container.content.childNodes);\n  fragment.appendChild(container.content);\n  return nodes;\n}\n\nfunction patchAttributeHandlers(\n  engine: Engine,\n  htmlBindings: WeakMap<Element, string>,\n  instances: WeakMap<Element, TemplateInstance>,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  const handlers: any[] = (engine as any).attributeHandlers ?? [];\n  (engine as any).attributeHandlers = handlers.filter((handler) => handler?.id !== \"vsn-html\");\n\n  engine.registerAttributeHandler({\n    id: \"vsn-html\",\n    match: (name) => name.startsWith(\"vsn-html\"),\n    handle: (element, _name, value, scope) => {\n      htmlBindings.set(element, value);\n      if ((engine as any).markInlineDeclaration) {\n        (engine as any).markInlineDeclaration(element, \"attr:html\");\n      }\n      const apply = () => {\n        const htmlValue = scope.get(value);\n        renderHtml(element, htmlValue, instances, handleHtmlBehaviors);\n      };\n      apply();\n      if ((engine as any).watch) {\n        (engine as any).watch(scope, value, apply, element);\n      }\n      return true;\n    }\n  });\n}\n\nfunction patchDirectiveSetter(\n  engine: Engine,\n  instances: WeakMap<Element, TemplateInstance>,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  const originalSet = (engine as any).setDirectiveValue?.bind(engine);\n  if (!originalSet) {\n    return;\n  }\n  (engine as any).setDirectiveValue = (element: Element, target: any, value: any) => {\n    if (target?.kind === \"attr\" && target?.name === \"html\") {\n      renderHtml(element, value, instances, handleHtmlBehaviors);\n      return;\n    }\n    return originalSet(element, target, value);\n  };\n}\n\nfunction patchEvaluate(\n  engine: Engine,\n  htmlBindings: WeakMap<Element, string>,\n  instances: WeakMap<Element, TemplateInstance>,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  const originalEvaluate = engine.evaluate.bind(engine);\n  engine.evaluate = (element: Element) => {\n    originalEvaluate(element);\n    const binding = htmlBindings.get(element);\n    if (!binding) {\n      return;\n    }\n    const scope = engine.getScope(element);\n    const htmlValue = scope.get(binding);\n    renderHtml(element, htmlValue, instances, handleHtmlBehaviors);\n  };\n}\n"],"mappings":"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","names":["registerTemplates","engine","htmlBindings","templateInstances","handleHtmlBehaviors","html","patchAttributeHandlers","patchDirectiveSetter","patchEvaluate","templates_default","globals","plugins","instance","autoEngine","stringsOrValue","values","isTemplate","value","renderValue","renderTemplate","template","strings","output","i","renderToString","renderHtml","element","instances","sameTemplate","updateInstance","next","buildInstance","a","b","textParts","attrParts","buildTemplateHtml","container","fragment","collectTextParts","collectAttributeParts","collectTextParts","fragment","textParts","walker","node","textNode","value","pieces","splitByPartTokens","replacement","piece","marker","next","collectAttributeParts","attrParts","element","attr","parsed","parseAttributeParts","parts","regex","lastIndex","match","start","index","strings","indices","updateInstance","instance","template","slot","updatePart","part","i","nextValue","renderValue","isTemplate","html","renderTemplate","appendHtml","text","container","nodes","patchAttributeHandlers","engine","htmlBindings","instances","handleHtmlBehaviors","handlers","handler","name","_name","scope","apply","htmlValue","renderHtml","patchDirectiveSetter","originalSet","target","patchEvaluate","originalEvaluate","binding"]}