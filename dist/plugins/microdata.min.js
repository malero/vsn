var U=class o{constructor(e){this.parent=e;this.root=e?e.root:this}data=new Map;root;listeners=new Map;anyListeners=new Set;isEachItem=!1;createChild(){return new o(this)}get(e){return this.getPath(e)}set(e,t){this.setPath(e,t)}hasKey(e){let r=e.split(".")[0];return r?this.data.has(r):!1}getPath(e){let t=e.startsWith("parent.")||e.startsWith("root.")||e.startsWith("self."),{targetScope:r,targetPath:s}=this.resolveScope(e);if(!r||!s)return;let i=this.getLocalPathValue(r,s);if(t||i!==void 0)return i;let n=r.parent;for(;n;){let a=this.getLocalPathValue(n,s);if(a!==void 0)return a;n=n.parent}}setPath(e,t){let r=e.startsWith("parent.")||e.startsWith("root.")||e.startsWith("self."),{targetScope:s,targetPath:i}=this.resolveScope(e);if(!s||!i)return;let n=r?s:this.findNearestScopeWithKey(s,i)??s,a=i.split("."),c=a[0];if(!c)return;if(a.length===1){n.data.set(c,t),n.emitChange(i);return}let p=n.data.get(c);(p==null||typeof p!="object")&&(p={},n.data.set(c,p));let l=p;for(let u=1;u<a.length-1;u+=1){let m=a[u];if(!m)return;(l[m]==null||typeof l[m]!="object")&&(l[m]={}),l=l[m]}let h=a[a.length-1];h&&(l[h]=t,n.emitChange(i))}on(e,t){let r=e.trim();if(!r)return;let s=this.listeners.get(r)??new Set;s.add(t),this.listeners.set(r,s)}off(e,t){let r=e.trim(),s=this.listeners.get(r);s&&(s.delete(t),s.size===0&&this.listeners.delete(r))}onAny(e){this.anyListeners.add(e)}offAny(e){this.anyListeners.delete(e)}emitChange(e){let t=e.trim();if(!t)return;this.listeners.get(t)?.forEach(s=>s());let r=t.split(".")[0];r&&r!==t&&this.listeners.get(r)?.forEach(s=>s()),this.anyListeners.forEach(s=>s())}resolveScope(e){let t=this,r=e;for(;r.startsWith("parent.");)t=t?.parent,r=r.slice(7);for(r.startsWith("root.")&&(t=t?.root,r=r.slice(5));r.startsWith("self.");)t=t??this,r=r.slice(5);return{targetScope:t,targetPath:r}}getLocalPathValue(e,t){let r=t.split("."),s=r[0];if(!s)return;let i=e.data.get(s);for(let n=1;n<r.length;n+=1){if(i==null)return;let a=r[n];if(!a)return;i=i[a]}return i}findNearestScopeWithKey(e,t){let r=t.split(".")[0];if(!r)return;let s=e;for(;s;){if(s.data.has(r))return s;s=s.parent}}};function Ce(o){return o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement||o instanceof HTMLSelectElement?o.value:o.textContent??""}function De(o,e){if(o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement){o.value=e,o.setAttribute("value",e);return}if(o instanceof HTMLSelectElement){o.value=e;return}o instanceof HTMLElement&&o.querySelector("*")||(o.textContent=e)}function G(o,e,t){let r=e.trim();if(!r)return;let s=Ce(o);t.set(r,s)}function Q(o,e,t){let r=e.trim();if(!r)return;let s=t.get(r);s!=null&&De(o,String(s))}function be(o,e){let t=o.trim();return t?!!e.get(t):!1}function ue(o,e,t){o.style.display=be(e,t)?"":"none"}function fe(o,e,t){o.style.display=be(e,t)?"":"none"}function Me(o){return o.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"")}function T(o,e,t,r){let s=e.trim();if(!s)return;let i=t.get(s),n=i==null?"":String(i);o.innerHTML=r?n:Me(n)}async function we(o,e,t,r){if(!globalThis.fetch)throw new Error("fetch is not available");let s=await globalThis.fetch(e.url);if(!s||!s.ok)return;let i=await s.text(),n=Le(o,e.targetSelector);if(!n){o.dispatchEvent(new CustomEvent("vsn:targetError",{detail:{selector:e.targetSelector}}));return}if(e.swap==="outer"){let a=document.createElement("div");T(a,"__html",{get:()=>i},e.trusted);let c=a.firstElementChild;c&&n.parentNode&&(n.parentNode.replaceChild(c,n),r?.(c));return}T(n,"__html",{get:()=>i},e.trusted),r?.(n)}function Le(o,e){return e?o.ownerDocument.querySelector(e):o}function B(o,e){let t;return(...r)=>{t&&clearTimeout(t),t=setTimeout(()=>{t=void 0,o(...r)},e)}}var d=class{constructor(e){this.type=e}async prepare(e){}evaluate(e){}};function q(o){return!!o&&typeof o.then=="function"}function f(o,e){return q(o)?o.then(e):e(o)}function de(o,e){let t=o.scope;if(!t||!t.createChild)return e.evaluate(o);let r=o.scope;o.scope=t.createChild();try{return e.evaluate(o)}finally{o.scope=r}}var _=class extends d{constructor(t,r=[]){super("Program");this.behaviors=t;this.uses=r}},Z=class extends d{constructor(t,r,s={},i={}){super("Use");this.name=t;this.alias=r;this.flags=s;this.flagArgs=i}},E=class extends d{constructor(t){super("Block");this.statements=t}evaluate(t){let r=0,s=()=>{for(;r<this.statements.length&&!t.returning;){let i=this.statements[r];if(r+=1,i&&typeof i.evaluate=="function"){let n=i.evaluate(t);if(q(n))return n.then(()=>s())}}};return s()}},Y=class extends d{constructor(t){super("Selector");this.selectorText=t}},C=class extends d{constructor(t,r,s={},i={}){super("Behavior");this.selector=t;this.body=r;this.flags=s;this.flagArgs=i}},F=class extends d{constructor(t,r,s,i={},n={}){super("OnBlock");this.eventName=t;this.args=r;this.body=s;this.flags=i;this.flagArgs=n}},W=class extends d{constructor(t,r,s="="){super("Assignment");this.target=t;this.value=r;this.operator=s}evaluate(t){if(!t.scope||!t.scope.setPath)return;let r=this.value.evaluate(t);return f(r,s=>{if(this.operator!=="=")return this.applyCompoundAssignment(t,s);if(this.target instanceof g&&this.target.name.startsWith("root.")&&t.rootScope){let i=this.target.name.slice(5);return t.rootScope.setPath?.(`self.${i}`,s),s}if(this.target instanceof y||this.target instanceof S){let i=this.resolveAssignmentTarget(t);return f(i,n=>n?.scope?.setPath?(n.scope.setPath(n.path,s),s):(this.assignTarget(t,this.target,s),s))}return this.assignTarget(t,this.target,s),s})}applyCompoundAssignment(t,r){if(!t.scope||!t.scope.setPath)return;let s=this.resolveAssignmentTarget(t);return f(s,i=>{if(!i)throw new Error("Compound assignment requires a simple identifier or member path");let{scope:n,path:a}=i,c=n?.getPath?n.getPath(a):void 0,p;return this.operator==="+="?p=c+r:this.operator==="-="?p=c-r:this.operator==="*="?p=c*r:p=c/r,n?.setPath?.(a,p),p})}resolveAssignmentTarget(t){if(this.target instanceof g){let r=this.target.name.startsWith("root."),s=r?this.target.name.slice(5):this.target.name;return r?t.rootScope?{scope:t.rootScope,path:`self.${s}`}:{scope:t.scope,path:`root.${s}`}:{scope:t.scope,path:s}}if(this.target instanceof y){let r=this.target.getIdentifierPath();if(!r)return null;let s=r.path,i=s.startsWith("root."),n=i?s.slice(5):s;return i?t.rootScope?{scope:t.rootScope,path:`self.${n}`}:{scope:t.scope,path:`root.${n}`}:{scope:t.scope,path:n}}if(this.target instanceof S){let r=this.resolveIndexPath(t,this.target);return f(r,s=>{if(!s)return null;let i=s.startsWith("root."),n=i?s.slice(5):s;return i?t.rootScope?{scope:t.rootScope,path:`self.${n}`}:{scope:t.scope,path:`root.${n}`}:{scope:t.scope,path:n}})}return null}resolveIndexPath(t,r){let s=this.resolveTargetPath(t,r.target);return f(s,i=>{if(!i)return null;let n=r.index.evaluate(t);return f(n,a=>a==null?null:`${i}.${a}`)})}resolveTargetPath(t,r){return r instanceof g?r.name:r instanceof y?r.getIdentifierPath()?.path??null:r instanceof S?this.resolveIndexPath(t,r):null}assignTarget(t,r,s){if(!(!t.scope||!t.scope.setPath)){if(r instanceof k){this.assignDirectiveTarget(t,r,s);return}if(r instanceof g){t.scope.setPath(r.name,s);return}if(r instanceof V){let i=Array.isArray(s)?s:[],n=0;for(let a of r.elements){if(a instanceof I){t.scope.setPath(a.target.name,i.slice(n));return}if(a===null){n+=1;continue}this.assignTarget(t,a,i[n]),n+=1}return}if(r instanceof R){let i=s&&typeof s=="object"?s:{},n=new Set;for(let a of r.entries){if("rest"in a){let c={};for(let p of Object.keys(i))n.has(p)||(c[p]=i[p]);t.scope.setPath(a.rest.name,c);continue}n.add(a.key),this.assignTarget(t,a.target,i[a.key])}return}}}assignDirectiveTarget(t,r,s){let i=t.element;if(i){if(r.kind==="attr"){if(r.name==="value"){if(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement){i.value=s==null?"":String(s),i.setAttribute("value",i.value);return}if(i instanceof HTMLSelectElement){i.value=s==null?"":String(s);return}}if(r.name==="checked"&&i instanceof HTMLInputElement){let n=s===!0||s==="true"||s===1||s==="1";i.checked=n,n?i.setAttribute("checked",""):i.removeAttribute("checked");return}if(r.name==="html"&&i instanceof HTMLElement){i.innerHTML=s==null?"":String(s);return}i.setAttribute(r.name,s==null?"":String(s));return}r.kind==="style"&&i instanceof HTMLElement&&i.style.setProperty(r.name,s==null?"":String(s))}}},D=class extends d{constructor(t){super("Return");this.value=t}evaluate(t){if(t.returning)return t.returnValue;let r=this.value?this.value.evaluate(t):void 0;return f(r,s=>(t.returnValue=s,t.returning=!0,t.returnValue))}},me=class extends Error{constructor(e="Assertion failed"){super(e),this.name="AssertError"}},J=class extends d{constructor(t){super("Assert");this.test=t}evaluate(t){let r=this.test.evaluate(t);return f(r,s=>{if(!s)throw new me;return s})}},X=class extends d{constructor(t,r,s){super("If");this.test=t;this.consequent=r;this.alternate=s}evaluate(t){let r=this.test.evaluate(t);return f(r,s=>{if(s)return de(t,this.consequent);if(this.alternate)return de(t,this.alternate)})}},ee=class extends d{constructor(t,r){super("While");this.test=t;this.body=r}evaluate(t){let r=t.scope;t.scope?.createChild&&(t.scope=t.scope.createChild());let s=()=>{let n=this.test.evaluate(t);return f(n,a=>{if(!a||t.returning)return;let c=this.body.evaluate(t);return f(c,()=>s())})},i=s();return q(i)?i.finally(()=>{t.scope=r}):(t.scope=r,i)}},te=class extends d{constructor(t,r,s,i){super("For");this.init=t;this.test=r;this.update=s;this.body=i}evaluate(t){let r=this.init?this.init.evaluate(t):void 0,s=()=>{let i=t.scope,n=t.scope;t.scope?.createChild&&(n=t.scope.createChild());let a=()=>{let c=this.test?this.test.evaluate(t):!0;return f(c,p=>{if(!p||t.returning){t.scope=i;return}t.scope=n;let l=this.body.evaluate(t);return f(l,()=>{if(t.returning){t.scope=i;return}t.scope=i;let h=this.update?this.update.evaluate(t):void 0;return f(h,()=>a())})})};return a()};return f(r,()=>s())}},re=class extends d{constructor(t,r,s){super("Try");this.body=t;this.errorName=r;this.handler=s}evaluate(t){let r=s=>{if(t.returning)return t.returnValue;let i=t.scope,n=t.scope;t.scope?.createChild&&(n=t.scope.createChild()),t.scope=n;let a=t.scope,c;a&&(c=a.getPath(this.errorName),a.setPath&&a.setPath(`self.${this.errorName}`,s));let p=this.handler.evaluate(t);return f(p,()=>{a&&a.setPath&&n===i&&a.setPath(this.errorName,c),t.scope=i})};try{let s=de(t,this.body);return q(s)?s.catch(i=>r(i)):s}catch(s){return r(s)}}},M=class extends d{constructor(t,r,s,i=!1){super("FunctionDeclaration");this.name=t;this.params=r;this.body=s;this.isAsync=i}},P=class extends d{constructor(t,r,s=!1){super("FunctionExpression");this.params=t;this.body=r;this.isAsync=s}evaluate(t){let r=t.scope,s=t.globals,i=t.element;return this.isAsync?(...n)=>{let a=r?.createChild?r.createChild():r,c={scope:a,rootScope:t.rootScope,...s?{globals:s}:{},...i?{element:i}:{},returnValue:void 0,returning:!1},p=new Map,l=a?this.applyParams(a,p,c,n):void 0,h=f(l,()=>this.body.evaluate(c)),u=f(h,()=>c.returnValue);return Promise.resolve(u).finally(()=>{a&&a===r&&this.restoreParams(a,p)})}:(...n)=>{let a=r?.createChild?r.createChild():r,c={scope:a,rootScope:t.rootScope,...s?{globals:s}:{},...i?{element:i}:{},returnValue:void 0,returning:!1},p=new Map,l=a?this.applyParams(a,p,c,n):void 0,h=f(l,()=>this.body.evaluate(c)),u=f(h,()=>c.returnValue);return q(u)?u.finally(()=>{a&&a===r&&this.restoreParams(a,p)}):(a&&a===r&&this.restoreParams(a,p),u)}}applyParams(t,r,s,i){if(!t)return;let n=t.setPath?.bind(t);if(!n)return;let a=this.params,c=(p,l)=>{for(let h=p;h<a.length;h+=1){let u=a[h],m=u.name;if(!m)continue;if(r.set(m,t.getPath(m)),u.rest){n(`self.${m}`,i.slice(l));return}let v=i[l];if(v===void 0&&u.defaultValue){let H=u.defaultValue.evaluate(s);return f(H,O=>(n(`self.${m}`,O),c(h+1,l+1)))}n(`self.${m}`,v),l+=1}};return c(0,0)}restoreParams(t,r){if(!t)return;let s=t.setPath?.bind(t);if(s)for(let i of this.params){let n=i.name;n&&s(n,r.get(n))}}},L=class extends d{constructor(t,r,s,i,n){super("Declaration");this.target=t;this.operator=r;this.value=s;this.flags=i;this.flagArgs=n}},g=class extends d{constructor(t){super("Identifier");this.name=t}evaluate(t){if(this.name.startsWith("root.")&&t.rootScope){let r=this.name.slice(5);return t.rootScope.getPath(`self.${r}`)}if(t.scope){let r=t.scope.getPath(this.name),s=this.name.split(".")[0];if(this.name.startsWith("parent.")||this.name.startsWith("root.")||this.name.startsWith("self.")||r!==void 0||s&&t.scope.hasKey?.(s))return r}return t.globals?t.globals[this.name]:void 0}},$=class extends d{constructor(t){super("SpreadElement");this.value=t}},I=class extends d{constructor(t){super("RestElement");this.target=t}},V=class extends d{constructor(t){super("ArrayPattern");this.elements=t}},R=class extends d{constructor(t){super("ObjectPattern");this.entries=t}},A=class extends d{constructor(t){super("Literal");this.value=t}evaluate(){return this.value}},se=class extends d{constructor(t){super("TemplateExpression");this.parts=t}evaluate(t){let r="",s=0,i=()=>{for(;s<this.parts.length;){let n=this.parts[s];s+=1;let a=n.evaluate(t);return f(a,c=>(r+=c==null?"":String(c),i()))}return r};return i()}},j=class extends d{constructor(t,r){super("UnaryExpression");this.operator=t;this.argument=r}evaluate(t){let r=this.argument.evaluate(t);return f(r,s=>this.operator==="!"?!s:this.operator==="-"?-s:s)}},x=class extends d{constructor(t,r,s){super("BinaryExpression");this.operator=t;this.left=r;this.right=s}evaluate(t){let r=this.left.evaluate(t);return f(r,s=>{if(this.operator==="&&")return s&&this.right.evaluate(t);if(this.operator==="||")return s||this.right.evaluate(t);if(this.operator==="??")return s??this.right.evaluate(t);let i=this.right.evaluate(t);return f(i,n=>{if(this.operator==="+")return s+n;if(this.operator==="-")return s-n;if(this.operator==="*")return s*n;if(this.operator==="/")return s/n;if(this.operator==="%")return s%n;if(this.operator==="==")return s==n;if(this.operator==="!=")return s!=n;if(this.operator==="===")return s===n;if(this.operator==="!==")return s!==n;if(this.operator==="<")return s<n;if(this.operator===">")return s>n;if(this.operator==="<=")return s<=n;if(this.operator===">=")return s>=n})})}},ie=class extends d{constructor(t,r,s){super("TernaryExpression");this.test=t;this.consequent=r;this.alternate=s}evaluate(t){let r=this.test.evaluate(t);return f(r,s=>s?this.consequent.evaluate(t):this.alternate.evaluate(t))}},y=class o extends d{constructor(t,r,s=!1){super("MemberExpression");this.target=t;this.property=r;this.optional=s}evaluate(t){let r=this.resolve(t);return f(r,s=>s?.value)}resolve(t){let r=this.getIdentifierPath();if(r){let i=this.resolveFromScope(t,r);if(i)return i;let n=this.resolveFromGlobals(t,r);if(n)return n}let s=this.target.evaluate(t);return f(s,i=>i==null?{value:void 0,target:i,optional:this.optional}:{value:i[this.property],target:i,optional:this.optional})}getIdentifierPath(){let t=this.getTargetIdentifierPath();return t?{path:`${t.path}.${this.property}`,root:t.root}:void 0}getTargetIdentifierPath(){if(this.target instanceof g){let t=this.target.name,r=t.split(".")[0];return r?{path:t,root:r}:void 0}if(this.target instanceof o)return this.target.getIdentifierPath()}resolveFromScope(t,r){if(!t.scope)return;if(r.path.startsWith("root.")&&t.rootScope){let c=r.path.slice(5),p=t.rootScope.getPath(`self.${c}`),l=c.split(".").slice(0,-1).join("."),h=l?t.rootScope.getPath(`self.${l}`):t.rootScope;return{value:p,target:h,optional:this.optional}}let s=t.scope.getPath(r.path);if(!(r.path.startsWith("parent.")||r.path.startsWith("root.")||r.path.startsWith("self."))&&s===void 0&&!t.scope.hasKey?.(r.root))return;let n=this.getTargetPath(r.path),a=n?t.scope.getPath(n):void 0;return{value:s,target:a,optional:this.optional}}resolveFromGlobals(t,r){let s=t.globals??{};if(!r.root||!(r.root in s))return;let i=s[r.root],n,a=r.path.split(".");for(let c=1;c<a.length;c+=1){n=i;let p=a[c];if(!p)return{value:void 0,target:n,optional:this.optional};i=i?.[p]}return{value:i,target:n,optional:this.optional}}getTargetPath(t){let r=t.split(".");if(!(r.length<=1))return r.slice(0,-1).join(".")}},b=class extends d{constructor(t,r){super("CallExpression");this.callee=t;this.args=r}evaluate(t){let r=this.resolveCallee(t);return f(r,s=>{let i=s?.fn??this.callee.evaluate(t);return f(i,n=>{if(typeof n!="function")return;let a=[],c=p=>{for(let l=p;l<this.args.length;l+=1){let u=this.args[l].evaluate(t);return f(u,m=>(a.push(m),c(l+1)))}return n.apply(s?.thisArg,a)};return c(0)})})}resolveCallee(t){if(this.callee instanceof y){let p=this.callee.resolve(t);return f(p,l=>{if(l)return{fn:l.value,thisArg:l.target}})}if(!(this.callee instanceof g))return;let r=this.callee.name,s=t.globals??{},i=r.split("."),n=i[0];if(!n||!(n in s)){if(i.length>1&&t.scope){let p=i.slice(0,-1).join("."),l=i[i.length-1];if(!l)return;let h=t.scope.getPath(p);return h==null?void 0:{fn:h?.[l],thisArg:h}}return}let a=s[n],c;for(let p=1;p<i.length;p+=1){c=a;let l=i[p];if(!l)return;a=a?.[l]}return{fn:a,thisArg:c}}},ne=class extends d{constructor(t){super("ArrayExpression");this.elements=t}evaluate(t){let r=[],s=n=>{if(n==null)return;if(typeof n[Symbol.iterator]=="function")for(let c of n)r.push(c);else r.push(n)},i=n=>{for(let a=n;a<this.elements.length;a+=1){let c=this.elements[a];if(c instanceof $){let l=c.value.evaluate(t);return f(l,h=>(s(h),i(a+1)))}let p=c.evaluate(t);return f(p,l=>(r.push(l),i(a+1)))}return r};return i(0)}},ae=class extends d{constructor(t){super("ObjectExpression");this.entries=t}evaluate(t){let r={},s=i=>{for(let n=i;n<this.entries.length;n+=1){let a=this.entries[n];if("spread"in a){let p=a.spread.evaluate(t);return f(p,l=>(l!=null&&Object.assign(r,l),s(n+1)))}if("computed"in a&&a.computed){let p=a.keyExpr.evaluate(t);return f(p,l=>{let h=a.value.evaluate(t);return f(h,u=>(r[String(l)]=u,s(n+1)))})}let c=a.value.evaluate(t);return f(c,p=>(r[a.key]=p,s(n+1)))}return r};return s(0)}},S=class extends d{constructor(t,r){super("IndexExpression");this.target=t;this.index=r}evaluate(t){let r=this.target.evaluate(t);return f(r,s=>{if(s==null)return;let i=this.index.evaluate(t);return f(i,n=>{if(n!=null)return s[n]})})}},k=class extends d{constructor(t,r){super("Directive");this.kind=t;this.name=r}evaluate(t){let r=t.element;if(!r)return`${this.kind}:${this.name}`;if(this.kind==="attr")return this.name==="value"&&(r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement||r instanceof HTMLSelectElement)?r.value:this.name==="checked"&&r instanceof HTMLInputElement?r.checked:this.name==="html"&&r instanceof HTMLElement?r.innerHTML:r.getAttribute(this.name)??void 0;if(this.kind==="style"&&r instanceof HTMLElement)return r.style.getPropertyValue(this.name)??void 0}},z=class extends d{constructor(t){super("AwaitExpression");this.argument=t}evaluate(t){let r=this.argument.evaluate(t);return Promise.resolve(r)}},oe=class extends d{constructor(t,r){super("Query");this.direction=t;this.selector=r}evaluate(t){let r=this.selector.trim();if(!r)return[];if(this.direction==="ancestor"){let i=[],n=t.element?.parentElement;for(;n;)n.matches(r)&&i.push(n),n=n.parentElement;return i}let s=this.direction==="descendant"?t.element??(typeof document<"u"?document:void 0):typeof document<"u"?document:void 0;return!s||!("querySelectorAll"in s)?[]:Array.from(s.querySelectorAll(r))}};var Ie={behavior:"Behavior",use:"Use",state:"State",on:"On",construct:"Construct",destruct:"Destruct",return:"Return",if:"If",else:"Else",for:"For",while:"While",try:"Try",catch:"Catch",assert:"Assert",true:"Boolean",false:"Boolean",null:"Null"},ce=class{constructor(e){this.input=e}index=0;line=1;column=1;pendingTokens=[];templateMode=!1;templateExpressionMode=!1;templateBraceDepth=0;tokenize(){let e=[];for(;!this.eof();){if(this.pendingTokens.length>0){let s=this.pendingTokens.shift();if(s){e.push(s),this.trackTemplateBrace(s);continue}}if(this.templateMode){let s=this.readTemplateChunk();e.push(s);continue}let t=this.peek();if(this.isWhitespace(t)){e.push(this.readWhitespace());continue}if(t==="`"){this.next(),this.templateMode=!0;continue}if(t==="/"&&this.peek(1)==="/"){this.readLineComment();continue}if(t==="/"&&this.peek(1)==="*"){this.readBlockComment();continue}if(this.isAlpha(t)||t==="_"){e.push(this.readIdentifier());continue}if(this.isDigit(t)||t==="-"&&this.isDigit(this.peek(1))){e.push(this.readNumber());continue}if(t==='"'||t==="'"){e.push(this.readString());continue}let r=this.readPunctuator();if(r){e.push(r),this.trackTemplateBrace(r);continue}throw new Error(`Unexpected character '${t}' at ${this.line}:${this.column}`)}return e}readWhitespace(){let e=this.position(),t="";for(;!this.eof()&&this.isWhitespace(this.peek());)t+=this.next();return this.token("Whitespace",t,e)}readLineComment(){for(this.next(),this.next();!this.eof()&&this.peek()!==`
`;)this.next()}readBlockComment(){for(this.next(),this.next();!this.eof();){if(this.peek()==="*"&&this.peek(1)==="/"){this.next(),this.next();return}this.next()}}readIdentifier(){let e=this.position(),t="";for(;!this.eof()&&(this.isAlphaNumeric(this.peek())||this.peek()==="_"||this.peek()==="-");)t+=this.next();let r=Ie[t];return r?this.token(r,t,e):this.token("Identifier",t,e)}readNumber(){let e=this.position(),t="";for(this.peek()==="-"&&(t+=this.next());!this.eof()&&this.isDigit(this.peek());)t+=this.next();if(this.peek()===".")for(t+=this.next();!this.eof()&&this.isDigit(this.peek());)t+=this.next();return this.token("Number",t,e)}readString(){let e=this.next(),t=this.position(),r="";for(;!this.eof();){let s=this.next();if(s==="\\"){let i=this.next();r+=i;continue}if(s===e)return this.token("String",r,t);r+=s}throw new Error(`Unterminated string at ${t.line}:${t.column}`)}readTemplateChunk(){let e=this.position(),t="";for(;!this.eof();){let r=this.peek();if(r==="`")return this.next(),this.templateMode=!1,this.token("Template",t,e);if(r==="$"&&this.peek(1)==="{"){let s=this.position();this.next();let i=this.position();return this.next(),this.templateMode=!1,this.templateExpressionMode=!0,this.templateBraceDepth=0,this.pendingTokens.push(this.token("Dollar","$",s)),this.pendingTokens.push(this.token("LBrace","{",i)),this.token("Template",t,e)}if(r==="\\"){this.next();let s=this.next();t+=s;continue}t+=this.next()}throw new Error(`Unterminated template literal at ${e.line}:${e.column}`)}readPunctuator(){let e=this.position(),t=this.peek(),r=this.peek(1);if(t==="="&&r==="="&&this.peek(2)==="=")return this.next(),this.next(),this.next(),this.token("TripleEquals","===",e);if(t==="="&&r==="=")return this.next(),this.next(),this.token("DoubleEquals","==",e);if(t==="="&&r===">")return this.next(),this.next(),this.token("Arrow","=>",e);if(t==="!"&&r==="="&&this.peek(2)==="=")return this.next(),this.next(),this.next(),this.token("StrictNotEquals","!==",e);if(t==="!"&&r==="=")return this.next(),this.next(),this.token("NotEquals","!=",e);if(t==="<"&&r==="=")return this.next(),this.next(),this.token("LessEqual","<=",e);if(t===">"&&r==="=")return this.next(),this.next(),this.token("GreaterEqual",">=",e);if(t==="&"&&r==="&")return this.next(),this.next(),this.token("And","&&",e);if(t==="|"&&r==="|")return this.next(),this.next(),this.token("Or","||",e);if(t==="?"&&r==="?")return this.next(),this.next(),this.token("NullishCoalesce","??",e);if(t==="?"&&r===".")return this.next(),this.next(),this.token("OptionalChain","?.",e);if(t==="|"&&r===">")return this.next(),this.next(),this.token("Pipe","|>",e);if(t==="."&&r==="."&&this.peek(2)===".")return this.next(),this.next(),this.next(),this.token("Ellipsis","...",e);let i={"{":"LBrace","}":"RBrace","(":"LParen",")":"RParen","[":"LBracket","]":"RBracket",":":"Colon",";":"Semicolon",",":"Comma",".":"Dot","#":"Hash",">":"Greater","<":"Less","+":"Plus","-":"Minus","~":"Tilde","*":"Star","/":"Slash","%":"Percent","=":"Equals","!":"Bang","@":"At",$:"Dollar","?":"Question"}[t];return i?(this.next(),this.token(i,t,e)):null}trackTemplateBrace(e){this.templateExpressionMode&&(e.type==="LBrace"?this.templateBraceDepth+=1:e.type==="RBrace"&&(this.templateBraceDepth-=1,this.templateBraceDepth<=0&&(this.templateExpressionMode=!1,this.templateMode=!0)))}token(e,t,r){return{type:e,value:t,start:r,end:this.position()}}position(){return{index:this.index,line:this.line,column:this.column}}peek(e=0){return this.input[this.index+e]??""}next(){let e=this.input[this.index++]??"";return e===`
`?(this.line+=1,this.column=1):this.column+=1,e}eof(){return this.index>=this.input.length}isWhitespace(e){return e===" "||e==="	"||e===`
`||e==="\r"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isDigit(e){return e>="0"&&e<="9"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}};var pe=class{constructor(e){this.tokens=e}index=0;peek(e=0){return this.tokens[this.index+e]??null}next(){let e=this.tokens[this.index++];if(!e)throw new Error("Unexpected end of input");return e}eof(){return this.index>=this.tokens.length}match(e){return this.peek()?.type===e?(this.next(),!0):!1}expect(e){let t=this.next();if(t.type!==e)throw new Error(`Expected ${e} but got ${t.type}`);return t}skipWhitespace(){for(;this.peek()?.type==="Whitespace";)this.next()}peekNonWhitespace(e=0){let t=0;for(let r=this.index;r<this.tokens.length;r++){let s=this.tokens[r];if(s.type!=="Whitespace"){if(t===e)return s;t+=1}}return null}indexAfterDelimited(e,t,r=0){let s=this.peekNonWhitespace(r);if(!s||s.type!==e)return null;let i=r+1,n=1;for(;;){let a=this.peekNonWhitespace(i);if(!a)return null;if(a.type===e)n+=1;else if(a.type===t&&(n-=1,n===0))return i+1;i+=1}}};var K=class o{stream;source;customFlags;behaviorFlags;allowImplicitSemicolon=!1;awaitStack=[];functionDepth=0;constructor(e,t){this.source=e,this.customFlags=t?.customFlags??new Set(["important","trusted","debounce"]),this.behaviorFlags=t?.behaviorFlags??new Set;let r=new ce(e);this.stream=new pe(r.tokenize())}static parseInline(e){return new o(`{${e}}`).parseInlineBlock()}parseProgram(){return this.wrapErrors(()=>{let e=[],t=[];for(this.stream.skipWhitespace();!this.stream.eof();){let r=this.stream.peek();if(!r)break;r.type==="Use"?t.push(this.parseUseStatement()):e.push(this.parseBehavior()),this.stream.skipWhitespace()}return new _(e,t)})}parseInlineBlock(){return this.wrapErrors(()=>(this.stream.skipWhitespace(),this.allowImplicitSemicolon=!0,this.parseBlock({allowDeclarations:!1})))}parseBehavior(){return this.wrapErrors(()=>{this.stream.skipWhitespace(),this.stream.expect("Behavior");let e=this.parseSelector(),{flags:t,flagArgs:r}=this.parseBehaviorFlags(),s=this.parseBlock({allowDeclarations:!0});return new C(e,s,t,r)})}parseSelector(){let e="",t=!1;for(;;){let r=this.stream.peek();if(!r||r.type==="LBrace"||r.type==="Bang")break;if(r.type==="Whitespace"){this.stream.next(),t&&e[e.length-1]!==" "&&(e+=" ");continue}t=!0,e+=this.stream.next().value}if(!e.trim())throw new Error("Behavior selector is required");return new Y(e.trim())}parseBehaviorFlags(){let e=this.parseFlags(this.behaviorFlags,"behavior modifier");return{flags:e.flags,flagArgs:e.flagArgs}}parseUseStatement(){return this.wrapErrors(()=>{this.stream.expect("Use"),this.stream.skipWhitespace();let e=this.parseIdentifierPath();this.stream.skipWhitespace();let t=e,r=this.stream.peek();r?.type==="Identifier"&&r.value==="as"&&(this.stream.next(),this.stream.skipWhitespace(),t=this.stream.expect("Identifier").value);let{flags:s,flagArgs:i}=this.parseUseFlags();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new Z(e,t,s,i)})}parseUseFlags(){let e={},t={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let r=this.stream.expect("Identifier").value;if(r!=="wait")throw new Error(`Unknown flag ${r}`);if(e.wait=!0,this.stream.peek()?.type==="LParen"){this.stream.next(),this.stream.skipWhitespace();let s=this.stream.expect("Number"),i=Number(s.value),n;if(this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next(),this.stream.skipWhitespace();let a=this.stream.expect("Number");n=Number(a.value),this.stream.skipWhitespace()}this.stream.expect("RParen"),t.wait={timeoutMs:i,...n!==void 0?{intervalMs:n}:{}}}}return{flags:e,flagArgs:t}}wrapErrors(e){try{return e()}catch(t){throw t instanceof Error&&!/\(line\s+\d+, column\s+\d+\)/i.test(t.message)?new Error(this.formatError(t.message)):t}}formatError(e){let t=this.stream.peek()??this.stream.peekNonWhitespace(0);if(!t)return`Parse error: ${e}`;let r=t.start.line,s=t.start.column,i=this.getLineSnippet(r,s);return`Parse error (line ${r}, column ${s}): ${e}
${i}`}getLineSnippet(e,t){let s=this.source.split(/\r?\n/)[e-1]??"",i=`${" ".repeat(Math.max(t-1,0))}^`;return`${s}
${i}`}parseBlock(e){let t=e?.allowDeclarations??!1,r=e?.allowReturn??this.functionDepth>0;this.stream.skipWhitespace(),this.stream.expect("LBrace");let s=[],i=t,n=!1,a=!1,c=!1;for(;;){this.stream.skipWhitespace();let p=this.stream.peek();if(!p)throw new Error("Unterminated block");if(p.type==="RBrace"){this.stream.next();break}if(t&&p.type==="Behavior"&&(c=!0),t&&c&&p.type!=="Behavior")throw new Error("Nested behaviors must appear after construct, function, and on blocks");if(t&&this.isFunctionDeclarationStart()){n||(a=!0),s.push(this.parseFunctionDeclaration());continue}if(t&&this.isFunctionExpressionAssignmentStart()){if(!i)throw new Error("Declarations must appear before blocks");s.push(this.parseAssignment());continue}if(this.isDeclarationStart()){if(!t)throw new Error("Declarations are only allowed at the behavior root");if(!i)throw new Error("Declarations must appear before blocks");s.push(this.parseDeclaration())}else{if(i&&(i=!1),t&&p.type==="On"&&!n&&(a=!0),t&&p.type==="Construct"){if(a)throw new Error("Construct blocks must appear before functions and on blocks");n=!0}s.push(this.parseStatement({allowReturn:r}))}}return new E(s)}parseStatement(e){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unexpected end of input");let r=e?.allowBlocks??!0,s=e?.allowReturn??!1;if(t.type==="Return"){if(!s)throw new Error("Return is only allowed inside functions");return this.parseReturnStatement()}if(t.type==="Assert")return this.parseAssertStatement();if(r&&t.type==="On")return this.parseOnBlock();if(r&&t.type==="If")return this.parseIfBlock();if(r&&t.type==="For")return this.parseForBlock();if(r&&t.type==="While")return this.parseWhileBlock();if(r&&t.type==="Try")return this.parseTryBlock();if(r&&t.type==="Construct")return this.parseConstructBlock();if(r&&t.type==="Destruct")return this.parseDestructBlock();if(r&&t.type==="Behavior")return this.parseBehavior();if(this.isAwaitAllowed()&&t.type==="Identifier"&&t.value==="await")return this.parseExpressionStatement();if(this.isAssignmentStart())return this.parseAssignment();if(this.isExpressionStatementStart())return this.parseExpressionStatement();throw new Error(`Unexpected token ${t.type}`)}parseOnBlock(){this.stream.expect("On"),this.stream.skipWhitespace();let e=this.parseIdentifierPath();this.stream.skipWhitespace(),this.stream.expect("LParen");let t=[];for(;;){this.stream.skipWhitespace();let n=this.stream.peek();if(!n)throw new Error("Unterminated on() arguments");if(n.type==="RParen"){this.stream.next();break}if(n.type==="Identifier"){t.push(this.stream.next().value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next();continue}throw new Error(`Unexpected token in on() args: ${n.type}`)}let{flags:r,flagArgs:s}=this.parseFlags(this.customFlags,"flag"),i=this.parseBlock({allowDeclarations:!1});return new F(e,t,i,r,s)}parseAssignment(){let e=this.parseAssignmentTarget();this.stream.skipWhitespace();let t=this.parseAssignmentOperator();this.stream.skipWhitespace();let r=this.parseExpression();return this.consumeStatementTerminator(),new W(e,r,t)}parseExpression(){return this.parsePipeExpression()}parsePipeExpression(){let e=this.parseTernaryExpression();for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Pipe";){this.stream.next(),this.stream.skipWhitespace();let t=!1,r=this.stream.peek();this.isAwaitAllowed()&&r?.type==="Identifier"&&r.value==="await"&&(this.stream.next(),this.stream.skipWhitespace(),t=!0);let s=this.parseCallExpression(),i=this.buildPipeCall(e,s);e=t?new z(i):i}return e}buildPipeCall(e,t){if(t instanceof b)return new b(t.callee,[e,...t.args]);if(t instanceof g||t instanceof y)return new b(t,[e]);throw new Error("Pipe operator requires a function call")}parseTernaryExpression(){let e=this.parseNullishExpression();if(this.stream.skipWhitespace(),this.stream.peek()?.type!=="Question")return e;this.stream.next(),this.stream.skipWhitespace();let t=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let r=this.parseExpression();return new ie(e,t,r)}parseNullishExpression(){let e=this.parseLogicalOrExpression();for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="NullishCoalesce";){this.stream.next(),this.stream.skipWhitespace();let t=this.parseLogicalOrExpression();e=new x("??",e,t)}return e}parseLogicalOrExpression(){let e=this.parseLogicalAndExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Or")break;this.stream.skipWhitespace(),this.stream.next(),this.stream.skipWhitespace();let r=this.parseLogicalAndExpression();this.stream.skipWhitespace(),e=new x("||",e,r)}return e}parseLogicalAndExpression(){let e=this.parseEqualityExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="And")break;this.stream.skipWhitespace(),this.stream.next(),this.stream.skipWhitespace();let r=this.parseEqualityExpression();this.stream.skipWhitespace(),e=new x("&&",e,r)}return e}parseEqualityExpression(){let e=this.parseComparisonExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="DoubleEquals"&&t.type!=="NotEquals"&&t.type!=="TripleEquals"&&t.type!=="StrictNotEquals")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseComparisonExpression();this.stream.skipWhitespace();let i="==";r.type==="NotEquals"?i="!=":r.type==="TripleEquals"?i="===":r.type==="StrictNotEquals"&&(i="!=="),e=new x(i,e,s)}return e}parseComparisonExpression(){let e=this.parseAdditiveExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Less"&&t.type!=="Greater"&&t.type!=="LessEqual"&&t.type!=="GreaterEqual")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseAdditiveExpression();this.stream.skipWhitespace();let i="<";r.type==="Greater"?i=">":r.type==="LessEqual"?i="<=":r.type==="GreaterEqual"&&(i=">="),e=new x(i,e,s)}return e}parseMultiplicativeExpression(){let e=this.parseUnaryExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Star"&&t.type!=="Slash"&&t.type!=="Percent")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseUnaryExpression();this.stream.skipWhitespace();let i="*";r.type==="Slash"?i="/":r.type==="Percent"&&(i="%"),e=new x(i,e,s)}return e}parseAdditiveExpression(){let e=this.parseMultiplicativeExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Plus"&&t.type!=="Minus")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseMultiplicativeExpression();this.stream.skipWhitespace(),e=new x(r.type==="Plus"?"+":"-",e,s)}return e}parseUnaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="Bang"){this.stream.next();let t=this.parseUnaryExpression();return new j("!",t)}if(e.type==="Minus"){this.stream.next();let t=this.parseUnaryExpression();return new j("-",t)}if(this.isAwaitAllowed()&&e.type==="Identifier"&&e.value==="await"){this.stream.next();let t=this.parseUnaryExpression();return new z(t)}return this.parseCallExpression()}parseCallExpression(){let e=this.parsePrimaryExpression();for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)break;if(t.type==="LParen"){this.stream.next();let r=[];for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated call expression");if(s.type==="RParen"){this.stream.next();break}if(r.push(this.parseExpression()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in call arguments")}e=new b(e,r);continue}if(t.type==="OptionalChain"){this.stream.next(),this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Expected property or call after ?.");if(r.type==="LParen"){this.stream.next();let s=[];for(;;){this.stream.skipWhitespace();let i=this.stream.peek();if(!i)throw new Error("Unterminated call expression");if(i.type==="RParen"){this.stream.next();break}if(s.push(this.parseExpression()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in call arguments")}e=new b(e,s);continue}if(r.type==="Identifier"){let s=this.stream.next();e=new y(e,s.value,!0);continue}throw new Error("Expected property or call after ?.")}if(t.type==="Dot"){this.stream.next();let r=this.stream.expect("Identifier");e=new y(e,r.value);continue}if(t.type==="LBracket"){this.stream.next(),this.stream.skipWhitespace();let r=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RBracket"),e=new S(e,r);continue}break}return e}parsePrimaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new k(t,r.value)}if(e.type==="Question")return this.parseQueryExpression();if(e.type==="LBracket")return this.parseArrayExpression();if(e.type==="LBrace")return this.parseObjectExpression();if(e.type==="LParen"){if(this.isArrowFunctionStart())return this.parseArrowFunctionExpression();this.stream.next();let t=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("RParen"),t}if(e.type==="Identifier")return this.isAsyncToken(e)&&this.isAsyncArrowFunctionStart()?(this.stream.next(),this.stream.skipWhitespace(),this.parseArrowFunctionExpression(!0)):new g(this.stream.next().value);if(e.type==="Boolean")return new A(this.stream.next().value==="true");if(e.type==="Null")return this.stream.next(),new A(null);if(e.type==="Number")return new A(Number(this.stream.next().value));if(e.type==="String")return new A(this.stream.next().value);if(e.type==="Template")return this.parseTemplateExpression();throw new Error(`Unsupported expression token ${e.type}`)}parseArrayExpression(){this.stream.expect("LBracket");let e=[];for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unterminated array literal");if(t.type==="RBracket"){this.stream.next();break}if(t.type==="Ellipsis"){this.stream.next(),this.stream.skipWhitespace();let r=this.parseExpression();e.push(new $(r))}else e.push(this.parseExpression());if(this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){if(this.stream.next(),this.stream.skipWhitespace(),this.stream.peek()?.type==="RBracket"){this.stream.next();break}continue}if(this.stream.peek()?.type==="RBracket"){this.stream.next();break}throw new Error("Expected ',' or ']' in array literal")}return new ne(e)}parseTemplateExpression(){let e=[];for(;;){let t=this.stream.peek();if(!t)throw new Error("Unterminated template literal");if(t.type!=="Template")throw new Error("Expected template literal");let r=this.stream.next().value;r&&e.push(new A(r));let s=this.stream.peek();if(!s||s.type!=="Dollar")break;this.stream.next(),this.stream.expect("LBrace"),this.stream.skipWhitespace();let i=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RBrace"),e.push(i)}return new se(e)}parseObjectExpression(){this.stream.expect("LBrace");let e=[];for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unterminated object literal");if(t.type==="RBrace"){this.stream.next();break}let r,s;if(t.type==="Ellipsis")this.stream.next(),this.stream.skipWhitespace(),s={spread:this.parseExpression()};else if(t.type==="LBracket"){this.stream.next(),this.stream.skipWhitespace();let i=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RBracket"),this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace(),r=this.parseExpression(),s={keyExpr:i,value:r,computed:!0}}else if(t.type==="Identifier"){let i=this.stream.next().value;this.stream.skipWhitespace(),this.stream.peek()?.type==="Colon"?(this.stream.next(),this.stream.skipWhitespace(),r=this.parseExpression()):r=new g(i),s={key:i,value:r}}else if(t.type==="String"){let i=this.stream.next().value;this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace(),r=this.parseExpression(),s={key:i,value:r}}else throw new Error(`Unexpected token in object literal: ${t.type}`);if(!s)throw new Error("Invalid object literal entry");if(e.push(s),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){if(this.stream.next(),this.stream.skipWhitespace(),this.stream.peek()?.type==="RBrace"){this.stream.next();break}continue}if(this.stream.peek()?.type==="RBrace"){this.stream.next();break}throw new Error("Expected ',' or '}' in object literal")}return new ae(e)}consumeStatementTerminator(){this.stream.skipWhitespace();let e=this.stream.peek();if(e?.type==="Semicolon"){this.stream.next();return}this.allowImplicitSemicolon&&e?.type==="RBrace"||this.stream.expect("Semicolon")}parseFunctionBlockWithAwait(e){this.stream.expect("LBrace");let t=[];this.awaitStack.push(e),this.functionDepth+=1;try{for(;;){this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Unterminated function block");if(r.type==="RBrace"){this.stream.next();break}t.push(this.parseStatement({allowBlocks:!0,allowReturn:!0}))}}finally{this.functionDepth-=1,this.awaitStack.pop()}return new E(t)}isAsyncToken(e){return e?.type==="Identifier"&&e.value==="async"}isAwaitAllowed(){return this.awaitStack.length===0?!1:this.awaitStack[this.awaitStack.length-1]===!0}parseArrowExpressionBody(e){this.awaitStack.push(e);try{let t=this.parseExpression();return new E([new D(t)])}finally{this.awaitStack.pop()}}parseAssignmentTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected assignment target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new k(t,r.value)}if(e.type==="LBracket")return this.parseArrayPattern();if(e.type==="LBrace")return this.parseObjectPattern();if(e.type==="Identifier"){let t=this.parseCallExpression();if(t instanceof b)throw new Error("Invalid assignment target CallExpression");if(t instanceof g||t instanceof y||t instanceof S)return t;throw new Error("Invalid assignment target")}throw new Error(`Invalid assignment target ${e.type}`)}parseArrayPattern(){this.stream.expect("LBracket");let e=[],t=!1;for(;;){this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Unterminated array pattern");if(r.type==="RBracket"){this.stream.next();break}if(r.type==="Comma"){this.stream.next(),e.push(null);continue}if(r.type==="Ellipsis"){if(t)throw new Error("Array patterns can only include one rest element");this.stream.next(),this.stream.skipWhitespace();let s=this.stream.expect("Identifier");e.push(new I(new g(s.value))),t=!0}else if(r.type==="LBracket")e.push(this.parseArrayPattern());else if(r.type==="LBrace")e.push(this.parseObjectPattern());else if(r.type==="Identifier")e.push(new g(this.parseIdentifierPath()));else throw new Error(`Unexpected token in array pattern: ${r.type}`);if(this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RBracket"){this.stream.next();break}throw new Error("Expected ',' or ']' in array pattern")}if(t&&!(e[e.length-1]instanceof I))throw new Error("Rest element must be last in array pattern");return new V(e)}parseObjectPattern(){this.stream.expect("LBrace");let e=[],t;for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated object pattern");if(s.type==="RBrace"){this.stream.next();break}if(s.type==="Ellipsis"){if(t)throw new Error("Object patterns can only include one rest element");this.stream.next(),this.stream.skipWhitespace();let i=this.stream.expect("Identifier");if(t=new g(i.value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&(this.stream.next(),this.stream.skipWhitespace()),this.stream.peek()?.type!=="RBrace")throw new Error("Rest element must be last in object pattern");this.stream.next();break}else if(s.type==="Identifier"||s.type==="String"){let n=this.stream.next().value;this.stream.skipWhitespace();let a;if(this.stream.peek()?.type==="Colon"){this.stream.next(),this.stream.skipWhitespace();let c=this.stream.peek();if(!c)throw new Error("Expected object pattern target");if(c.type==="LBracket")a=this.parseArrayPattern();else if(c.type==="LBrace")a=this.parseObjectPattern();else if(c.type==="Identifier")a=new g(this.parseIdentifierPath());else throw new Error(`Unexpected token in object pattern: ${c.type}`)}else a=new g(n);e.push({key:n,target:a})}else throw new Error(`Unexpected token in object pattern: ${s.type}`);if(this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){if(this.stream.next(),this.stream.skipWhitespace(),this.stream.peek()?.type==="RBrace"){this.stream.next();break}continue}if(this.stream.peek()?.type==="RBrace"){this.stream.next();break}throw new Error("Expected ',' or '}' in object pattern")}let r=t?[...e,{rest:t}]:e;return t&&e.length===0?new R([{rest:t}]):new R(r)}parseDeclaration(){let e=this.parseDeclarationTarget();this.stream.skipWhitespace();let t=this.parseDeclarationOperator();this.stream.skipWhitespace();let r=this.parseExpression(),{flags:s,flagArgs:i}=this.parseFlags(this.customFlags,"flag");return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new L(e,t,r,s,i)}parseDeclarationTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected declaration target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new k(t,r.value)}if(e.type==="Identifier")return new g(this.stream.next().value);throw new Error(`Invalid declaration target ${e.type}`)}parseDeclarationOperator(){this.stream.expect("Colon");let e=this.stream.peek();return e?e.type==="Equals"?(this.stream.next(),":="):e.type==="Less"?(this.stream.next(),":<"):e.type==="Greater"?(this.stream.next(),":>"):":":":"}parseFlags(e,t){let r={},s={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let i=this.stream.expect("Identifier").value;if(e&&!e.has(i))throw new Error(`Unknown ${t} ${i}`);r[i]=!0;let n=this.parseCustomFlagArg();n!==void 0&&(s[i]=n)}return{flags:r,flagArgs:s}}parseCustomFlagArg(){if(this.stream.peek()?.type!=="LParen")return;if(this.stream.next(),this.stream.skipWhitespace(),!this.stream.peek())throw new Error("Unterminated flag arguments");let t=this.parseCustomFlagLiteral();return this.stream.skipWhitespace(),this.stream.expect("RParen"),t}parseCustomFlagLiteral(){let e=this.stream.peek();if(!e)throw new Error("Unterminated flag arguments");if(e.type==="Number")return Number(this.stream.next().value);if(e.type==="String")return this.stream.next().value;if(e.type==="Boolean")return this.stream.next().value==="true";if(e.type==="Identifier")return this.stream.next().value;if(e.type==="LBracket")return this.parseCustomFlagArray();if(e.type==="LBrace")return this.parseCustomFlagObject();throw new Error(`Unsupported flag argument ${e.type}`)}parseCustomFlagArray(){this.stream.expect("LBracket");let e=[];for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unterminated flag array");if(t.type==="RBracket"){this.stream.next();break}e.push(this.parseCustomFlagLiteral()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next()}return e}parseCustomFlagObject(){this.stream.expect("LBrace");let e={};for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unterminated flag object");if(t.type==="RBrace"){this.stream.next();break}let r;if(t.type==="Identifier"||t.type==="String")r=this.stream.next().value;else throw new Error(`Unsupported flag object key ${t.type}`);this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace(),e[r]=this.parseCustomFlagLiteral(),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next()}return e}isDeclarationStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier")return this.stream.peekNonWhitespace(1)?.type==="Colon";if(e.type==="At"||e.type==="Dollar"){let t=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return t?.type==="Identifier"&&r?.type==="Colon"}return!1}isAssignmentStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier"){let t=1;for(;this.stream.peekNonWhitespace(t)?.type==="Dot"&&this.stream.peekNonWhitespace(t+1)?.type==="Identifier";)t+=2;for(;this.stream.peekNonWhitespace(t)?.type==="LBracket";){let r=this.stream.indexAfterDelimited("LBracket","RBracket",t);if(r===null)return!1;t=r}return this.isAssignmentOperatorStart(t)}if(e.type==="At"||e.type==="Dollar")return this.stream.peekNonWhitespace(1)?.type==="Identifier"&&this.isAssignmentOperatorStart(2);if(e.type==="LBrace"||e.type==="LBracket"){let t=[],r=0;for(;;){let s=this.stream.peekNonWhitespace(r);if(!s)return!1;if(s.type==="LBrace"||s.type==="LBracket")t.push(s.type);else if((s.type==="RBrace"||s.type==="RBracket")&&(t.pop(),t.length===0))return this.isAssignmentOperatorStart(r+1);r+=1}}return!1}isAssignmentOperatorStart(e){let t=this.stream.peekNonWhitespace(e);return t?t.type==="Equals"?!0:t.type==="Plus"||t.type==="Minus"||t.type==="Star"||t.type==="Slash"?this.stream.peekNonWhitespace(e+1)?.type==="Equals":!1:!1}isExpressionStatementStart(){let e=this.stream.peekNonWhitespace(0);return e?e.type==="Identifier"?!0:e.type==="Number"||e.type==="String"||e.type==="Boolean"||e.type==="Null"||e.type==="LParen"||e.type==="LBracket"||e.type==="LBrace"||e.type==="At"||e.type==="Dollar"||e.type==="Question"||e.type==="Bang"||e.type==="Minus":!1}isFunctionDeclarationStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;let t=0;if(this.isAsyncToken(e)){let s=this.stream.peekNonWhitespace(1);if(!s||s.type!=="Identifier")return!1;t=1}else if(e.type!=="Identifier")return!1;if(t+=1,this.stream.peekNonWhitespace(t)?.type!=="LParen")return!1;let r=this.stream.indexAfterDelimited("LParen","RParen",t);return r===null?!1:this.stream.peekNonWhitespace(r)?.type==="LBrace"}isArrowFunctionStart(){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="LParen")return!1;let t=this.stream.indexAfterDelimited("LParen","RParen",0);return t===null?!1:this.stream.peekNonWhitespace(t)?.type==="Arrow"}isAsyncArrowFunctionStart(){let e=this.stream.peekNonWhitespace(0);if(!this.isAsyncToken(e)||this.stream.peekNonWhitespace(1)?.type!=="LParen")return!1;let t=this.stream.indexAfterDelimited("LParen","RParen",1);return t===null?!1:this.stream.peekNonWhitespace(t)?.type==="Arrow"}isFunctionExpressionAssignmentStart(){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Identifier"||this.stream.peekNonWhitespace(1)?.type!=="Equals")return!1;let t=2;if(this.isAsyncToken(this.stream.peekNonWhitespace(t))&&(t+=1),this.stream.peekNonWhitespace(t)?.type!=="LParen")return!1;let r=this.stream.indexAfterDelimited("LParen","RParen",t);return r===null?!1:this.stream.peekNonWhitespace(r)?.type==="Arrow"}parseExpressionStatement(){let e=this.parseExpression();return this.consumeStatementTerminator(),e}parseIfBlock(){this.stream.expect("If"),this.stream.skipWhitespace(),this.stream.expect("LParen"),this.stream.skipWhitespace();let e=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RParen");let t=this.parseBlock({allowDeclarations:!1});this.stream.skipWhitespace();let r;if(this.stream.peek()?.type==="Else")if(this.stream.next(),this.stream.skipWhitespace(),this.stream.peek()?.type==="If"){let s=this.parseIfBlock();r=new E([s])}else r=this.parseBlock({allowDeclarations:!1});return new X(e,t,r)}parseWhileBlock(){this.stream.expect("While"),this.stream.skipWhitespace(),this.stream.expect("LParen"),this.stream.skipWhitespace();let e=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RParen");let t=this.parseBlock({allowDeclarations:!1});return new ee(e,t)}parseForBlock(){this.stream.expect("For"),this.stream.skipWhitespace(),this.stream.expect("LParen"),this.stream.skipWhitespace();let e;this.stream.peek()?.type!=="Semicolon"&&(e=this.parseForClause()),this.stream.skipWhitespace(),this.stream.expect("Semicolon"),this.stream.skipWhitespace();let t;this.stream.peek()?.type!=="Semicolon"&&(t=this.parseExpression()),this.stream.skipWhitespace(),this.stream.expect("Semicolon"),this.stream.skipWhitespace();let r;this.stream.peek()?.type!=="RParen"&&(r=this.parseForClause()),this.stream.skipWhitespace(),this.stream.expect("RParen");let s=this.parseBlock({allowDeclarations:!1});return new te(e,t,r,s)}parseForClause(){return this.isAssignmentStart()?this.parseAssignmentExpression():this.parseExpression()}parseAssignmentExpression(){let e=this.parseAssignmentTarget();this.stream.skipWhitespace();let t=this.parseAssignmentOperator();this.stream.skipWhitespace();let r=this.parseExpression();return new W(e,r,t)}parseAssignmentOperator(){let e=this.stream.peek();if(!e)throw new Error("Expected assignment operator");if(e.type==="Equals")return this.stream.next(),"=";if(e.type==="Plus"||e.type==="Minus"||e.type==="Star"||e.type==="Slash"){let t=this.stream.next();return this.stream.expect("Equals"),t.type==="Plus"?"+=":t.type==="Minus"?"-=":t.type==="Star"?"*=":"/="}throw new Error("Expected assignment operator")}parseTryBlock(){this.stream.expect("Try");let e=this.parseBlock({allowDeclarations:!1});this.stream.skipWhitespace(),this.stream.expect("Catch"),this.stream.skipWhitespace(),this.stream.expect("LParen"),this.stream.skipWhitespace();let t=this.stream.expect("Identifier").value;this.stream.skipWhitespace(),this.stream.expect("RParen");let r=this.parseBlock({allowDeclarations:!1});return new re(e,t,r)}parseConstructBlock(){this.stream.expect("Construct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Construct",e}parseDestructBlock(){this.stream.expect("Destruct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Destruct",e}parseQueryExpression(){this.stream.expect("Question");let e="self";this.stream.peek()?.type==="Greater"?(this.stream.next(),e="descendant"):this.stream.peek()?.type==="Less"&&(this.stream.next(),e="ancestor"),this.stream.skipWhitespace(),this.stream.expect("LParen");let t=this.readSelectorUntil("RParen");return new oe(e,t)}parseFunctionDeclaration(){let e=!1,t=this.stream.peekNonWhitespace(0);this.isAsyncToken(t)&&(this.stream.next(),this.stream.skipWhitespace(),e=!0);let r=this.stream.expect("Identifier").value;this.stream.skipWhitespace();let s=this.parseFunctionParams();this.stream.skipWhitespace();let i=this.parseFunctionBlockWithAwait(e);return new M(r,s,i,e)}parseReturnStatement(){if(this.stream.expect("Return"),this.stream.skipWhitespace(),this.stream.peek()?.type==="Semicolon")return this.stream.next(),new D;let e=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new D(e)}parseAssertStatement(){this.stream.expect("Assert"),this.stream.skipWhitespace();let e=this.parseExpression();return this.consumeStatementTerminator(),new J(e)}parseArrowFunctionExpression(e=!1){let t=this.parseFunctionParams();if(this.stream.skipWhitespace(),this.stream.expect("Arrow"),this.stream.skipWhitespace(),this.stream.peek()?.type==="LBrace"){let s=this.parseFunctionBlockWithAwait(e);return new P(t,s,e)}let r=this.parseArrowExpressionBody(e);return new P(t,r,e)}parseFunctionParams(){this.stream.expect("LParen");let e=[],t=!1;for(;;){this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Unterminated function parameters");if(r.type==="RParen"){this.stream.next();break}if(r.type==="Ellipsis"){if(t)throw new Error("Function parameters can only include one rest parameter");this.stream.next(),this.stream.skipWhitespace();let n=this.stream.expect("Identifier").value;if(e.push({name:n,rest:!0}),t=!0,this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma")throw new Error("Rest parameter must be last in function parameters");this.stream.expect("RParen");break}let s=this.stream.expect("Identifier").value;this.stream.skipWhitespace();let i;if(this.stream.peek()?.type==="Equals"&&(this.stream.next(),this.stream.skipWhitespace(),i=this.parseExpression()),e.push(i?{name:s,defaultValue:i}:{name:s}),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in function parameters")}return e}readSelectorUntil(e){let t="",r=!1;for(;;){let s=this.stream.peek();if(!s)throw new Error("Unterminated selector");if(s.type===e){this.stream.next();break}if(s.type==="Whitespace"){this.stream.next(),r&&t[t.length-1]!==" "&&(t+=" ");continue}r=!0,t+=this.stream.next().value}return t.trim()}parseIdentifierPath(){let e=this.stream.expect("Identifier").value;for(;this.stream.peek()?.type==="Dot";){this.stream.next();let t=this.stream.expect("Identifier").value;e=`${e}.${t}`}return e}};var le=class o{static activeEngines=new WeakMap;scopes=new WeakMap;bindBindings=new WeakMap;ifBindings=new WeakMap;showBindings=new WeakMap;htmlBindings=new WeakMap;getBindings=new WeakMap;eachBindings=new WeakMap;lifecycleBindings=new WeakMap;behaviorRegistry=[];behaviorBindings=new WeakMap;behaviorListeners=new WeakMap;behaviorId=0;codeCache=new Map;behaviorCache=new Map;observer;attributeHandlers=[];globals={};importantFlags=new WeakMap;inlineDeclarations=new WeakMap;flagHandlers=new Map;behaviorModifiers=new Map;pendingAdded=new Set;pendingRemoved=new Set;pendingUpdated=new Set;observerFlush;ignoredAdded=new WeakMap;diagnostics;logger;pendingUses=[];pendingAutoBindToScope=[];scopeWatchers=new WeakMap;executionStack=[];constructor(e={}){this.diagnostics=e.diagnostics??!1,this.logger=e.logger??console,this.registerGlobal("console",console),this.registerFlag("important"),this.registerFlag("trusted"),this.registerFlag("debounce",{onEventBind:({args:t})=>({debounceMs:typeof t=="number"?t:200})}),this.registerFlag("prevent",{onEventBefore:({event:t})=>{t?.preventDefault()}}),this.registerFlag("stop",{onEventBefore:({event:t})=>{t?.stopPropagation()}}),this.registerFlag("self",{onEventBefore:({event:t,element:r})=>{let s=t?.target;return s instanceof Node?s===r:!1}}),this.registerFlag("outside",{onEventBind:({element:t})=>({listenerTarget:t.ownerDocument}),onEventBefore:({event:t,element:r})=>{let s=t?.target;return s instanceof Node?!r.contains(s):!1}}),this.registerFlag("once",{onEventBind:()=>({options:{once:!0}})}),this.registerFlag("passive",{onEventBind:()=>({options:{passive:!0}})}),this.registerFlag("capture",{onEventBind:()=>({options:{capture:!0}})}),this.registerFlag("shift",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"shift")}),this.registerFlag("ctrl",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"ctrl")}),this.registerFlag("control",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"ctrl")}),this.registerFlag("alt",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"alt")}),this.registerFlag("meta",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"meta")}),this.registerFlag("enter",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"enter")}),this.registerFlag("escape",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"escape")}),this.registerFlag("esc",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"escape")}),this.registerFlag("tab",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"tab")}),this.registerFlag("space",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"space")}),this.registerFlag("up",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"arrowup")}),this.registerFlag("down",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"arrowdown")}),this.registerFlag("left",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"arrowleft")}),this.registerFlag("right",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"arrowright")}),this.registerFlag("arrowup",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"arrowup")}),this.registerFlag("arrowdown",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"arrowdown")}),this.registerFlag("arrowleft",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"arrowleft")}),this.registerFlag("arrowright",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"arrowright")}),this.registerFlag("delete",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"delete")}),this.registerFlag("backspace",{onEventBefore:({event:t})=>this.matchesKeyFlag(t,"backspace")}),this.registerGlobal("list",{async map(t,r){if(!Array.isArray(t)||typeof r!="function")return[];let s=[];for(let i=0;i<t.length;i+=1)s.push(await r(t[i],i));return s},async filter(t,r){if(!Array.isArray(t)||typeof r!="function")return[];let s=[];for(let i=0;i<t.length;i+=1)await r(t[i],i)&&s.push(t[i]);return s},async reduce(t,r,s){if(!Array.isArray(t)||typeof r!="function")return s;let i=arguments.length>2,n=i?s:t[0],a=i?0:1;for(let c=a;c<t.length;c+=1)n=await r(n,t[c],c);return n}}),this.registerDefaultAttributeHandlers(),this.registerFlag("int",{transformValue:(t,r)=>this.coerceInt(r)}),this.registerFlag("float",{transformValue:(t,r)=>this.coerceFloat(r)})}async mount(e){let t=e.ownerDocument,r=o.activeEngines.get(t);r&&r!==this&&r.disconnectObserver(),o.activeEngines.set(t,this);let s=[e,...Array.from(e.querySelectorAll("*"))];for(let i of s){if(!this.hasVsnAttributes(i))continue;let n=this.findParentScope(i);this.getScope(i,n),this.attachAttributes(i),this.runConstruct(i)}await this.applyBehaviors(e),this.attachObserver(e)}unmount(e){this.runDestruct(e),this.disconnectObserver()}registerBehaviors(e){let t=new K(e,{customFlags:new Set(this.flagHandlers.keys()),behaviorFlags:new Set(this.behaviorModifiers.keys())}).parseProgram();for(let r of t.uses){if(r.flags?.wait){this.pendingUses.push(this.waitForUseGlobal(r));continue}let s=this.resolveGlobalPath(r.name);if(s===void 0){console.warn(`vsn: global '${r.name}' not found`);continue}this.registerGlobal(r.alias,s)}for(let r of t.behaviors)this.collectBehavior(r)}registerGlobal(e,t){this.globals[e]=t}registerGlobals(e){Object.assign(this.globals,e)}registerFlag(e,t={}){this.flagHandlers.set(e,t)}registerBehaviorModifier(e,t={}){if(new Set(["important","trusted","debounce"]).has(e))throw new Error(`Behavior modifier '${e}' is reserved`);this.behaviorModifiers.set(e,t)}getRegistryStats(){return{behaviorCount:this.behaviorRegistry.length,behaviorCacheSize:this.behaviorCache.size}}registerAttributeHandler(e){this.attributeHandlers.push(e)}resolveGlobalPath(e){let t=e.split("."),r=t[0];if(!r)return;let s=globalThis[r];for(let i=1;i<t.length;i+=1){let n=t[i];if(!n)return;s=s?.[n]}return s}async waitForUses(){for(;this.pendingUses.length>0;){let e=this.pendingUses;this.pendingUses=[],await Promise.all(e)}}waitForUseGlobal(e){let t=e.flagArgs?.wait??{},r=t.timeoutMs??1e4,s=t.intervalMs??100,i=1e3,n=this.resolveGlobalPath(e.name);return n!==void 0?(this.registerGlobal(e.alias,n),Promise.resolve()):r<=0?(this.emitUseError(e.name,new Error(`vsn: global '${e.name}' not found`)),Promise.resolve()):new Promise(a=>{let c=0,p=s,l=()=>{let h=this.resolveGlobalPath(e.name);if(h!==void 0){this.registerGlobal(e.alias,h),a();return}if(c>=r){this.emitUseError(e.name,new Error(`vsn: global '${e.name}' not found`)),a();return}let u=Math.min(p,r-c);setTimeout(()=>{c+=u,p=Math.min(p*2,i),l()},u)};l()})}getScope(e,t){let r=this.scopes.get(e);if(r)return r;let s=new U(t??this.findParentScope(e));return this.scopes.set(e,s),s}evaluate(e){let t=this.getScope(e),r=this.bindBindings.get(e);r&&(r.direction==="from"||r.direction==="both")&&Q(e,r.expr,t);let s=this.ifBindings.get(e);s&&e instanceof HTMLElement&&ue(e,s,t);let i=this.showBindings.get(e);i&&e instanceof HTMLElement&&fe(e,i,t);let n=this.htmlBindings.get(e);n&&e instanceof HTMLElement&&(T(e,n.expr,t,n.trusted),n.trusted&&this.handleTrustedHtml(e))}attachObserver(e){this.observer||(this.observerFlush=B(()=>this.flushObserverQueue(),10),this.observer=new MutationObserver(t=>{for(let r of t){r.type==="attributes"&&r.target instanceof Element&&this.pendingUpdated.add(r.target);for(let s of Array.from(r.addedNodes))if(s&&s.nodeType===1){let i=s;if(this.ignoredAdded.has(i)){this.ignoredAdded.delete(i);continue}this.pendingAdded.add(i)}for(let s of Array.from(r.removedNodes))s&&s.nodeType===1&&this.pendingRemoved.add(s)}this.observerFlush?.()}),this.observer.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}))}disconnectObserver(){this.observer?.disconnect(),this.observer=void 0,this.pendingAdded.clear(),this.pendingRemoved.clear(),this.pendingUpdated.clear()}flushObserverQueue(){let e=Array.from(this.pendingRemoved);this.pendingRemoved.clear();for(let s of e)this.handleRemovedNode(s);let t=Array.from(this.pendingUpdated);this.pendingUpdated.clear();for(let s of t)this.handleUpdatedNode(s);let r=Array.from(this.pendingAdded);this.pendingAdded.clear();for(let s of r)this.handleAddedNode(s)}handleRemovedNode(e){this.lifecycleBindings.has(e)&&this.runDestruct(e),this.behaviorBindings.has(e)&&this.runBehaviorDestruct(e),this.cleanupScopeWatchers(e),this.cleanupBehaviorListeners(e);for(let t of Array.from(e.querySelectorAll("*")))this.lifecycleBindings.has(t)&&this.runDestruct(t),this.behaviorBindings.has(t)&&this.runBehaviorDestruct(t),this.cleanupScopeWatchers(t),this.cleanupBehaviorListeners(t)}handleAddedNode(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let r of t){if(!this.hasVsnAttributes(r))continue;let s=this.findParentScope(r);this.getScope(r,s),this.attachAttributes(r),this.runConstruct(r)}this.applyBehaviors(e)}handleUpdatedNode(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let r of t)this.reapplyBehaviorsForElement(r)}async applyBehaviors(e){if(await this.waitForUses(),this.behaviorRegistry.length>0){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let r of t)await this.reapplyBehaviorsForElement(r)}this.flushAutoBindQueue()}async reapplyBehaviorsForElement(e){if(this.behaviorRegistry.length===0)return;let t=this.behaviorBindings.get(e)??new Set,r=this.getScope(e),s=this.behaviorRegistry.filter(n=>e.matches(n.selector)).sort((n,a)=>n.specificity!==a.specificity?n.specificity-a.specificity:n.order-a.order);for(let n of s)t.has(n.id)||await this.applyBehaviorForElement(n,e,r,t);let i=new Set(s.map(n=>n.id));for(let n of this.behaviorRegistry)t.has(n.id)&&!i.has(n.id)&&this.unbindBehaviorForElement(n,e,r,t);this.behaviorBindings.set(e,t)}async applyBehaviorForElement(e,t,r,s){s.add(e.id);let i=this.getBehaviorRootScope(t,e);this.applyBehaviorFunctions(t,r,e.functions,i),await this.applyBehaviorDeclarations(t,r,e.declarations,i),await this.applyBehaviorModifierHook("onBind",e,t,r,i),e.construct&&await this.safeExecuteBlock(e.construct,r,t,i),await this.applyBehaviorModifierHook("onConstruct",e,t,r,i);for(let n of e.onBlocks)this.attachBehaviorOnHandler(t,n.event,n.body,n.flags,n.flagArgs,n.args,e.id,i);this.logDiagnostic("bind",t,e)}unbindBehaviorForElement(e,t,r,s){s.delete(e.id);let i=this.getBehaviorRootScope(t,e);e.destruct&&this.safeExecuteBlock(e.destruct,r,t,i),this.applyBehaviorModifierHook("onDestruct",e,t,r,i);let n=this.behaviorListeners.get(t),a=n?.get(e.id);if(a){for(let c of a)c.target.removeEventListener(c.event,c.handler,c.options);n?.delete(e.id)}this.applyBehaviorModifierHook("onUnbind",e,t,r,i),this.logDiagnostic("unbind",t,e)}runBehaviorDestruct(e){let t=this.behaviorBindings.get(e);if(!t)return;let r=this.getScope(e);for(let s of this.behaviorRegistry){if(!t.has(s.id)||!s.destruct&&!this.behaviorHasModifierHooks(s))continue;let i=this.getBehaviorRootScope(e,s);s.destruct&&this.safeExecuteBlock(s.destruct,r,e,i),this.applyBehaviorModifierHook("onDestruct",s,e,r,i),this.applyBehaviorModifierHook("onUnbind",s,e,r,i)}}attachAttributes(e){let t=this.getScope(e);for(let r of e.getAttributeNames()){if(!r.startsWith("vsn-"))continue;let s=e.getAttribute(r)??"";for(let i of this.attributeHandlers){if(!i.match(r))continue;if(i.handle(e,r,s,t)!==!1)break}}}setLifecycle(e,t){let r=this.lifecycleBindings.get(e)??{};this.lifecycleBindings.set(e,{...r,...t})}runConstruct(e){let t=this.lifecycleBindings.get(e);if(!t?.construct)return;let r=this.getScope(e);this.safeExecute(t.construct,r,e)}runDestruct(e){let t=this.lifecycleBindings.get(e);if(!t?.destruct)return;let r=this.getScope(e);this.safeExecute(t.destruct,r,e)}parseEachExpression(e){let[t,r]=e.split(/\s+as\s+/);if(!t||!r)return null;let s=t.trim(),i=r.split(",").map(c=>c.trim()).filter(Boolean);if(!s||i.length===0)return null;let n=i[0]??"",a=i[1];return{listExpr:s,itemName:n,...a?{indexName:a}:{}}}renderEach(e){let t=this.eachBindings.get(e);if(!t||!(e instanceof HTMLTemplateElement))return;let r=e.parentElement;if(!r)return;for(let a of t.rendered)this.handleRemovedNode(a),a.parentNode&&a.parentNode.removeChild(a);t.rendered=[];let s=this.getScope(e),i=s.get(t.listExpr);if(!Array.isArray(i))return;let n=[];i.forEach((a,c)=>{let p=e.content.cloneNode(!0),l=Array.from(p.children),h=new U(s);h.isEachItem=!0,h.setPath(`self.${t.itemName}`,a),t.indexName&&h.setPath(`self.${t.indexName}`,c);for(let u of l)this.getScope(u,h);r.insertBefore(p,e);for(let u of l){this.ignoredAdded.set(u,!0),n.push(u),this.handleAddedNode(u),this.evaluate(u);for(let m of Array.from(u.querySelectorAll("*")))this.evaluate(m)}}),t.rendered=n}attachBindInputHandler(e,t){if(!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement))return;let r=()=>{let s=this.getScope(e);G(e,t,s)};e.addEventListener("input",r),e.addEventListener("change",r)}parseBindDirection(e){return e.includes(":from")?"from":e.includes(":to")?"to":"auto"}resolveBindConfig(e,t,r,s){return s!=="auto"?{direction:s,seedFromScope:!1,syncToScope:s==="to"||s==="both",deferToScope:!1}:this.isInEachScope(r)?{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!1}:this.isFormControl(e)?this.hasScopeValue(r,t)?{direction:"both",seedFromScope:!0,syncToScope:!1,deferToScope:!1}:{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!0}:this.hasScopeValue(r,t)?{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!1}:this.hasElementValue(e)?{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!0}:{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!1}}isFormControl(e){return e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement}hasScopeValue(e,t){let r=t.trim();if(!r)return!1;let s=e.get(r);return s!=null}hasElementValue(e){return e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement?e.value.length>0:(e.textContent??"").trim().length>0}coerceInt(e){if(e==null||e==="")return e;let t=typeof e=="number"?e:Number.parseInt(String(e),10);return Number.isNaN(t)?e:t}coerceFloat(e){if(e==null||e==="")return e;let t=typeof e=="number"?e:Number.parseFloat(String(e));return Number.isNaN(t)?e:t}isInEachScope(e){let t=e;for(;t;){if(t.isEachItem)return!0;t=t.parent}return!1}flushAutoBindQueue(){if(this.pendingAutoBindToScope.length===0)return;let e=this.pendingAutoBindToScope;this.pendingAutoBindToScope=[];for(let t of e)t.element.isConnected&&(this.hasScopeValue(t.scope,t.expr)||this.hasElementValue(t.element)&&G(t.element,t.expr,t.scope))}hasVsnAttributes(e){return e.getAttributeNames().some(t=>t.startsWith("vsn-"))}markInlineDeclaration(e,t){let r=this.inlineDeclarations.get(e)??new Set;r.add(t),this.inlineDeclarations.set(e,r)}isInlineDeclaration(e,t){let r=this.inlineDeclarations.get(e);return r?r.has(t):!1}findParentScope(e){let t=e.parentElement;for(;t;){let r=this.scopes.get(t);if(r)return r;t=t.parentElement}}watch(e,t,r,s){let i=t.trim();if(!i)return;let n=i.split(".")[0];if(!n)return;let a=e;for(;a&&!a.hasKey(n);)a=a.parent;if(a){a.on(i,r),s&&this.trackScopeWatcher(s,a,"path",r,i);return}let c=e;for(;c;)c.on(i,r),s&&this.trackScopeWatcher(s,c,"path",r,i),c=c.parent}watchWithDebounce(e,t,r,s,i){let n=s?B(r,s):r;this.watch(e,t,n,i)}watchAllScopes(e,t,r,s){let i=r?B(t,r):t,n=e;for(;n;)n.onAny(i),s&&this.trackScopeWatcher(s,n,"any",i),n=n.parent}trackScopeWatcher(e,t,r,s,i){let n=this.scopeWatchers.get(e)??[];n.push({scope:t,kind:r,handler:s,...i?{key:i}:{}}),this.scopeWatchers.set(e,n)}cleanupScopeWatchers(e){let t=this.scopeWatchers.get(e);if(t){for(let r of t){if(r.kind==="any"){r.scope.offAny(r.handler);continue}r.key&&r.scope.off(r.key,r.handler)}this.scopeWatchers.delete(e)}}cleanupBehaviorListeners(e){let t=this.behaviorListeners.get(e);if(t){for(let r of t.values())for(let s of r)s.target.removeEventListener(s.event,s.handler,s.options);t.clear(),this.behaviorListeners.delete(e),this.behaviorBindings.delete(e)}}parseOnAttribute(e,t){if(!e.startsWith("vsn-on:"))return null;let r=e.slice(7),[s,...i]=r.split("!");if(!s)return null;if(s.includes("."))throw new Error("vsn:on does not support dot modifiers; use !flags instead");let{flagMap:n,flagArgs:a}=this.parseInlineFlags(i);return{event:s,code:t,flags:n,flagArgs:a}}parseInlineFlags(e){let t={},r={};for(let s of e){let i=s.trim();if(!i)continue;let n=i.match(/^([a-zA-Z][\w-]*)(?:\((.+)\))?$/);if(!n)continue;let a=n[1]??"";if(a){if(!this.flagHandlers.has(a))throw new Error(`Unknown flag ${a}`);t[a]=!0,n[2]!==void 0&&(r[a]=this.parseInlineFlagArg(n[2]))}}return{flagMap:t,flagArgs:r}}parseInlineFlagArg(e){let t=e.trim();return t==="true"?!0:t==="false"?!1:/^-?\d+(\.\d+)?$/.test(t)?Number(t):t}describeElement(e){let t=e.tagName.toLowerCase(),r=e.id?`#${e.id}`:"",s=e.classList.length>0?`.${Array.from(e.classList).join(".")}`:"";return`${t}${r}${s}`}logDiagnostic(e,t,r){!this.diagnostics||!this.logger.info||this.logger.info(`vsn:${e}`,{element:this.describeElement(t),selector:r.selector,behaviorId:r.id})}emitError(e,t){let r=this.describeElement(e);this.logger.warn?.("vsn:error",{error:t,selector:r}),e.dispatchEvent(new CustomEvent("vsn:error",{detail:{error:t,selector:r},bubbles:!0}))}emitUseError(e,t){let r=`use:${e}`;this.logger.warn?.("vsn:error",{error:t,selector:r});let s=globalThis.document;s&&typeof s.dispatchEvent=="function"&&s.dispatchEvent(new CustomEvent("vsn:error",{detail:{error:t,selector:r},bubbles:!0}))}attachOnHandler(e,t){let{listenerTarget:r,options:s,debounceMs:i}=this.getEventBindingConfig(e,t.flags,t.flagArgs),n,a=async c=>{if(!e.isConnected){r.removeEventListener(t.event,n,s);return}let p=this.getScope(e);if(this.applyEventFlagBefore(e,p,t.flags,t.flagArgs,c))try{await this.execute(t.code,p,e),this.evaluate(e)}catch(l){this.emitError(e,l)}finally{this.applyEventFlagAfter(e,p,t.flags,t.flagArgs,c)}};n=i?B(a,i):a,r.addEventListener(t.event,n,s)}attachBehaviorOnHandler(e,t,r,s,i,n,a,c){if(t.includes("."))throw new Error("vsn:on does not support dot modifiers; use !flags instead");let{listenerTarget:p,options:l,debounceMs:h}=this.getEventBindingConfig(e,s,i),u=async O=>{let N=this.getScope(e);if(!this.applyEventFlagBefore(e,N,s,i,O))return;let xe=new Map;if(n&&n.length>0){let w=n[0];if(w){xe.set(w,N.getPath(w));let[he]=this.applyEventFlagArgTransforms(e,N,s,i,O);N.setPath(w,he)}}let ke=!1;try{await this.executeBlock(r,N,e,c)}catch(w){ke=!0,this.emitError(e,w)}finally{for(let[w,he]of xe.entries())N.setPath(w,he);this.applyEventFlagAfter(e,N,s,i,O)}ke||this.evaluate(e)},m=h?B(u,h):u;p.addEventListener(t,m,l);let v=this.behaviorListeners.get(e)??new Map,H=v.get(a)??[];H.push({target:p,event:t,handler:m,options:l}),v.set(a,H),this.behaviorListeners.set(e,v)}attachGetHandler(e,t=!1){let r=async()=>{let s=this.getBindings.get(e);if(s)try{await we(e,s,this.getScope(e),i=>{s.trusted&&this.handleTrustedHtml(i)})}catch(i){console.warn("vsn:getError",i),e.dispatchEvent(new CustomEvent("vsn:getError",{detail:{error:i},bubbles:!0}))}};e.addEventListener("click",s=>{s.target===e&&r()}),t&&Promise.resolve().then(r)}getEventBindingConfig(e,t,r){let s=e,i={},n;for(let a of Object.keys(t)){let c=this.flagHandlers.get(a);if(!c?.onEventBind)continue;let p=c.onEventBind({name:a,args:r[a],element:e,scope:this.getScope(e),rootScope:void 0,event:void 0,engine:this});p&&(p.listenerTarget&&(s=p.listenerTarget),p.options&&(i={...i,...p.options}),p.debounceMs!==void 0&&(n=p.debounceMs))}return{listenerTarget:s,...Object.keys(i).length>0?{options:i}:{},...n!==void 0?{debounceMs:n}:{}}}applyEventFlagBefore(e,t,r,s,i){for(let n of Object.keys(r)){let a=this.flagHandlers.get(n);if(!a?.onEventBefore)continue;if(a.onEventBefore({name:n,args:s[n],element:e,scope:t,rootScope:void 0,event:i,engine:this})===!1)return!1}return!0}applyEventFlagAfter(e,t,r,s,i){for(let n of Object.keys(r)){let a=this.flagHandlers.get(n);a?.onEventAfter&&a.onEventAfter({name:n,args:s[n],element:e,scope:t,rootScope:void 0,event:i,engine:this})}}applyEventFlagArgTransforms(e,t,r,s,i){let n=[i];for(let a of Object.keys(r)){let c=this.flagHandlers.get(a);if(!c?.transformEventArgs)continue;let p=c.transformEventArgs({name:a,args:s[a],element:e,scope:t,rootScope:void 0,event:i,engine:this},n);Array.isArray(p)&&(n=p)}return n}matchesKeyFlag(e,t){if(!(e instanceof KeyboardEvent))return!1;let r={shift:e.shiftKey,ctrl:e.ctrlKey,alt:e.altKey,meta:e.metaKey};if(t in r)return r[t]??!1;let s={escape:"escape",esc:"escape",enter:"enter",tab:"tab",space:"space",spacebar:"space",up:"arrowup",down:"arrowdown",left:"arrowleft",right:"arrowright",arrowup:"arrowup",arrowdown:"arrowdown",arrowleft:"arrowleft",arrowright:"arrowright",delete:"delete",backspace:"backspace"},i=e.key?.toLowerCase()??"";i===" "&&(i="space");let n=s[t]??t;return i===n}async withExecutionElement(e,t){if(!e){await t();return}this.executionStack.push(e);try{await t()}finally{this.executionStack.pop()}}getCurrentElement(){return this.executionStack[this.executionStack.length-1]}async execute(e,t,r,s){let i=this.codeCache.get(e);i||(i=K.parseInline(e),this.codeCache.set(e,i)),await this.withExecutionElement(r,async()=>{let n={scope:t,rootScope:s,globals:this.globals,...r?{element:r}:{}};await i.evaluate(n)})}async executeBlock(e,t,r,s){await this.withExecutionElement(r,async()=>{let i={scope:t,rootScope:s,globals:this.globals,...r?{element:r}:{}};await e.evaluate(i)})}async safeExecute(e,t,r,s){try{await this.execute(e,t,r,s)}catch(i){r&&this.emitError(r,i)}}async safeExecuteBlock(e,t,r,s){try{await this.executeBlock(e,t,r,s)}catch(i){r&&this.emitError(r,i)}}collectBehavior(e,t,r){let s=t?`${t} ${e.selector.selectorText}`:e.selector.selectorText,i=r??t??e.selector.selectorText,n=this.getCachedBehavior(e);this.behaviorRegistry.push({id:this.behaviorId+=1,selector:s,rootSelector:i,specificity:this.computeSpecificity(s),order:this.behaviorRegistry.length,flags:e.flags??{},flagArgs:e.flagArgs??{},...n}),this.collectNestedBehaviors(e.body,s,i)}collectNestedBehaviors(e,t,r){for(let s of e.statements){if(s instanceof C){this.collectBehavior(s,t,r);continue}if(s instanceof F){this.collectNestedBehaviors(s.body,t,r);continue}s instanceof E&&this.collectNestedBehaviors(s,t,r)}}computeSpecificity(e){let t=e.match(/#[\w-]+/g)?.length??0,r=e.match(/\.[\w-]+/g)?.length??0,s=e.match(/\[[^\]]+\]/g)?.length??0,i=e.match(/:[\w-]+/g)?.length??0,n=e.match(/(^|[\s>+~])([a-zA-Z][\w-]*)/g)?.length??0;return t*100+(r+s+i)*10+n}getBehaviorRootScope(e,t){let r=e.closest(t.rootSelector)??e;return this.getScope(r)}getImportantKey(e){if(e.target instanceof g)return`state:${e.target.name}`;if(e.target instanceof k)return`${e.target.kind}:${e.target.name}`}isImportant(e,t){let r=this.importantFlags.get(e);return r?r.has(t):!1}markImportant(e,t){let r=this.importantFlags.get(e)??new Set;r.add(t),this.importantFlags.set(e,r)}extractLifecycle(e){let t,r;for(let s of e.statements)s instanceof E&&(s.type==="Construct"?t=s:s.type==="Destruct"&&(r=s));return{...t?{construct:t}:{},...r?{destruct:r}:{}}}extractOnBlocks(e){let t=[];for(let r of e.statements)r instanceof F&&t.push({event:r.eventName,body:r.body,flags:r.flags,flagArgs:r.flagArgs,args:r.args});return t}extractDeclarations(e){let t=[];for(let r of e.statements)r instanceof L&&t.push(r);return t}extractFunctionDeclarations(e){let t=[];for(let r of e.statements){if(r instanceof M){t.push({name:r.name,params:r.params,body:r.body});continue}r instanceof W&&r.target instanceof g&&r.value instanceof P&&t.push({name:r.target.name,params:r.value.params,body:r.value.body})}return t}getCachedBehavior(e){let t=this.hashBehavior(e),r=this.behaviorCache.get(t);if(r)return r;let s=this.extractLifecycle(e.body),i={onBlocks:this.extractOnBlocks(e.body),declarations:this.extractDeclarations(e.body),functions:this.extractFunctionDeclarations(e.body),...s};return this.behaviorCache.set(t,i),i}hashBehavior(e){let t=this.normalizeNode(e),r=JSON.stringify(t);return this.hashString(r)}normalizeNode(e){if(!e||typeof e!="object")return e;let t=e.type??"Unknown";return t==="Behavior"?{type:t,selector:e.selector?.selectorText??"",flags:e.flags??{},flagArgs:e.flagArgs??{},body:this.normalizeNode(e.body)}:t==="Selector"?{type:t,selectorText:e.selectorText??""}:t==="Block"||t==="Construct"||t==="Destruct"?{type:t,statements:Array.isArray(e.statements)?e.statements.map(r=>this.normalizeNode(r)):[]}:t==="OnBlock"?{type:t,eventName:e.eventName??"",args:Array.isArray(e.args)?e.args:[],flags:e.flags??{},flagArgs:e.flagArgs??{},body:this.normalizeNode(e.body)}:t==="Declaration"?{type:t,target:this.normalizeNode(e.target),operator:e.operator??"",value:this.normalizeNode(e.value),flags:e.flags??{},flagArgs:e.flagArgs??{}}:t==="Assignment"?{type:t,target:this.normalizeNode(e.target),value:this.normalizeNode(e.value)}:t==="FunctionDeclaration"?{type:t,name:e.name??"",params:Array.isArray(e.params)?e.params.map(r=>({name:r?.name??"",rest:!!r?.rest,defaultValue:this.normalizeNode(r?.defaultValue??null)})):[],body:this.normalizeNode(e.body),isAsync:!!e.isAsync}:t==="FunctionExpression"?{type:t,params:Array.isArray(e.params)?e.params.map(r=>({name:r?.name??"",rest:!!r?.rest,defaultValue:this.normalizeNode(r?.defaultValue??null)})):[],body:this.normalizeNode(e.body),isAsync:!!e.isAsync}:t==="Return"?{type:t,value:this.normalizeNode(e.value??null)}:t==="Assert"?{type:t,test:this.normalizeNode(e.test)}:t==="If"?{type:t,test:this.normalizeNode(e.test),consequent:this.normalizeNode(e.consequent),alternate:this.normalizeNode(e.alternate??null)}:t==="While"?{type:t,test:this.normalizeNode(e.test),body:this.normalizeNode(e.body)}:t==="For"?{type:t,init:this.normalizeNode(e.init??null),test:this.normalizeNode(e.test??null),update:this.normalizeNode(e.update??null),body:this.normalizeNode(e.body)}:t==="Try"?{type:t,errorName:e.errorName??"",body:this.normalizeNode(e.body),handler:this.normalizeNode(e.handler)}:t==="Identifier"?{type:t,name:e.name??""}:t==="Literal"?{type:t,value:e.value}:t==="TemplateExpression"?{type:t,parts:Array.isArray(e.parts)?e.parts.map(r=>this.normalizeNode(r)):[]}:t==="UnaryExpression"?{type:t,operator:e.operator??"",argument:this.normalizeNode(e.argument)}:t==="BinaryExpression"?{type:t,operator:e.operator??"",left:this.normalizeNode(e.left),right:this.normalizeNode(e.right)}:t==="TernaryExpression"?{type:t,test:this.normalizeNode(e.test),consequent:this.normalizeNode(e.consequent),alternate:this.normalizeNode(e.alternate)}:t==="MemberExpression"?{type:t,target:this.normalizeNode(e.target),property:e.property??"",optional:!!e.optional}:t==="CallExpression"?{type:t,callee:this.normalizeNode(e.callee),args:Array.isArray(e.args)?e.args.map(r=>this.normalizeNode(r)):[]}:t==="AwaitExpression"?{type:t,argument:this.normalizeNode(e.argument)}:t==="Directive"?{type:t,kind:e.kind??"",name:e.name??""}:t==="Query"?{type:t,direction:e.direction??"",selector:e.selector??""}:t==="ArrayExpression"?{type:t,elements:Array.isArray(e.elements)?e.elements.map(r=>this.normalizeNode(r)):[]}:t==="ObjectExpression"?{type:t,entries:Array.isArray(e.entries)?e.entries.map(r=>({key:r?.key??"",computed:!!r?.computed,keyExpr:r?.keyExpr?this.normalizeNode(r.keyExpr):null,value:this.normalizeNode(r?.value)})):[]}:t==="IndexExpression"?{type:t,target:this.normalizeNode(e.target),index:this.normalizeNode(e.index)}:{type:t}}hashString(e){let t=5381;for(let r=0;r<e.length;r+=1)t=(t<<5)+t+e.charCodeAt(r),t|=0;return(t>>>0).toString(16)}applyBehaviorFunctions(e,t,r,s){for(let i of r)this.applyBehaviorFunction(e,t,i,s)}applyBehaviorFunction(e,t,r,s){let i=t.getPath(r.name);if(i!==void 0&&typeof i!="function")throw new Error(`Cannot override non-function '${r.name}' with a function`);let n=async(...a)=>{let c=t.createChild?t.createChild():t,p={scope:c,rootScope:s??c,globals:this.globals,element:e,returnValue:void 0,returning:!1},l=new Map;return await this.applyFunctionParams(c,r.params,l,p,a),await r.body.evaluate(p),c===t&&this.restoreFunctionParams(c,r.params,l),p.returnValue};t.setPath(r.name,n)}async applyFunctionParams(e,t,r,s,i){let n=0;for(let a of t){let c=a.name;if(!c)continue;if(r.set(c,e.getPath(c)),a.rest){e.setPath(`self.${c}`,i.slice(n)),n=i.length;continue}let p=i[n];p===void 0&&a.defaultValue&&(p=await a.defaultValue.evaluate(s)),e.setPath(`self.${c}`,p),n+=1}}restoreFunctionParams(e,t,r){for(let s of t){let i=s.name;i&&e.setPath(i,r.get(i))}}async applyBehaviorDeclarations(e,t,r,s){for(let i of r)await this.applyBehaviorDeclaration(e,t,i,s)}async applyBehaviorDeclaration(e,t,r,s){let i={scope:t,rootScope:s,element:e},n=r.operator,a=r.flags.debounce?r.flagArgs.debounce??200:void 0,c=m=>this.applyCustomFlagTransforms(m,e,t,r),p=this.getImportantKey(r);if(!r.flags.important&&p&&this.isImportant(e,p)||p&&this.isInlineDeclaration(e,p))return;if(this.applyCustomFlags(e,t,r),r.target instanceof g){let m=await r.value.evaluate(i),v=this.applyCustomFlagTransforms(m,e,t,r);t.setPath(r.target.name,v),r.flags.important&&p&&this.markImportant(e,p);return}if(!(r.target instanceof k))return;let l=r.target,h=r.value instanceof g?r.value.name:void 0;if(n===":>"){h&&this.applyDirectiveToScope(e,l,h,t,a,s,c),r.flags.important&&p&&this.markImportant(e,p);return}if(n===":="&&h&&this.applyDirectiveToScope(e,l,h,t,a,s,c),!h){let m=await r.value.evaluate(i),v=this.applyCustomFlagTransforms(m,e,t,r);this.setDirectiveValue(e,l,v,r.flags.trusted),(n===":<"||n===":=")&&this.applyDirectiveFromExpression(e,l,r.value,t,r.flags.trusted,a,s),r.flags.important&&p&&this.markImportant(e,p);return}let u=n===":<"||n===":=";this.applyDirectiveFromScope(e,l,h,t,r.flags.trusted,a,u,s),r.flags.important&&p&&this.markImportant(e,p)}applyCustomFlags(e,t,r){if(this.flagHandlers.size!==0)for(let[s,i]of this.flagHandlers)r.flags[s]&&i.onApply?.({name:s,args:r.flagArgs[s],element:e,scope:t,declaration:r})}applyCustomFlagTransforms(e,t,r,s){if(this.flagHandlers.size===0)return e;let i=e;for(let[n,a]of this.flagHandlers)!s.flags[n]||!a.transformValue||(i=a.transformValue({name:n,args:s.flagArgs[n],element:t,scope:r,declaration:s},i));return i}async applyBehaviorModifierHook(e,t,r,s,i){if(this.behaviorModifiers.size!==0)for(let[n,a]of this.behaviorModifiers){if(!t.flags?.[n])continue;let c=a[e];c&&await c({name:n,args:t.flagArgs?.[n],element:r,scope:s,rootScope:i,behavior:t,engine:this})}}behaviorHasModifierHooks(e){if(this.behaviorModifiers.size===0)return!1;let t=e.flags??{};for(let r of Object.keys(t))if(t[r]&&this.behaviorModifiers.has(r))return!0;return!1}applyDirectiveFromScope(e,t,r,s,i,n,a=!0,c){if(t.kind==="attr"&&t.name==="html"&&e instanceof HTMLElement){let l=()=>{let h=r.startsWith("root.")&&c,u=h?c:s,m=h?`self.${r.slice(5)}`:r;T(e,m,u,!!i)};if(l(),i&&this.handleTrustedHtml(e),a){let h=r.startsWith("root.")&&c,u=h?c:s,m=h?r.slice(5):r;this.watchWithDebounce(u,m,l,n,e)}return}let p=()=>{let l=r.startsWith("root.")&&c,h=l?c:s,u=l?`self.${r.slice(5)}`:r,m=h.get(u);m!=null&&this.setDirectiveValue(e,t,m,i)};if(p(),a){let l=r.startsWith("root.")&&c,h=l?c:s,u=l?r.slice(5):r;this.watchWithDebounce(h,u,p,n,e)}}applyDirectiveFromExpression(e,t,r,s,i,n,a){let c=async()=>{let p={scope:s,rootScope:a,element:e},l=await r.evaluate(p);this.setDirectiveValue(e,t,l,i)};c(),this.watchAllScopes(s,()=>{c()},n,e)}applyDirectiveToScope(e,t,r,s,i,n,a){let c=r.startsWith("root.")&&n,p=c?n:s,l=c?`self.${r.slice(5)}`:r;if(t.kind==="attr"&&t.name==="value"){this.applyValueBindingToScope(e,l,i,p,a);return}if(t.kind==="attr"&&t.name==="checked"){this.applyCheckedBindingToScope(e,l,i,p,a);return}let h=this.getDirectiveValue(e,t);if(h!=null){let u=a?a(h):h;p.set(l,u)}}applyCheckedBindingToScope(e,t,r,s,i){if(!(e instanceof HTMLInputElement))return;let n=()=>{let c=s??this.getScope(e),p=i?i(e.checked):e.checked;c.set(t,p)},a=r?B(n,r):n;a(),e.addEventListener("change",a),e.addEventListener("input",a)}applyValueBindingToScope(e,t,r,s,i){if(!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement))return;let n=()=>{let c=s??this.getScope(e),p=e.value,l=i?i(p):p;c.set(t,l)},a=r?B(n,r):n;a(),e.addEventListener("input",a),e.addEventListener("change",a)}setDirectiveValue(e,t,r,s){if(t.kind==="attr"&&t.name==="html"&&e instanceof HTMLElement){let i=r==null?"":String(r);e.innerHTML=s?i:i.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,""),s&&this.handleTrustedHtml(e);return}if(t.kind==="attr"){if(t.name==="value"){if(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement){e.value=r==null?"":String(r),e.setAttribute("value",e.value);return}if(e instanceof HTMLSelectElement){e.value=r==null?"":String(r);return}}if(t.name==="checked"&&e instanceof HTMLInputElement){let i=r===!0||r==="true"||r===1||r==="1";e.checked=i,i?e.setAttribute("checked",""):e.removeAttribute("checked");return}e.setAttribute(t.name,r==null?"":String(r));return}t.kind==="style"&&e instanceof HTMLElement&&e.style.setProperty(t.name,r==null?"":String(r))}getDirectiveValue(e,t){if(t.kind==="attr")return t.name==="value"&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)?e.value:t.name==="checked"&&e instanceof HTMLInputElement?e.checked:e.getAttribute(t.name)??void 0;if(t.kind==="style"&&e instanceof HTMLElement)return e.style.getPropertyValue(t.name)??void 0}handleTrustedHtml(e){let t=Array.from(e.querySelectorAll('script[type="text/vsn"]'));if(t.length===0)return;let r=t.map(s=>s.textContent??"").join(`
`);r.trim()&&(this.registerBehaviors(r),this.applyBehaviors(e))}registerDefaultAttributeHandlers(){this.registerAttributeHandler({id:"vsn-bind",match:e=>e.startsWith("vsn-bind"),handle:(e,t,r,s)=>{let i=this.parseBindDirection(t),n=this.resolveBindConfig(e,r,s,i),a=n.direction,c=i==="auto";this.bindBindings.set(e,{expr:r,direction:a,auto:c}),!c&&(a==="to"||a==="both")&&this.markInlineDeclaration(e,`state:${r}`),n.seedFromScope&&Q(e,r,s),n.deferToScope?this.pendingAutoBindToScope.push({element:e,expr:r,scope:s}):n.syncToScope&&G(e,r,s),(a==="to"||a==="both")&&this.attachBindInputHandler(e,r),(a==="from"||a==="both")&&this.watch(s,r,()=>Q(e,r,s),e)}}),this.registerAttributeHandler({id:"vsn-if",match:e=>e==="vsn-if",handle:(e,t,r,s)=>{this.ifBindings.set(e,r),e instanceof HTMLElement&&ue(e,r,s),this.watch(s,r,()=>this.evaluate(e),e)}}),this.registerAttributeHandler({id:"vsn-show",match:e=>e==="vsn-show",handle:(e,t,r,s)=>{this.showBindings.set(e,r),e instanceof HTMLElement&&fe(e,r,s),this.watch(s,r,()=>this.evaluate(e),e)}}),this.registerAttributeHandler({id:"vsn-html",match:e=>e.startsWith("vsn-html"),handle:(e,t,r,s)=>{let i=t.includes("!trusted");this.htmlBindings.set(e,{expr:r,trusted:i}),this.markInlineDeclaration(e,"attr:html"),e instanceof HTMLElement&&(T(e,r,s,i),i&&this.handleTrustedHtml(e)),this.watch(s,r,()=>this.evaluate(e),e)}}),this.registerAttributeHandler({id:"vsn-each",match:e=>e==="vsn-each",handle:(e,t,r,s)=>{let i=this.parseEachExpression(r);i&&(this.eachBindings.set(e,{...i,rendered:[]}),this.renderEach(e),this.watch(s,i.listExpr,()=>this.renderEach(e),e))}}),this.registerAttributeHandler({id:"vsn-get",match:e=>e.startsWith("vsn-get"),handle:(e,t)=>{let r=t.includes("!trusted"),s=t.includes("!load"),i=e.getAttribute(t)??"",n=e.getAttribute("vsn-target")??void 0,a=e.getAttribute("vsn-swap")??"inner",c={url:i,swap:a,trusted:r,...n?{targetSelector:n}:{}};this.getBindings.set(e,c),this.attachGetHandler(e,s)}}),this.registerAttributeHandler({id:"vsn-construct",match:e=>e==="vsn-construct",handle:(e,t,r)=>{this.setLifecycle(e,{construct:r})}}),this.registerAttributeHandler({id:"vsn-destruct",match:e=>e==="vsn-destruct",handle:(e,t,r)=>{this.setLifecycle(e,{destruct:r})}}),this.registerAttributeHandler({id:"vsn-on",match:e=>e.startsWith("vsn-on:"),handle:(e,t,r)=>{let s=this.parseOnAttribute(t,r);s&&this.attachOnHandler(e,s)}})}};var Te="@type",Fe="@id";function ve(o){o.registerBehaviorModifier("microdata",{onBind:({element:e,scope:t,args:r})=>{let s=Se(r),i=Ae(e);if(!i)return;let n=ye(i,s);Oe(t,n,s)}}),o.registerGlobal("microdata",(e,t)=>{let r=Se(ge(e)?e:t),s=Re(o,e);if(!s)return;let i=ye(Ae(s)??s,r);return typeof e=="string"&&!ge(t)?i[e]:i})}var Ct=ve,Ee=globalThis,We=Ee.VSNPlugins??{};We.microdata=o=>ve(o);Ee.VSNPlugins=We;var Be=Ee.VSNEngine;Be instanceof le&&ve(Be);function Se(o){if(!o)return{};if(typeof o=="string")return{key:o};if(ge(o)){let e={};return typeof o.key=="string"&&(e.key=o.key),typeof o.flatten=="boolean"&&(e.flatten=o.flatten),e}return{}}function ge(o){return!!o&&typeof o=="object"&&!Array.isArray(o)}function Re(o,e){return e?e instanceof Element?e:Array.isArray(e)&&e[0]instanceof Element?e[0]:o.getCurrentElement():o.getCurrentElement()}function Ae(o){return o.hasAttribute("itemscope")?o:o.querySelector("[itemscope]")??void 0}function ye(o,e){let t={},r=o.getAttribute("itemtype"),s=o.getAttribute("itemid");return r&&(t[Te]=r),s&&(t[Fe]=s),Pe(o,t,e),t}function Pe(o,e,t){let r=Array.from(o.children);for(let s of r){let i=s.hasAttribute("itemprop"),n=s.hasAttribute("itemscope");if(!(n&&!i)){if(i){let a=(s.getAttribute("itemprop")??"").split(/\s+/).map(p=>p.trim()).filter(Boolean),c=n?ye(s,t):He(s);for(let p of a)Ne(e,p,c);if(t.flatten&&c&&typeof c=="object"&&!Array.isArray(c))for(let[p,l]of Object.entries(c))p.startsWith("@")||Ne(e,p,l);if(n)continue}Pe(s,e,t)}}}function He(o){return o instanceof HTMLMetaElement?o.content??"":o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement||o instanceof HTMLSelectElement?o.value??"":o instanceof HTMLTimeElement?o.dateTime||o.getAttribute("datetime")||"":o instanceof HTMLAnchorElement||o instanceof HTMLLinkElement?o.getAttribute("href")??"":o instanceof HTMLImageElement?o.getAttribute("src")??"":o.hasAttribute("content")?o.getAttribute("content")??"":(o.textContent??"").trim()}function Ne(o,e,t){if(o[e]===void 0){o[e]=t;return}if(Array.isArray(o[e])){o[e].push(t);return}o[e]=[o[e],t]}function Oe(o,e,t){if(t.key){o.setPath?.(t.key,e);return}for(let[r,s]of Object.entries(e)){if(r===Te){o.setPath?.("itemtype",s);continue}if(r===Fe){o.setPath?.("itemid",s);continue}o.setPath?.(r,s)}}export{Ct as default,ve as registerMicrodata};
//# sourceMappingURL=microdata.min.js.map