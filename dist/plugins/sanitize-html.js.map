{"version":3,"sources":["../../src/plugins/sanitize-html.ts"],"sourcesContent":["import type { Engine } from \"../runtime/engine\";\n\ntype SanitizerOptions = {\n  dompurifyConfig?: Record<string, any>;\n  sanitizer?: (html: string) => string;\n};\n\ntype HtmlBinding = { expr: string; trusted: boolean };\ntype TrustedHtmlValue = { __vsnTrustedHtml: true; value: any };\n\nconst TRUSTED_HTML_KEY = \"__vsnTrustedHtml\";\n\nexport function registerSanitizeHtml(engine: Engine, options: SanitizerOptions = {}): void {\n  const htmlBindings = new WeakMap<Element, HtmlBinding>();\n  const trustedElements = new WeakSet<Element>();\n  const sanitizer = resolveSanitizer(options);\n  const handleHtmlBehaviors = (engine as any).handleHtmlBehaviors?.bind(engine);\n\n  engine.registerFlag(\"trusted\", {\n    transformValue: ({ declaration }, value) => {\n      const target = (declaration as any)?.target;\n      if (target?.type === \"Directive\" && target?.name === \"html\") {\n        return { [TRUSTED_HTML_KEY]: true, value } as TrustedHtmlValue;\n      }\n      return value;\n    }\n  });\n\n  patchAttributeHandlers(engine, htmlBindings, trustedElements, sanitizer, handleHtmlBehaviors);\n  patchDirectiveSetter(engine, trustedElements, sanitizer, handleHtmlBehaviors);\n  patchEvaluate(engine, htmlBindings, trustedElements, sanitizer, handleHtmlBehaviors);\n  patchBehaviorDeclarations(engine, trustedElements);\n}\n\nexport default registerSanitizeHtml;\n\nconst globals = globalThis as Record<string, any>;\nconst plugins = globals.VSNPlugins ?? {};\nplugins.sanitizeHtml = (instance: Engine) => registerSanitizeHtml(instance);\nglobals.VSNPlugins = plugins;\n\nconst autoEngine = globals.VSNEngine;\nif (autoEngine && typeof autoEngine.registerFlag === \"function\") {\n  registerSanitizeHtml(autoEngine as Engine);\n}\n\nfunction patchAttributeHandlers(\n  engine: Engine,\n  htmlBindings: WeakMap<Element, HtmlBinding>,\n  trustedElements: WeakSet<Element>,\n  sanitizer: (html: string) => string,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  const handlers: any[] = (engine as any).attributeHandlers ?? [];\n  (engine as any).attributeHandlers = handlers.filter((handler) => handler?.id !== \"vsn-html\" && handler?.id !== \"vsn-get\");\n\n  engine.registerAttributeHandler({\n    id: \"vsn-html\",\n    match: (name) => name.startsWith(\"vsn-html\"),\n    handle: (element, name, value, scope) => {\n      const trusted = name.includes(\"!trusted\");\n      htmlBindings.set(element, { expr: value, trusted });\n      if ((engine as any).markInlineDeclaration) {\n        (engine as any).markInlineDeclaration(element, \"attr:html\");\n      }\n      const apply = () => {\n        const html = scope.get(value);\n        const raw = html == null ? \"\" : String(html);\n        element.innerHTML = trusted ? raw : sanitizer(raw);\n        if (trusted) {\n          trustedElements.add(element);\n          handleHtmlBehaviors?.(element);\n        }\n      };\n      apply();\n      if ((engine as any).watch) {\n        (engine as any).watch(scope, value, apply, element);\n      }\n      return true;\n    }\n  });\n\n  engine.registerAttributeHandler({\n    id: \"vsn-get\",\n    match: (name) => name.startsWith(\"vsn-get\"),\n    handle: (element, name) => {\n      const trusted = name.includes(\"!trusted\");\n      const autoLoad = name.includes(\"!load\");\n      const url = element.getAttribute(name) ?? \"\";\n      const target = element.getAttribute(\"vsn-target\") ?? undefined;\n      const swap = (element.getAttribute(\"vsn-swap\") as \"inner\" | \"outer\" | null) ?? \"inner\";\n      const targetSelector = target ?? undefined;\n\n      const run = async () => {\n        try {\n          await applyGetWithSanitize(\n            engine,\n            element,\n            {\n              url,\n              swap,\n              trusted,\n              ...(targetSelector ? { targetSelector } : {})\n            },\n            sanitizer,\n            handleHtmlBehaviors,\n            trustedElements\n          );\n        } catch (error) {\n          console.warn(\"vsn:getError\", error);\n          element.dispatchEvent(new CustomEvent(\"vsn:getError\", { detail: { error }, bubbles: true }));\n        }\n      };\n\n      element.addEventListener(\"click\", (event) => {\n        if (event.target !== element) {\n          return;\n        }\n        void run();\n      });\n      if (autoLoad) {\n        Promise.resolve().then(run);\n      }\n      return true;\n    }\n  });\n}\n\nfunction patchDirectiveSetter(\n  engine: Engine,\n  trustedElements: WeakSet<Element>,\n  sanitizer: (html: string) => string,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  const originalSet = (engine as any).setDirectiveValue?.bind(engine);\n  if (!originalSet) {\n    return;\n  }\n  (engine as any).setDirectiveValue = (element: Element, target: any, value: any) => {\n    if (target?.kind === \"attr\" && target?.name === \"html\" && element instanceof HTMLElement) {\n      const { html, trusted } = unwrapTrustedHtml(value, element, trustedElements);\n      element.innerHTML = trusted ? html : sanitizer(html);\n      if (trusted) {\n        handleHtmlBehaviors?.(element);\n      }\n      return;\n    }\n    return originalSet(element, target, value);\n  };\n}\n\nfunction patchEvaluate(\n  engine: Engine,\n  htmlBindings: WeakMap<Element, HtmlBinding>,\n  trustedElements: WeakSet<Element>,\n  sanitizer: (html: string) => string,\n  handleHtmlBehaviors?: (root: Element) => void\n): void {\n  const originalEvaluate = engine.evaluate.bind(engine);\n  engine.evaluate = (element: Element) => {\n    originalEvaluate(element);\n    const binding = htmlBindings.get(element);\n    if (!binding || !(element instanceof HTMLElement)) {\n      return;\n    }\n    const scope = engine.getScope(element);\n    const html = scope.get(binding.expr);\n    const raw = html == null ? \"\" : String(html);\n    element.innerHTML = binding.trusted ? raw : sanitizer(raw);\n    if (binding.trusted) {\n      trustedElements.add(element);\n      handleHtmlBehaviors?.(element);\n    }\n  };\n}\n\nfunction patchBehaviorDeclarations(engine: Engine, trustedElements: WeakSet<Element>): void {\n  const originalApply = (engine as any).applyBehaviorDeclaration?.bind(engine);\n  if (!originalApply) {\n    return;\n  }\n  (engine as any).applyBehaviorDeclaration = async (\n    element: Element,\n    scope: any,\n    declaration: any,\n    rootScope?: any\n  ) => {\n    const target = declaration?.target;\n    if (declaration?.flags?.trusted && target?.type === \"Directive\" && target?.name === \"html\") {\n      trustedElements.add(element);\n    }\n    return originalApply(element, scope, declaration, rootScope);\n  };\n}\n\nfunction unwrapTrustedHtml(\n  value: any,\n  element: Element,\n  trustedElements: WeakSet<Element>\n): { html: string; trusted: boolean } {\n  if (value && typeof value === \"object\" && value[TRUSTED_HTML_KEY]) {\n    const html = value.value == null ? \"\" : String(value.value);\n    return { html, trusted: true };\n  }\n  const html = value == null ? \"\" : String(value);\n  return { html, trusted: trustedElements.has(element) };\n}\n\nasync function applyGetWithSanitize(\n  engine: Engine,\n  element: Element,\n  config: { url: string; targetSelector?: string; swap?: \"inner\" | \"outer\"; trusted: boolean },\n  sanitizer: (html: string) => string,\n  handleHtmlBehaviors?: (root: Element) => void,\n  trustedElements?: WeakSet<Element>\n): Promise<void> {\n  if (!globalThis.fetch) {\n    throw new Error(\"fetch is not available\");\n  }\n\n  const response = await globalThis.fetch(config.url);\n  if (!response || !response.ok) {\n    return;\n  }\n\n  const html = await response.text();\n  const target = resolveTarget(element, config.targetSelector);\n  if (!target) {\n    element.dispatchEvent(new CustomEvent(\"vsn:targetError\", { detail: { selector: config.targetSelector } }));\n    return;\n  }\n\n  const output = config.trusted ? html : sanitizer(html);\n  if (config.swap === \"outer\") {\n    const wrapper = document.createElement(\"div\");\n    wrapper.innerHTML = output;\n    const replacement = wrapper.firstElementChild;\n    if (replacement && target.parentNode) {\n      target.parentNode.replaceChild(replacement, target);\n      if (config.trusted) {\n        trustedElements?.add(replacement);\n        handleHtmlBehaviors?.(replacement);\n      }\n    }\n    return;\n  }\n\n  (target as HTMLElement).innerHTML = output;\n  if (config.trusted) {\n    trustedElements?.add(target);\n    handleHtmlBehaviors?.(target);\n  }\n}\n\nfunction resolveTarget(element: Element, selector?: string): Element | null {\n  if (!selector) {\n    return element;\n  }\n  return element.ownerDocument.querySelector(selector);\n}\n\nfunction resolveSanitizer(options: SanitizerOptions): (html: string) => string {\n  if (options.sanitizer) {\n    return options.sanitizer;\n  }\n  const purifier = (globalThis as any).DOMPurify;\n  if (purifier && typeof purifier.sanitize === \"function\") {\n    return (html) => purifier.sanitize(html, options.dompurifyConfig ?? {});\n  }\n  return fallbackSanitize;\n}\n\nfunction fallbackSanitize(html: string): string {\n  if (typeof document === \"undefined\") {\n    return html.replace(/<script\\b[^>]*>[\\s\\S]*?<\\/script>/gi, \"\");\n  }\n  const template = document.createElement(\"template\");\n  template.innerHTML = html;\n  const scripts = template.content.querySelectorAll(\"script\");\n  scripts.forEach((script) => script.remove());\n  const elements = template.content.querySelectorAll(\"*\");\n  for (const element of Array.from(elements)) {\n    for (const attr of Array.from(element.attributes)) {\n      const name = attr.name.toLowerCase();\n      const value = attr.value;\n      if (name.startsWith(\"on\")) {\n        element.removeAttribute(attr.name);\n        continue;\n      }\n      if ((name === \"href\" || name === \"src\") && value.trim().toLowerCase().startsWith(\"javascript:\")) {\n        element.removeAttribute(attr.name);\n      }\n    }\n  }\n  return template.innerHTML;\n}\n"],"mappings":"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","names":["html"]}