{"version":3,"sources":["../../src/plugins/microdata.ts"],"sourcesContent":["import type { Engine } from \"../runtime/engine\";\n\ntype MicrodataOptions = {\n  key?: string;\n  flatten?: boolean;\n};\n\ntype ExtractResult = Record<string, any>;\n\nconst META_TYPE = \"@type\";\nconst META_ID = \"@id\";\n\nexport function registerMicrodata(engine: Engine): void {\n  engine.registerBehaviorModifier(\"microdata\", {\n    onBind: ({ element, scope, args }) => {\n      const options = normalizeOptions(args);\n      const root = resolveItemscopeRoot(element);\n      if (!root) {\n        return;\n      }\n      const data = extractMicrodata(root, options);\n      applyMicrodataToScope(scope, data, options);\n    }\n  });\n\n  engine.registerGlobal(\"microdata\", (target?: any, maybeOptions?: any) => {\n    const options = normalizeOptions(\n      isPlainObject(target) ? target : maybeOptions\n    );\n    const root = resolveTargetElement(engine, target);\n    if (!root) {\n      return undefined;\n    }\n    const data = extractMicrodata(resolveItemscopeRoot(root) ?? root, options);\n    if (typeof target === \"string\" && !isPlainObject(maybeOptions)) {\n      return data[target];\n    }\n    return data;\n  });\n}\n\nexport default registerMicrodata;\n\nconst globals = (globalThis as Record<string, any>);\nconst plugins = globals.VSNPlugins ?? {};\nplugins.microdata = (instance: Engine) => registerMicrodata(instance);\nglobals.VSNPlugins = plugins;\n\nconst autoEngine = globals.VSNEngine;\nif (autoEngine && typeof autoEngine.registerBehaviorModifier === \"function\") {\n  registerMicrodata(autoEngine as Engine);\n}\n\nfunction normalizeOptions(value: any): MicrodataOptions {\n  if (!value) {\n    return {};\n  }\n  if (typeof value === \"string\") {\n    return { key: value };\n  }\n  if (isPlainObject(value)) {\n    const options: MicrodataOptions = {};\n    if (typeof value.key === \"string\") {\n      options.key = value.key;\n    }\n    if (typeof value.flatten === \"boolean\") {\n      options.flatten = value.flatten;\n    }\n    return options;\n  }\n  return {};\n}\n\nfunction isPlainObject(value: any): value is Record<string, any> {\n  return Boolean(value) && typeof value === \"object\" && !Array.isArray(value);\n}\n\nfunction resolveTargetElement(engine: Engine, target?: any): Element | undefined {\n  if (!target) {\n    return engine.getCurrentElement();\n  }\n  if (target instanceof Element) {\n    return target;\n  }\n  if (Array.isArray(target) && target[0] instanceof Element) {\n    return target[0];\n  }\n  return engine.getCurrentElement();\n}\n\nfunction resolveItemscopeRoot(element: Element): Element | undefined {\n  if (element.hasAttribute(\"itemscope\")) {\n    return element;\n  }\n  return element.querySelector(\"[itemscope]\") ?? undefined;\n}\n\nfunction extractMicrodata(root: Element, options: MicrodataOptions): ExtractResult {\n  const result: ExtractResult = {};\n  const itemType = root.getAttribute(\"itemtype\");\n  const itemId = root.getAttribute(\"itemid\");\n  if (itemType) {\n    result[META_TYPE] = itemType;\n  }\n  if (itemId) {\n    result[META_ID] = itemId;\n  }\n\n  collectItemProps(root, result, options);\n  return result;\n}\n\nfunction collectItemProps(root: Element, result: ExtractResult, options: MicrodataOptions): void {\n  const children = Array.from(root.children);\n  for (const child of children) {\n    const hasItemprop = child.hasAttribute(\"itemprop\");\n    const hasItemscope = child.hasAttribute(\"itemscope\");\n\n    if (hasItemscope && !hasItemprop) {\n      continue;\n    }\n\n    if (hasItemprop) {\n      const props = (child.getAttribute(\"itemprop\") ?? \"\")\n        .split(/\\s+/)\n        .map((prop) => prop.trim())\n        .filter(Boolean);\n      const value = hasItemscope ? extractMicrodata(child, options) : readItemValue(child);\n      for (const prop of props) {\n        addValue(result, prop, value);\n      }\n      if (options.flatten && value && typeof value === \"object\" && !Array.isArray(value)) {\n        for (const [key, nestedValue] of Object.entries(value)) {\n          if (key.startsWith(\"@\")) {\n            continue;\n          }\n          addValue(result, key, nestedValue);\n        }\n      }\n      if (hasItemscope) {\n        continue;\n      }\n    }\n\n    collectItemProps(child, result, options);\n  }\n}\n\nfunction readItemValue(element: Element): string {\n  if (element instanceof HTMLMetaElement) {\n    return element.content ?? \"\";\n  }\n  if (element instanceof HTMLInputElement || element instanceof HTMLTextAreaElement) {\n    return element.value ?? \"\";\n  }\n  if (element instanceof HTMLSelectElement) {\n    return element.value ?? \"\";\n  }\n  if (element instanceof HTMLTimeElement) {\n    return element.dateTime || element.getAttribute(\"datetime\") || \"\";\n  }\n  if (element instanceof HTMLAnchorElement || element instanceof HTMLLinkElement) {\n    return element.getAttribute(\"href\") ?? \"\";\n  }\n  if (element instanceof HTMLImageElement) {\n    return element.getAttribute(\"src\") ?? \"\";\n  }\n  if (element.hasAttribute(\"content\")) {\n    return element.getAttribute(\"content\") ?? \"\";\n  }\n  return (element.textContent ?? \"\").trim();\n}\n\nfunction addValue(result: ExtractResult, key: string, value: any): void {\n  if (result[key] === undefined) {\n    result[key] = value;\n    return;\n  }\n  if (Array.isArray(result[key])) {\n    result[key].push(value);\n    return;\n  }\n  result[key] = [result[key], value];\n}\n\nfunction applyMicrodataToScope(scope: any, data: ExtractResult, options: MicrodataOptions): void {\n  if (options.key) {\n    scope.setPath?.(options.key, data);\n    return;\n  }\n  for (const [key, value] of Object.entries(data)) {\n    if (key === META_TYPE) {\n      scope.setPath?.(\"itemtype\", value);\n      continue;\n    }\n    if (key === META_ID) {\n      scope.setPath?.(\"itemid\", value);\n      continue;\n    }\n    scope.setPath?.(key, value);\n  }\n}\n"],"mappings":"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","names":[]}