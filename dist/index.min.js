var O=(a=>(a.Whitespace="Whitespace",a.Identifier="Identifier",a.Number="Number",a.String="String",a.Boolean="Boolean",a.Null="Null",a.Behavior="Behavior",a.State="State",a.On="On",a.Construct="Construct",a.Destruct="Destruct",a.LBrace="LBrace",a.RBrace="RBrace",a.LParen="LParen",a.RParen="RParen",a.LBracket="LBracket",a.RBracket="RBracket",a.Colon="Colon",a.Semicolon="Semicolon",a.Comma="Comma",a.Dot="Dot",a.Hash="Hash",a.Greater="Greater",a.Less="Less",a.Plus="Plus",a.Tilde="Tilde",a.Star="Star",a.Equals="Equals",a.Bang="Bang",a.At="At",a.Dollar="Dollar",a.Question="Question",a))(O||{});var q={behavior:"Behavior",state:"State",on:"On",construct:"Construct",destruct:"Destruct",true:"Boolean",false:"Boolean",null:"Null"},v=class{constructor(e){this.input=e}index=0;line=1;column=1;tokenize(){let e=[];for(;!this.eof();){let t=this.peek();if(this.isWhitespace(t)){e.push(this.readWhitespace());continue}if(t==="/"&&this.peek(1)==="/"){this.readLineComment();continue}if(t==="/"&&this.peek(1)==="*"){this.readBlockComment();continue}if(this.isAlpha(t)||t==="_"){e.push(this.readIdentifier());continue}if(this.isDigit(t)||t==="-"&&this.isDigit(this.peek(1))){e.push(this.readNumber());continue}if(t==='"'||t==="'"){e.push(this.readString());continue}let r=this.readPunctuator();if(r){e.push(r);continue}throw new Error(`Unexpected character '${t}' at ${this.line}:${this.column}`)}return e}readWhitespace(){let e=this.position(),t="";for(;!this.eof()&&this.isWhitespace(this.peek());)t+=this.next();return this.token("Whitespace",t,e)}readLineComment(){for(this.next(),this.next();!this.eof()&&this.peek()!==`
`;)this.next()}readBlockComment(){for(this.next(),this.next();!this.eof();){if(this.peek()==="*"&&this.peek(1)==="/"){this.next(),this.next();return}this.next()}}readIdentifier(){let e=this.position(),t="";for(;!this.eof()&&(this.isAlphaNumeric(this.peek())||this.peek()==="_"||this.peek()==="-");)t+=this.next();let r=q[t];return r?this.token(r,t,e):this.token("Identifier",t,e)}readNumber(){let e=this.position(),t="";for(this.peek()==="-"&&(t+=this.next());!this.eof()&&this.isDigit(this.peek());)t+=this.next();if(this.peek()===".")for(t+=this.next();!this.eof()&&this.isDigit(this.peek());)t+=this.next();return this.token("Number",t,e)}readString(){let e=this.next(),t=this.position(),r="";for(;!this.eof();){let s=this.next();if(s==="\\"){let n=this.next();r+=n;continue}if(s===e)return this.token("String",r,t);r+=s}throw new Error(`Unterminated string at ${t.line}:${t.column}`)}readPunctuator(){let e=this.position(),t=this.peek(),s={"{":"LBrace","}":"RBrace","(":"LParen",")":"RParen","[":"LBracket","]":"RBracket",":":"Colon",";":"Semicolon",",":"Comma",".":"Dot","#":"Hash",">":"Greater","<":"Less","+":"Plus","~":"Tilde","*":"Star","=":"Equals","!":"Bang","@":"At",$:"Dollar","?":"Question"}[t];return s?(this.next(),this.token(s,t,e)):null}token(e,t,r){return{type:e,value:t,start:r,end:this.position()}}position(){return{index:this.index,line:this.line,column:this.column}}peek(e=0){return this.input[this.index+e]??""}next(){let e=this.input[this.index++]??"";return e===`
`?(this.line+=1,this.column=1):this.column+=1,e}eof(){return this.index>=this.input.length}isWhitespace(e){return e===" "||e==="	"||e===`
`||e==="\r"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isDigit(e){return e>="0"&&e<="9"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}};var p=class{constructor(e){this.type=e}async prepare(e){}async evaluate(e){}},y=class extends p{constructor(t){super("Program");this.behaviors=t}},E=class extends p{constructor(t){super("Block");this.statements=t}async evaluate(t){for(let r of this.statements)r&&typeof r.evaluate=="function"&&await r.evaluate(t)}},b=class extends p{constructor(t){super("Selector");this.selectorText=t}},w=class extends p{constructor(t,r){super("Behavior");this.selector=t;this.body=r}},B=class extends p{constructor(t,r,s){super("StateEntry");this.name=t;this.value=r;this.important=s}},S=class extends p{constructor(t){super("StateBlock");this.entries=t}},D=class extends p{constructor(t,r,s){super("OnBlock");this.eventName=t;this.args=r;this.body=s}},W=class extends p{constructor(t,r){super("Assignment");this.target=t;this.value=r}async evaluate(t){if(!t.scope||!t.scope.setPath)return;let r;if(this.target instanceof h&&(r=this.target.name),!r)return;let s=await this.value.evaluate(t);return t.scope.setPath(r,s),s}},N=class extends p{constructor(t,r,s,n,o){super("Declaration");this.target=t;this.operator=r;this.value=s;this.flags=n;this.flagArgs=o}},h=class extends p{constructor(t){super("Identifier");this.name=t}async evaluate(t){if(t.scope)return t.scope.getPath(this.name)}},f=class extends p{constructor(t){super("Literal");this.value=t}async evaluate(){return this.value}},P=class extends p{constructor(t,r){super("UnaryExpression");this.operator=t;this.argument=r}async evaluate(t){let r=await this.argument.evaluate(t);return this.operator==="!"?!r:r}},C=class extends p{constructor(t,r,s){super("BinaryExpression");this.operator=t;this.left=r;this.right=s}async evaluate(t){let r=await this.left.evaluate(t),s=await this.right.evaluate(t);if(this.operator==="+")return r+s}},d=class extends p{constructor(t,r){super("Directive");this.kind=t;this.name=r}async evaluate(){return`${this.kind}:${this.name}`}},A=class extends p{constructor(t,r){super("Query");this.direction=t;this.selector=r}};var L=class{constructor(e){this.tokens=e}index=0;peek(e=0){return this.tokens[this.index+e]??null}next(){let e=this.tokens[this.index++];if(!e)throw new Error("Unexpected end of input");return e}eof(){return this.index>=this.tokens.length}match(e){return this.peek()?.type===e?(this.next(),!0):!1}expect(e){let t=this.next();if(t.type!==e)throw new Error(`Expected ${e} but got ${t.type}`);return t}skipWhitespace(){for(;this.peek()?.type==="Whitespace";)this.next()}peekNonWhitespace(e=0){let t=0;for(let r=this.index;r<this.tokens.length;r++){let s=this.tokens[r];if(s.type!=="Whitespace"){if(t===e)return s;t+=1}}return null}};var m=class i{stream;constructor(e){let t=new v(e);this.stream=new L(t.tokenize())}static parseInline(e){return new i(`{${e}}`).parseInlineBlock()}parseProgram(){let e=[];for(this.stream.skipWhitespace();!this.stream.eof();)e.push(this.parseBehavior()),this.stream.skipWhitespace();return new y(e)}parseInlineBlock(){return this.stream.skipWhitespace(),this.parseBlock({allowDeclarations:!1})}parseBehavior(){this.stream.skipWhitespace(),this.stream.expect("Behavior");let e=this.parseSelector(),t=this.parseBlock({allowDeclarations:!0});return new w(e,t)}parseSelector(){let e="",t=!1;for(;;){let r=this.stream.peek();if(!r||r.type==="LBrace")break;if(r.type==="Whitespace"){this.stream.next(),t&&e[e.length-1]!==" "&&(e+=" ");continue}t=!0,e+=this.stream.next().value}if(!e.trim())throw new Error("Behavior selector is required");return new b(e.trim())}parseBlock(e){let t=e?.allowDeclarations??!1;this.stream.skipWhitespace(),this.stream.expect("LBrace");let r=[],s=t;for(;;){this.stream.skipWhitespace();let n=this.stream.peek();if(!n)throw new Error("Unterminated block");if(n.type==="RBrace"){this.stream.next();break}if(this.isDeclarationStart()){if(!t)throw new Error("Declarations are only allowed at the behavior root");if(!s)throw new Error("Declarations must appear before blocks");r.push(this.parseDeclaration())}else s&&(s=!1),r.push(this.parseStatement())}return new E(r)}parseStatement(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unexpected end of input");if(e.type==="On")return this.parseOnBlock();if(e.type==="Construct")return this.parseConstructBlock();if(e.type==="Destruct")return this.parseDestructBlock();if(e.type==="Behavior")return this.parseBehavior();if(this.isAssignmentStart())return this.parseAssignment();throw new Error(`Unexpected token ${e.type}`)}parseStateBlock(){this.stream.expect("State"),this.stream.skipWhitespace(),this.stream.expect("LBrace");let e=[];for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unterminated state block");if(t.type==="RBrace"){this.stream.next();break}let r=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let s=this.parseExpression();this.stream.skipWhitespace();let n=!1;if(this.stream.peek()?.type==="Bang"){this.stream.next(),this.stream.skipWhitespace();let o=this.stream.next();if(o.type==="Identifier"&&o.value==="important")n=!0;else throw new Error("Expected 'important' after '!'")}this.stream.skipWhitespace(),this.stream.expect("Semicolon"),e.push(new B(r.value,s,n))}return new S(e)}parseOnBlock(){this.stream.expect("On"),this.stream.skipWhitespace();let e=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("LParen");let t=[];for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated on() arguments");if(s.type==="RParen"){this.stream.next();break}if(s.type==="Identifier"){t.push(this.stream.next().value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next();continue}throw new Error(`Unexpected token in on() args: ${s.type}`)}let r=this.parseBlock({allowDeclarations:!1});return new D(e.value,t,r)}parseAssignment(){let e=this.parseAssignmentTarget();this.stream.skipWhitespace(),this.stream.expect("Equals"),this.stream.skipWhitespace();let t=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new W(e,t)}parseExpression(){return this.parseAdditiveExpression()}parseAdditiveExpression(){let e=this.parseUnaryExpression();for(this.stream.skipWhitespace();this.stream.peekNonWhitespace(0)?.type==="Plus";){this.stream.skipWhitespace(),this.stream.expect("Plus"),this.stream.skipWhitespace();let t=this.parseUnaryExpression();this.stream.skipWhitespace(),e=new C("+",e,t)}return e}parseUnaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="Bang"){this.stream.next();let t=this.parseUnaryExpression();return new P("!",t)}return this.parsePrimaryExpression()}parsePrimaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new d(t,r.value)}if(e.type==="Question")return this.parseQueryExpression();if(e.type==="Identifier"){let t=this.parseIdentifierPath();return new h(t)}if(e.type==="Boolean")return new f(this.stream.next().value==="true");if(e.type==="Null")return this.stream.next(),new f(null);if(e.type==="Number")return new f(Number(this.stream.next().value));if(e.type==="String")return new f(this.stream.next().value);throw new Error(`Unsupported expression token ${e.type}`)}parseAssignmentTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected assignment target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new d(t,r.value)}if(e.type==="Identifier")return new h(this.parseIdentifierPath());throw new Error(`Invalid assignment target ${e.type}`)}parseDeclaration(){let e=this.parseDeclarationTarget();this.stream.skipWhitespace();let t=this.parseDeclarationOperator();this.stream.skipWhitespace();let r=this.parseExpression(),{flags:s,flagArgs:n}=this.parseFlags();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new N(e,t,r,s,n)}parseDeclarationTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected declaration target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new d(t,r.value)}if(e.type==="Identifier")return new h(this.stream.next().value);throw new Error(`Invalid declaration target ${e.type}`)}parseDeclarationOperator(){this.stream.expect("Colon");let e=this.stream.peek();return e?e.type==="Equals"?(this.stream.next(),":="):e.type==="Less"?(this.stream.next(),":<"):e.type==="Greater"?(this.stream.next(),":>"):":":":"}parseFlags(){let e={},t={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let r=this.stream.expect("Identifier").value;if(r==="important")e.important=!0;else if(r==="trusted")e.trusted=!0;else if(r==="debounce")if(e.debounce=!0,this.stream.peek()?.type==="LParen"){this.stream.next(),this.stream.skipWhitespace();let s=this.stream.expect("Number");t.debounce=Number(s.value),this.stream.skipWhitespace(),this.stream.expect("RParen")}else t.debounce=200;else throw new Error(`Unknown flag ${r}`)}return{flags:e,flagArgs:t}}isDeclarationStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier")return this.stream.peekNonWhitespace(1)?.type==="Colon";if(e.type==="At"||e.type==="Dollar"){let t=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return t?.type==="Identifier"&&r?.type==="Colon"}return!1}isAssignmentStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier"){let t=this.stream.peekNonWhitespace(1);return t?.type==="Equals"||t?.type==="Dot"}if(e.type==="At"||e.type==="Dollar"){let t=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return t?.type==="Identifier"&&r?.type==="Equals"}return!1}parseConstructBlock(){this.stream.expect("Construct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Construct",e}parseDestructBlock(){this.stream.expect("Destruct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Destruct",e}parseQueryExpression(){this.stream.expect("Question");let e="self";this.stream.peek()?.type==="Greater"?(this.stream.next(),e="descendant"):this.stream.peek()?.type==="Less"&&(this.stream.next(),e="ancestor"),this.stream.skipWhitespace(),this.stream.expect("LParen");let t=this.readSelectorUntil("RParen");return new A(e,t)}readSelectorUntil(e){let t="",r=!1;for(;;){let s=this.stream.peek();if(!s)throw new Error("Unterminated selector");if(s.type===e){this.stream.next();break}if(s.type==="Whitespace"){this.stream.next(),r&&t[t.length-1]!==" "&&(t+=" ");continue}r=!0,t+=this.stream.next().value}return t.trim()}parseIdentifierPath(){let e=this.stream.expect("Identifier").value;for(;this.stream.peek()?.type==="Dot";){this.stream.next();let t=this.stream.expect("Identifier").value;e=`${e}.${t}`}return e}};var I=class{constructor(e){this.parent=e;this.root=e?e.root:this}data=new Map;root;get(e){return this.getPath(e)}set(e,t){this.setPath(e,t)}getPath(e){let{targetScope:t,targetPath:r}=this.resolveScope(e);if(!t||!r)return;let s=r.split("."),n=s[0];if(!n)return;let o=t.data.get(n);for(let c=1;c<s.length;c+=1){if(o==null)return;let l=s[c];if(!l)return;o=o[l]}return o}setPath(e,t){let{targetScope:r,targetPath:s}=this.resolveScope(e);if(!r||!s)return;let n=s.split("."),o=n[0];if(!o)return;if(n.length===1){r.data.set(o,t);return}let c=r.data.get(o);(c==null||typeof c!="object")&&(c={},r.data.set(o,c));let l=c;for(let M=1;M<n.length-1;M+=1){let x=n[M];if(!x)return;(l[x]==null||typeof l[x]!="object")&&(l[x]={}),l=l[x]}let u=n[n.length-1];u&&(l[u]=t)}resolveScope(e){return e.startsWith("parent.")?{targetScope:this.parent,targetPath:e.slice(7)}:e.startsWith("root.")?{targetScope:this.root,targetPath:e.slice(5)}:e.startsWith("self.")?{targetScope:this,targetPath:e.slice(5)}:{targetScope:this,targetPath:e}}};function Q(i){return i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement?i.value:i.textContent??""}function _(i,e){if(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement){i.value=e,i.setAttribute("value",e);return}i.textContent=e}function U(i,e,t){let r=e.trim();if(!r)return;let s=Q(i).trim();s!==""&&t.set(r,s)}function $(i,e,t){let r=e.trim();if(!r)return;let s=t.get(r);s!=null&&_(i,String(s))}function R(i,e){let t=i.trim();return t?!!e.get(t):!1}function T(i,e,t){i.style.display=R(e,t)?"":"none"}function H(i,e,t){i.style.display=R(e,t)?"":"none"}function V(i){return i.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"")}function g(i,e,t,r){let s=e.trim();if(!s)return;let n=t.get(s),o=n==null?"":String(n);i.innerHTML=r?o:V(o)}async function F(i,e,t){if(!globalThis.fetch)throw new Error("fetch is not available");let r=await globalThis.fetch(e.url);if(!r||!r.ok)return;let s=await r.text(),n=z(i,e.targetSelector);if(!n){i.dispatchEvent(new CustomEvent("vsn:targetError",{detail:{selector:e.targetSelector}}));return}if(e.swap==="outer"){let o=document.createElement("div");g(o,"__html",{get:()=>s},e.trusted);let c=o.firstElementChild;c&&n.parentNode&&n.parentNode.replaceChild(c,n);return}g(n,"__html",{get:()=>s},e.trusted)}function z(i,e){return e?i.ownerDocument.querySelector(e):i}function G(i,e){let t;return(...r)=>{t&&clearTimeout(t),t=setTimeout(()=>{t=void 0,i(...r)},e)}}var k=class{scopes=new WeakMap;bindBindings=new WeakMap;ifBindings=new WeakMap;showBindings=new WeakMap;htmlBindings=new WeakMap;getBindings=new WeakMap;codeCache=new Map;async mount(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let r of t){if(!this.hasVsnAttributes(r))continue;let s=this.findParentScope(r);this.getScope(r,s),this.attachAttributes(r)}}getScope(e,t){let r=this.scopes.get(e);if(r)return r;let s=new I(t??this.findParentScope(e));return this.scopes.set(e,s),s}evaluate(e){let t=this.getScope(e),r=this.bindBindings.get(e);r&&(r.direction==="from"||r.direction==="both")&&$(e,r.expr,t);let s=this.ifBindings.get(e);s&&e instanceof HTMLElement&&T(e,s,t);let n=this.showBindings.get(e);n&&e instanceof HTMLElement&&H(e,n,t);let o=this.htmlBindings.get(e);o&&e instanceof HTMLElement&&g(e,o.expr,t,o.trusted)}attachAttributes(e){let t=this.getScope(e);for(let r of e.getAttributeNames()){if(r.startsWith("vsn-bind")){let n=e.getAttribute(r)??"",o=this.parseBindDirection(r);this.bindBindings.set(e,{expr:n,direction:o}),(o==="to"||o==="both")&&U(e,n,t);continue}if(r==="vsn-if"){let n=e.getAttribute(r)??"";this.ifBindings.set(e,n),e instanceof HTMLElement&&T(e,n,t);continue}if(r==="vsn-show"){let n=e.getAttribute(r)??"";this.showBindings.set(e,n),e instanceof HTMLElement&&H(e,n,t);continue}if(r.startsWith("vsn-html")){let n=r.includes("!trusted"),o=e.getAttribute(r)??"";this.htmlBindings.set(e,{expr:o,trusted:n}),e instanceof HTMLElement&&g(e,o,t,n);continue}if(r.startsWith("vsn-get")){let n=r.includes("!trusted"),o=e.getAttribute(r)??"",c=e.getAttribute("vsn-target")??void 0,l=e.getAttribute("vsn-swap")??"inner",u={url:o,swap:l,trusted:n,...c?{targetSelector:c}:{}};this.getBindings.set(e,u),this.attachGetHandler(e);continue}let s=this.parseOnAttribute(r,e.getAttribute(r)??"");s&&this.attachOnHandler(e,s)}}parseBindDirection(e){return e.includes(":from")?"from":e.includes(":to")?"to":"both"}hasVsnAttributes(e){return e.getAttributeNames().some(t=>t.startsWith("vsn-"))}findParentScope(e){let t=e.parentElement;for(;t;){let r=this.scopes.get(t);if(r)return r;t=t.parentElement}}parseOnAttribute(e,t){if(!e.startsWith("vsn-on:"))return null;let r=e.slice(7),[s,...n]=r.split("!");if(!s)return null;let o;for(let l of n){if(!l.startsWith("debounce"))continue;let u=l.match(/debounce\((\d+)\)/);o=u?Number(u[1]):200}return{event:s,code:t,...o!==void 0?{debounceMs:o}:{}}}attachOnHandler(e,t){let r=async()=>{let n=this.getScope(e);await this.execute(t.code,n),this.evaluate(e)},s=t.debounceMs?G(r,t.debounceMs):r;e.addEventListener(t.event,s)}attachGetHandler(e){e.addEventListener("click",async()=>{let t=this.getBindings.get(e);t&&await F(e,t,this.getScope(e))})}async execute(e,t){let r=this.codeCache.get(e);r||(r=m.parseInline(e),this.codeCache.set(e,r));let s={scope:t};await r.evaluate(s)}evaluateExpression(e,t){let r=e.split("+").map(n=>n.trim()).filter(Boolean);if(r.length>1)return r.reduce((n,o)=>{let c=this.evaluateExpression(o,t);return n+c},0);let s=r[0];if(s)return s==="true"?!0:s==="false"?!1:s==="null"?null:/^-?\d+(?:\.\d+)?$/.test(s)?Number(s):s.startsWith('"')&&s.endsWith('"')||s.startsWith("'")&&s.endsWith("'")?s.slice(1,-1):t.getPath(s)}};var Se="0.1.0";function Ne(i){return new m(i).parseProgram()}function j(i=document){if(console.log("auto mounting"),typeof document>"u")return null;let e=new k,t=()=>{let r=i instanceof Document?i.body:i;r&&e.mount(r)};return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t(),e}typeof document<"u"&&document.querySelector("script[auto-mount]")&&j();export{W as AssignmentNode,p as BaseNode,w as BehaviorNode,C as BinaryExpression,E as BlockNode,N as DeclarationNode,d as DirectiveExpression,k as Engine,h as IdentifierExpression,v as Lexer,f as LiteralExpression,D as OnBlockNode,m as Parser,y as ProgramNode,A as QueryExpression,b as SelectorNode,S as StateBlockNode,B as StateEntryNode,O as TokenType,P as UnaryExpression,Se as VERSION,j as autoMount,Ne as parseCFS};
//# sourceMappingURL=index.min.js.map