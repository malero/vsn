var Ne=(u=>(u.Whitespace="Whitespace",u.Identifier="Identifier",u.Number="Number",u.String="String",u.Template="Template",u.Boolean="Boolean",u.Null="Null",u.Behavior="Behavior",u.Use="Use",u.State="State",u.On="On",u.Construct="Construct",u.Destruct="Destruct",u.Return="Return",u.If="If",u.Else="Else",u.For="For",u.While="While",u.Try="Try",u.Catch="Catch",u.Assert="Assert",u.Break="Break",u.Continue="Continue",u.LBrace="LBrace",u.RBrace="RBrace",u.LParen="LParen",u.RParen="RParen",u.LBracket="LBracket",u.RBracket="RBracket",u.Colon="Colon",u.Semicolon="Semicolon",u.Comma="Comma",u.Ellipsis="Ellipsis",u.Dot="Dot",u.Hash="Hash",u.Greater="Greater",u.Less="Less",u.Plus="Plus",u.PlusPlus="PlusPlus",u.Minus="Minus",u.MinusMinus="MinusMinus",u.Tilde="Tilde",u.Star="Star",u.Slash="Slash",u.Percent="Percent",u.Equals="Equals",u.Arrow="Arrow",u.DoubleEquals="DoubleEquals",u.TripleEquals="TripleEquals",u.NotEquals="NotEquals",u.StrictNotEquals="StrictNotEquals",u.LessEqual="LessEqual",u.GreaterEqual="GreaterEqual",u.And="And",u.Or="Or",u.Pipe="Pipe",u.NullishCoalesce="NullishCoalesce",u.OptionalChain="OptionalChain",u.Bang="Bang",u.At="At",u.Dollar="Dollar",u.Question="Question",u))(Ne||{});var We={behavior:"Behavior",use:"Use",state:"State",on:"On",construct:"Construct",destruct:"Destruct",return:"Return",if:"If",else:"Else",for:"For",while:"While",try:"Try",catch:"Catch",assert:"Assert",break:"Break",continue:"Continue",true:"Boolean",false:"Boolean",null:"Null"},j=class{constructor(t){this.input=t}index=0;line=1;column=1;pendingTokens=[];templateMode=!1;templateExpressionMode=!1;templateBraceDepth=0;tokenize(){let t=[];for(;!this.eof();){if(this.pendingTokens.length>0){let s=this.pendingTokens.shift();if(s){t.push(s),this.trackTemplateBrace(s);continue}}if(this.templateMode){let s=this.readTemplateChunk();t.push(s);continue}let e=this.peek();if(this.isWhitespace(e)){t.push(this.readWhitespace());continue}if(e==="`"){this.next(),this.templateMode=!0;continue}if(e==="/"&&this.peek(1)==="/"){this.readLineComment();continue}if(e==="/"&&this.peek(1)==="*"){this.readBlockComment();continue}if(this.isAlpha(e)||e==="_"){t.push(this.readIdentifier());continue}if(this.isDigit(e)||e==="-"&&this.isDigit(this.peek(1))){t.push(this.readNumber());continue}if(e==='"'||e==="'"){t.push(this.readString());continue}let r=this.readPunctuator();if(r){t.push(r),this.trackTemplateBrace(r);continue}throw new Error(`Unexpected character '${e}' at ${this.line}:${this.column}`)}return t}readWhitespace(){let t=this.position(),e="";for(;!this.eof()&&this.isWhitespace(this.peek());)e+=this.next();return this.token("Whitespace",e,t)}readLineComment(){for(this.next(),this.next();!this.eof()&&this.peek()!==`
`;)this.next()}readBlockComment(){for(this.next(),this.next();!this.eof();){if(this.peek()==="*"&&this.peek(1)==="/"){this.next(),this.next();return}this.next()}}readIdentifier(){let t=this.position(),e="";for(;!this.eof();){let s=this.peek();if(this.isAlphaNumeric(s)||s==="_"){e+=this.next();continue}if(s==="-"){if(this.peek(1)==="-")break;e+=this.next();continue}break}let r=We[e];return r?this.token(r,e,t):this.token("Identifier",e,t)}readNumber(){let t=this.position(),e="";for(this.peek()==="-"&&(e+=this.next());!this.eof()&&this.isDigit(this.peek());)e+=this.next();if(this.peek()===".")for(e+=this.next();!this.eof()&&this.isDigit(this.peek());)e+=this.next();return this.token("Number",e,t)}readString(){let t=this.next(),e=this.position(),r="";for(;!this.eof();){let s=this.next();if(s==="\\"){let i=this.next();r+=i;continue}if(s===t)return this.token("String",r,e);r+=s}throw new Error(`Unterminated string at ${e.line}:${e.column}`)}readTemplateChunk(){let t=this.position(),e="";for(;!this.eof();){let r=this.peek();if(r==="`")return this.next(),this.templateMode=!1,this.token("Template",e,t);if(r==="$"&&this.peek(1)==="{"){let s=this.position();this.next();let i=this.position();return this.next(),this.templateMode=!1,this.templateExpressionMode=!0,this.templateBraceDepth=0,this.pendingTokens.push(this.token("Dollar","$",s)),this.pendingTokens.push(this.token("LBrace","{",i)),this.token("Template",e,t)}if(r==="\\"){this.next();let s=this.next();e+=s;continue}e+=this.next()}throw new Error(`Unterminated template literal at ${t.line}:${t.column}`)}readPunctuator(){let t=this.position(),e=this.peek(),r=this.peek(1);if(e==="="&&r==="="&&this.peek(2)==="=")return this.next(),this.next(),this.next(),this.token("TripleEquals","===",t);if(e==="="&&r==="=")return this.next(),this.next(),this.token("DoubleEquals","==",t);if(e==="="&&r===">")return this.next(),this.next(),this.token("Arrow","=>",t);if(e==="!"&&r==="="&&this.peek(2)==="=")return this.next(),this.next(),this.next(),this.token("StrictNotEquals","!==",t);if(e==="!"&&r==="=")return this.next(),this.next(),this.token("NotEquals","!=",t);if(e==="<"&&r==="=")return this.next(),this.next(),this.token("LessEqual","<=",t);if(e===">"&&r==="=")return this.next(),this.next(),this.token("GreaterEqual",">=",t);if(e==="&"&&r==="&")return this.next(),this.next(),this.token("And","&&",t);if(e==="|"&&r==="|")return this.next(),this.next(),this.token("Or","||",t);if(e==="?"&&r==="?")return this.next(),this.next(),this.token("NullishCoalesce","??",t);if(e==="?"&&r===".")return this.next(),this.next(),this.token("OptionalChain","?.",t);if(e==="|"&&r===">")return this.next(),this.next(),this.token("Pipe","|>",t);if(e==="+"&&r==="+")return this.next(),this.next(),this.token("PlusPlus","++",t);if(e==="-"&&r==="-")return this.next(),this.next(),this.token("MinusMinus","--",t);if(e==="."&&r==="."&&this.peek(2)===".")return this.next(),this.next(),this.next(),this.token("Ellipsis","...",t);let i={"{":"LBrace","}":"RBrace","(":"LParen",")":"RParen","[":"LBracket","]":"RBracket",":":"Colon",";":"Semicolon",",":"Comma",".":"Dot","#":"Hash",">":"Greater","<":"Less","+":"Plus","-":"Minus","~":"Tilde","*":"Star","/":"Slash","%":"Percent","=":"Equals","!":"Bang","@":"At",$:"Dollar","?":"Question"}[e];return i?(this.next(),this.token(i,e,t)):null}trackTemplateBrace(t){this.templateExpressionMode&&(t.type==="LBrace"?this.templateBraceDepth+=1:t.type==="RBrace"&&(this.templateBraceDepth-=1,this.templateBraceDepth<=0&&(this.templateExpressionMode=!1,this.templateMode=!0)))}token(t,e,r){return{type:t,value:e,start:r,end:this.position()}}position(){return{index:this.index,line:this.line,column:this.column}}peek(t=0){return this.input[this.index+t]??""}next(){let t=this.input[this.index++]??"";return t===`
`?(this.line+=1,this.column=1):this.column+=1,t}eof(){return this.index>=this.input.length}isWhitespace(t){return t===" "||t==="	"||t===`
`||t==="\r"}isAlpha(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"}isDigit(t){return t>="0"&&t<="9"}isAlphaNumeric(t){return this.isAlpha(t)||this.isDigit(t)}};var m=class{constructor(t){this.type=t}async prepare(t){}evaluate(t){}};function D(p){return!!p&&typeof p.then=="function"}function f(p,t){return D(p)?p.then(t):t(p)}function ke(p,t){let e=p.scope;if(!e||!e.createChild)return t.evaluate(p);let r=p.scope;p.scope=e.createChild();try{return t.evaluate(p)}finally{p.scope=r}}var te=class extends m{constructor(e,r=[]){super("Program");this.behaviors=e;this.uses=r}},re=class extends m{constructor(e,r,s={},i={}){super("Use");this.name=e;this.alias=r;this.flags=s;this.flagArgs=i}},k=class extends m{constructor(e){super("Block");this.statements=e}evaluate(e){let r=0,s=()=>{for(;r<this.statements.length&&!(e.returning||e.breaking||e.continuing);){let i=this.statements[r];if(r+=1,i&&typeof i.evaluate=="function"){let n=i.evaluate(e);if(D(n))return n.then(()=>s())}}};return s()}},se=class extends m{constructor(e){super("Selector");this.selectorText=e}},H=class extends m{constructor(e,r,s={},i={}){super("Behavior");this.selector=e;this.body=r;this.flags=s;this.flagArgs=i}},T=class extends m{constructor(e,r,s,i={},n={}){super("OnBlock");this.eventName=e;this.args=r;this.body=s;this.flags=i;this.flagArgs=n}},F=class extends m{constructor(e,r,s="=",i=!1){super("Assignment");this.target=e;this.value=r;this.operator=s;this.prefix=i}evaluate(e){let r=this.target;if(r instanceof x){let i=this.value.evaluate(e);return f(i,n=>(this.assignDirectiveTarget(e,r,n,this.operator),n))}if(r instanceof A){let i=r.element.evaluate(e);return f(i,n=>{let a=z(n);if(!a)return;let o=this.value.evaluate(e);return f(o,c=>(this.assignDirectiveTarget({...e,element:a},r.directive,c,this.operator),c))})}if(!e.scope||!e.scope.setPath)return;if(this.operator==="++"||this.operator==="--")return this.applyIncrement(e);let s=this.value.evaluate(e);return f(s,i=>{if(this.operator!=="=")return this.applyCompoundAssignment(e,i);if(this.target instanceof g&&this.target.name.startsWith("root.")&&e.rootScope){let n=this.target.name.slice(5);return e.rootScope.setPath?.(`self.${n}`,i),i}if(this.target instanceof E||this.target instanceof B){let n=this.resolveAssignmentTarget(e);return f(n,a=>a?.scope?.setPath?(a.scope.setPath(a.path,i),i):(this.assignTarget(e,this.target,i),i))}return this.assignTarget(e,this.target,i,this.operator),i})}applyCompoundAssignment(e,r){if(!e.scope||!e.scope.setPath)return;let s=this.resolveAssignmentTarget(e);return f(s,i=>{if(!i)throw new Error("Compound assignment requires a simple identifier or member path");let{scope:n,path:a}=i,o=n?.getPath?n.getPath(a):void 0,c;return this.operator==="+="?c=o+r:this.operator==="-="?c=o-r:this.operator==="*="?c=o*r:c=o/r,n?.setPath?.(a,c),c})}applyIncrement(e){if(!e.scope||!e.scope.setPath)return;let r=this.resolveAssignmentTarget(e);return f(r,s=>{if(!s)throw new Error("Increment/decrement requires a simple identifier or member path");let{scope:i,path:n}=s,a=i?.getPath?i.getPath(n):void 0,o=typeof a=="number"?a:Number(a),c=this.operator==="++"?1:-1,l=(Number.isNaN(o)?0:o)+c;return i?.setPath?.(n,l),this.prefix?l:o})}resolveAssignmentTarget(e){if(this.target instanceof g){let r=this.target.name.startsWith("root."),s=r?this.target.name.slice(5):this.target.name;return r?e.rootScope?{scope:e.rootScope,path:`self.${s}`}:{scope:e.scope,path:`root.${s}`}:{scope:e.scope,path:s}}if(this.target instanceof E){let r=this.target.getIdentifierPath();if(r){let n=r.path,a=n.startsWith("root."),o=a?n.slice(5):n;return a?e.rootScope?{scope:e.rootScope,path:`self.${o}`}:{scope:e.scope,path:`root.${o}`}:{scope:e.scope,path:o}}let s=this.target,i=this.resolveTargetPath(e,s.target);return f(i,n=>{if(!n)return null;let a=`${n}.${s.property}`,o=a.startsWith("root."),c=o?a.slice(5):a;return o?e.rootScope?{scope:e.rootScope,path:`self.${c}`}:{scope:e.scope,path:`root.${c}`}:{scope:e.scope,path:c}})}if(this.target instanceof B){let r=this.resolveIndexPath(e,this.target);return f(r,s=>{if(!s)return null;let i=s.startsWith("root."),n=i?s.slice(5):s;return i?e.rootScope?{scope:e.rootScope,path:`self.${n}`}:{scope:e.scope,path:`root.${n}`}:{scope:e.scope,path:n}})}return null}resolveIndexPath(e,r){let s=this.resolveTargetPath(e,r.target);return f(s,i=>{if(!i)return null;let n=r.index.evaluate(e);return f(n,a=>a==null?null:`${i}.${a}`)})}resolveTargetPath(e,r){return r instanceof g?r.name:r instanceof E?r.getIdentifierPath()?.path??null:r instanceof B?this.resolveIndexPath(e,r):null}assignTarget(e,r,s,i="="){if(!(!e.scope||!e.scope.setPath)){if(r instanceof x){this.assignDirectiveTarget(e,r,s,i);return}if(r instanceof A){let n=r.element.evaluate(e),a=f(n,o=>{let c=z(o);c&&this.assignDirectiveTarget({...e,element:c},r.directive,s,i)});D(a);return}if(r instanceof J){let n=r.element.evaluate(e),a=f(n,o=>{if(o&&typeof o=="object"&&o.__scope){o.__scope.setPath?.(r.property,s);return}let c=z(o);c&&(c[r.property]=s)});D(a);return}if(r instanceof g){e.scope.setPath(r.name,s);return}if(r instanceof _){let n=Array.isArray(s)?s:[],a=0;for(let o of r.elements){if(o instanceof V){e.scope.setPath(o.target.name,n.slice(a));return}if(o===null){a+=1;continue}this.assignTarget(e,o,n[a],i),a+=1}return}if(r instanceof q){let n=s&&typeof s=="object"?s:{},a=new Set;for(let o of r.entries){if("rest"in o){let c={};for(let l of Object.keys(n))a.has(l)||(c[l]=n[l]);e.scope.setPath(o.rest.name,c);continue}a.add(o.key),this.assignTarget(e,o.target,n[o.key],i)}return}}}assignDirectiveTarget(e,r,s,i="="){let n=e.element;if(n){if(r.kind==="attr"){if(r.name==="class"&&"classList"in n&&i!=="="){let a=Ce(s);if(a.length===0)return;if(i==="+="){n.classList.add(...a);return}if(i==="-="){n.classList.remove(...a);return}if(i==="~="){for(let o of a)n.classList.toggle(o);return}}if(r.name==="value"){if(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement){n.value=s==null?"":String(s),n.setAttribute("value",n.value);return}if(n instanceof HTMLSelectElement){n.value=s==null?"":String(s);return}}if(r.name==="checked"&&n instanceof HTMLInputElement){let a=s===!0||s==="true"||s===1||s==="1";n.checked=a,a?n.setAttribute("checked",""):n.removeAttribute("checked");return}if(r.name==="html"&&n instanceof HTMLElement){n.innerHTML=s==null?"":String(s);return}n.setAttribute(r.name,s==null?"":String(s));return}r.kind==="style"&&n instanceof HTMLElement&&n.style.setProperty(r.name,s==null?"":String(s))}}};function Ce(p){return p==null?[]:Array.isArray(p)?p.flatMap(t=>String(t).split(/\s+/)).map(t=>t.trim()).filter(Boolean):String(p).split(/\s+/).map(t=>t.trim()).filter(Boolean)}var O=class extends m{constructor(e){super("Return");this.value=e}evaluate(e){if(e.returning)return e.returnValue;let r=this.value?this.value.evaluate(e):void 0;return f(r,s=>(e.returnValue=s,e.returning=!0,e.returnValue))}},ie=class extends m{constructor(){super("Break")}evaluate(t){t.breaking=!0}},ne=class extends m{constructor(){super("Continue")}evaluate(t){t.continuing=!0}},be=class extends Error{constructor(t="Assertion failed"){super(t),this.name="AssertError"}},ae=class extends m{constructor(e){super("Assert");this.test=e}evaluate(e){let r=this.test.evaluate(e);return f(r,s=>{if(!s)throw new be;return s})}},oe=class extends m{constructor(e,r,s){super("If");this.test=e;this.consequent=r;this.alternate=s}evaluate(e){let r=this.test.evaluate(e);return f(r,s=>{if(s)return ke(e,this.consequent);if(this.alternate)return ke(e,this.alternate)})}},ce=class extends m{constructor(e,r){super("While");this.test=e;this.body=r}evaluate(e){let r=e.scope;e.scope?.createChild&&(e.scope=e.scope.createChild());let s=()=>{let n=this.test.evaluate(e);return f(n,a=>{if(!a||e.returning)return;let o=this.body.evaluate(e);return f(o,()=>{if(e.breaking){e.breaking=!1;return}return e.continuing&&(e.continuing=!1),s()})})},i=s();return D(i)?i.finally(()=>{e.scope=r}):(e.scope=r,i)}},pe=class extends m{constructor(e,r,s,i){super("ForEach");this.target=e;this.iterable=r;this.kind=s;this.body=i}evaluate(e){let r=this.iterable.evaluate(e);return f(r,s=>{let i=this.getEntries(s),n=e.scope,a=e.scope;e.scope?.createChild&&(a=e.scope.createChild());let o=0,c=()=>{if(o>=i.length||e.returning){e.scope=n;return}let l=i[o];o+=1,e.scope=a,e.scope?.setPath?.(this.target.name,l);let h=this.body.evaluate(e);return f(h,()=>{if(e.breaking){e.breaking=!1,e.scope=n;return}return e.continuing&&(e.continuing=!1),e.scope=n,c()})};return c()})}getEntries(e){return e==null?[]:this.kind==="in"?typeof e=="object"?Object.keys(e):[]:typeof e=="string"||typeof e[Symbol.iterator]=="function"?Array.from(e):typeof e=="object"?Object.values(e):[]}},le=class extends m{constructor(e,r,s,i){super("For");this.init=e;this.test=r;this.update=s;this.body=i}evaluate(e){let r=this.init?this.init.evaluate(e):void 0,s=()=>{let i=e.scope,n=e.scope;e.scope?.createChild&&(n=e.scope.createChild());let a=()=>{let o=this.test?this.test.evaluate(e):!0;return f(o,c=>{if(!c||e.returning){e.scope=i;return}e.scope=n;let l=this.body.evaluate(e);return f(l,()=>{if(e.returning){e.scope=i;return}if(e.breaking){e.breaking=!1,e.scope=i;return}e.scope=i,e.continuing&&(e.continuing=!1);let h=this.update?this.update.evaluate(e):void 0;return f(h,()=>a())})})};return a()};return f(r,()=>s())}},he=class extends m{constructor(e,r,s){super("Try");this.body=e;this.errorName=r;this.handler=s}evaluate(e){let r=s=>{if(e.returning)return e.returnValue;let i=e.scope,n=e.scope;e.scope?.createChild&&(n=e.scope.createChild()),e.scope=n;let a=e.scope,o;a&&(o=a.getPath(this.errorName),a.setPath&&a.setPath(`self.${this.errorName}`,s));let c=this.handler.evaluate(e);return f(c,()=>{a&&a.setPath&&n===i&&a.setPath(this.errorName,o),e.scope=i})};try{let s=ke(e,this.body);return D(s)?s.catch(i=>r(i)):s}catch(s){return r(s)}}},$=class extends m{constructor(e,r,s,i=!1){super("FunctionDeclaration");this.name=e;this.params=r;this.body=s;this.isAsync=i}},M=class extends m{constructor(e,r,s=!1){super("FunctionExpression");this.params=e;this.body=r;this.isAsync=s}evaluate(e){let r=e.scope,s=e.globals,i=e.element;return this.isAsync?(...n)=>{let a=r?.createChild?r.createChild():r,o={scope:a,rootScope:e.rootScope,...s?{globals:s}:{},...i?{element:i}:{},...e.self?{self:e.self}:{},returnValue:void 0,returning:!1,breaking:!1,continuing:!1},c=new Map,l=a?this.applyParams(a,c,o,n):void 0,h=f(l,()=>this.body.evaluate(o)),d=f(h,()=>o.returnValue);return Promise.resolve(d).finally(()=>{a&&a===r&&this.restoreParams(a,c)})}:(...n)=>{let a=r?.createChild?r.createChild():r,o={scope:a,rootScope:e.rootScope,...s?{globals:s}:{},...i?{element:i}:{},...e.self?{self:e.self}:{},returnValue:void 0,returning:!1,breaking:!1,continuing:!1},c=new Map,l=a?this.applyParams(a,c,o,n):void 0,h=f(l,()=>this.body.evaluate(o)),d=f(h,()=>o.returnValue);return D(d)?d.finally(()=>{a&&a===r&&this.restoreParams(a,c)}):(a&&a===r&&this.restoreParams(a,c),d)}}applyParams(e,r,s,i){if(!e)return;let n=e.setPath?.bind(e);if(!n)return;let a=this.params,o=(c,l)=>{for(let h=c;h<a.length;h+=1){let d=a[h],y=d.name;if(!y)continue;if(r.set(y,e.getPath(y)),d.rest){n(`self.${y}`,i.slice(l));return}let v=i[l];if(v===void 0&&d.defaultValue){let N=d.defaultValue.evaluate(s);return f(N,R=>(n(`self.${y}`,R),o(h+1,l+1)))}n(`self.${y}`,v),l+=1}};return o(0,0)}restoreParams(e,r){if(!e)return;let s=e.setPath?.bind(e);if(s)for(let i of this.params){let n=i.name;n&&s(n,r.get(n))}}},U=class extends m{constructor(e,r,s,i,n){super("Declaration");this.target=e;this.operator=r;this.value=s;this.flags=i;this.flagArgs=n}},g=class extends m{constructor(e){super("Identifier");this.name=e}evaluate(e){if(this.name==="self")return e.self??e.element??e.scope;if(this.name.startsWith("root.")&&e.rootScope){let r=this.name.slice(5);return e.rootScope.getPath(`self.${r}`)}if(e.scope){let r=e.scope.getPath(this.name),s=this.name.split(".")[0];if(this.name.startsWith("parent.")||this.name.startsWith("root.")||this.name.startsWith("self.")||r!==void 0||s&&e.scope.hasKey?.(s))return r}return e.globals?e.globals[this.name]:void 0}},G=class extends m{constructor(e){super("ElementRef");this.id=e}evaluate(e){let r=e.element?.ownerDocument??(typeof document<"u"?document:void 0);if(!r)return;let s=r.getElementById(this.id);if(!s)return;let i=globalThis.VSNEngine,n=i?.getScope?i.getScope(s):void 0;return{__element:s,__scope:n}}},K=class extends m{constructor(e){super("SpreadElement");this.value=e}},V=class extends m{constructor(e){super("RestElement");this.target=e}},_=class extends m{constructor(e){super("ArrayPattern");this.elements=e}},q=class extends m{constructor(e){super("ObjectPattern");this.entries=e}},b=class extends m{constructor(e){super("Literal");this.value=e}evaluate(){return this.value}},Q=class extends m{constructor(e){super("TemplateExpression");this.parts=e}evaluate(e){let r="",s=0,i=()=>{for(;s<this.parts.length;){let n=this.parts[s];s+=1;let a=n.evaluate(e);return f(a,o=>(r+=o==null?"":String(o),i()))}return r};return i()}getTemplateParts(e){let r=[],s=[];for(let i of this.parts){if(i instanceof b){r.push(String(i.value??""));continue}s.push(i?.evaluate(e))}return{strings:r,values:s}}},ue=class extends m{constructor(e,r){super("TaggedTemplateExpression");this.tag=e;this.template=r}evaluate(e){let r=this.tag.evaluate(e);return f(r,s=>{if(typeof s!="function")return;let{strings:i,values:n}=this.template.getTemplateParts(e);return s(i,...n)})}},Z=class extends m{constructor(e,r){super("UnaryExpression");this.operator=e;this.argument=r}evaluate(e){let r=this.argument.evaluate(e);return f(r,s=>this.operator==="!"?!s:this.operator==="-"?-s:s)}},w=class extends m{constructor(e,r,s){super("BinaryExpression");this.operator=e;this.left=r;this.right=s}evaluate(e){let r=this.left.evaluate(e);return f(r,s=>{if(this.operator==="&&")return s&&this.right.evaluate(e);if(this.operator==="||")return s||this.right.evaluate(e);if(this.operator==="??")return s??this.right.evaluate(e);let i=this.right.evaluate(e);return f(i,n=>{if(this.operator==="+")return s+n;if(this.operator==="-")return s-n;if(this.operator==="*")return s*n;if(this.operator==="/")return s/n;if(this.operator==="%")return s%n;if(this.operator==="==")return s==n;if(this.operator==="!=")return s!=n;if(this.operator==="===")return s===n;if(this.operator==="!==")return s!==n;if(this.operator==="<")return s<n;if(this.operator===">")return s>n;if(this.operator==="<=")return s<=n;if(this.operator===">=")return s>=n})})}},fe=class extends m{constructor(e,r,s){super("TernaryExpression");this.test=e;this.consequent=r;this.alternate=s}evaluate(e){let r=this.test.evaluate(e);return f(r,s=>s?this.consequent.evaluate(e):this.alternate.evaluate(e))}},E=class p extends m{constructor(e,r,s=!1){super("MemberExpression");this.target=e;this.property=r;this.optional=s}evaluate(e){let r=this.resolve(e);return f(r,s=>s?.value)}resolve(e){let r=this.getIdentifierPath();if(r){let i=this.resolveFromScope(e,r);if(i)return i;let n=this.resolveFromGlobals(e,r);if(n)return n}let s=this.target.evaluate(e);return f(s,i=>i==null?{value:void 0,target:i,optional:this.optional}:{value:i[this.property],target:i,optional:this.optional})}getIdentifierPath(){let e=this.getTargetIdentifierPath();return e?{path:`${e.path}.${this.property}`,root:e.root}:void 0}getTargetIdentifierPath(){if(this.target instanceof g){let e=this.target.name,r=e.split(".")[0];return r?{path:e,root:r}:void 0}if(this.target instanceof p)return this.target.getIdentifierPath()}resolveFromScope(e,r){if(!e.scope)return;if(r.path.startsWith("root.")&&e.rootScope){let o=r.path.slice(5),c=e.rootScope.getPath(`self.${o}`),l=o.split(".").slice(0,-1).join("."),h=l?e.rootScope.getPath(`self.${l}`):e.rootScope;return{value:c,target:h,optional:this.optional}}let s=e.scope.getPath(r.path);if(!(r.path.startsWith("parent.")||r.path.startsWith("root.")||r.path.startsWith("self."))&&s===void 0&&!e.scope.hasKey?.(r.root))return;let n=this.getTargetPath(r.path),a=n?e.scope.getPath(n):void 0;return{value:s,target:a,optional:this.optional}}resolveFromGlobals(e,r){let s=e.globals??{};if(!r.root||!(r.root in s))return;let i=s[r.root],n,a=r.path.split(".");for(let o=1;o<a.length;o+=1){n=i;let c=a[o];if(!c)return{value:void 0,target:n,optional:this.optional};i=i?.[c]}return{value:i,target:n,optional:this.optional}}getTargetPath(e){let r=e.split(".");if(!(r.length<=1))return r.slice(0,-1).join(".")}},S=class extends m{constructor(e,r){super("CallExpression");this.callee=e;this.args=r}evaluate(e){let r=this.resolveCallee(e);return f(r,s=>{let i=s?.fn??this.callee.evaluate(e);return f(i,n=>{if(typeof n!="function")return;let a=[],o=c=>{for(let l=c;l<this.args.length;l+=1){let d=this.args[l].evaluate(e);return f(d,y=>(a.push(y),o(l+1)))}return n.apply(s?.thisArg,a)};return o(0)})})}resolveCallee(e){if(this.callee instanceof E){let c=this.callee.resolve(e);return f(c,l=>{if(l)return{fn:l.value,thisArg:l.target}})}if(!(this.callee instanceof g))return;let r=this.callee.name,s=e.globals??{},i=r.split("."),n=i[0];if(!n||!(n in s)){if(i.length>1&&e.scope){let c=i.slice(0,-1).join("."),l=i[i.length-1];if(!l)return;let h=e.scope.getPath(c);return h==null?void 0:{fn:h?.[l],thisArg:h}}return}let a=s[n],o;for(let c=1;c<i.length;c+=1){o=a;let l=i[c];if(!l)return;a=a?.[l]}return{fn:a,thisArg:o}}},de=class extends m{constructor(e){super("ArrayExpression");this.elements=e}evaluate(e){let r=[],s=n=>{if(n==null)return;if(typeof n[Symbol.iterator]=="function")for(let o of n)r.push(o);else r.push(n)},i=n=>{for(let a=n;a<this.elements.length;a+=1){let o=this.elements[a];if(o instanceof K){let l=o.value.evaluate(e);return f(l,h=>(s(h),i(a+1)))}let c=o.evaluate(e);return f(c,l=>(r.push(l),i(a+1)))}return r};return i(0)}},me=class extends m{constructor(e){super("ObjectExpression");this.entries=e}evaluate(e){let r={},s=i=>{for(let n=i;n<this.entries.length;n+=1){let a=this.entries[n];if("spread"in a){let c=a.spread.evaluate(e);return f(c,l=>(l!=null&&Object.assign(r,l),s(n+1)))}if("computed"in a&&a.computed){let c=a.keyExpr.evaluate(e);return f(c,l=>{let h=a.value.evaluate(e);return f(h,d=>(r[String(l)]=d,s(n+1)))})}let o=a.value.evaluate(e);return f(o,c=>(r[a.key]=c,s(n+1)))}return r};return s(0)}},B=class extends m{constructor(e,r){super("IndexExpression");this.target=e;this.index=r}evaluate(e){let r=this.target.evaluate(e);return f(r,s=>{if(s==null)return;let i=this.index.evaluate(e);return f(i,n=>{if(n==null)return;let a=this.normalizeIndexKey(s,n);return s[a]})})}normalizeIndexKey(e,r){if(Array.isArray(e)&&typeof r=="string"&&r.trim()!==""){let s=Number(r);if(!Number.isNaN(s))return s}return r}},x=class extends m{constructor(e,r){super("Directive");this.kind=e;this.name=r}evaluate(e){let r=e.element;if(!r)return`${this.kind}:${this.name}`;if(this.kind==="attr")return this.name==="value"&&(r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement||r instanceof HTMLSelectElement)?r.value:this.name==="text"&&r instanceof HTMLElement?r.innerText:this.name==="content"&&r instanceof HTMLElement?r.textContent??"":this.name==="checked"&&r instanceof HTMLInputElement?r.checked:this.name==="html"&&r instanceof HTMLElement?r.innerHTML:r.getAttribute(this.name)??void 0;if(this.kind==="style"&&r instanceof HTMLElement)return r.style.getPropertyValue(this.name)??void 0}},A=class extends m{constructor(e,r){super("ElementDirective");this.element=e;this.directive=r}evaluate(e){let r=this.element.evaluate(e);return f(r,s=>{let i=z(s);if(!i)return;let n={...e,element:i};return this.directive.evaluate(n)})}},J=class extends m{constructor(e,r){super("ElementProperty");this.element=e;this.property=r}evaluate(e){let r=this.element.evaluate(e);return f(r,s=>{if(s&&typeof s=="object"&&s.__scope)return s.__scope.getPath?.(this.property);let i=z(s);if(i)return i[this.property]})}};function z(p){if(p&&typeof p=="object"){let t=p.__element;if(t&&typeof t=="object"&&t.nodeType===1)return t;if(p.nodeType===1)return p}}var Y=class extends m{constructor(e){super("AwaitExpression");this.argument=e}evaluate(e){let r=this.argument.evaluate(e);return Promise.resolve(r)}},ge=class extends m{constructor(e,r){super("Query");this.direction=e;this.selector=r}evaluate(e){let r=this.selector.trim();if(!r)return[];if(this.direction==="ancestor"){let i=[],n=e.element?.parentElement;for(;n;)n.matches(r)&&i.push(n),n=n.parentElement;return i}let s=this.direction==="descendant"?e.element??(typeof document<"u"?document:void 0):typeof document<"u"?document:void 0;return!s||!("querySelectorAll"in s)?[]:Array.from(s.querySelectorAll(r))}};var ye=class{constructor(t){this.tokens=t}index=0;peek(t=0){return this.tokens[this.index+t]??null}next(){let t=this.tokens[this.index++];if(!t)throw new Error("Unexpected end of input");return t}eof(){return this.index>=this.tokens.length}match(t){return this.peek()?.type===t?(this.next(),!0):!1}expect(t){let e=this.next();if(e.type!==t)throw new Error(`Expected ${t} but got ${e.type}`);return e}skipWhitespace(){for(;this.peek()?.type==="Whitespace";)this.next()}peekNonWhitespace(t=0){let e=0;for(let r=this.index;r<this.tokens.length;r++){let s=this.tokens[r];if(s&&s.type!=="Whitespace"){if(e===t)return s;e+=1}}return null}indexAfterDelimited(t,e,r=0){let s=this.peekNonWhitespace(r);if(!s||s.type!==t)return null;let i=r+1,n=1;for(;;){let a=this.peekNonWhitespace(i);if(!a)return null;if(a.type===t)n+=1;else if(a.type===e&&(n-=1,n===0))return i+1;i+=1}}};var L=class p{stream;source;customFlags;behaviorFlags;allowImplicitSemicolon=!1;awaitStack=[];functionDepth=0;constructor(t,e){this.source=t,this.customFlags=e?.customFlags??new Set(["important","debounce"]),this.behaviorFlags=e?.behaviorFlags??new Set;let r=new j(t);this.stream=new ye(r.tokenize())}static parseInline(t){return new p(`{${t}}`).parseInlineBlock()}parseProgram(){return this.wrapErrors(()=>{let t=[],e=[];for(this.stream.skipWhitespace();!this.stream.eof();){let r=this.stream.peek();if(!r)break;r.type==="Use"?e.push(this.parseUseStatement()):t.push(this.parseBehavior()),this.stream.skipWhitespace()}return new te(t,e)})}parseInlineBlock(){return this.wrapErrors(()=>(this.stream.skipWhitespace(),this.allowImplicitSemicolon=!0,this.parseBlock({allowDeclarations:!1})))}parseBehavior(){return this.wrapErrors(()=>{this.stream.skipWhitespace(),this.stream.expect("Behavior");let t=this.parseSelector(),{flags:e,flagArgs:r}=this.parseBehaviorFlags(),s=this.parseBlock({allowDeclarations:!0});return new H(t,s,e,r)})}parseSelector(){let t="",e=!1;for(;;){let r=this.stream.peek();if(!r||r.type==="LBrace"||r.type==="Bang")break;if(r.type==="Whitespace"){this.stream.next(),e&&t[t.length-1]!==" "&&(t+=" ");continue}e=!0,t+=this.stream.next().value}if(!t.trim())throw new Error("Behavior selector is required");return new se(t.trim())}parseBehaviorFlags(){let t=this.parseFlags(this.behaviorFlags,"behavior modifier");return{flags:t.flags,flagArgs:t.flagArgs}}parseUseStatement(){return this.wrapErrors(()=>{this.stream.expect("Use"),this.stream.skipWhitespace();let t=this.parseIdentifierPath();this.stream.skipWhitespace();let e=t,r=this.stream.peek();r?.type==="Identifier"&&r.value==="as"&&(this.stream.next(),this.stream.skipWhitespace(),e=this.stream.expect("Identifier").value);let{flags:s,flagArgs:i}=this.parseUseFlags();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new re(t,e,s,i)})}parseUseFlags(){let t={},e={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let r=this.stream.expect("Identifier").value;if(r!=="wait")throw new Error(`Unknown flag ${r}`);if(t.wait=!0,this.stream.peek()?.type==="LParen"){this.stream.next(),this.stream.skipWhitespace();let s=this.stream.expect("Number"),i=Number(s.value),n;if(this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next(),this.stream.skipWhitespace();let a=this.stream.expect("Number");n=Number(a.value),this.stream.skipWhitespace()}this.stream.expect("RParen"),e.wait={timeoutMs:i,...n!==void 0?{intervalMs:n}:{}}}}return{flags:t,flagArgs:e}}wrapErrors(t){try{return t()}catch(e){throw e instanceof Error&&!/\(line\s+\d+, column\s+\d+\)/i.test(e.message)?new Error(this.formatError(e.message)):e}}formatError(t){let e=this.stream.peek()??this.stream.peekNonWhitespace(0);if(!e)return`Parse error: ${t}`;let r=e.start.line,s=e.start.column,i=this.getLineSnippet(r,s);return`Parse error (line ${r}, column ${s}): ${t}
${i}`}getLineSnippet(t,e){let s=this.source.split(/\r?\n/)[t-1]??"",i=`${" ".repeat(Math.max(e-1,0))}^`;return`${s}
${i}`}parseBlock(t){let e=t?.allowDeclarations??!1,r=t?.allowReturn??this.functionDepth>0;this.stream.skipWhitespace(),this.stream.expect("LBrace");let s=[],i=e,n=!1,a=!1,o=!1;for(;;){this.stream.skipWhitespace();let c=this.stream.peek();if(!c)throw new Error("Unterminated block");if(c.type==="RBrace"){this.stream.next();break}if(e&&c.type==="Behavior"&&(o=!0),e&&o&&c.type!=="Behavior")throw new Error("Nested behaviors must appear after construct, function, and on blocks");if(e&&this.isFunctionDeclarationStart()){n||(a=!0),s.push(this.parseFunctionDeclaration());continue}if(e&&this.isFunctionExpressionAssignmentStart()){if(!i)throw new Error("Declarations must appear before blocks");s.push(this.parseAssignment());continue}if(this.isDeclarationStart()){if(!e)throw new Error("Declarations are only allowed at the behavior root");if(!i)throw new Error("Declarations must appear before blocks");s.push(this.parseDeclaration())}else{if(i&&(i=!1),e&&c.type==="On"&&!n&&(a=!0),e&&c.type==="Construct"){if(a)throw new Error("Construct blocks must appear before functions and on blocks");n=!0}s.push(this.parseStatement({allowReturn:r}))}}return new k(s)}parseStatement(t){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unexpected end of input");let r=t?.allowBlocks??!0,s=t?.allowReturn??!1;if(e.type==="Return"){if(!s)throw new Error("Return is only allowed inside functions");return this.parseReturnStatement()}if(e.type==="Assert")return this.parseAssertStatement();if(e.type==="Break")return this.parseBreakStatement();if(e.type==="Continue")return this.parseContinueStatement();if(r&&e.type==="On")return this.parseOnBlock();if(r&&e.type==="If")return this.parseIfBlock();if(r&&e.type==="For")return this.parseForBlock();if(r&&e.type==="While")return this.parseWhileBlock();if(r&&e.type==="Try")return this.parseTryBlock();if(r&&e.type==="Construct")return this.parseConstructBlock();if(r&&e.type==="Destruct")return this.parseDestructBlock();if(r&&e.type==="Behavior")return this.parseBehavior();if(this.isAwaitAllowed()&&e.type==="Identifier"&&e.value==="await")return this.parseExpressionStatement();if(this.isAssignmentStart())return this.parseAssignment();if(this.isExpressionStatementStart())return this.parseExpressionStatement();throw new Error(`Unexpected token ${e.type}`)}parseOnBlock(){this.stream.expect("On"),this.stream.skipWhitespace();let t=this.parseIdentifierPath(),e=this.parseOnFlags();this.stream.skipWhitespace(),this.stream.expect("LParen");let r=[];for(;;){this.stream.skipWhitespace();let o=this.stream.peek();if(!o)throw new Error("Unterminated on() arguments");if(o.type==="RParen"){this.stream.next();break}if(o.type==="Identifier"){r.push(this.stream.next().value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next();continue}throw new Error(`Unexpected token in on() args: ${o.type}`)}let s=this.parseOnFlags(),i={...e.flags,...s.flags},n={...e.flagArgs,...s.flagArgs},a=this.parseBlock({allowDeclarations:!1});return new T(t,r,a,i,n)}parseOnFlags(){let t={},e={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let r=this.stream.expect("Identifier").value;if(this.customFlags&&!this.customFlags.has(r))throw new Error(`Unknown flag ${r}`);if(t[r]=!0,this.stream.skipWhitespace(),this.stream.peekNonWhitespace(0)?.type!=="LParen")continue;let i=this.stream.peekNonWhitespace(1);if(i?.type==="Identifier"||i?.type==="RParen")continue;let n=this.parseCustomFlagArg();n!==void 0&&(e[r]=n)}return{flags:t,flagArgs:e}}parseAssignment(){let t=this.parseAssignmentTarget();this.stream.skipWhitespace();let e=this.parseAssignmentOperator();this.stream.skipWhitespace();let r=this.parseExpression();return this.consumeStatementTerminator(),new F(t,r,e)}parseExpression(){return this.parsePipeExpression()}parsePipeExpression(){let t=this.parseTernaryExpression();for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Pipe";){this.stream.next(),this.stream.skipWhitespace();let e=!1,r=this.stream.peek();this.isAwaitAllowed()&&r?.type==="Identifier"&&r.value==="await"&&(this.stream.next(),this.stream.skipWhitespace(),e=!0);let s=this.parseCallExpression(),i=this.buildPipeCall(t,s);t=e?new Y(i):i}return t}buildPipeCall(t,e){if(e instanceof S)return new S(e.callee,[t,...e.args]);if(e instanceof g||e instanceof E)return new S(e,[t]);throw new Error("Pipe operator requires a function call")}parseTernaryExpression(){let t=this.parseNullishExpression();if(this.stream.skipWhitespace(),this.stream.peek()?.type!=="Question")return t;this.stream.next(),this.stream.skipWhitespace();let e=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let r=this.parseExpression();return new fe(t,e,r)}parseNullishExpression(){let t=this.parseLogicalOrExpression();for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="NullishCoalesce";){this.stream.next(),this.stream.skipWhitespace();let e=this.parseLogicalOrExpression();t=new w("??",t,e)}return t}parseLogicalOrExpression(){let t=this.parseLogicalAndExpression();for(this.stream.skipWhitespace();;){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Or")break;this.stream.skipWhitespace(),this.stream.next(),this.stream.skipWhitespace();let r=this.parseLogicalAndExpression();this.stream.skipWhitespace(),t=new w("||",t,r)}return t}parseLogicalAndExpression(){let t=this.parseEqualityExpression();for(this.stream.skipWhitespace();;){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="And")break;this.stream.skipWhitespace(),this.stream.next(),this.stream.skipWhitespace();let r=this.parseEqualityExpression();this.stream.skipWhitespace(),t=new w("&&",t,r)}return t}parseEqualityExpression(){let t=this.parseComparisonExpression();for(this.stream.skipWhitespace();;){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="DoubleEquals"&&e.type!=="NotEquals"&&e.type!=="TripleEquals"&&e.type!=="StrictNotEquals")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseComparisonExpression();this.stream.skipWhitespace();let i="==";r.type==="NotEquals"?i="!=":r.type==="TripleEquals"?i="===":r.type==="StrictNotEquals"&&(i="!=="),t=new w(i,t,s)}return t}parseComparisonExpression(){let t=this.parseAdditiveExpression();for(this.stream.skipWhitespace();;){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Less"&&e.type!=="Greater"&&e.type!=="LessEqual"&&e.type!=="GreaterEqual")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseAdditiveExpression();this.stream.skipWhitespace();let i="<";r.type==="Greater"?i=">":r.type==="LessEqual"?i="<=":r.type==="GreaterEqual"&&(i=">="),t=new w(i,t,s)}return t}parseMultiplicativeExpression(){let t=this.parseUnaryExpression();for(this.stream.skipWhitespace();;){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Star"&&e.type!=="Slash"&&e.type!=="Percent")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseUnaryExpression();this.stream.skipWhitespace();let i="*";r.type==="Slash"?i="/":r.type==="Percent"&&(i="%"),t=new w(i,t,s)}return t}parseAdditiveExpression(){let t=this.parseMultiplicativeExpression();for(this.stream.skipWhitespace();;){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Plus"&&e.type!=="Minus")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseMultiplicativeExpression();this.stream.skipWhitespace(),t=new w(r.type==="Plus"?"+":"-",t,s)}return t}parseUnaryExpression(){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Expected expression");if(t.type==="PlusPlus"||t.type==="MinusMinus"){this.stream.next();let e=this.parseUnaryExpression();return this.createIncrementNode(t,e,!0)}if(t.type==="Bang"){this.stream.next();let e=this.parseUnaryExpression();return new Z("!",e)}if(t.type==="Minus"){this.stream.next();let e=this.parseUnaryExpression();return new Z("-",e)}if(this.isAwaitAllowed()&&t.type==="Identifier"&&t.value==="await"){this.stream.next();let e=this.parseUnaryExpression();return new Y(e)}return this.parsePostfixExpression()}parsePostfixExpression(){let t=this.parseCallExpression();for(;;){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)break;if(e.type==="PlusPlus"||e.type==="MinusMinus"){this.stream.next(),t=this.createIncrementNode(e,t,!1);continue}break}return t}createIncrementNode(t,e,r){if(!(e instanceof g)&&!(e instanceof E)&&!(e instanceof B)&&!(e instanceof x)&&!(e instanceof A))throw new Error("Increment/decrement requires a mutable target");let s=t.type==="PlusPlus"?"++":"--";return new F(e,new b(1),s,r)}parseCallExpression(){let t=this.parsePrimaryExpression();for(;;){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)break;if(e.type==="Template"){let r=this.parseTemplateExpression();if(!(r instanceof Q))throw new Error("Expected template literal");t=new ue(t,r);continue}if(e.type==="LParen"){this.stream.next();let r=[];for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated call expression");if(s.type==="RParen"){this.stream.next();break}if(r.push(this.parseExpression()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in call arguments")}t=new S(t,r);continue}if(e.type==="OptionalChain"){this.stream.next(),this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Expected property or call after ?.");if(r.type==="LParen"){this.stream.next();let s=[];for(;;){this.stream.skipWhitespace();let i=this.stream.peek();if(!i)throw new Error("Unterminated call expression");if(i.type==="RParen"){this.stream.next();break}if(s.push(this.parseExpression()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in call arguments")}t=new S(t,s);continue}if(r.type==="Identifier"){let s=this.stream.next();t=new E(t,s.value,!0);continue}throw new Error("Expected property or call after ?.")}if(e.type==="Dot"){this.stream.next();let r=this.stream.peek();if(r?.type==="At"||r?.type==="Dollar"){let s=this.parseDirectiveExpression();t=new A(t,s)}else{let s=this.stream.expect("Identifier");t instanceof G?t=new J(t,s.value):t=new E(t,s.value)}continue}if(e.type==="LBracket"){this.stream.next(),this.stream.skipWhitespace();let r=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RBracket"),t=new B(t,r);continue}break}return t}parsePrimaryExpression(){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Expected expression");if(t.type==="At"||t.type==="Dollar")return this.parseDirectiveExpression();if(t.type==="Hash")return this.parseElementRefExpression();if(t.type==="Question")return this.parseQueryExpression();if(t.type==="LBracket")return this.parseArrayExpression();if(t.type==="LBrace")return this.parseObjectExpression();if(t.type==="LParen"){if(this.isArrowFunctionStart())return this.parseArrowFunctionExpression();this.stream.next();let e=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("RParen"),e}if(t.type==="Identifier")return this.isAsyncToken(t)&&this.isAsyncArrowFunctionStart()?(this.stream.next(),this.stream.skipWhitespace(),this.parseArrowFunctionExpression(!0)):new g(this.stream.next().value);if(t.type==="Boolean")return new b(this.stream.next().value==="true");if(t.type==="Null")return this.stream.next(),new b(null);if(t.type==="Number")return new b(Number(this.stream.next().value));if(t.type==="String")return new b(this.stream.next().value);if(t.type==="Template")return this.parseTemplateExpression();throw new Error(`Unsupported expression token ${t.type}`)}parseDirectiveExpression(){let t=this.stream.peek();if(!t||t.type!=="At"&&t.type!=="Dollar")throw new Error("Expected directive");let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new x(e,r.value)}parseElementRefExpression(){this.stream.expect("Hash");let t=this.stream.expect("Identifier").value;return new G(t)}parseArrayExpression(){this.stream.expect("LBracket");let t=[];for(;;){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unterminated array literal");if(e.type==="RBracket"){this.stream.next();break}if(e.type==="Ellipsis"){this.stream.next(),this.stream.skipWhitespace();let r=this.parseExpression();t.push(new K(r))}else t.push(this.parseExpression());if(this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){if(this.stream.next(),this.stream.skipWhitespace(),this.stream.peek()?.type==="RBracket"){this.stream.next();break}continue}if(this.stream.peek()?.type==="RBracket"){this.stream.next();break}throw new Error("Expected ',' or ']' in array literal")}return new de(t)}parseTemplateExpression(){let t=[];for(;;){let e=this.stream.peek();if(!e)throw new Error("Unterminated template literal");if(e.type!=="Template")throw new Error("Expected template literal");let r=this.stream.next().value;t.push(new b(r));let s=this.stream.peek();if(!s||s.type!=="Dollar")break;this.stream.next(),this.stream.expect("LBrace"),this.stream.skipWhitespace();let i=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RBrace"),t.push(i)}return new Q(t)}parseObjectExpression(){this.stream.expect("LBrace");let t=[];for(;;){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unterminated object literal");if(e.type==="RBrace"){this.stream.next();break}let r,s;if(e.type==="Ellipsis")this.stream.next(),this.stream.skipWhitespace(),s={spread:this.parseExpression()};else if(e.type==="LBracket"){this.stream.next(),this.stream.skipWhitespace();let i=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RBracket"),this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace(),r=this.parseExpression(),s={keyExpr:i,value:r,computed:!0}}else if(e.type==="Identifier"){let i=this.stream.next().value;this.stream.skipWhitespace(),this.stream.peek()?.type==="Colon"?(this.stream.next(),this.stream.skipWhitespace(),r=this.parseExpression()):r=new g(i),s={key:i,value:r}}else if(e.type==="String"){let i=this.stream.next().value;this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace(),r=this.parseExpression(),s={key:i,value:r}}else throw new Error(`Unexpected token in object literal: ${e.type}`);if(!s)throw new Error("Invalid object literal entry");if(t.push(s),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){if(this.stream.next(),this.stream.skipWhitespace(),this.stream.peek()?.type==="RBrace"){this.stream.next();break}continue}if(this.stream.peek()?.type==="RBrace"){this.stream.next();break}throw new Error("Expected ',' or '}' in object literal")}return new me(t)}consumeStatementTerminator(){this.stream.skipWhitespace();let t=this.stream.peek();if(t?.type==="Semicolon"){this.stream.next();return}this.allowImplicitSemicolon&&t?.type==="RBrace"||this.stream.expect("Semicolon")}parseFunctionBlockWithAwait(t){this.stream.expect("LBrace");let e=[];this.awaitStack.push(t),this.functionDepth+=1;try{for(;;){this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Unterminated function block");if(r.type==="RBrace"){this.stream.next();break}e.push(this.parseStatement({allowBlocks:!0,allowReturn:!0}))}}finally{this.functionDepth-=1,this.awaitStack.pop()}return new k(e)}isAsyncToken(t){return t?.type==="Identifier"&&t.value==="async"}isAwaitAllowed(){return this.awaitStack.length===0?!1:this.awaitStack[this.awaitStack.length-1]===!0}parseArrowExpressionBody(t){this.awaitStack.push(t);try{let e=this.parseExpression();return new k([new O(e)])}finally{this.awaitStack.pop()}}parseAssignmentTarget(){let t=this.stream.peek();if(!t)throw new Error("Expected assignment target");if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new x(e,r.value)}if(t.type==="LBracket")return this.parseArrayPattern();if(t.type==="LBrace")return this.parseObjectPattern();if(t.type==="Identifier"){let e=this.parseCallExpression();if(e instanceof S)throw new Error("Invalid assignment target CallExpression");if(e instanceof g||e instanceof E||e instanceof B||e instanceof A)return e;throw new Error("Invalid assignment target")}if(t.type==="Hash"){let e=this.parseCallExpression();if(e instanceof A)return e;throw new Error("Invalid assignment target")}throw new Error(`Invalid assignment target ${t.type}`)}parseArrayPattern(){this.stream.expect("LBracket");let t=[],e=!1;for(;;){this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Unterminated array pattern");if(r.type==="RBracket"){this.stream.next();break}if(r.type==="Comma"){this.stream.next(),t.push(null);continue}if(r.type==="Ellipsis"){if(e)throw new Error("Array patterns can only include one rest element");this.stream.next(),this.stream.skipWhitespace();let s=this.stream.expect("Identifier");t.push(new V(new g(s.value))),e=!0}else if(r.type==="LBracket")t.push(this.parseArrayPattern());else if(r.type==="LBrace")t.push(this.parseObjectPattern());else if(r.type==="Identifier")t.push(new g(this.parseIdentifierPath()));else throw new Error(`Unexpected token in array pattern: ${r.type}`);if(this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RBracket"){this.stream.next();break}throw new Error("Expected ',' or ']' in array pattern")}if(e&&!(t[t.length-1]instanceof V))throw new Error("Rest element must be last in array pattern");return new _(t)}parseObjectPattern(){this.stream.expect("LBrace");let t=[],e;for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated object pattern");if(s.type==="RBrace"){this.stream.next();break}if(s.type==="Ellipsis"){if(e)throw new Error("Object patterns can only include one rest element");this.stream.next(),this.stream.skipWhitespace();let i=this.stream.expect("Identifier");if(e=new g(i.value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&(this.stream.next(),this.stream.skipWhitespace()),this.stream.peek()?.type!=="RBrace")throw new Error("Rest element must be last in object pattern");this.stream.next();break}else if(s.type==="Identifier"||s.type==="String"){let n=this.stream.next().value;this.stream.skipWhitespace();let a;if(this.stream.peek()?.type==="Colon"){this.stream.next(),this.stream.skipWhitespace();let o=this.stream.peek();if(!o)throw new Error("Expected object pattern target");if(o.type==="LBracket")a=this.parseArrayPattern();else if(o.type==="LBrace")a=this.parseObjectPattern();else if(o.type==="Identifier")a=new g(this.parseIdentifierPath());else throw new Error(`Unexpected token in object pattern: ${o.type}`)}else a=new g(n);t.push({key:n,target:a})}else throw new Error(`Unexpected token in object pattern: ${s.type}`);if(this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){if(this.stream.next(),this.stream.skipWhitespace(),this.stream.peek()?.type==="RBrace"){this.stream.next();break}continue}if(this.stream.peek()?.type==="RBrace"){this.stream.next();break}throw new Error("Expected ',' or '}' in object pattern")}let r=e?[...t,{rest:e}]:t;return e&&t.length===0?new q([{rest:e}]):new q(r)}parseDeclaration(){let t=this.parseDeclarationTarget();this.stream.skipWhitespace();let e=this.parseDeclarationOperator();this.stream.skipWhitespace();let r=this.parseExpression(),{flags:s,flagArgs:i}=this.parseFlags(this.customFlags,"flag");return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new U(t,e,r,s,i)}parseDeclarationTarget(){let t=this.stream.peek();if(!t)throw new Error("Expected declaration target");if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new x(e,r.value)}if(t.type==="Identifier")return new g(this.stream.next().value);throw new Error(`Invalid declaration target ${t.type}`)}parseDeclarationOperator(){this.stream.expect("Colon");let t=this.stream.peek();return t?t.type==="Equals"?(this.stream.next(),":="):t.type==="Less"?(this.stream.next(),":<"):t.type==="Greater"?(this.stream.next(),":>"):":":":"}parseFlags(t,e){let r={},s={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let i=this.stream.expect("Identifier").value;if(t&&!t.has(i))throw new Error(`Unknown ${e} ${i}`);r[i]=!0;let n=this.parseCustomFlagArg();n!==void 0&&(s[i]=n)}return{flags:r,flagArgs:s}}parseCustomFlagArg(){if(this.stream.peek()?.type!=="LParen")return;if(this.stream.next(),this.stream.skipWhitespace(),!this.stream.peek())throw new Error("Unterminated flag arguments");let e=this.parseCustomFlagLiteral();return this.stream.skipWhitespace(),this.stream.expect("RParen"),e}parseCustomFlagLiteral(){let t=this.stream.peek();if(!t)throw new Error("Unterminated flag arguments");if(t.type==="Number")return Number(this.stream.next().value);if(t.type==="String")return this.stream.next().value;if(t.type==="Boolean")return this.stream.next().value==="true";if(t.type==="Identifier")return this.stream.next().value;if(t.type==="LBracket")return this.parseCustomFlagArray();if(t.type==="LBrace")return this.parseCustomFlagObject();throw new Error(`Unsupported flag argument ${t.type}`)}parseCustomFlagArray(){this.stream.expect("LBracket");let t=[];for(;;){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unterminated flag array");if(e.type==="RBracket"){this.stream.next();break}t.push(this.parseCustomFlagLiteral()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next()}return t}parseCustomFlagObject(){this.stream.expect("LBrace");let t={};for(;;){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unterminated flag object");if(e.type==="RBrace"){this.stream.next();break}let r;if(e.type==="Identifier"||e.type==="String")r=this.stream.next().value;else throw new Error(`Unsupported flag object key ${e.type}`);this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace(),t[r]=this.parseCustomFlagLiteral(),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next()}return t}isDeclarationStart(){let t=this.stream.peekNonWhitespace(0);if(!t)return!1;if(t.type==="Identifier")return this.stream.peekNonWhitespace(1)?.type==="Colon";if(t.type==="At"||t.type==="Dollar"){let e=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return e?.type==="Identifier"&&r?.type==="Colon"}return!1}isAssignmentStart(){let t=this.stream.peekNonWhitespace(0);if(!t)return!1;if(t.type==="Identifier"){let e=1;for(;;){let r=this.stream.peekNonWhitespace(e);if(!r)return!1;if(r.type==="Dot"){let s=this.stream.peekNonWhitespace(e+1);if(s?.type==="Identifier"){e+=2;continue}if(s?.type==="At"||s?.type==="Dollar"){if(this.stream.peekNonWhitespace(e+2)?.type!=="Identifier")return!1;e+=3;continue}return!1}if(r.type==="LBracket"){let s=this.stream.indexAfterDelimited("LBracket","RBracket",e);if(s===null)return!1;e=s;continue}break}return this.isAssignmentOperatorStart(e)}if(t.type==="At"||t.type==="Dollar")return this.stream.peekNonWhitespace(1)?.type==="Identifier"&&this.isAssignmentOperatorStart(2);if(t.type==="Hash"){let e=1;if(this.stream.peekNonWhitespace(e)?.type!=="Identifier")return!1;for(e+=1;;){let r=this.stream.peekNonWhitespace(e);if(!r)return!1;if(r.type==="Dot"){let s=this.stream.peekNonWhitespace(e+1);if(s?.type==="Identifier"){e+=2;continue}if(s?.type==="At"||s?.type==="Dollar"){if(this.stream.peekNonWhitespace(e+2)?.type!=="Identifier")return!1;e+=3;continue}return!1}if(r.type==="LBracket"){let s=this.stream.indexAfterDelimited("LBracket","RBracket",e);if(s===null)return!1;e=s;continue}break}return this.isAssignmentOperatorStart(e)}if(t.type==="LBrace"||t.type==="LBracket"){let e=[],r=0;for(;;){let s=this.stream.peekNonWhitespace(r);if(!s)return!1;if(s.type==="LBrace"||s.type==="LBracket")e.push(s.type);else if((s.type==="RBrace"||s.type==="RBracket")&&(e.pop(),e.length===0))return this.isAssignmentOperatorStart(r+1);r+=1}}return!1}isAssignmentOperatorStart(t){let e=this.stream.peekNonWhitespace(t);return e?e.type==="Equals"?!0:e.type==="Tilde"?this.stream.peekNonWhitespace(t+1)?.type==="Equals":e.type==="Plus"||e.type==="Minus"||e.type==="Star"||e.type==="Slash"?this.stream.peekNonWhitespace(t+1)?.type==="Equals":!1:!1}isExpressionStatementStart(){let t=this.stream.peekNonWhitespace(0);return t?t.type==="Identifier"?!0:t.type==="Number"||t.type==="String"||t.type==="Boolean"||t.type==="Null"||t.type==="LParen"||t.type==="LBracket"||t.type==="LBrace"||t.type==="At"||t.type==="Dollar"||t.type==="Hash"||t.type==="Question"||t.type==="Bang"||t.type==="Minus":!1}isFunctionDeclarationStart(){let t=this.stream.peekNonWhitespace(0);if(!t)return!1;let e=0;if(this.isAsyncToken(t)){let s=this.stream.peekNonWhitespace(1);if(!s||s.type!=="Identifier")return!1;e=1}else if(t.type!=="Identifier")return!1;if(e+=1,this.stream.peekNonWhitespace(e)?.type!=="LParen")return!1;let r=this.stream.indexAfterDelimited("LParen","RParen",e);return r===null?!1:this.stream.peekNonWhitespace(r)?.type==="LBrace"}isArrowFunctionStart(){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="LParen")return!1;let e=this.stream.indexAfterDelimited("LParen","RParen",0);return e===null?!1:this.stream.peekNonWhitespace(e)?.type==="Arrow"}isAsyncArrowFunctionStart(){let t=this.stream.peekNonWhitespace(0);if(!this.isAsyncToken(t)||this.stream.peekNonWhitespace(1)?.type!=="LParen")return!1;let e=this.stream.indexAfterDelimited("LParen","RParen",1);return e===null?!1:this.stream.peekNonWhitespace(e)?.type==="Arrow"}isFunctionExpressionAssignmentStart(){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Identifier"||this.stream.peekNonWhitespace(1)?.type!=="Equals")return!1;let e=2;if(this.isAsyncToken(this.stream.peekNonWhitespace(e))&&(e+=1),this.stream.peekNonWhitespace(e)?.type!=="LParen")return!1;let r=this.stream.indexAfterDelimited("LParen","RParen",e);return r===null?!1:this.stream.peekNonWhitespace(r)?.type==="Arrow"}parseExpressionStatement(){let t=this.parseExpression();return this.consumeStatementTerminator(),t}parseIfBlock(){this.stream.expect("If"),this.stream.skipWhitespace(),this.stream.expect("LParen"),this.stream.skipWhitespace();let t=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RParen");let e=this.parseConditionalBody();this.stream.skipWhitespace();let r;if(this.stream.peek()?.type==="Else")if(this.stream.next(),this.stream.skipWhitespace(),this.stream.peek()?.type==="If"){let s=this.parseIfBlock();r=new k([s])}else r=this.parseConditionalBody();return new oe(t,e,r)}parseConditionalBody(){if(this.stream.skipWhitespace(),this.stream.peek()?.type==="LBrace")return this.parseBlock({allowDeclarations:!1});let t=this.parseStatement({allowBlocks:!1,allowReturn:this.functionDepth>0});return new k([t])}parseWhileBlock(){this.stream.expect("While"),this.stream.skipWhitespace(),this.stream.expect("LParen"),this.stream.skipWhitespace();let t=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RParen");let e=this.parseBlock({allowDeclarations:!1});return new ce(t,e)}parseForBlock(){this.stream.expect("For"),this.stream.skipWhitespace(),this.stream.expect("LParen"),this.stream.skipWhitespace();let t=this.detectForEachKind();if(t){let n=this.parseForEachTarget();this.stream.skipWhitespace();let a=this.stream.expect("Identifier");if(a.value!==t)throw new Error(`Expected '${t}' but got '${a.value}'`);this.stream.skipWhitespace();let o=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RParen");let c=this.parseBlock({allowDeclarations:!1});return new pe(n,o,t,c)}let e;this.stream.peek()?.type!=="Semicolon"&&(e=this.parseForClause()),this.stream.skipWhitespace(),this.stream.expect("Semicolon"),this.stream.skipWhitespace();let r;this.stream.peek()?.type!=="Semicolon"&&(r=this.parseExpression()),this.stream.skipWhitespace(),this.stream.expect("Semicolon"),this.stream.skipWhitespace();let s;this.stream.peek()?.type!=="RParen"&&(s=this.parseForClause()),this.stream.skipWhitespace(),this.stream.expect("RParen");let i=this.parseBlock({allowDeclarations:!1});return new le(e,r,s,i)}detectForEachKind(){let t=0,e=0;for(;;){let r=this.stream.peekNonWhitespace(t);if(!r)return null;if(r.type==="LParen"||r.type==="LBracket"||r.type==="LBrace")e+=1;else if(r.type==="RParen"||r.type==="RBracket"||r.type==="RBrace"){if(e===0)return null;e-=1}if(e===0){if(r.type==="Semicolon")return null;if(r.type==="Identifier"&&(r.value==="in"||r.value==="of"))return r.value}t+=1}}parseForEachTarget(){let t=this.stream.peek();if(!t)throw new Error("Expected for-each target");if(t.type!=="Identifier")throw new Error("for-in/of target must be an identifier");return new g(this.stream.next().value)}parseForClause(){return this.isAssignmentStart()?this.parseAssignmentExpression():this.parseExpression()}parseAssignmentExpression(){let t=this.parseAssignmentTarget();this.stream.skipWhitespace();let e=this.parseAssignmentOperator();this.stream.skipWhitespace();let r=this.parseExpression();return new F(t,r,e)}parseAssignmentOperator(){let t=this.stream.peek();if(!t)throw new Error("Expected assignment operator");if(t.type==="Equals")return this.stream.next(),"=";if(t.type==="Tilde")return this.stream.next(),this.stream.expect("Equals"),"~=";if(t.type==="Plus"||t.type==="Minus"||t.type==="Star"||t.type==="Slash"){let e=this.stream.next();return this.stream.expect("Equals"),e.type==="Plus"?"+=":e.type==="Minus"?"-=":e.type==="Star"?"*=":"/="}throw new Error("Expected assignment operator")}parseTryBlock(){this.stream.expect("Try");let t=this.parseBlock({allowDeclarations:!1});this.stream.skipWhitespace(),this.stream.expect("Catch"),this.stream.skipWhitespace(),this.stream.expect("LParen"),this.stream.skipWhitespace();let e=this.stream.expect("Identifier").value;this.stream.skipWhitespace(),this.stream.expect("RParen");let r=this.parseBlock({allowDeclarations:!1});return new he(t,e,r)}parseConstructBlock(){this.stream.expect("Construct");let t=this.parseBlock({allowDeclarations:!1});return t.type="Construct",t}parseDestructBlock(){this.stream.expect("Destruct");let t=this.parseBlock({allowDeclarations:!1});return t.type="Destruct",t}parseQueryExpression(){this.stream.expect("Question");let t="self";this.stream.peek()?.type==="Greater"?(this.stream.next(),t="descendant"):this.stream.peek()?.type==="Less"&&(this.stream.next(),t="ancestor"),this.stream.skipWhitespace(),this.stream.expect("LParen");let e=this.readSelectorUntil("RParen");return new ge(t,e)}parseFunctionDeclaration(){let t=!1,e=this.stream.peekNonWhitespace(0);this.isAsyncToken(e)&&(this.stream.next(),this.stream.skipWhitespace(),t=!0);let r=this.stream.expect("Identifier").value;this.stream.skipWhitespace();let s=this.parseFunctionParams();this.stream.skipWhitespace();let i=this.parseFunctionBlockWithAwait(t);return new $(r,s,i,t)}parseReturnStatement(){if(this.stream.expect("Return"),this.stream.skipWhitespace(),this.stream.peek()?.type==="Semicolon")return this.stream.next(),new O;let t=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new O(t)}parseAssertStatement(){this.stream.expect("Assert"),this.stream.skipWhitespace();let t=this.parseExpression();return this.consumeStatementTerminator(),new ae(t)}parseBreakStatement(){return this.stream.expect("Break"),this.consumeStatementTerminator(),new ie}parseContinueStatement(){return this.stream.expect("Continue"),this.consumeStatementTerminator(),new ne}parseArrowFunctionExpression(t=!1){let e=this.parseFunctionParams();if(this.stream.skipWhitespace(),this.stream.expect("Arrow"),this.stream.skipWhitespace(),this.stream.peek()?.type==="LBrace"){let s=this.parseFunctionBlockWithAwait(t);return new M(e,s,t)}let r=this.parseArrowExpressionBody(t);return new M(e,r,t)}parseFunctionParams(){this.stream.expect("LParen");let t=[],e=!1;for(;;){this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Unterminated function parameters");if(r.type==="RParen"){this.stream.next();break}if(r.type==="Ellipsis"){if(e)throw new Error("Function parameters can only include one rest parameter");this.stream.next(),this.stream.skipWhitespace();let n=this.stream.expect("Identifier").value;if(t.push({name:n,rest:!0}),e=!0,this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma")throw new Error("Rest parameter must be last in function parameters");this.stream.expect("RParen");break}let s=this.stream.expect("Identifier").value;this.stream.skipWhitespace();let i;if(this.stream.peek()?.type==="Equals"&&(this.stream.next(),this.stream.skipWhitespace(),i=this.parseExpression()),t.push(i?{name:s,defaultValue:i}:{name:s}),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in function parameters")}return t}readSelectorUntil(t){let e="",r=!1;for(;;){let s=this.stream.peek();if(!s)throw new Error("Unterminated selector");if(s.type===t){this.stream.next();break}if(s.type==="Whitespace"){this.stream.next(),r&&e[e.length-1]!==" "&&(e+=" ");continue}r=!0,e+=this.stream.next().value}return e.trim()}parseIdentifierPath(){let t=this.stream.expect("Identifier").value;for(;this.stream.peek()?.type==="Dot";){this.stream.next();let e=this.stream.expect("Identifier").value;t=`${t}.${e}`}return t}};var X=class p{constructor(t){this.parent=t;this.root=t?t.root:this}data=new Map;root;listeners=new Map;anyListeners=new Set;isEachItem=!1;createChild(){return new p(this)}setParent(t){this.parent||(this.parent=t,this.root=t.root)}get(t){return this.getPath(t)}set(t,e){this.setPath(t,e)}hasKey(t){let r=t.split(".")[0];return r?this.data.has(r):!1}getPath(t){let e=t.startsWith("parent.")||t.startsWith("root.")||t.startsWith("self."),{targetScope:r,targetPath:s}=this.resolveScope(t);if(!r||!s)return;let i=this.getLocalPathValue(r,s);if(e||i!==void 0)return i;let n=r.parent;for(;n;){let a=this.getLocalPathValue(n,s);if(a!==void 0)return a;n=n.parent}}setPath(t,e){let r=t.startsWith("parent.")||t.startsWith("root.")||t.startsWith("self."),{targetScope:s,targetPath:i}=this.resolveScope(t);if(!s||!i)return;let n=r?s:this.findNearestScopeWithKey(s,i)??s,a=i.split("."),o=a[0];if(!o)return;if(a.length===1){n.data.set(o,e),n.emitChange(i);return}let c=n.data.get(o);(c==null||typeof c!="object")&&(c={},n.data.set(o,c));let l=c;for(let d=1;d<a.length-1;d+=1){let y=a[d];if(!y)return;(l[y]==null||typeof l[y]!="object")&&(l[y]={}),l=l[y]}let h=a[a.length-1];h&&(l[h]=e,n.emitChange(i))}on(t,e){let r=t.trim();if(!r)return;let s=this.listeners.get(r)??new Set;s.add(e),this.listeners.set(r,s)}off(t,e){let r=t.trim(),s=this.listeners.get(r);s&&(s.delete(e),s.size===0&&this.listeners.delete(r))}onAny(t){this.anyListeners.add(t)}offAny(t){this.anyListeners.delete(t)}emitChange(t){let e=t.trim();if(!e)return;this.listeners.get(e)?.forEach(s=>s());let r=e.split(".")[0];r&&r!==e&&this.listeners.get(r)?.forEach(s=>s()),this.anyListeners.forEach(s=>s())}resolveScope(t){let e=this,r=t;for(;r.startsWith("parent.");)e=e?.parent,r=r.slice(7);for(r.startsWith("root.")&&(e=e?.root,r=r.slice(5));r.startsWith("self.");)e=e??this,r=r.slice(5);return{targetScope:e,targetPath:r}}getLocalPathValue(t,e){let r=e.split("."),s=r[0];if(!s)return;let i=t.data.get(s);for(let n=1;n<r.length;n+=1){if(i==null)return;let a=r[n];if(!a)return;i=i[a]}return i}findNearestScopeWithKey(t,e){let r=e.split(".")[0];if(!r)return;let s=t;for(;s;){if(s.data.has(r))return s;s=s.parent}}};function De(p){return p instanceof HTMLInputElement||p instanceof HTMLTextAreaElement||p instanceof HTMLSelectElement?p.value:p.textContent??""}function Te(p,t){if(p instanceof HTMLInputElement||p instanceof HTMLTextAreaElement){p.value=t,p.setAttribute("value",t);return}if(p instanceof HTMLSelectElement){p.value=t;return}p instanceof HTMLElement&&p.querySelector("*")||(p.textContent=t)}function ve(p,t,e){let r=t.trim();if(!r)return;let s=De(p);e.set(r,s)}function Ee(p,t,e){let r=t.trim();if(!r)return;let s=e.get(r);s!=null&&Te(p,String(s))}function Pe(p,t){let e=p.trim();return e?!!t.get(e):!1}function we(p,t,e){p.style.display=Pe(t,e)?"":"none"}function Be(p,t,e){p.style.display=Pe(t,e)?"":"none"}function I(p,t,e){let r=t.trim();if(!r)return;let s=e.get(r),i=s==null?"":String(s);p.innerHTML=i}async function Fe(p,t,e,r){if(!globalThis.fetch)throw new Error("fetch is not available");let s=await globalThis.fetch(t.url);if(!s||!s.ok)return;let i=await s.text(),n=Me(p,t.targetSelector);if(!n){p.dispatchEvent(new CustomEvent("vsn:targetError",{detail:{selector:t.targetSelector}}));return}if(t.swap==="outer"){let a=document.createElement("div");I(a,"__html",{get:()=>i});let o=a.firstElementChild;o&&n.parentNode&&(n.parentNode.replaceChild(o,n),r?.(o));return}I(n,"__html",{get:()=>i}),r?.(n)}function Me(p,t){return t?p.ownerDocument.querySelector(t):p}function W(p,t){let e;return(...r)=>{e&&clearTimeout(e),e=setTimeout(()=>{e=void 0,p(...r)},t)}}var ee=class p{static activeEngines=new WeakMap;scopes=new WeakMap;bindBindings=new WeakMap;ifBindings=new WeakMap;showBindings=new WeakMap;htmlBindings=new WeakMap;getBindings=new WeakMap;eachBindings=new WeakMap;lifecycleBindings=new WeakMap;behaviorRegistry=[];behaviorRegistryHashes=new Set;behaviorBindings=new WeakMap;behaviorListeners=new WeakMap;behaviorId=0;codeCache=new Map;behaviorCache=new Map;observer;attributeHandlers=[];globals={};importantFlags=new WeakMap;inlineDeclarations=new WeakMap;flagHandlers=new Map;behaviorModifiers=new Map;pendingAdded=new Set;pendingRemoved=new Set;pendingUpdated=new Set;observerFlush;ignoredAdded=new WeakMap;diagnostics;logger;pendingUses=[];pendingAutoBindToScope=[];scopeWatchers=new WeakMap;executionStack=[];groupProxyCache=new WeakMap;scopeElements=new WeakMap;constructor(t={}){this.diagnostics=t.diagnostics??!1,this.logger=t.logger??console,this.registerGlobal("console",console),this.registerFlag("important"),this.registerFlag("debounce",{onEventBind:({args:e})=>({debounceMs:typeof e=="number"?e:200})}),this.registerFlag("prevent",{onEventBefore:({event:e})=>{e?.preventDefault()}}),this.registerFlag("stop",{onEventBefore:({event:e})=>{e?.stopPropagation()}}),this.registerFlag("self",{onEventBefore:({event:e,element:r})=>{let s=e?.target;return s instanceof Node?s===r:!1}}),this.registerFlag("outside",{onEventBind:({element:e})=>({listenerTarget:e.ownerDocument}),onEventBefore:({event:e,element:r})=>{let s=e?.target;return s instanceof Node?!r.contains(s):!1}}),this.registerFlag("once",{onEventBind:()=>({options:{once:!0}})}),this.registerFlag("passive",{onEventBind:()=>({options:{passive:!0}})}),this.registerFlag("capture",{onEventBind:()=>({options:{capture:!0}})}),this.registerFlag("shift",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"shift")}),this.registerFlag("ctrl",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"ctrl")}),this.registerFlag("control",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"ctrl")}),this.registerFlag("alt",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"alt")}),this.registerFlag("meta",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"meta")}),this.registerFlag("enter",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"enter")}),this.registerFlag("escape",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"escape")}),this.registerFlag("esc",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"escape")}),this.registerFlag("tab",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"tab")}),this.registerFlag("space",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"space")}),this.registerFlag("up",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"arrowup")}),this.registerFlag("down",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"arrowdown")}),this.registerFlag("left",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"arrowleft")}),this.registerFlag("right",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"arrowright")}),this.registerFlag("arrowup",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"arrowup")}),this.registerFlag("arrowdown",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"arrowdown")}),this.registerFlag("arrowleft",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"arrowleft")}),this.registerFlag("arrowright",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"arrowright")}),this.registerFlag("delete",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"delete")}),this.registerFlag("backspace",{onEventBefore:({event:e})=>this.matchesKeyFlag(e,"backspace")}),this.registerFlag("minwidth",{onEventBefore:({args:e})=>this.matchesMinWidth(e)}),this.registerFlag("maxwidth",{onEventBefore:({args:e})=>this.matchesMaxWidth(e)}),this.registerGlobal("minwidth",e=>this.matchesMinWidth(e)),this.registerGlobal("maxwidth",e=>this.matchesMaxWidth(e)),this.registerGlobal("list",{async map(e,r){if(!Array.isArray(e)||typeof r!="function")return[];let s=[];for(let i=0;i<e.length;i+=1)s.push(await r(e[i],i));return s},async filter(e,r){if(!Array.isArray(e)||typeof r!="function")return[];let s=[];for(let i=0;i<e.length;i+=1)await r(e[i],i)&&s.push(e[i]);return s},async reduce(e,r,s){if(!Array.isArray(e)||typeof r!="function")return s;let i=arguments.length>2,n=i?s:e[0],a=i?0:1;for(let o=a;o<e.length;o+=1)n=await r(n,e[o],o);return n}}),this.registerDefaultAttributeHandlers(),this.registerFlag("int",{transformValue:(e,r)=>this.coerceInt(r)}),this.registerFlag("float",{transformValue:(e,r)=>this.coerceFloat(r)}),this.registerBehaviorModifier("group",{onConstruct:({args:e,scope:r,rootScope:s,behavior:i,element:n})=>{let a=typeof e=="string"?e:void 0;if(!a)return;let o=this.getGroupTargetScope(n,i,r,s),c=o.getPath?.(a),l=Array.isArray(c)?c:[],h=this.getGroupProxy(r);l.includes(h)?Array.isArray(c)||o.setPath?.(a,l):(l.push(h),o.setPath?.(a,l))},onUnbind:({args:e,scope:r,rootScope:s,behavior:i,element:n})=>{let a=typeof e=="string"?e:void 0;if(!a)return;let o=this.getGroupTargetScope(n,i,r,s),c=o.getPath?.(a);if(!Array.isArray(c))return;let l=this.getGroupProxy(r),h=c.filter(d=>d!==l);h.length!==c.length&&o.setPath?.(a,h)}})}matchesMinWidth(t){let e=this.parseWidthArg(t);return e===void 0?!1:this.mediaMatches(`(min-width: ${e}px)`)}matchesMaxWidth(t){let e=this.parseWidthArg(t);return e===void 0?!1:this.mediaMatches(`(max-width: ${e}px)`)}parseWidthArg(t){if(typeof t=="number"&&Number.isFinite(t))return t;if(typeof t=="string"){let e=t.match(/-?\d+(\.\d+)?/);if(!e)return;let r=Number(e[0]);return Number.isFinite(r)?r:void 0}}mediaMatches(t){let e=globalThis.matchMedia;return typeof e!="function"?!1:!!e(t)?.matches}getGroupTargetScope(t,e,r,s){let i=s??r;if(e.parentSelector){let n=t.closest(e.parentSelector);n&&(i=this.getScope(n))}return i}getGroupProxy(t){let e=this.groupProxyCache.get(t);if(e)return e;let r=this.scopeElements.get(t),s=new Proxy({},{get:(i,n)=>{if(typeof n=="symbol")return;if(n==="__element")return r;if(n==="__scope")return t;let a=String(n),o=t.getPath(a),c=a.split(".")[0],l=c?t.hasKey?.(c):!1;if(o!==void 0||l)return o;if(r&&a in r){let h=r[a];return typeof h=="function"?h.bind(r):h}},set:(i,n,a)=>typeof n=="symbol"?!1:(t.setPath(String(n),a),!0),has:(i,n)=>typeof n=="symbol"?!1:t.getPath(String(n))!==void 0,getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0}),ownKeys:()=>[]});return this.groupProxyCache.set(t,s),s}async mount(t){let e=t.ownerDocument,r=p.activeEngines.get(e);r&&r!==this&&r.disconnectObserver(),p.activeEngines.set(e,this);let s=[t,...Array.from(t.querySelectorAll("*"))];for(let i of s){if(!this.hasVsnAttributes(i))continue;let n=this.findParentScope(i);this.getScope(i,n),this.attachAttributes(i),this.runConstruct(i)}await this.applyBehaviors(t),this.attachObserver(t)}unmount(t){this.runDestruct(t),this.disconnectObserver()}registerBehaviors(t){let e=new L(t,{customFlags:new Set(this.flagHandlers.keys()),behaviorFlags:new Set(this.behaviorModifiers.keys())}).parseProgram();for(let r of e.uses){if(r.flags?.wait){this.pendingUses.push(this.waitForUseGlobal(r));continue}let s=this.resolveGlobalPath(r.name);if(s===void 0){console.warn(`vsn: global '${r.name}' not found`);continue}this.registerGlobal(r.alias,s)}for(let r of e.behaviors)this.collectBehavior(r)}registerGlobal(t,e){this.globals[t]=e}registerGlobals(t){Object.assign(this.globals,t)}registerFlag(t,e={}){this.flagHandlers.set(t,e)}registerBehaviorModifier(t,e={}){if(new Set(["important","debounce"]).has(t))throw new Error(`Behavior modifier '${t}' is reserved`);this.behaviorModifiers.set(t,e)}getRegistryStats(){return{behaviorCount:this.behaviorRegistry.length,behaviorCacheSize:this.behaviorCache.size}}registerAttributeHandler(t){this.attributeHandlers.push(t)}resolveGlobalPath(t){let e=t.split("."),r=e[0];if(!r)return;let s=globalThis[r];for(let i=1;i<e.length;i+=1){let n=e[i];if(!n)return;s=s?.[n]}return s}async waitForUses(){for(;this.pendingUses.length>0;){let t=this.pendingUses;this.pendingUses=[],await Promise.all(t)}}waitForUseGlobal(t){let e=t.flagArgs?.wait??{},r=e.timeoutMs??1e4,s=e.intervalMs??100,i=1e3,n=this.resolveGlobalPath(t.name);return n!==void 0?(this.registerGlobal(t.alias,n),Promise.resolve()):r<=0?(this.emitUseError(t.name,new Error(`vsn: global '${t.name}' not found`)),Promise.resolve()):new Promise(a=>{let o=0,c=s,l=()=>{let h=this.resolveGlobalPath(t.name);if(h!==void 0){this.registerGlobal(t.alias,h),a();return}if(o>=r){this.emitUseError(t.name,new Error(`vsn: global '${t.name}' not found`)),a();return}let d=Math.min(c,r-o);setTimeout(()=>{o+=d,c=Math.min(c*2,i),l()},d)};l()})}getScope(t,e){let r=this.scopes.get(t);if(r)return e&&r.setParent(e),this.scopeElements.has(r)||this.scopeElements.set(r,t),r;let s=new X(e??this.findParentScope(t));return this.scopes.set(t,s),this.scopeElements.set(s,t),s}evaluate(t){let e=this.getScope(t),r=this.bindBindings.get(t);r&&(r.direction==="from"||r.direction==="both")&&Ee(t,r.expr,e);let s=this.ifBindings.get(t);s&&t instanceof HTMLElement&&we(t,s,e);let i=this.showBindings.get(t);i&&t instanceof HTMLElement&&Be(t,i,e);let n=this.htmlBindings.get(t);n&&t instanceof HTMLElement&&(I(t,n.expr,e),this.handleHtmlBehaviors(t))}attachObserver(t){this.observer||(this.observerFlush=W(()=>this.flushObserverQueue(),10),this.observer=new MutationObserver(e=>{for(let r of e){r.type==="attributes"&&r.target instanceof Element&&this.pendingUpdated.add(r.target);for(let s of Array.from(r.addedNodes))if(s&&s.nodeType===1){let i=s;if(this.ignoredAdded.has(i)){this.ignoredAdded.delete(i);continue}this.pendingAdded.add(i)}for(let s of Array.from(r.removedNodes))s&&s.nodeType===1&&this.pendingRemoved.add(s)}this.observerFlush?.()}),this.observer.observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}))}disconnectObserver(){this.observer?.disconnect(),this.observer=void 0,this.pendingAdded.clear(),this.pendingRemoved.clear(),this.pendingUpdated.clear()}flushObserverQueue(){let t=Array.from(this.pendingRemoved);this.pendingRemoved.clear();for(let s of t)this.handleRemovedNode(s);let e=Array.from(this.pendingUpdated);this.pendingUpdated.clear();for(let s of e)this.handleUpdatedNode(s);let r=Array.from(this.pendingAdded);this.pendingAdded.clear();for(let s of r)this.handleAddedNode(s)}handleRemovedNode(t){this.lifecycleBindings.has(t)&&this.runDestruct(t),this.behaviorBindings.has(t)&&this.runBehaviorDestruct(t),this.cleanupScopeWatchers(t),this.cleanupBehaviorListeners(t);for(let e of Array.from(t.querySelectorAll("*")))this.lifecycleBindings.has(e)&&this.runDestruct(e),this.behaviorBindings.has(e)&&this.runBehaviorDestruct(e),this.cleanupScopeWatchers(e),this.cleanupBehaviorListeners(e)}handleAddedNode(t){let e=[t,...Array.from(t.querySelectorAll("*"))];for(let r of e){if(!this.hasVsnAttributes(r))continue;let s=this.findParentScope(r);this.getScope(r,s),this.attachAttributes(r),this.runConstruct(r)}this.applyBehaviors(t)}handleUpdatedNode(t){let e=[t,...Array.from(t.querySelectorAll("*"))];for(let r of e)this.reapplyBehaviorsForElement(r)}async applyBehaviors(t){if(await this.waitForUses(),this.behaviorRegistry.length>0){let e=[t,...Array.from(t.querySelectorAll("*"))];for(let r of e)await this.reapplyBehaviorsForElement(r)}this.flushAutoBindQueue()}async reapplyBehaviorsForElement(t){if(this.behaviorRegistry.length===0)return;let e=this.behaviorBindings.get(t)??new Set,r=this.getScope(t),s=this.behaviorRegistry.filter(n=>t.matches(n.selector)).sort((n,a)=>n.specificity!==a.specificity?n.specificity-a.specificity:n.order-a.order);for(let n of s)e.has(n.id)||await this.applyBehaviorForElement(n,t,r,e);let i=new Set(s.map(n=>n.id));for(let n of this.behaviorRegistry)e.has(n.id)&&!i.has(n.id)&&this.unbindBehaviorForElement(n,t,r,e);this.behaviorBindings.set(t,e)}async applyBehaviorForElement(t,e,r,s){s.add(t.id);let i=this.getBehaviorRootScope(e,t);this.applyBehaviorFunctions(e,r,t.functions,i),await this.applyBehaviorDeclarations(e,r,t.declarations,i),await this.applyBehaviorModifierHook("onBind",t,e,r,i),t.construct&&await this.safeExecuteBlock(t.construct,r,e,i),await this.applyBehaviorModifierHook("onConstruct",t,e,r,i);for(let n of t.onBlocks)this.attachBehaviorOnHandler(e,n.event,n.body,n.flags,n.flagArgs,n.args,t.id,i);this.logDiagnostic("bind",e,t)}unbindBehaviorForElement(t,e,r,s){s.delete(t.id);let i=this.getBehaviorRootScope(e,t);t.destruct&&this.safeExecuteBlock(t.destruct,r,e,i),this.applyBehaviorModifierHook("onDestruct",t,e,r,i);let n=this.behaviorListeners.get(e),a=n?.get(t.id);if(a){for(let o of a)o.target.removeEventListener(o.event,o.handler,o.options);n?.delete(t.id)}this.applyBehaviorModifierHook("onUnbind",t,e,r,i),this.logDiagnostic("unbind",e,t)}runBehaviorDestruct(t){let e=this.behaviorBindings.get(t);if(!e)return;let r=this.getScope(t);for(let s of this.behaviorRegistry){if(!e.has(s.id)||!s.destruct&&!this.behaviorHasModifierHooks(s))continue;let i=this.getBehaviorRootScope(t,s);s.destruct&&this.safeExecuteBlock(s.destruct,r,t,i),this.applyBehaviorModifierHook("onDestruct",s,t,r,i),this.applyBehaviorModifierHook("onUnbind",s,t,r,i)}}attachAttributes(t){let e=this.getScope(t);for(let r of t.getAttributeNames()){if(!r.startsWith("vsn-"))continue;let s=t.getAttribute(r)??"";for(let i of this.attributeHandlers){if(!i.match(r))continue;if(i.handle(t,r,s,e)!==!1)break}}}setLifecycle(t,e){let r=this.lifecycleBindings.get(t)??{};this.lifecycleBindings.set(t,{...r,...e})}runConstruct(t){let e=this.lifecycleBindings.get(t);if(!e?.construct)return;let r=this.getScope(t);this.safeExecute(e.construct,r,t)}runDestruct(t){let e=this.lifecycleBindings.get(t);if(!e?.destruct)return;let r=this.getScope(t);this.safeExecute(e.destruct,r,t)}parseEachExpression(t){let[e,r]=t.split(/\s+as\s+/);if(!e||!r)return null;let s=e.trim(),i=r.split(",").map(o=>o.trim()).filter(Boolean);if(!s||i.length===0)return null;let n=i[0]??"",a=i[1];return{listExpr:s,itemName:n,...a?{indexName:a}:{}}}renderEach(t){let e=this.eachBindings.get(t);if(!e||!(t instanceof HTMLTemplateElement))return;let r=t.parentElement;if(!r)return;for(let a of e.rendered)this.handleRemovedNode(a),a.parentNode&&a.parentNode.removeChild(a);e.rendered=[];let s=this.getScope(t),i=s.get(e.listExpr);if(!Array.isArray(i))return;let n=[];i.forEach((a,o)=>{let c=t.content.cloneNode(!0),l=Array.from(c.children),h=new X(s);h.isEachItem=!0,h.setPath(`self.${e.itemName}`,a),e.indexName&&h.setPath(`self.${e.indexName}`,o);for(let d of l)this.getScope(d,h);r.insertBefore(c,t);for(let d of l){this.ignoredAdded.set(d,!0),n.push(d),this.handleAddedNode(d),this.evaluate(d);for(let y of Array.from(d.querySelectorAll("*")))this.evaluate(y)}}),e.rendered=n}attachBindInputHandler(t,e){if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement))return;let r=()=>{let s=this.getScope(t);ve(t,e,s)};t.addEventListener("input",r),t.addEventListener("change",r)}parseBindDirection(t){return t.includes(":from")?"from":t.includes(":to")?"to":"auto"}resolveBindConfig(t,e,r,s){return s!=="auto"?{direction:s,seedFromScope:!1,syncToScope:s==="to"||s==="both",deferToScope:!1}:this.isInEachScope(r)?{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!1}:this.isFormControl(t)?this.hasScopeValue(r,e)?{direction:"both",seedFromScope:!0,syncToScope:!1,deferToScope:!1}:{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!0}:this.hasScopeValue(r,e)?{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!1}:this.hasElementValue(t)?{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!0}:{direction:"both",seedFromScope:!1,syncToScope:!1,deferToScope:!1}}isFormControl(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement}hasScopeValue(t,e){let r=e.trim();if(!r)return!1;let s=t.get(r);return s!=null}hasElementValue(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement?t.value.length>0:(t.textContent??"").trim().length>0}coerceInt(t){if(t==null||t==="")return t;let e=typeof t=="number"?t:Number.parseInt(String(t),10);return Number.isNaN(e)?t:e}coerceFloat(t){if(t==null||t==="")return t;let e=typeof t=="number"?t:Number.parseFloat(String(t));return Number.isNaN(e)?t:e}isInEachScope(t){let e=t;for(;e;){if(e.isEachItem)return!0;e=e.parent}return!1}flushAutoBindQueue(){if(this.pendingAutoBindToScope.length===0)return;let t=this.pendingAutoBindToScope;this.pendingAutoBindToScope=[];for(let e of t)e.element.isConnected&&(this.hasScopeValue(e.scope,e.expr)||this.hasElementValue(e.element)&&ve(e.element,e.expr,e.scope))}hasVsnAttributes(t){return t.getAttributeNames().some(e=>e.startsWith("vsn-"))}markInlineDeclaration(t,e){let r=this.inlineDeclarations.get(t)??new Set;r.add(e),this.inlineDeclarations.set(t,r)}isInlineDeclaration(t,e){let r=this.inlineDeclarations.get(t);return r?r.has(e):!1}findParentScope(t){let e=t.parentElement;for(;e;){let r=this.scopes.get(e);if(r)return r;e=e.parentElement}}watch(t,e,r,s){let i=e.trim();if(!i)return;let n=i.split(".")[0];if(!n)return;let a=t;for(;a&&!a.hasKey(n);)a=a.parent;if(a){a.on(i,r),s&&this.trackScopeWatcher(s,a,"path",r,i);return}let o=t;for(;o;)o.on(i,r),s&&this.trackScopeWatcher(s,o,"path",r,i),o=o.parent}watchWithDebounce(t,e,r,s,i){let n=s?W(r,s):r;this.watch(t,e,n,i)}watchAllScopes(t,e,r,s){let i=r?W(e,r):e,n=t;for(;n;)n.onAny(i),s&&this.trackScopeWatcher(s,n,"any",i),n=n.parent}trackScopeWatcher(t,e,r,s,i){let n=this.scopeWatchers.get(t)??[];n.push({scope:e,kind:r,handler:s,...i?{key:i}:{}}),this.scopeWatchers.set(t,n)}cleanupScopeWatchers(t){let e=this.scopeWatchers.get(t);if(e){for(let r of e){if(r.kind==="any"){r.scope.offAny(r.handler);continue}r.key&&r.scope.off(r.key,r.handler)}this.scopeWatchers.delete(t)}}cleanupBehaviorListeners(t){let e=this.behaviorListeners.get(t);if(e){for(let r of e.values())for(let s of r)s.target.removeEventListener(s.event,s.handler,s.options);e.clear(),this.behaviorListeners.delete(t),this.behaviorBindings.delete(t)}}parseOnAttribute(t,e){if(!t.startsWith("vsn-on:"))return null;let r=t.slice(7),[s,...i]=r.split("!");if(!s)return null;if(s.includes("."))throw new Error("vsn:on does not support dot modifiers; use !flags instead");let{flagMap:n,flagArgs:a}=this.parseInlineFlags(i);return{event:s,code:e,flags:n,flagArgs:a}}parseInlineFlags(t){let e={},r={};for(let s of t){let i=s.trim();if(!i)continue;let n=i.match(/^([a-zA-Z][\w-]*)(?:\((.+)\))?$/);if(!n)continue;let a=n[1]??"";if(a){if(!this.flagHandlers.has(a))throw new Error(`Unknown flag ${a}`);e[a]=!0,n[2]!==void 0&&(r[a]=this.parseInlineFlagArg(n[2]))}}return{flagMap:e,flagArgs:r}}parseInlineFlagArg(t){let e=t.trim();return e==="true"?!0:e==="false"?!1:/^-?\d+(\.\d+)?$/.test(e)?Number(e):e}describeElement(t){let e=t.tagName.toLowerCase(),r=t.id?`#${t.id}`:"",s=t.classList.length>0?`.${Array.from(t.classList).join(".")}`:"";return`${e}${r}${s}`}logDiagnostic(t,e,r){!this.diagnostics||!this.logger.info||this.logger.info(`vsn:${t}`,{element:this.describeElement(e),selector:r.selector,behaviorId:r.id})}emitError(t,e){let r=this.describeElement(t);this.logger.warn?.("vsn:error",{error:e,selector:r}),t.dispatchEvent(new CustomEvent("vsn:error",{detail:{error:e,selector:r},bubbles:!0}))}emitUseError(t,e){let r=`use:${t}`;this.logger.warn?.("vsn:error",{error:e,selector:r});let s=globalThis.document;s&&typeof s.dispatchEvent=="function"&&s.dispatchEvent(new CustomEvent("vsn:error",{detail:{error:e,selector:r},bubbles:!0}))}attachOnHandler(t,e){let{listenerTarget:r,options:s,debounceMs:i}=this.getEventBindingConfig(t,e.flags,e.flagArgs),n,a=async o=>{if(!t.isConnected){r.removeEventListener(e.event,n,s);return}let c=this.getScope(t);if(this.applyEventFlagBefore(t,c,e.flags,e.flagArgs,o))try{await this.execute(e.code,c,t),this.evaluate(t)}catch(l){this.emitError(t,l)}finally{this.applyEventFlagAfter(t,c,e.flags,e.flagArgs,o)}};n=i?W(a,i):a,r.addEventListener(e.event,n,s)}attachBehaviorOnHandler(t,e,r,s,i,n,a,o){if(e.includes("."))throw new Error("vsn:on does not support dot modifiers; use !flags instead");let{listenerTarget:c,options:l,debounceMs:h}=this.getEventBindingConfig(t,s,i),d=async R=>{let C=this.getScope(t);if(!this.applyEventFlagBefore(t,C,s,i,R))return;let Se=new Map;if(n&&n.length>0){let P=n[0];if(P){Se.set(P,C.getPath(P));let[xe]=this.applyEventFlagArgTransforms(t,C,s,i,R);C.setPath(P,xe)}}let Ae=!1;try{await this.executeBlock(r,C,t,o)}catch(P){Ae=!0,this.emitError(t,P)}finally{for(let[P,xe]of Se.entries())C.setPath(P,xe);this.applyEventFlagAfter(t,C,s,i,R)}Ae||this.evaluate(t)},y=h?W(d,h):d;c.addEventListener(e,y,l);let v=this.behaviorListeners.get(t)??new Map,N=v.get(a)??[];N.push({target:c,event:e,handler:y,options:l}),v.set(a,N),this.behaviorListeners.set(t,v)}attachGetHandler(t,e=!1){let r=async()=>{let s=this.getBindings.get(t);if(s)try{await Fe(t,s,this.getScope(t),i=>{this.handleHtmlBehaviors(i)})}catch(i){console.warn("vsn:getError",i),t.dispatchEvent(new CustomEvent("vsn:getError",{detail:{error:i},bubbles:!0}))}};t.addEventListener("click",s=>{s.target===t&&r()}),e&&Promise.resolve().then(r)}getEventBindingConfig(t,e,r){let s=t,i={},n;for(let a of Object.keys(e)){let o=this.flagHandlers.get(a);if(!o?.onEventBind)continue;let c=o.onEventBind({name:a,args:r[a],element:t,scope:this.getScope(t),rootScope:void 0,event:void 0,engine:this});c&&(c.listenerTarget&&(s=c.listenerTarget),c.options&&(i={...i,...c.options}),c.debounceMs!==void 0&&(n=c.debounceMs))}return{listenerTarget:s,...Object.keys(i).length>0?{options:i}:{},...n!==void 0?{debounceMs:n}:{}}}applyEventFlagBefore(t,e,r,s,i){for(let n of Object.keys(r)){let a=this.flagHandlers.get(n);if(!a?.onEventBefore)continue;if(a.onEventBefore({name:n,args:s[n],element:t,scope:e,rootScope:void 0,event:i,engine:this})===!1)return!1}return!0}applyEventFlagAfter(t,e,r,s,i){for(let n of Object.keys(r)){let a=this.flagHandlers.get(n);a?.onEventAfter&&a.onEventAfter({name:n,args:s[n],element:t,scope:e,rootScope:void 0,event:i,engine:this})}}applyEventFlagArgTransforms(t,e,r,s,i){let n=[i];for(let a of Object.keys(r)){let o=this.flagHandlers.get(a);if(!o?.transformEventArgs)continue;let c=o.transformEventArgs({name:a,args:s[a],element:t,scope:e,rootScope:void 0,event:i,engine:this},n);Array.isArray(c)&&(n=c)}return n}matchesKeyFlag(t,e){if(!(t instanceof KeyboardEvent))return!1;let r={shift:t.shiftKey,ctrl:t.ctrlKey,alt:t.altKey,meta:t.metaKey};if(e in r)return r[e]??!1;let s={escape:"escape",esc:"escape",enter:"enter",tab:"tab",space:"space",spacebar:"space",up:"arrowup",down:"arrowdown",left:"arrowleft",right:"arrowright",arrowup:"arrowup",arrowdown:"arrowdown",arrowleft:"arrowleft",arrowright:"arrowright",delete:"delete",backspace:"backspace"},i=t.key?.toLowerCase()??"";i===" "&&(i="space");let n=s[e]??e;return i===n}async withExecutionElement(t,e){if(!t){await e();return}this.executionStack.push(t);try{await e()}finally{this.executionStack.pop()}}getCurrentElement(){return this.executionStack[this.executionStack.length-1]}async execute(t,e,r,s){let i=this.codeCache.get(t);i||(i=L.parseInline(t),this.codeCache.set(t,i)),await this.withExecutionElement(r,async()=>{let n=this.getGroupProxy(e),a={scope:e,rootScope:s,globals:this.globals,...r?{element:r}:{},self:n};await i.evaluate(a)})}async executeBlock(t,e,r,s){await this.withExecutionElement(r,async()=>{let i=this.getGroupProxy(e),n={scope:e,rootScope:s,globals:this.globals,...r?{element:r}:{},self:i};await t.evaluate(n)})}async safeExecute(t,e,r,s){try{await this.execute(t,e,r,s)}catch(i){r&&this.emitError(r,i)}}async safeExecuteBlock(t,e,r,s){try{await this.executeBlock(t,e,r,s)}catch(i){r&&this.emitError(r,i)}}collectBehavior(t,e,r){let s=e?`${e} ${t.selector.selectorText}`:t.selector.selectorText,i=r??e??t.selector.selectorText,n=this.hashBehavior(t),a=`${s}::${i}::${n}`;if(this.behaviorRegistryHashes.has(a))return;let o=this.getCachedBehavior(t),c={id:this.behaviorId+=1,hash:a,selector:s,rootSelector:i,specificity:this.computeSpecificity(s),order:this.behaviorRegistry.length,flags:t.flags??{},flagArgs:t.flagArgs??{},...o,...e?{parentSelector:e}:{}};this.behaviorRegistry.push(c),this.behaviorRegistryHashes.add(a),this.collectNestedBehaviors(t.body,s,i)}collectNestedBehaviors(t,e,r){for(let s of t.statements){if(s instanceof H){this.collectBehavior(s,e,r);continue}if(s instanceof T){this.collectNestedBehaviors(s.body,e,r);continue}s instanceof k&&this.collectNestedBehaviors(s,e,r)}}computeSpecificity(t){let e=t.match(/#[\w-]+/g)?.length??0,r=t.match(/\.[\w-]+/g)?.length??0,s=t.match(/\[[^\]]+\]/g)?.length??0,i=t.match(/:[\w-]+/g)?.length??0,n=t.match(/(^|[\s>+~])([a-zA-Z][\w-]*)/g)?.length??0;return e*100+(r+s+i)*10+n}getBehaviorRootScope(t,e){let r=t.closest(e.rootSelector)??t;return this.getScope(r)}getImportantKey(t){if(t.target instanceof g)return`state:${t.target.name}`;if(t.target instanceof x)return`${t.target.kind}:${t.target.name}`}isImportant(t,e){let r=this.importantFlags.get(t);return r?r.has(e):!1}markImportant(t,e){let r=this.importantFlags.get(t)??new Set;r.add(e),this.importantFlags.set(t,r)}extractLifecycle(t){let e,r;for(let s of t.statements)s instanceof k&&(s.type==="Construct"?e=s:s.type==="Destruct"&&(r=s));return{...e?{construct:e}:{},...r?{destruct:r}:{}}}extractOnBlocks(t){let e=[];for(let r of t.statements)r instanceof T&&e.push({event:r.eventName,body:r.body,flags:r.flags,flagArgs:r.flagArgs,args:r.args});return e}extractDeclarations(t){let e=[];for(let r of t.statements)r instanceof U&&e.push(r);return e}extractFunctionDeclarations(t){let e=[];for(let r of t.statements){if(r instanceof $){e.push({name:r.name,params:r.params,body:r.body});continue}r instanceof F&&r.target instanceof g&&r.value instanceof M&&e.push({name:r.target.name,params:r.value.params,body:r.value.body})}return e}getCachedBehavior(t){let e=this.hashBehavior(t),r=this.behaviorCache.get(e);if(r)return r;let s=this.extractLifecycle(t.body),i={onBlocks:this.extractOnBlocks(t.body),declarations:this.extractDeclarations(t.body),functions:this.extractFunctionDeclarations(t.body),...s};return this.behaviorCache.set(e,i),i}hashBehavior(t){let e=this.normalizeNode(t),r=JSON.stringify(e);return this.hashString(r)}normalizeNode(t){if(!t||typeof t!="object")return t;let e=t.type??"Unknown";return e==="Behavior"?{type:e,selector:t.selector?.selectorText??"",flags:t.flags??{},flagArgs:t.flagArgs??{},body:this.normalizeNode(t.body)}:e==="Selector"?{type:e,selectorText:t.selectorText??""}:e==="Block"||e==="Construct"||e==="Destruct"?{type:e,statements:Array.isArray(t.statements)?t.statements.map(r=>this.normalizeNode(r)):[]}:e==="OnBlock"?{type:e,eventName:t.eventName??"",args:Array.isArray(t.args)?t.args:[],flags:t.flags??{},flagArgs:t.flagArgs??{},body:this.normalizeNode(t.body)}:e==="Declaration"?{type:e,target:this.normalizeNode(t.target),operator:t.operator??"",value:this.normalizeNode(t.value),flags:t.flags??{},flagArgs:t.flagArgs??{}}:e==="Assignment"?{type:e,target:this.normalizeNode(t.target),value:this.normalizeNode(t.value),operator:t.operator??"",prefix:!!t.prefix}:e==="FunctionDeclaration"?{type:e,name:t.name??"",params:Array.isArray(t.params)?t.params.map(r=>({name:r?.name??"",rest:!!r?.rest,defaultValue:this.normalizeNode(r?.defaultValue??null)})):[],body:this.normalizeNode(t.body),isAsync:!!t.isAsync}:e==="FunctionExpression"?{type:e,params:Array.isArray(t.params)?t.params.map(r=>({name:r?.name??"",rest:!!r?.rest,defaultValue:this.normalizeNode(r?.defaultValue??null)})):[],body:this.normalizeNode(t.body),isAsync:!!t.isAsync}:e==="Return"?{type:e,value:this.normalizeNode(t.value??null)}:e==="Assert"?{type:e,test:this.normalizeNode(t.test)}:e==="Break"||e==="Continue"?{type:e}:e==="If"?{type:e,test:this.normalizeNode(t.test),consequent:this.normalizeNode(t.consequent),alternate:this.normalizeNode(t.alternate??null)}:e==="While"?{type:e,test:this.normalizeNode(t.test),body:this.normalizeNode(t.body)}:e==="For"?{type:e,init:this.normalizeNode(t.init??null),test:this.normalizeNode(t.test??null),update:this.normalizeNode(t.update??null),body:this.normalizeNode(t.body)}:e==="ForEach"?{type:e,kind:t.kind??"of",target:this.normalizeNode(t.target),iterable:this.normalizeNode(t.iterable),body:this.normalizeNode(t.body)}:e==="Try"?{type:e,errorName:t.errorName??"",body:this.normalizeNode(t.body),handler:this.normalizeNode(t.handler)}:e==="Identifier"?{type:e,name:t.name??""}:e==="ElementRef"?{type:e,id:t.id??""}:e==="Literal"?{type:e,value:t.value}:e==="TemplateExpression"?{type:e,parts:Array.isArray(t.parts)?t.parts.map(r=>this.normalizeNode(r)):[]}:e==="TaggedTemplateExpression"?{type:e,tag:this.normalizeNode(t.tag),template:this.normalizeNode(t.template)}:e==="UnaryExpression"?{type:e,operator:t.operator??"",argument:this.normalizeNode(t.argument)}:e==="BinaryExpression"?{type:e,operator:t.operator??"",left:this.normalizeNode(t.left),right:this.normalizeNode(t.right)}:e==="TernaryExpression"?{type:e,test:this.normalizeNode(t.test),consequent:this.normalizeNode(t.consequent),alternate:this.normalizeNode(t.alternate)}:e==="MemberExpression"?{type:e,target:this.normalizeNode(t.target),property:t.property??"",optional:!!t.optional}:e==="CallExpression"?{type:e,callee:this.normalizeNode(t.callee),args:Array.isArray(t.args)?t.args.map(r=>this.normalizeNode(r)):[]}:e==="AwaitExpression"?{type:e,argument:this.normalizeNode(t.argument)}:e==="Directive"?{type:e,kind:t.kind??"",name:t.name??""}:e==="ElementDirective"?{type:e,element:this.normalizeNode(t.element),directive:this.normalizeNode(t.directive)}:e==="ElementProperty"?{type:e,element:this.normalizeNode(t.element),property:t.property??""}:e==="Query"?{type:e,direction:t.direction??"",selector:t.selector??""}:e==="ArrayExpression"?{type:e,elements:Array.isArray(t.elements)?t.elements.map(r=>this.normalizeNode(r)):[]}:e==="ObjectExpression"?{type:e,entries:Array.isArray(t.entries)?t.entries.map(r=>({key:r?.key??"",computed:!!r?.computed,keyExpr:r?.keyExpr?this.normalizeNode(r.keyExpr):null,value:this.normalizeNode(r?.value)})):[]}:e==="IndexExpression"?{type:e,target:this.normalizeNode(t.target),index:this.normalizeNode(t.index)}:{type:e}}hashString(t){let e=5381;for(let r=0;r<t.length;r+=1)e=(e<<5)+e+t.charCodeAt(r),e|=0;return(e>>>0).toString(16)}applyBehaviorFunctions(t,e,r,s){for(let i of r)this.applyBehaviorFunction(t,e,i,s)}applyBehaviorFunction(t,e,r,s){let i=e.getPath(r.name);if(i!==void 0&&typeof i!="function")throw new Error(`Cannot override non-function '${r.name}' with a function`);let n=this.getGroupProxy(e),a=async(...o)=>{let c=e.createChild?e.createChild():e,l={scope:c,rootScope:s??c,globals:this.globals,element:t,self:n,returnValue:void 0,returning:!1,breaking:!1,continuing:!1},h=new Map;return await this.applyFunctionParams(c,r.params,h,l,o),await r.body.evaluate(l),c===e&&this.restoreFunctionParams(c,r.params,h),l.returnValue};e.setPath(r.name,a)}async applyFunctionParams(t,e,r,s,i){let n=0;for(let a of e){let o=a.name;if(!o)continue;if(r.set(o,t.getPath(o)),a.rest){t.setPath(`self.${o}`,i.slice(n)),n=i.length;continue}let c=i[n];c===void 0&&a.defaultValue&&(c=await a.defaultValue.evaluate(s)),t.setPath(`self.${o}`,c),n+=1}}restoreFunctionParams(t,e,r){for(let s of e){let i=s.name;i&&t.setPath(i,r.get(i))}}async applyBehaviorDeclarations(t,e,r,s){for(let i of r)await this.applyBehaviorDeclaration(t,e,i,s)}async applyBehaviorDeclaration(t,e,r,s){let i=this.getGroupProxy(e),n={scope:e,rootScope:s,element:t,self:i},a=r.operator,o=r.flags.debounce?r.flagArgs.debounce??200:void 0,c=v=>this.applyCustomFlagTransforms(v,t,e,r),l=this.getImportantKey(r);if(!r.flags.important&&l&&this.isImportant(t,l)||l&&this.isInlineDeclaration(t,l))return;if(this.applyCustomFlags(t,e,r),r.target instanceof g){let v=await r.value.evaluate(n),N=this.applyCustomFlagTransforms(v,t,e,r);e.setPath(r.target.name,N),r.flags.important&&l&&this.markImportant(t,l);return}if(!(r.target instanceof x))return;let h=r.target,d=r.value instanceof g?r.value.name:void 0;if(a===":>"){d&&this.applyDirectiveToScope(t,h,d,e,o,s,c),r.flags.important&&l&&this.markImportant(t,l);return}if(a===":="&&d&&this.applyDirectiveToScope(t,h,d,e,o,s,c),!d){let v=await r.value.evaluate(n),N=this.applyCustomFlagTransforms(v,t,e,r);this.setDirectiveValue(t,h,N),(a===":<"||a===":=")&&this.applyDirectiveFromExpression(t,h,r.value,e,o,s),r.flags.important&&l&&this.markImportant(t,l);return}let y=a===":<"||a===":=";this.applyDirectiveFromScope(t,h,d,e,o,y,s),r.flags.important&&l&&this.markImportant(t,l)}applyCustomFlags(t,e,r){if(this.flagHandlers.size!==0)for(let[s,i]of this.flagHandlers)r.flags[s]&&i.onApply?.({name:s,args:r.flagArgs[s],element:t,scope:e,declaration:r})}applyCustomFlagTransforms(t,e,r,s){if(this.flagHandlers.size===0)return t;let i=t;for(let[n,a]of this.flagHandlers)!s.flags[n]||!a.transformValue||(i=a.transformValue({name:n,args:s.flagArgs[n],element:e,scope:r,declaration:s},i));return i}async applyBehaviorModifierHook(t,e,r,s,i){if(this.behaviorModifiers.size!==0)for(let[n,a]of this.behaviorModifiers){if(!e.flags?.[n])continue;let o=a[t];o&&await o({name:n,args:e.flagArgs?.[n],element:r,scope:s,rootScope:i,behavior:e,engine:this})}}behaviorHasModifierHooks(t){if(this.behaviorModifiers.size===0)return!1;let e=t.flags??{};for(let r of Object.keys(e))if(e[r]&&this.behaviorModifiers.has(r))return!0;return!1}applyDirectiveFromScope(t,e,r,s,i,n=!0,a){if(e.kind==="attr"&&e.name==="html"&&t instanceof HTMLElement){let c=()=>{let l=r.startsWith("root.")&&a,h=l?a:s,d=l?`self.${r.slice(5)}`:r;I(t,d,h)};if(c(),this.handleHtmlBehaviors(t),n){let l=r.startsWith("root.")&&a,h=l?a:s,d=l?r.slice(5):r;this.watchWithDebounce(h,d,c,i,t)}return}let o=()=>{let c=r.startsWith("root.")&&a,l=c?a:s,h=c?`self.${r.slice(5)}`:r,d=l.get(h);d!=null&&this.setDirectiveValue(t,e,d)};if(o(),n){let c=r.startsWith("root.")&&a,l=c?a:s,h=c?r.slice(5):r;this.watchWithDebounce(l,h,o,i,t)}}applyDirectiveFromExpression(t,e,r,s,i,n){let a=async()=>{let o=this.getGroupProxy(s),c={scope:s,rootScope:n,element:t,self:o},l=await r.evaluate(c);this.setDirectiveValue(t,e,l)};a(),this.watchAllScopes(s,()=>{a()},i,t)}applyDirectiveToScope(t,e,r,s,i,n,a){let o=r.startsWith("root.")&&n,c=o?n:s,l=o?`self.${r.slice(5)}`:r;if(e.kind==="attr"&&e.name==="value"){this.applyValueBindingToScope(t,l,i,c,a);return}if(e.kind==="attr"&&e.name==="checked"){this.applyCheckedBindingToScope(t,l,i,c,a);return}let h=this.getDirectiveValue(t,e);if(h!=null){let d=a?a(h):h;c.set(l,d)}}applyCheckedBindingToScope(t,e,r,s,i){if(!(t instanceof HTMLInputElement))return;let n=()=>{let o=s??this.getScope(t),c=i?i(t.checked):t.checked;o.set(e,c)},a=r?W(n,r):n;a(),t.addEventListener("change",a),t.addEventListener("input",a)}applyValueBindingToScope(t,e,r,s,i){if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement))return;let n=()=>{let o=s??this.getScope(t),c=t.value,l=i?i(c):c;o.set(e,l)},a=r?W(n,r):n;a(),t.addEventListener("input",a),t.addEventListener("change",a)}setDirectiveValue(t,e,r){if(e.kind==="attr"&&e.name==="html"&&t instanceof HTMLElement){let s=r==null?"":String(r);t.innerHTML=s,this.handleHtmlBehaviors(t);return}if(e.kind==="attr"){if(e.name==="text"&&t instanceof HTMLElement){t.innerText=r==null?"":String(r);return}if(e.name==="content"&&t instanceof HTMLElement){t.textContent=r==null?"":String(r);return}if(e.name==="value"){if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement){t.value=r==null?"":String(r),t.setAttribute("value",t.value);return}if(t instanceof HTMLSelectElement){t.value=r==null?"":String(r);return}}if(e.name==="checked"&&t instanceof HTMLInputElement){let s=r===!0||r==="true"||r===1||r==="1";t.checked=s,s?t.setAttribute("checked",""):t.removeAttribute("checked");return}t.setAttribute(e.name,r==null?"":String(r));return}e.kind==="style"&&t instanceof HTMLElement&&t.style.setProperty(e.name,r==null?"":String(r))}getDirectiveValue(t,e){if(e.kind==="attr")return e.name==="text"&&t instanceof HTMLElement?t.innerText:e.name==="content"&&t instanceof HTMLElement?t.textContent??"":e.name==="value"&&(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement)?t.value:e.name==="checked"&&t instanceof HTMLInputElement?t.checked:t.getAttribute(e.name)??void 0;if(e.kind==="style"&&t instanceof HTMLElement)return t.style.getPropertyValue(e.name)??void 0}handleHtmlBehaviors(t){let e=Array.from(t.querySelectorAll('script[type="text/vsn"]'));if(e.length===0)return;let r=e.map(s=>s.textContent??"").join(`
`);r.trim()&&(this.registerBehaviors(r),this.applyBehaviors(t))}registerDefaultAttributeHandlers(){this.registerAttributeHandler({id:"vsn-bind",match:t=>t.startsWith("vsn-bind"),handle:(t,e,r,s)=>{let i=this.parseBindDirection(e),n=this.resolveBindConfig(t,r,s,i),a=n.direction,o=i==="auto";this.bindBindings.set(t,{expr:r,direction:a,auto:o}),!o&&(a==="to"||a==="both")&&this.markInlineDeclaration(t,`state:${r}`),n.seedFromScope&&Ee(t,r,s),n.deferToScope?this.pendingAutoBindToScope.push({element:t,expr:r,scope:s}):n.syncToScope&&ve(t,r,s),(a==="to"||a==="both")&&this.attachBindInputHandler(t,r),(a==="from"||a==="both")&&this.watch(s,r,()=>Ee(t,r,s),t)}}),this.registerAttributeHandler({id:"vsn-if",match:t=>t==="vsn-if",handle:(t,e,r,s)=>{this.ifBindings.set(t,r),t instanceof HTMLElement&&we(t,r,s),this.watch(s,r,()=>this.evaluate(t),t)}}),this.registerAttributeHandler({id:"vsn-show",match:t=>t==="vsn-show",handle:(t,e,r,s)=>{this.showBindings.set(t,r),t instanceof HTMLElement&&Be(t,r,s),this.watch(s,r,()=>this.evaluate(t),t)}}),this.registerAttributeHandler({id:"vsn-html",match:t=>t.startsWith("vsn-html"),handle:(t,e,r,s)=>{this.htmlBindings.set(t,{expr:r}),this.markInlineDeclaration(t,"attr:html"),t instanceof HTMLElement&&(I(t,r,s),this.handleHtmlBehaviors(t)),this.watch(s,r,()=>this.evaluate(t),t)}}),this.registerAttributeHandler({id:"vsn-each",match:t=>t==="vsn-each",handle:(t,e,r,s)=>{let i=this.parseEachExpression(r);i&&(this.eachBindings.set(t,{...i,rendered:[]}),this.renderEach(t),this.watch(s,i.listExpr,()=>this.renderEach(t),t))}}),this.registerAttributeHandler({id:"vsn-get",match:t=>t.startsWith("vsn-get"),handle:(t,e)=>{let r=e.includes("!load"),s=t.getAttribute(e)??"",i=t.getAttribute("vsn-target")??void 0,n=t.getAttribute("vsn-swap")??"inner",a={url:s,swap:n,...i?{targetSelector:i}:{}};this.getBindings.set(t,a),this.attachGetHandler(t,r)}}),this.registerAttributeHandler({id:"vsn-construct",match:t=>t==="vsn-construct",handle:(t,e,r)=>{this.setLifecycle(t,{construct:r})}}),this.registerAttributeHandler({id:"vsn-destruct",match:t=>t==="vsn-destruct",handle:(t,e,r)=>{this.setLifecycle(t,{destruct:r})}}),this.registerAttributeHandler({id:"vsn-on",match:t=>t.startsWith("vsn-on:"),handle:(t,e,r)=>{let s=this.parseOnAttribute(e,r);s&&this.attachOnHandler(t,s)}})}};var Le="1.0.10";function Ie(p){return new L(p).parseProgram()}typeof window<"u"&&(window.parseCFS=Ie);function Re(p=document){if(typeof document>"u")return null;let t=new ee;globalThis.VSNEngine=t;let e=typeof performance<"u"&&performance.now?performance.now():Date.now(),r=()=>{let s=p instanceof Document?p.body:p;if(s){let i=globalThis.VSNPlugins;if(i&&typeof i=="object")for(let c of Object.values(i))typeof c=="function"&&c(t);let n=Array.from(document.querySelectorAll('script[type="text/vsn"]')).map(c=>c.textContent??"").join(`
`);n.trim()&&t.registerBehaviors(n),t.mount(s);let a=typeof performance<"u"&&performance.now?performance.now():Date.now(),o=Math.round(a-e);console.log(`Took ${o}ms to start up VSN.js. https://www.vsnjs.com/ v${Le}`)}};return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>setTimeout(r,0),{once:!0}):setTimeout(r,0),t}typeof document<"u"&&document.querySelector("script[auto-mount]")&&Re();export{de as ArrayExpression,_ as ArrayPattern,be as AssertError,ae as AssertNode,F as AssignmentNode,Y as AwaitExpression,m as BaseNode,H as BehaviorNode,w as BinaryExpression,k as BlockNode,ie as BreakNode,S as CallExpression,ne as ContinueNode,U as DeclarationNode,x as DirectiveExpression,A as ElementDirectiveExpression,J as ElementPropertyExpression,G as ElementRefExpression,ee as Engine,pe as ForEachNode,le as ForNode,$ as FunctionDeclarationNode,M as FunctionExpression,g as IdentifierExpression,oe as IfNode,B as IndexExpression,j as Lexer,b as LiteralExpression,E as MemberExpression,me as ObjectExpression,q as ObjectPattern,T as OnBlockNode,L as Parser,te as ProgramNode,ge as QueryExpression,V as RestElement,O as ReturnNode,se as SelectorNode,K as SpreadElement,ue as TaggedTemplateExpression,Q as TemplateExpression,fe as TernaryExpression,Ne as TokenType,he as TryNode,Z as UnaryExpression,re as UseNode,Le as VERSION,ce as WhileNode,Re as autoMount,Ie as parseCFS};
//# sourceMappingURL=index.min.js.map