var U=(a=>(a.Whitespace="Whitespace",a.Identifier="Identifier",a.Number="Number",a.String="String",a.Boolean="Boolean",a.Null="Null",a.Behavior="Behavior",a.State="State",a.On="On",a.Construct="Construct",a.Destruct="Destruct",a.LBrace="LBrace",a.RBrace="RBrace",a.LParen="LParen",a.RParen="RParen",a.LBracket="LBracket",a.RBracket="RBracket",a.Colon="Colon",a.Semicolon="Semicolon",a.Comma="Comma",a.Dot="Dot",a.Hash="Hash",a.Greater="Greater",a.Less="Less",a.Plus="Plus",a.Minus="Minus",a.Tilde="Tilde",a.Star="Star",a.Equals="Equals",a.Bang="Bang",a.At="At",a.Dollar="Dollar",a.Question="Question",a))(U||{});var G={behavior:"Behavior",state:"State",on:"On",construct:"Construct",destruct:"Destruct",true:"Boolean",false:"Boolean",null:"Null"},k=class{constructor(t){this.input=t}index=0;line=1;column=1;tokenize(){let t=[];for(;!this.eof();){let e=this.peek();if(this.isWhitespace(e)){t.push(this.readWhitespace());continue}if(e==="/"&&this.peek(1)==="/"){this.readLineComment();continue}if(e==="/"&&this.peek(1)==="*"){this.readBlockComment();continue}if(this.isAlpha(e)||e==="_"){t.push(this.readIdentifier());continue}if(this.isDigit(e)||e==="-"&&this.isDigit(this.peek(1))){t.push(this.readNumber());continue}if(e==='"'||e==="'"){t.push(this.readString());continue}let r=this.readPunctuator();if(r){t.push(r);continue}throw new Error(`Unexpected character '${e}' at ${this.line}:${this.column}`)}return t}readWhitespace(){let t=this.position(),e="";for(;!this.eof()&&this.isWhitespace(this.peek());)e+=this.next();return this.token("Whitespace",e,t)}readLineComment(){for(this.next(),this.next();!this.eof()&&this.peek()!==`
`;)this.next()}readBlockComment(){for(this.next(),this.next();!this.eof();){if(this.peek()==="*"&&this.peek(1)==="/"){this.next(),this.next();return}this.next()}}readIdentifier(){let t=this.position(),e="";for(;!this.eof()&&(this.isAlphaNumeric(this.peek())||this.peek()==="_"||this.peek()==="-");)e+=this.next();let r=G[e];return r?this.token(r,e,t):this.token("Identifier",e,t)}readNumber(){let t=this.position(),e="";for(this.peek()==="-"&&(e+=this.next());!this.eof()&&this.isDigit(this.peek());)e+=this.next();if(this.peek()===".")for(e+=this.next();!this.eof()&&this.isDigit(this.peek());)e+=this.next();return this.token("Number",e,t)}readString(){let t=this.next(),e=this.position(),r="";for(;!this.eof();){let s=this.next();if(s==="\\"){let n=this.next();r+=n;continue}if(s===t)return this.token("String",r,e);r+=s}throw new Error(`Unterminated string at ${e.line}:${e.column}`)}readPunctuator(){let t=this.position(),e=this.peek(),s={"{":"LBrace","}":"RBrace","(":"LParen",")":"RParen","[":"LBracket","]":"RBracket",":":"Colon",";":"Semicolon",",":"Comma",".":"Dot","#":"Hash",">":"Greater","<":"Less","+":"Plus","-":"Minus","~":"Tilde","*":"Star","=":"Equals","!":"Bang","@":"At",$:"Dollar","?":"Question"}[e];return s?(this.next(),this.token(s,e,t)):null}token(t,e,r){return{type:t,value:e,start:r,end:this.position()}}position(){return{index:this.index,line:this.line,column:this.column}}peek(t=0){return this.input[this.index+t]??""}next(){let t=this.input[this.index++]??"";return t===`
`?(this.line+=1,this.column=1):this.column+=1,t}eof(){return this.index>=this.input.length}isWhitespace(t){return t===" "||t==="	"||t===`
`||t==="\r"}isAlpha(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"}isDigit(t){return t>="0"&&t<="9"}isAlphaNumeric(t){return this.isAlpha(t)||this.isDigit(t)}};var c=class{constructor(t){this.type=t}async prepare(t){}async evaluate(t){}},w=class extends c{constructor(e){super("Program");this.behaviors=e}},f=class extends c{constructor(e){super("Block");this.statements=e}async evaluate(e){for(let r of this.statements)r&&typeof r.evaluate=="function"&&await r.evaluate(e)}},B=class extends c{constructor(e){super("Selector");this.selectorText=e}},m=class extends c{constructor(e,r){super("Behavior");this.selector=e;this.body=r}},S=class extends c{constructor(e,r,s){super("StateEntry");this.name=e;this.value=r;this.important=s}},D=class extends c{constructor(e){super("StateBlock");this.entries=e}},N=class extends c{constructor(e,r,s){super("OnBlock");this.eventName=e;this.args=r;this.body=s}},W=class extends c{constructor(e,r){super("Assignment");this.target=e;this.value=r}async evaluate(e){if(!e.scope||!e.scope.setPath)return;let r;if(this.target instanceof h&&(r=this.target.name),!r)return;let s=await this.value.evaluate(e);return e.scope.setPath(r,s),s}},A=class extends c{constructor(e,r,s,n,o){super("Declaration");this.target=e;this.operator=r;this.value=s;this.flags=n;this.flagArgs=o}},h=class extends c{constructor(e){super("Identifier");this.name=e}async evaluate(e){if(e.scope)return e.scope.getPath(this.name)}},u=class extends c{constructor(e){super("Literal");this.value=e}async evaluate(){return this.value}},b=class extends c{constructor(e,r){super("UnaryExpression");this.operator=e;this.argument=r}async evaluate(e){let r=await this.argument.evaluate(e);return this.operator==="!"?!r:this.operator==="-"?-r:r}},C=class extends c{constructor(e,r,s){super("BinaryExpression");this.operator=e;this.left=r;this.right=s}async evaluate(e){let r=await this.left.evaluate(e),s=await this.right.evaluate(e);if(this.operator==="+")return r+s;if(this.operator==="-")return r-s}},g=class extends c{constructor(e,r){super("Directive");this.kind=e;this.name=r}async evaluate(){return`${this.kind}:${this.name}`}},P=class extends c{constructor(e,r){super("Query");this.direction=e;this.selector=r}};var L=class{constructor(t){this.tokens=t}index=0;peek(t=0){return this.tokens[this.index+t]??null}next(){let t=this.tokens[this.index++];if(!t)throw new Error("Unexpected end of input");return t}eof(){return this.index>=this.tokens.length}match(t){return this.peek()?.type===t?(this.next(),!0):!1}expect(t){let e=this.next();if(e.type!==t)throw new Error(`Expected ${t} but got ${e.type}`);return e}skipWhitespace(){for(;this.peek()?.type==="Whitespace";)this.next()}peekNonWhitespace(t=0){let e=0;for(let r=this.index;r<this.tokens.length;r++){let s=this.tokens[r];if(s.type!=="Whitespace"){if(e===t)return s;e+=1}}return null}};var d=class i{stream;constructor(t){let e=new k(t);this.stream=new L(e.tokenize())}static parseInline(t){return new i(`{${t}}`).parseInlineBlock()}parseProgram(){let t=[];for(this.stream.skipWhitespace();!this.stream.eof();)t.push(this.parseBehavior()),this.stream.skipWhitespace();return new w(t)}parseInlineBlock(){return this.stream.skipWhitespace(),this.parseBlock({allowDeclarations:!1})}parseBehavior(){this.stream.skipWhitespace(),this.stream.expect("Behavior");let t=this.parseSelector(),e=this.parseBlock({allowDeclarations:!0});return new m(t,e)}parseSelector(){let t="",e=!1;for(;;){let r=this.stream.peek();if(!r||r.type==="LBrace")break;if(r.type==="Whitespace"){this.stream.next(),e&&t[t.length-1]!==" "&&(t+=" ");continue}e=!0,t+=this.stream.next().value}if(!t.trim())throw new Error("Behavior selector is required");return new B(t.trim())}parseBlock(t){let e=t?.allowDeclarations??!1;this.stream.skipWhitespace(),this.stream.expect("LBrace");let r=[],s=e;for(;;){this.stream.skipWhitespace();let n=this.stream.peek();if(!n)throw new Error("Unterminated block");if(n.type==="RBrace"){this.stream.next();break}if(this.isDeclarationStart()){if(!e)throw new Error("Declarations are only allowed at the behavior root");if(!s)throw new Error("Declarations must appear before blocks");r.push(this.parseDeclaration())}else s&&(s=!1),r.push(this.parseStatement())}return new f(r)}parseStatement(){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unexpected end of input");if(t.type==="On")return this.parseOnBlock();if(t.type==="Construct")return this.parseConstructBlock();if(t.type==="Destruct")return this.parseDestructBlock();if(t.type==="Behavior")return this.parseBehavior();if(this.isAssignmentStart())return this.parseAssignment();throw new Error(`Unexpected token ${t.type}`)}parseStateBlock(){this.stream.expect("State"),this.stream.skipWhitespace(),this.stream.expect("LBrace");let t=[];for(;;){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unterminated state block");if(e.type==="RBrace"){this.stream.next();break}let r=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let s=this.parseExpression();this.stream.skipWhitespace();let n=!1;if(this.stream.peek()?.type==="Bang"){this.stream.next(),this.stream.skipWhitespace();let o=this.stream.next();if(o.type==="Identifier"&&o.value==="important")n=!0;else throw new Error("Expected 'important' after '!'")}this.stream.skipWhitespace(),this.stream.expect("Semicolon"),t.push(new S(r.value,s,n))}return new D(t)}parseOnBlock(){this.stream.expect("On"),this.stream.skipWhitespace();let t=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("LParen");let e=[];for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated on() arguments");if(s.type==="RParen"){this.stream.next();break}if(s.type==="Identifier"){e.push(this.stream.next().value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next();continue}throw new Error(`Unexpected token in on() args: ${s.type}`)}let r=this.parseBlock({allowDeclarations:!1});return new N(t.value,e,r)}parseAssignment(){let t=this.parseAssignmentTarget();this.stream.skipWhitespace(),this.stream.expect("Equals"),this.stream.skipWhitespace();let e=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new W(t,e)}parseExpression(){return this.parseAdditiveExpression()}parseAdditiveExpression(){let t=this.parseUnaryExpression();for(this.stream.skipWhitespace();;){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Plus"&&e.type!=="Minus")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseUnaryExpression();this.stream.skipWhitespace(),t=new C(r.type==="Plus"?"+":"-",t,s)}return t}parseUnaryExpression(){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Expected expression");if(t.type==="Bang"){this.stream.next();let e=this.parseUnaryExpression();return new b("!",e)}if(t.type==="Minus"){this.stream.next();let e=this.parseUnaryExpression();return new b("-",e)}return this.parsePrimaryExpression()}parsePrimaryExpression(){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Expected expression");if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new g(e,r.value)}if(t.type==="Question")return this.parseQueryExpression();if(t.type==="LParen"){this.stream.next();let e=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("RParen"),e}if(t.type==="Identifier"){let e=this.parseIdentifierPath();return new h(e)}if(t.type==="Boolean")return new u(this.stream.next().value==="true");if(t.type==="Null")return this.stream.next(),new u(null);if(t.type==="Number")return new u(Number(this.stream.next().value));if(t.type==="String")return new u(this.stream.next().value);throw new Error(`Unsupported expression token ${t.type}`)}parseAssignmentTarget(){let t=this.stream.peek();if(!t)throw new Error("Expected assignment target");if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new g(e,r.value)}if(t.type==="Identifier")return new h(this.parseIdentifierPath());throw new Error(`Invalid assignment target ${t.type}`)}parseDeclaration(){let t=this.parseDeclarationTarget();this.stream.skipWhitespace();let e=this.parseDeclarationOperator();this.stream.skipWhitespace();let r=this.parseExpression(),{flags:s,flagArgs:n}=this.parseFlags();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new A(t,e,r,s,n)}parseDeclarationTarget(){let t=this.stream.peek();if(!t)throw new Error("Expected declaration target");if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new g(e,r.value)}if(t.type==="Identifier")return new h(this.stream.next().value);throw new Error(`Invalid declaration target ${t.type}`)}parseDeclarationOperator(){this.stream.expect("Colon");let t=this.stream.peek();return t?t.type==="Equals"?(this.stream.next(),":="):t.type==="Less"?(this.stream.next(),":<"):t.type==="Greater"?(this.stream.next(),":>"):":":":"}parseFlags(){let t={},e={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let r=this.stream.expect("Identifier").value;if(r==="important")t.important=!0;else if(r==="trusted")t.trusted=!0;else if(r==="debounce")if(t.debounce=!0,this.stream.peek()?.type==="LParen"){this.stream.next(),this.stream.skipWhitespace();let s=this.stream.expect("Number");e.debounce=Number(s.value),this.stream.skipWhitespace(),this.stream.expect("RParen")}else e.debounce=200;else throw new Error(`Unknown flag ${r}`)}return{flags:t,flagArgs:e}}isDeclarationStart(){let t=this.stream.peekNonWhitespace(0);if(!t)return!1;if(t.type==="Identifier")return this.stream.peekNonWhitespace(1)?.type==="Colon";if(t.type==="At"||t.type==="Dollar"){let e=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return e?.type==="Identifier"&&r?.type==="Colon"}return!1}isAssignmentStart(){let t=this.stream.peekNonWhitespace(0);if(!t)return!1;if(t.type==="Identifier"){let e=this.stream.peekNonWhitespace(1);return e?.type==="Equals"||e?.type==="Dot"}if(t.type==="At"||t.type==="Dollar"){let e=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return e?.type==="Identifier"&&r?.type==="Equals"}return!1}parseConstructBlock(){this.stream.expect("Construct");let t=this.parseBlock({allowDeclarations:!1});return t.type="Construct",t}parseDestructBlock(){this.stream.expect("Destruct");let t=this.parseBlock({allowDeclarations:!1});return t.type="Destruct",t}parseQueryExpression(){this.stream.expect("Question");let t="self";this.stream.peek()?.type==="Greater"?(this.stream.next(),t="descendant"):this.stream.peek()?.type==="Less"&&(this.stream.next(),t="ancestor"),this.stream.skipWhitespace(),this.stream.expect("LParen");let e=this.readSelectorUntil("RParen");return new P(t,e)}readSelectorUntil(t){let e="",r=!1;for(;;){let s=this.stream.peek();if(!s)throw new Error("Unterminated selector");if(s.type===t){this.stream.next();break}if(s.type==="Whitespace"){this.stream.next(),r&&e[e.length-1]!==" "&&(e+=" ");continue}r=!0,e+=this.stream.next().value}return e.trim()}parseIdentifierPath(){let t=this.stream.expect("Identifier").value;for(;this.stream.peek()?.type==="Dot";){this.stream.next();let e=this.stream.expect("Identifier").value;t=`${t}.${e}`}return t}};var H=class{constructor(t){this.parent=t;this.root=t?t.root:this}data=new Map;root;listeners=new Map;get(t){return this.getPath(t)}set(t,e){this.setPath(t,e)}getPath(t){let{targetScope:e,targetPath:r}=this.resolveScope(t);if(!e||!r)return;let s=r.split("."),n=s[0];if(!n)return;let o=e.data.get(n);for(let p=1;p<s.length;p+=1){if(o==null)return;let l=s[p];if(!l)return;o=o[l]}return o}setPath(t,e){let{targetScope:r,targetPath:s}=this.resolveScope(t);if(!r||!s)return;let n=s.split("."),o=n[0];if(!o)return;if(n.length===1){r.data.set(o,e),r.emitChange(s);return}let p=r.data.get(o);(p==null||typeof p!="object")&&(p={},r.data.set(o,p));let l=p;for(let M=1;M<n.length-1;M+=1){let y=n[M];if(!y)return;(l[y]==null||typeof l[y]!="object")&&(l[y]={}),l=l[y]}let x=n[n.length-1];x&&(l[x]=e,this.emitChange(t))}on(t,e){let r=t.trim();if(!r)return;let s=this.listeners.get(r)??new Set;s.add(e),this.listeners.set(r,s)}off(t,e){let r=t.trim(),s=this.listeners.get(r);s&&(s.delete(e),s.size===0&&this.listeners.delete(r))}emitChange(t){let e=t.trim();if(!e)return;this.listeners.get(e)?.forEach(s=>s());let r=e.split(".")[0];r&&r!==e&&this.listeners.get(r)?.forEach(s=>s())}resolveScope(t){return t.startsWith("parent.")?{targetScope:this.parent,targetPath:t.slice(7)}:t.startsWith("root.")?{targetScope:this.root,targetPath:t.slice(5)}:t.startsWith("self.")?{targetScope:this,targetPath:t.slice(5)}:{targetScope:this,targetPath:t}}};function _(i){return i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement?i.value:i.textContent??""}function Q(i,t){if(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement){i.value=t,i.setAttribute("value",t);return}i.textContent=t}function I(i,t,e){let r=t.trim();if(!r)return;let s=_(i).trim();s!==""&&e.set(r,s)}function T(i,t,e){let r=t.trim();if(!r)return;let s=e.get(r);s!=null&&Q(i,String(s))}function $(i,t){let e=i.trim();return e?!!t.get(e):!1}function R(i,t,e){i.style.display=$(t,e)?"":"none"}function O(i,t,e){i.style.display=$(t,e)?"":"none"}function z(i){return i.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"")}function v(i,t,e,r){let s=t.trim();if(!s)return;let n=e.get(s),o=n==null?"":String(n);i.innerHTML=r?o:z(o)}async function F(i,t,e){if(!globalThis.fetch)throw new Error("fetch is not available");let r=await globalThis.fetch(t.url);if(!r||!r.ok)return;let s=await r.text(),n=V(i,t.targetSelector);if(!n){i.dispatchEvent(new CustomEvent("vsn:targetError",{detail:{selector:t.targetSelector}}));return}if(t.swap==="outer"){let o=document.createElement("div");v(o,"__html",{get:()=>s},t.trusted);let p=o.firstElementChild;p&&n.parentNode&&n.parentNode.replaceChild(p,n);return}v(n,"__html",{get:()=>s},t.trusted)}function V(i,t){return t?i.ownerDocument.querySelector(t):i}function q(i,t){let e;return(...r)=>{e&&clearTimeout(e),e=setTimeout(()=>{e=void 0,i(...r)},t)}}var E=class{scopes=new WeakMap;bindBindings=new WeakMap;ifBindings=new WeakMap;showBindings=new WeakMap;htmlBindings=new WeakMap;getBindings=new WeakMap;lifecycleBindings=new WeakMap;behaviorRegistry=[];behaviorBindings=new WeakMap;behaviorId=0;codeCache=new Map;observer;attributeHandlers=[];constructor(){this.registerDefaultAttributeHandlers()}async mount(t){let e=[t,...Array.from(t.querySelectorAll("*"))];for(let r of e){if(!this.hasVsnAttributes(r))continue;let s=this.findParentScope(r);this.getScope(r,s),this.attachAttributes(r),this.runConstruct(r)}await this.applyBehaviors(t),this.attachObserver(t)}unmount(t){this.runDestruct(t)}registerBehaviors(t){let e=new d(t).parseProgram();for(let r of e.behaviors)this.collectBehavior(r)}registerAttributeHandler(t){this.attributeHandlers.push(t)}getScope(t,e){let r=this.scopes.get(t);if(r)return r;let s=new H(e??this.findParentScope(t));return this.scopes.set(t,s),s}evaluate(t){let e=this.getScope(t),r=this.bindBindings.get(t);r&&(r.direction==="from"||r.direction==="both")&&T(t,r.expr,e);let s=this.ifBindings.get(t);s&&t instanceof HTMLElement&&R(t,s,e);let n=this.showBindings.get(t);n&&t instanceof HTMLElement&&O(t,n,e);let o=this.htmlBindings.get(t);o&&t instanceof HTMLElement&&v(t,o.expr,e,o.trusted)}attachObserver(t){this.observer||(this.observer=new MutationObserver(e=>{for(let r of e)for(let s of Array.from(r.removedNodes))s&&s.nodeType===1&&this.handleRemovedNode(s)}),this.observer.observe(t,{childList:!0,subtree:!0}))}handleRemovedNode(t){this.lifecycleBindings.has(t)&&this.runDestruct(t),this.behaviorBindings.has(t)&&this.runBehaviorDestruct(t);for(let e of Array.from(t.querySelectorAll("*")))this.lifecycleBindings.has(e)&&this.runDestruct(e),this.behaviorBindings.has(e)&&this.runBehaviorDestruct(e)}async applyBehaviors(t){if(this.behaviorRegistry.length!==0)for(let e of this.behaviorRegistry){let r=[];t.matches(e.selector)&&r.push(t),r.push(...Array.from(t.querySelectorAll(e.selector)));for(let s of r){let n=this.behaviorBindings.get(s)??new Set;if(n.has(e.id))continue;n.add(e.id),this.behaviorBindings.set(s,n);let o=this.getScope(s);e.construct&&await this.executeBlock(e.construct,o)}}}runBehaviorDestruct(t){let e=this.behaviorBindings.get(t);if(!e)return;let r=this.getScope(t);for(let s of this.behaviorRegistry)!e.has(s.id)||!s.destruct||this.executeBlock(s.destruct,r)}attachAttributes(t){let e=this.getScope(t);for(let r of t.getAttributeNames()){if(!r.startsWith("vsn-"))continue;let s=t.getAttribute(r)??"";for(let n of this.attributeHandlers){if(!n.match(r))continue;if(n.handle(t,r,s,e)!==!1)break}}}setLifecycle(t,e){let r=this.lifecycleBindings.get(t)??{};this.lifecycleBindings.set(t,{...r,...e})}runConstruct(t){let e=this.lifecycleBindings.get(t);if(!e?.construct)return;let r=this.getScope(t);this.execute(e.construct,r)}runDestruct(t){let e=this.lifecycleBindings.get(t);if(!e?.destruct)return;let r=this.getScope(t);this.execute(e.destruct,r)}attachBindInputHandler(t,e){if(!(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement))return;let r=()=>{let s=this.getScope(t);I(t,e,s)};t.addEventListener("input",r),t.addEventListener("change",r)}parseBindDirection(t){return t.includes(":from")?"from":t.includes(":to")?"to":"both"}hasVsnAttributes(t){return t.getAttributeNames().some(e=>e.startsWith("vsn-"))}findParentScope(t){let e=t.parentElement;for(;e;){let r=this.scopes.get(e);if(r)return r;e=e.parentElement}}watch(t,e,r){let s=e.trim();s&&t.on(s,r)}parseOnAttribute(t,e){if(!t.startsWith("vsn-on:"))return null;let r=t.slice(7),[s,...n]=r.split("!");if(!s)return null;let o;for(let l of n){if(!l.startsWith("debounce"))continue;let x=l.match(/debounce\((\d+)\)/);o=x?Number(x[1]):200}return{event:s,code:e,...o!==void 0?{debounceMs:o}:{}}}attachOnHandler(t,e){let r=async()=>{let n=this.getScope(t);await this.execute(e.code,n),this.evaluate(t)},s=e.debounceMs?q(r,e.debounceMs):r;t.addEventListener(e.event,s)}attachGetHandler(t){t.addEventListener("click",async()=>{let e=this.getBindings.get(t);e&&await F(t,e,this.getScope(t))})}async execute(t,e){let r=this.codeCache.get(t);r||(r=d.parseInline(t),this.codeCache.set(t,r));let s={scope:e};await r.evaluate(s)}async executeBlock(t,e){let r={scope:e};await t.evaluate(r)}collectBehavior(t,e){let r=e?`${e} ${t.selector.selectorText}`:t.selector.selectorText,s=this.extractLifecycle(t.body);this.behaviorRegistry.push({id:this.behaviorId+=1,selector:r,...s});for(let n of t.body.statements)n instanceof m&&this.collectBehavior(n,r)}extractLifecycle(t){let e,r;for(let s of t.statements)s instanceof f&&(s.type==="Construct"?e=s:s.type==="Destruct"&&(r=s));return{...e?{construct:e}:{},...r?{destruct:r}:{}}}registerDefaultAttributeHandlers(){this.registerAttributeHandler({id:"vsn-bind",match:t=>t.startsWith("vsn-bind"),handle:(t,e,r,s)=>{let n=this.parseBindDirection(e);this.bindBindings.set(t,{expr:r,direction:n}),(n==="to"||n==="both")&&(I(t,r,s),this.attachBindInputHandler(t,r)),(n==="from"||n==="both")&&this.watch(s,r,()=>T(t,r,s))}}),this.registerAttributeHandler({id:"vsn-if",match:t=>t==="vsn-if",handle:(t,e,r,s)=>{this.ifBindings.set(t,r),t instanceof HTMLElement&&R(t,r,s),this.watch(s,r,()=>this.evaluate(t))}}),this.registerAttributeHandler({id:"vsn-show",match:t=>t==="vsn-show",handle:(t,e,r,s)=>{this.showBindings.set(t,r),t instanceof HTMLElement&&O(t,r,s),this.watch(s,r,()=>this.evaluate(t))}}),this.registerAttributeHandler({id:"vsn-html",match:t=>t.startsWith("vsn-html"),handle:(t,e,r,s)=>{let n=e.includes("!trusted");this.htmlBindings.set(t,{expr:r,trusted:n}),t instanceof HTMLElement&&v(t,r,s,n),this.watch(s,r,()=>this.evaluate(t))}}),this.registerAttributeHandler({id:"vsn-get",match:t=>t.startsWith("vsn-get"),handle:(t,e)=>{let r=e.includes("!trusted"),s=t.getAttribute(e)??"",n=t.getAttribute("vsn-target")??void 0,o=t.getAttribute("vsn-swap")??"inner",p={url:s,swap:o,trusted:r,...n?{targetSelector:n}:{}};this.getBindings.set(t,p),this.attachGetHandler(t)}}),this.registerAttributeHandler({id:"vsn-construct",match:t=>t==="vsn-construct",handle:(t,e,r)=>{this.setLifecycle(t,{construct:r})}}),this.registerAttributeHandler({id:"vsn-destruct",match:t=>t==="vsn-destruct",handle:(t,e,r)=>{this.setLifecycle(t,{destruct:r})}}),this.registerAttributeHandler({id:"vsn-on",match:t=>t.startsWith("vsn-on:"),handle:(t,e,r)=>{let s=this.parseOnAttribute(e,r);s&&this.attachOnHandler(t,s)}})}};var Nt="0.1.0";function Ct(i){return new d(i).parseProgram()}function j(i=document){if(console.log("auto mounting"),typeof document>"u")return null;let t=new E,e=()=>{let r=i instanceof Document?i.body:i;r&&t.mount(r)};return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),t}typeof document<"u"&&document.querySelector("script[auto-mount]")&&j();export{W as AssignmentNode,c as BaseNode,m as BehaviorNode,C as BinaryExpression,f as BlockNode,A as DeclarationNode,g as DirectiveExpression,E as Engine,h as IdentifierExpression,k as Lexer,u as LiteralExpression,N as OnBlockNode,d as Parser,w as ProgramNode,P as QueryExpression,B as SelectorNode,D as StateBlockNode,S as StateEntryNode,U as TokenType,b as UnaryExpression,Nt as VERSION,j as autoMount,Ct as parseCFS};
//# sourceMappingURL=index.min.js.map