var $=(c=>(c.Whitespace="Whitespace",c.Identifier="Identifier",c.Number="Number",c.String="String",c.Boolean="Boolean",c.Null="Null",c.Behavior="Behavior",c.Use="Use",c.State="State",c.On="On",c.Construct="Construct",c.Destruct="Destruct",c.LBrace="LBrace",c.RBrace="RBrace",c.LParen="LParen",c.RParen="RParen",c.LBracket="LBracket",c.RBracket="RBracket",c.Colon="Colon",c.Semicolon="Semicolon",c.Comma="Comma",c.Dot="Dot",c.Hash="Hash",c.Greater="Greater",c.Less="Less",c.Plus="Plus",c.Minus="Minus",c.Tilde="Tilde",c.Star="Star",c.Equals="Equals",c.DoubleEquals="DoubleEquals",c.NotEquals="NotEquals",c.LessEqual="LessEqual",c.GreaterEqual="GreaterEqual",c.And="And",c.Or="Or",c.Bang="Bang",c.At="At",c.Dollar="Dollar",c.Question="Question",c))($||{});var Q={behavior:"Behavior",use:"Use",state:"State",on:"On",construct:"Construct",destruct:"Destruct",true:"Boolean",false:"Boolean",null:"Null"},B=class{constructor(e){this.input=e}index=0;line=1;column=1;tokenize(){let e=[];for(;!this.eof();){let t=this.peek();if(this.isWhitespace(t)){e.push(this.readWhitespace());continue}if(t==="/"&&this.peek(1)==="/"){this.readLineComment();continue}if(t==="/"&&this.peek(1)==="*"){this.readBlockComment();continue}if(this.isAlpha(t)||t==="_"){e.push(this.readIdentifier());continue}if(this.isDigit(t)||t==="-"&&this.isDigit(this.peek(1))){e.push(this.readNumber());continue}if(t==='"'||t==="'"){e.push(this.readString());continue}let s=this.readPunctuator();if(s){e.push(s);continue}throw new Error(`Unexpected character '${t}' at ${this.line}:${this.column}`)}return e}readWhitespace(){let e=this.position(),t="";for(;!this.eof()&&this.isWhitespace(this.peek());)t+=this.next();return this.token("Whitespace",t,e)}readLineComment(){for(this.next(),this.next();!this.eof()&&this.peek()!==`
`;)this.next()}readBlockComment(){for(this.next(),this.next();!this.eof();){if(this.peek()==="*"&&this.peek(1)==="/"){this.next(),this.next();return}this.next()}}readIdentifier(){let e=this.position(),t="";for(;!this.eof()&&(this.isAlphaNumeric(this.peek())||this.peek()==="_"||this.peek()==="-");)t+=this.next();let s=Q[t];return s?this.token(s,t,e):this.token("Identifier",t,e)}readNumber(){let e=this.position(),t="";for(this.peek()==="-"&&(t+=this.next());!this.eof()&&this.isDigit(this.peek());)t+=this.next();if(this.peek()===".")for(t+=this.next();!this.eof()&&this.isDigit(this.peek());)t+=this.next();return this.token("Number",t,e)}readString(){let e=this.next(),t=this.position(),s="";for(;!this.eof();){let i=this.next();if(i==="\\"){let r=this.next();s+=r;continue}if(i===e)return this.token("String",s,t);s+=i}throw new Error(`Unterminated string at ${t.line}:${t.column}`)}readPunctuator(){let e=this.position(),t=this.peek(),s=this.peek(1);if(t==="="&&s==="=")return this.next(),this.next(),this.token("DoubleEquals","==",e);if(t==="!"&&s==="=")return this.next(),this.next(),this.token("NotEquals","!=",e);if(t==="<"&&s==="=")return this.next(),this.next(),this.token("LessEqual","<=",e);if(t===">"&&s==="=")return this.next(),this.next(),this.token("GreaterEqual",">=",e);if(t==="&"&&s==="&")return this.next(),this.next(),this.token("And","&&",e);if(t==="|"&&s==="|")return this.next(),this.next(),this.token("Or","||",e);let r={"{":"LBrace","}":"RBrace","(":"LParen",")":"RParen","[":"LBracket","]":"RBracket",":":"Colon",";":"Semicolon",",":"Comma",".":"Dot","#":"Hash",">":"Greater","<":"Less","+":"Plus","-":"Minus","~":"Tilde","*":"Star","=":"Equals","!":"Bang","@":"At",$:"Dollar","?":"Question"}[t];return r?(this.next(),this.token(r,t,e)):null}token(e,t,s){return{type:e,value:t,start:s,end:this.position()}}position(){return{index:this.index,line:this.line,column:this.column}}peek(e=0){return this.input[this.index+e]??""}next(){let e=this.input[this.index++]??"";return e===`
`?(this.line+=1,this.column=1):this.column+=1,e}eof(){return this.index>=this.input.length}isWhitespace(e){return e===" "||e==="	"||e===`
`||e==="\r"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isDigit(e){return e>="0"&&e<="9"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}};var h=class{constructor(e){this.type=e}async prepare(e){}async evaluate(e){}},N=class extends h{constructor(t,s=[]){super("Program");this.behaviors=t;this.uses=s}},W=class extends h{constructor(t,s){super("Use");this.name=t;this.alias=s}},k=class extends h{constructor(t){super("Block");this.statements=t}async evaluate(t){for(let s of this.statements)s&&typeof s.evaluate=="function"&&await s.evaluate(t)}},A=class extends h{constructor(t){super("Selector");this.selectorText=t}},E=class extends h{constructor(t,s){super("Behavior");this.selector=t;this.body=s}},L=class extends h{constructor(t,s,i){super("StateEntry");this.name=t;this.value=s;this.important=i}},C=class extends h{constructor(t){super("StateBlock");this.entries=t}},b=class extends h{constructor(t,s,i){super("OnBlock");this.eventName=t;this.args=s;this.body=i}},P=class extends h{constructor(t,s){super("Assignment");this.target=t;this.value=s}async evaluate(t){if(!t.scope||!t.scope.setPath)return;let s;if(this.target instanceof u&&(s=this.target.name),!s)return;let i=await this.value.evaluate(t);return t.scope.setPath(s,i),i}},w=class extends h{constructor(t,s,i,r,n){super("Declaration");this.target=t;this.operator=s;this.value=i;this.flags=r;this.flagArgs=n}},u=class extends h{constructor(t){super("Identifier");this.name=t}async evaluate(t){if(t.scope)return t.scope.getPath(this.name)}},v=class extends h{constructor(t){super("Literal");this.value=t}async evaluate(){return this.value}},S=class extends h{constructor(t,s){super("UnaryExpression");this.operator=t;this.argument=s}async evaluate(t){let s=await this.argument.evaluate(t);return this.operator==="!"?!s:this.operator==="-"?-s:s}},g=class extends h{constructor(t,s,i){super("BinaryExpression");this.operator=t;this.left=s;this.right=i}async evaluate(t){if(this.operator==="&&")return await this.left.evaluate(t)&&await this.right.evaluate(t);if(this.operator==="||")return await this.left.evaluate(t)||await this.right.evaluate(t);let s=await this.left.evaluate(t),i=await this.right.evaluate(t);if(this.operator==="+")return s+i;if(this.operator==="-")return s-i;if(this.operator==="==")return s==i;if(this.operator==="!=")return s!=i;if(this.operator==="<")return s<i;if(this.operator===">")return s>i;if(this.operator==="<=")return s<=i;if(this.operator===">=")return s>=i}},H=class extends h{constructor(t,s){super("CallExpression");this.callee=t;this.args=s}async evaluate(t){let s=this.resolveCallee(t),i=s?.fn??await this.callee.evaluate(t);if(typeof i!="function")return;let r=[];for(let n of this.args)r.push(await n.evaluate(t));return i.apply(s?.thisArg,r)}resolveCallee(t){if(!(this.callee instanceof u))return;let s=this.callee.name,i=t.globals??{},r=s.split("."),n=r[0];if(!n||!(n in i))return;let o=i[n],p;for(let l=1;l<r.length;l+=1){p=o;let m=r[l];if(!m)return;o=o?.[m]}return{fn:o,thisArg:p}}},f=class extends h{constructor(t,s){super("Directive");this.kind=t;this.name=s}async evaluate(){return`${this.kind}:${this.name}`}},I=class extends h{constructor(t,s){super("Query");this.direction=t;this.selector=s}async evaluate(t){let s=this.selector.trim();if(!s)return[];if(this.direction==="ancestor"){let r=[],n=t.element?.parentElement;for(;n;)n.matches(s)&&r.push(n),n=n.parentElement;return r}let i=this.direction==="descendant"?t.element??(typeof document<"u"?document:void 0):typeof document<"u"?document:void 0;return!i||!("querySelectorAll"in i)?[]:Array.from(i.querySelectorAll(s))}};var M=class{constructor(e){this.tokens=e}index=0;peek(e=0){return this.tokens[this.index+e]??null}next(){let e=this.tokens[this.index++];if(!e)throw new Error("Unexpected end of input");return e}eof(){return this.index>=this.tokens.length}match(e){return this.peek()?.type===e?(this.next(),!0):!1}expect(e){let t=this.next();if(t.type!==e)throw new Error(`Expected ${e} but got ${t.type}`);return t}skipWhitespace(){for(;this.peek()?.type==="Whitespace";)this.next()}peekNonWhitespace(e=0){let t=0;for(let s=this.index;s<this.tokens.length;s++){let i=this.tokens[s];if(i.type!=="Whitespace"){if(t===e)return i;t+=1}}return null}};var x=class a{stream;constructor(e){let t=new B(e);this.stream=new M(t.tokenize())}static parseInline(e){return new a(`{${e}}`).parseInlineBlock()}parseProgram(){let e=[],t=[];for(this.stream.skipWhitespace();!this.stream.eof();){let s=this.stream.peek();if(!s)break;s.type==="Use"?t.push(this.parseUseStatement()):e.push(this.parseBehavior()),this.stream.skipWhitespace()}return new N(e,t)}parseInlineBlock(){return this.stream.skipWhitespace(),this.parseBlock({allowDeclarations:!1})}parseBehavior(){this.stream.skipWhitespace(),this.stream.expect("Behavior");let e=this.parseSelector(),t=this.parseBlock({allowDeclarations:!0});return new E(e,t)}parseSelector(){let e="",t=!1;for(;;){let s=this.stream.peek();if(!s||s.type==="LBrace")break;if(s.type==="Whitespace"){this.stream.next(),t&&e[e.length-1]!==" "&&(e+=" ");continue}t=!0,e+=this.stream.next().value}if(!e.trim())throw new Error("Behavior selector is required");return new A(e.trim())}parseUseStatement(){this.stream.expect("Use"),this.stream.skipWhitespace();let e=this.parseIdentifierPath();this.stream.skipWhitespace();let t=e,s=this.stream.peek();return s?.type==="Identifier"&&s.value==="as"&&(this.stream.next(),this.stream.skipWhitespace(),t=this.stream.expect("Identifier").value),this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new W(e,t)}parseBlock(e){let t=e?.allowDeclarations??!1;this.stream.skipWhitespace(),this.stream.expect("LBrace");let s=[],i=t;for(;;){this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Unterminated block");if(r.type==="RBrace"){this.stream.next();break}if(this.isDeclarationStart()){if(!t)throw new Error("Declarations are only allowed at the behavior root");if(!i)throw new Error("Declarations must appear before blocks");s.push(this.parseDeclaration())}else i&&(i=!1),s.push(this.parseStatement())}return new k(s)}parseStatement(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unexpected end of input");if(e.type==="On")return this.parseOnBlock();if(e.type==="Construct")return this.parseConstructBlock();if(e.type==="Destruct")return this.parseDestructBlock();if(e.type==="Behavior")return this.parseBehavior();if(this.isCallStart())return this.parseExpressionStatement();if(this.isAssignmentStart())return this.parseAssignment();throw new Error(`Unexpected token ${e.type}`)}parseStateBlock(){this.stream.expect("State"),this.stream.skipWhitespace(),this.stream.expect("LBrace");let e=[];for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unterminated state block");if(t.type==="RBrace"){this.stream.next();break}let s=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let i=this.parseExpression();this.stream.skipWhitespace();let r=!1;if(this.stream.peek()?.type==="Bang"){this.stream.next(),this.stream.skipWhitespace();let n=this.stream.next();if(n.type==="Identifier"&&n.value==="important")r=!0;else throw new Error("Expected 'important' after '!'")}this.stream.skipWhitespace(),this.stream.expect("Semicolon"),e.push(new L(s.value,i,r))}return new C(e)}parseOnBlock(){this.stream.expect("On"),this.stream.skipWhitespace();let e=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("LParen");let t=[];for(;;){this.stream.skipWhitespace();let i=this.stream.peek();if(!i)throw new Error("Unterminated on() arguments");if(i.type==="RParen"){this.stream.next();break}if(i.type==="Identifier"){t.push(this.stream.next().value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next();continue}throw new Error(`Unexpected token in on() args: ${i.type}`)}let s=this.parseBlock({allowDeclarations:!1});return new b(e.value,t,s)}parseAssignment(){let e=this.parseAssignmentTarget();this.stream.skipWhitespace(),this.stream.expect("Equals"),this.stream.skipWhitespace();let t=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new P(e,t)}parseExpression(){return this.parseLogicalOrExpression()}parseLogicalOrExpression(){let e=this.parseLogicalAndExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Or")break;this.stream.skipWhitespace(),this.stream.next(),this.stream.skipWhitespace();let s=this.parseLogicalAndExpression();this.stream.skipWhitespace(),e=new g("||",e,s)}return e}parseLogicalAndExpression(){let e=this.parseEqualityExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="And")break;this.stream.skipWhitespace(),this.stream.next(),this.stream.skipWhitespace();let s=this.parseEqualityExpression();this.stream.skipWhitespace(),e=new g("&&",e,s)}return e}parseEqualityExpression(){let e=this.parseComparisonExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="DoubleEquals"&&t.type!=="NotEquals")break;this.stream.skipWhitespace();let s=this.stream.next();this.stream.skipWhitespace();let i=this.parseComparisonExpression();this.stream.skipWhitespace(),e=new g(s.type==="DoubleEquals"?"==":"!=",e,i)}return e}parseComparisonExpression(){let e=this.parseAdditiveExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Less"&&t.type!=="Greater"&&t.type!=="LessEqual"&&t.type!=="GreaterEqual")break;this.stream.skipWhitespace();let s=this.stream.next();this.stream.skipWhitespace();let i=this.parseAdditiveExpression();this.stream.skipWhitespace();let r="<";s.type==="Greater"?r=">":s.type==="LessEqual"?r="<=":s.type==="GreaterEqual"&&(r=">="),e=new g(r,e,i)}return e}parseAdditiveExpression(){let e=this.parseUnaryExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Plus"&&t.type!=="Minus")break;this.stream.skipWhitespace();let s=this.stream.next();this.stream.skipWhitespace();let i=this.parseUnaryExpression();this.stream.skipWhitespace(),e=new g(s.type==="Plus"?"+":"-",e,i)}return e}parseUnaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="Bang"){this.stream.next();let t=this.parseUnaryExpression();return new S("!",t)}if(e.type==="Minus"){this.stream.next();let t=this.parseUnaryExpression();return new S("-",t)}return this.parseCallExpression()}parseCallExpression(){let e=this.parsePrimaryExpression();for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="LParen";){this.stream.next();let t=[];for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated call expression");if(s.type==="RParen"){this.stream.next();break}if(t.push(this.parseExpression()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in call arguments")}e=new H(e,t)}return e}parsePrimaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let s=this.stream.expect("Identifier");return new f(t,s.value)}if(e.type==="Question")return this.parseQueryExpression();if(e.type==="LParen"){this.stream.next();let t=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("RParen"),t}if(e.type==="Identifier"){let t=this.parseIdentifierPath();return new u(t)}if(e.type==="Boolean")return new v(this.stream.next().value==="true");if(e.type==="Null")return this.stream.next(),new v(null);if(e.type==="Number")return new v(Number(this.stream.next().value));if(e.type==="String")return new v(this.stream.next().value);throw new Error(`Unsupported expression token ${e.type}`)}parseAssignmentTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected assignment target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let s=this.stream.expect("Identifier");return new f(t,s.value)}if(e.type==="Identifier")return new u(this.parseIdentifierPath());throw new Error(`Invalid assignment target ${e.type}`)}parseDeclaration(){let e=this.parseDeclarationTarget();this.stream.skipWhitespace();let t=this.parseDeclarationOperator();this.stream.skipWhitespace();let s=this.parseExpression(),{flags:i,flagArgs:r}=this.parseFlags();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new w(e,t,s,i,r)}parseDeclarationTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected declaration target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let s=this.stream.expect("Identifier");return new f(t,s.value)}if(e.type==="Identifier")return new u(this.stream.next().value);throw new Error(`Invalid declaration target ${e.type}`)}parseDeclarationOperator(){this.stream.expect("Colon");let e=this.stream.peek();return e?e.type==="Equals"?(this.stream.next(),":="):e.type==="Less"?(this.stream.next(),":<"):e.type==="Greater"?(this.stream.next(),":>"):":":":"}parseFlags(){let e={},t={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let s=this.stream.expect("Identifier").value;if(s==="important")e.important=!0;else if(s==="trusted")e.trusted=!0;else if(s==="debounce")if(e.debounce=!0,this.stream.peek()?.type==="LParen"){this.stream.next(),this.stream.skipWhitespace();let i=this.stream.expect("Number");t.debounce=Number(i.value),this.stream.skipWhitespace(),this.stream.expect("RParen")}else t.debounce=200;else throw new Error(`Unknown flag ${s}`)}return{flags:e,flagArgs:t}}isDeclarationStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier")return this.stream.peekNonWhitespace(1)?.type==="Colon";if(e.type==="At"||e.type==="Dollar"){let t=this.stream.peekNonWhitespace(1),s=this.stream.peekNonWhitespace(2);return t?.type==="Identifier"&&s?.type==="Colon"}return!1}isAssignmentStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier"){let t=1;for(;this.stream.peekNonWhitespace(t)?.type==="Dot"&&this.stream.peekNonWhitespace(t+1)?.type==="Identifier";)t+=2;return this.stream.peekNonWhitespace(t)?.type==="Equals"}if(e.type==="At"||e.type==="Dollar"){let t=this.stream.peekNonWhitespace(1),s=this.stream.peekNonWhitespace(2);return t?.type==="Identifier"&&s?.type==="Equals"}return!1}isCallStart(){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Identifier")return!1;let t=1;for(;this.stream.peekNonWhitespace(t)?.type==="Dot"&&this.stream.peekNonWhitespace(t+1)?.type==="Identifier";)t+=2;return this.stream.peekNonWhitespace(t)?.type==="LParen"}parseExpressionStatement(){let e=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),e}parseConstructBlock(){this.stream.expect("Construct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Construct",e}parseDestructBlock(){this.stream.expect("Destruct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Destruct",e}parseQueryExpression(){this.stream.expect("Question");let e="self";this.stream.peek()?.type==="Greater"?(this.stream.next(),e="descendant"):this.stream.peek()?.type==="Less"&&(this.stream.next(),e="ancestor"),this.stream.skipWhitespace(),this.stream.expect("LParen");let t=this.readSelectorUntil("RParen");return new I(e,t)}readSelectorUntil(e){let t="",s=!1;for(;;){let i=this.stream.peek();if(!i)throw new Error("Unterminated selector");if(i.type===e){this.stream.next();break}if(i.type==="Whitespace"){this.stream.next(),s&&t[t.length-1]!==" "&&(t+=" ");continue}s=!0,t+=this.stream.next().value}return t.trim()}parseIdentifierPath(){let e=this.stream.expect("Identifier").value;for(;this.stream.peek()?.type==="Dot";){this.stream.next();let t=this.stream.expect("Identifier").value;e=`${e}.${t}`}return e}};var T=class{constructor(e){this.parent=e;this.root=e?e.root:this}data=new Map;root;listeners=new Map;get(e){return this.getPath(e)}set(e,t){this.setPath(e,t)}getPath(e){let{targetScope:t,targetPath:s}=this.resolveScope(e);if(!t||!s)return;let i=s.split("."),r=i[0];if(!r)return;let n=t.data.get(r);for(let o=1;o<i.length;o+=1){if(n==null)return;let p=i[o];if(!p)return;n=n[p]}return n}setPath(e,t){let{targetScope:s,targetPath:i}=this.resolveScope(e);if(!s||!i)return;let r=i.split("."),n=r[0];if(!n)return;if(r.length===1){s.data.set(n,t),s.emitChange(i);return}let o=s.data.get(n);(o==null||typeof o!="object")&&(o={},s.data.set(n,o));let p=o;for(let m=1;m<r.length-1;m+=1){let d=r[m];if(!d)return;(p[d]==null||typeof p[d]!="object")&&(p[d]={}),p=p[d]}let l=r[r.length-1];l&&(p[l]=t,this.emitChange(e))}on(e,t){let s=e.trim();if(!s)return;let i=this.listeners.get(s)??new Set;i.add(t),this.listeners.set(s,i)}off(e,t){let s=e.trim(),i=this.listeners.get(s);i&&(i.delete(t),i.size===0&&this.listeners.delete(s))}emitChange(e){let t=e.trim();if(!t)return;this.listeners.get(t)?.forEach(i=>i());let s=t.split(".")[0];s&&s!==t&&this.listeners.get(s)?.forEach(i=>i())}resolveScope(e){return e.startsWith("parent.")?{targetScope:this.parent,targetPath:e.slice(7)}:e.startsWith("root.")?{targetScope:this.root,targetPath:e.slice(5)}:e.startsWith("self.")?{targetScope:this,targetPath:e.slice(5)}:{targetScope:this,targetPath:e}}};function _(a){return a instanceof HTMLInputElement||a instanceof HTMLTextAreaElement?a.value:a.textContent??""}function z(a,e){if(a instanceof HTMLInputElement||a instanceof HTMLTextAreaElement){a.value=e,a.setAttribute("value",e);return}a.textContent=e}function q(a,e,t){let s=e.trim();if(!s)return;let i=_(a).trim();i!==""&&t.set(s,i)}function R(a,e,t){let s=e.trim();if(!s)return;let i=t.get(s);i!=null&&z(a,String(i))}function F(a,e){let t=a.trim();return t?!!e.get(t):!1}function U(a,e,t){a.style.display=F(e,t)?"":"none"}function G(a,e,t){a.style.display=F(e,t)?"":"none"}function K(a){return a.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"")}function y(a,e,t,s){let i=e.trim();if(!i)return;let r=t.get(i),n=r==null?"":String(r);a.innerHTML=s?n:K(n)}async function V(a,e,t){if(!globalThis.fetch)throw new Error("fetch is not available");let s=await globalThis.fetch(e.url);if(!s||!s.ok)return;let i=await s.text(),r=j(a,e.targetSelector);if(!r){a.dispatchEvent(new CustomEvent("vsn:targetError",{detail:{selector:e.targetSelector}}));return}if(e.swap==="outer"){let n=document.createElement("div");y(n,"__html",{get:()=>i},e.trusted);let o=n.firstElementChild;o&&r.parentNode&&r.parentNode.replaceChild(o,r);return}y(r,"__html",{get:()=>i},e.trusted)}function j(a,e){return e?a.ownerDocument.querySelector(e):a}function O(a,e){let t;return(...s)=>{t&&clearTimeout(t),t=setTimeout(()=>{t=void 0,a(...s)},e)}}var D=class{scopes=new WeakMap;bindBindings=new WeakMap;ifBindings=new WeakMap;showBindings=new WeakMap;htmlBindings=new WeakMap;getBindings=new WeakMap;lifecycleBindings=new WeakMap;behaviorRegistry=[];behaviorBindings=new WeakMap;behaviorId=0;codeCache=new Map;observer;attributeHandlers=[];globals={};importantFlags=new WeakMap;constructor(){this.registerGlobal("console",console),this.registerQueryHelpers(),this.registerDefaultAttributeHandlers()}async mount(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let s of t){if(!this.hasVsnAttributes(s))continue;let i=this.findParentScope(s);this.getScope(s,i),this.attachAttributes(s),this.runConstruct(s)}await this.applyBehaviors(e),this.attachObserver(e)}unmount(e){this.runDestruct(e)}registerBehaviors(e){let t=new x(e).parseProgram();for(let s of t.uses){let i=this.resolveGlobalPath(s.name);if(i===void 0){console.warn(`vsn: global '${s.name}' not found`);continue}this.registerGlobal(s.alias,i)}for(let s of t.behaviors)this.collectBehavior(s)}registerGlobal(e,t){this.globals[e]=t}registerGlobals(e){Object.assign(this.globals,e)}registerAttributeHandler(e){this.attributeHandlers.push(e)}resolveGlobalPath(e){let t=e.split("."),s=t[0];if(!s)return;let i=globalThis[s];for(let r=1;r<t.length;r+=1){let n=t[r];if(!n)return;i=i?.[n]}return i}getScope(e,t){let s=this.scopes.get(e);if(s)return s;let i=new T(t??this.findParentScope(e));return this.scopes.set(e,i),i}evaluate(e){let t=this.getScope(e),s=this.bindBindings.get(e);s&&(s.direction==="from"||s.direction==="both")&&R(e,s.expr,t);let i=this.ifBindings.get(e);i&&e instanceof HTMLElement&&U(e,i,t);let r=this.showBindings.get(e);r&&e instanceof HTMLElement&&G(e,r,t);let n=this.htmlBindings.get(e);n&&e instanceof HTMLElement&&y(e,n.expr,t,n.trusted)}attachObserver(e){this.observer||(this.observer=new MutationObserver(t=>{for(let s of t){for(let i of Array.from(s.addedNodes))i&&i.nodeType===1&&this.handleAddedNode(i);for(let i of Array.from(s.removedNodes))i&&i.nodeType===1&&this.handleRemovedNode(i)}}),this.observer.observe(e,{childList:!0,subtree:!0}))}handleRemovedNode(e){this.lifecycleBindings.has(e)&&this.runDestruct(e),this.behaviorBindings.has(e)&&this.runBehaviorDestruct(e);for(let t of Array.from(e.querySelectorAll("*")))this.lifecycleBindings.has(t)&&this.runDestruct(t),this.behaviorBindings.has(t)&&this.runBehaviorDestruct(t)}handleAddedNode(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let s of t){if(!this.hasVsnAttributes(s))continue;let i=this.findParentScope(s);this.getScope(s,i),this.attachAttributes(s),this.runConstruct(s)}this.applyBehaviors(e)}async applyBehaviors(e){if(this.behaviorRegistry.length===0)return;let t=[e,...Array.from(e.querySelectorAll("*"))];for(let s of t){let i=this.behaviorBindings.get(s)??new Set,r=this.behaviorRegistry.filter(o=>i.has(o.id)?!1:s.matches(o.selector));if(r.length===0)continue;r.sort((o,p)=>o.specificity!==p.specificity?o.specificity-p.specificity:o.order-p.order);let n=this.getScope(s);for(let o of r){i.add(o.id),await this.applyBehaviorDeclarations(s,n,o.declarations),o.construct&&await this.executeBlock(o.construct,n,s);for(let p of o.onBlocks)this.attachBehaviorOnHandler(s,p.event,p.body)}this.behaviorBindings.set(s,i)}}runBehaviorDestruct(e){let t=this.behaviorBindings.get(e);if(!t)return;let s=this.getScope(e);for(let i of this.behaviorRegistry)!t.has(i.id)||!i.destruct||this.executeBlock(i.destruct,s,e)}attachAttributes(e){let t=this.getScope(e);for(let s of e.getAttributeNames()){if(!s.startsWith("vsn-"))continue;let i=e.getAttribute(s)??"";for(let r of this.attributeHandlers){if(!r.match(s))continue;if(r.handle(e,s,i,t)!==!1)break}}}setLifecycle(e,t){let s=this.lifecycleBindings.get(e)??{};this.lifecycleBindings.set(e,{...s,...t})}runConstruct(e){let t=this.lifecycleBindings.get(e);if(!t?.construct)return;let s=this.getScope(e);this.execute(t.construct,s,e)}runDestruct(e){let t=this.lifecycleBindings.get(e);if(!t?.destruct)return;let s=this.getScope(e);this.execute(t.destruct,s,e)}attachBindInputHandler(e,t){if(!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement))return;let s=()=>{let i=this.getScope(e);q(e,t,i)};e.addEventListener("input",s),e.addEventListener("change",s)}parseBindDirection(e){return e.includes(":from")?"from":e.includes(":to")?"to":"both"}hasVsnAttributes(e){return e.getAttributeNames().some(t=>t.startsWith("vsn-"))}findParentScope(e){let t=e.parentElement;for(;t;){let s=this.scopes.get(t);if(s)return s;t=t.parentElement}}watch(e,t,s){let i=t.trim();i&&e.on(i,s)}watchWithDebounce(e,t,s,i){i?this.watch(e,t,O(s,i)):this.watch(e,t,s)}parseOnAttribute(e,t){if(!e.startsWith("vsn-on:"))return null;let s=e.slice(7),[i,...r]=s.split("!");if(!i)return null;let n;for(let p of r){if(!p.startsWith("debounce"))continue;let l=p.match(/debounce\((\d+)\)/);n=l?Number(l[1]):200}return{event:i,code:t,...n!==void 0?{debounceMs:n}:{}}}attachOnHandler(e,t){let s=async()=>{let r=this.getScope(e);await this.execute(t.code,r,e),this.evaluate(e)},i=t.debounceMs?O(s,t.debounceMs):s;e.addEventListener(t.event,i)}attachBehaviorOnHandler(e,t,s){let i=async()=>{let r=this.getScope(e);await this.executeBlock(s,r,e),this.evaluate(e)};e.addEventListener(t,i)}attachGetHandler(e){e.addEventListener("click",async()=>{let t=this.getBindings.get(e);t&&await V(e,t,this.getScope(e))})}async execute(e,t,s){let i=this.codeCache.get(e);i||(i=x.parseInline(e),this.codeCache.set(e,i));let r={scope:t,globals:this.globals,...s?{element:s}:{}};await i.evaluate(r)}async executeBlock(e,t,s){let i={scope:t,globals:this.globals,...s?{element:s}:{}};await e.evaluate(i)}collectBehavior(e,t){let s=t?`${t} ${e.selector.selectorText}`:e.selector.selectorText,i=this.extractLifecycle(e.body);this.behaviorRegistry.push({id:this.behaviorId+=1,selector:s,specificity:this.computeSpecificity(s),order:this.behaviorRegistry.length,onBlocks:this.extractOnBlocks(e.body),declarations:this.extractDeclarations(e.body),...i});for(let r of e.body.statements)r instanceof E&&this.collectBehavior(r,s)}computeSpecificity(e){let t=e.match(/#[\w-]+/g)?.length??0,s=e.match(/\.[\w-]+/g)?.length??0,i=e.match(/\[[^\]]+\]/g)?.length??0,r=e.match(/:[\w-]+/g)?.length??0,n=e.match(/(^|[\s>+~])([a-zA-Z][\w-]*)/g)?.length??0;return t*100+(s+i+r)*10+n}registerQueryHelpers(){let e=i=>typeof document>"u"?[]:Array.from(document.querySelectorAll(i)),t=(i,r)=>i?Array.from(i.querySelectorAll(r)):[],s=(i,r)=>{let n=[],o=i?.parentElement;for(;o;)o.matches(r)&&n.push(o),o=o.parentElement;return n};this.registerGlobal("?",i=>e(i)),this.registerGlobal("?>",(i,r)=>t(r,i)),this.registerGlobal("?<",(i,r)=>s(r,i))}getImportantKey(e){if(e.target instanceof u)return`state:${e.target.name}`;if(e.target instanceof f)return`${e.target.kind}:${e.target.name}`}isImportant(e,t){let s=this.importantFlags.get(e);return s?s.has(t):!1}markImportant(e,t){let s=this.importantFlags.get(e)??new Set;s.add(t),this.importantFlags.set(e,s)}extractLifecycle(e){let t,s;for(let i of e.statements)i instanceof k&&(i.type==="Construct"?t=i:i.type==="Destruct"&&(s=i));return{...t?{construct:t}:{},...s?{destruct:s}:{}}}extractOnBlocks(e){let t=[];for(let s of e.statements)s instanceof b&&t.push({event:s.eventName,body:s.body});return t}extractDeclarations(e){let t=[];for(let s of e.statements)s instanceof w&&t.push(s);return t}async applyBehaviorDeclarations(e,t,s){for(let i of s)await this.applyBehaviorDeclaration(e,t,i)}async applyBehaviorDeclaration(e,t,s){let i={scope:t,element:e},r=s.operator,n=s.flags.debounce?s.flagArgs.debounce??200:void 0,o=this.getImportantKey(s);if(!s.flags.important&&o&&this.isImportant(e,o))return;if(s.target instanceof u){let d=await s.value.evaluate(i);t.setPath(s.target.name,d),s.flags.important&&o&&this.markImportant(e,o);return}if(!(s.target instanceof f))return;let p=s.target,l=s.value instanceof u?s.value.name:void 0;if(r===":>"){l&&this.applyDirectiveToScope(e,p,l,t,n),s.flags.important&&o&&this.markImportant(e,o);return}if(r===":="&&l&&this.applyDirectiveToScope(e,p,l,t,n),!l){let d=await s.value.evaluate(i);this.setDirectiveValue(e,p,d,s.flags.trusted),s.flags.important&&o&&this.markImportant(e,o);return}let m=r===":<"||r===":=";this.applyDirectiveFromScope(e,p,l,t,s.flags.trusted,n,m),s.flags.important&&o&&this.markImportant(e,o)}applyDirectiveFromScope(e,t,s,i,r,n,o=!0){if(t.kind==="attr"&&t.name==="html"&&e instanceof HTMLElement){let l=()=>y(e,s,i,!!r);l(),o&&this.watchWithDebounce(i,s,l,n);return}let p=()=>{let l=i.get(s);l!=null&&this.setDirectiveValue(e,t,l,r)};p(),o&&this.watchWithDebounce(i,s,p,n)}applyDirectiveToScope(e,t,s,i,r){if(t.kind==="attr"&&t.name==="value"){this.applyValueBindingToScope(e,s,r);return}let n=this.getDirectiveValue(e,t);n!=null&&i.set(s,n)}applyValueBindingToScope(e,t,s){if(!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement))return;let i=()=>{let n=this.getScope(e);q(e,t,n)},r=s?O(i,s):i;r(),e.addEventListener("input",r),e.addEventListener("change",r)}setDirectiveValue(e,t,s,i){if(t.kind==="attr"&&t.name==="html"&&e instanceof HTMLElement){let r=s==null?"":String(s);e.innerHTML=i?r:r.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"");return}if(t.kind==="attr"){if(t.name==="value"){if(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement){e.value=s==null?"":String(s),e.setAttribute("value",e.value);return}if(e instanceof HTMLSelectElement){e.value=s==null?"":String(s);return}}if(t.name==="checked"&&e instanceof HTMLInputElement){let r=!!s;e.checked=r,r?e.setAttribute("checked",""):e.removeAttribute("checked");return}e.setAttribute(t.name,s==null?"":String(s));return}t.kind==="style"&&e instanceof HTMLElement&&e.style.setProperty(t.name,s==null?"":String(s))}getDirectiveValue(e,t){if(t.kind==="attr")return t.name==="value"&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)?e.value:t.name==="checked"&&e instanceof HTMLInputElement?e.checked?"true":"false":e.getAttribute(t.name)??void 0;if(t.kind==="style"&&e instanceof HTMLElement)return e.style.getPropertyValue(t.name)??void 0}registerDefaultAttributeHandlers(){this.registerAttributeHandler({id:"vsn-bind",match:e=>e.startsWith("vsn-bind"),handle:(e,t,s,i)=>{let r=this.parseBindDirection(t);this.bindBindings.set(e,{expr:s,direction:r}),(r==="to"||r==="both")&&(q(e,s,i),this.attachBindInputHandler(e,s)),(r==="from"||r==="both")&&this.watch(i,s,()=>R(e,s,i))}}),this.registerAttributeHandler({id:"vsn-if",match:e=>e==="vsn-if",handle:(e,t,s,i)=>{this.ifBindings.set(e,s),e instanceof HTMLElement&&U(e,s,i),this.watch(i,s,()=>this.evaluate(e))}}),this.registerAttributeHandler({id:"vsn-show",match:e=>e==="vsn-show",handle:(e,t,s,i)=>{this.showBindings.set(e,s),e instanceof HTMLElement&&G(e,s,i),this.watch(i,s,()=>this.evaluate(e))}}),this.registerAttributeHandler({id:"vsn-html",match:e=>e.startsWith("vsn-html"),handle:(e,t,s,i)=>{let r=t.includes("!trusted");this.htmlBindings.set(e,{expr:s,trusted:r}),e instanceof HTMLElement&&y(e,s,i,r),this.watch(i,s,()=>this.evaluate(e))}}),this.registerAttributeHandler({id:"vsn-get",match:e=>e.startsWith("vsn-get"),handle:(e,t)=>{let s=t.includes("!trusted"),i=e.getAttribute(t)??"",r=e.getAttribute("vsn-target")??void 0,n=e.getAttribute("vsn-swap")??"inner",o={url:i,swap:n,trusted:s,...r?{targetSelector:r}:{}};this.getBindings.set(e,o),this.attachGetHandler(e)}}),this.registerAttributeHandler({id:"vsn-construct",match:e=>e==="vsn-construct",handle:(e,t,s)=>{this.setLifecycle(e,{construct:s})}}),this.registerAttributeHandler({id:"vsn-destruct",match:e=>e==="vsn-destruct",handle:(e,t,s)=>{this.setLifecycle(e,{destruct:s})}}),this.registerAttributeHandler({id:"vsn-on",match:e=>e.startsWith("vsn-on:"),handle:(e,t,s)=>{let i=this.parseOnAttribute(t,s);i&&this.attachOnHandler(e,i)}})}};var Ae="0.1.0";function Pe(a){return new x(a).parseProgram()}function Z(a=document){if(typeof document>"u")return null;let e=new D,t=()=>{let s=a instanceof Document?a.body:a;if(s){let i=Array.from(document.querySelectorAll('script[type="text/vsn"]')).map(r=>r.textContent??"").join(`
`);i.trim()&&e.registerBehaviors(i),e.mount(s)}};return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t(),e}typeof document<"u"&&document.querySelector("script[auto-mount]")&&Z();export{P as AssignmentNode,h as BaseNode,E as BehaviorNode,g as BinaryExpression,k as BlockNode,H as CallExpression,w as DeclarationNode,f as DirectiveExpression,D as Engine,u as IdentifierExpression,B as Lexer,v as LiteralExpression,b as OnBlockNode,x as Parser,N as ProgramNode,I as QueryExpression,A as SelectorNode,C as StateBlockNode,L as StateEntryNode,$ as TokenType,S as UnaryExpression,W as UseNode,Ae as VERSION,Z as autoMount,Pe as parseCFS};
//# sourceMappingURL=index.min.js.map