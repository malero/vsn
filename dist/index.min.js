var J=(l=>(l.Whitespace="Whitespace",l.Identifier="Identifier",l.Number="Number",l.String="String",l.Boolean="Boolean",l.Null="Null",l.Behavior="Behavior",l.Use="Use",l.State="State",l.On="On",l.Construct="Construct",l.Destruct="Destruct",l.Return="Return",l.LBrace="LBrace",l.RBrace="RBrace",l.LParen="LParen",l.RParen="RParen",l.LBracket="LBracket",l.RBracket="RBracket",l.Colon="Colon",l.Semicolon="Semicolon",l.Comma="Comma",l.Dot="Dot",l.Hash="Hash",l.Greater="Greater",l.Less="Less",l.Plus="Plus",l.Minus="Minus",l.Tilde="Tilde",l.Star="Star",l.Equals="Equals",l.Arrow="Arrow",l.DoubleEquals="DoubleEquals",l.NotEquals="NotEquals",l.LessEqual="LessEqual",l.GreaterEqual="GreaterEqual",l.And="And",l.Or="Or",l.Bang="Bang",l.At="At",l.Dollar="Dollar",l.Question="Question",l))(J||{});var ee={behavior:"Behavior",use:"Use",state:"State",on:"On",construct:"Construct",destruct:"Destruct",return:"Return",true:"Boolean",false:"Boolean",null:"Null"},C=class{constructor(e){this.input=e}index=0;line=1;column=1;tokenize(){let e=[];for(;!this.eof();){let t=this.peek();if(this.isWhitespace(t)){e.push(this.readWhitespace());continue}if(t==="/"&&this.peek(1)==="/"){this.readLineComment();continue}if(t==="/"&&this.peek(1)==="*"){this.readBlockComment();continue}if(this.isAlpha(t)||t==="_"){e.push(this.readIdentifier());continue}if(this.isDigit(t)||t==="-"&&this.isDigit(this.peek(1))){e.push(this.readNumber());continue}if(t==='"'||t==="'"){e.push(this.readString());continue}let r=this.readPunctuator();if(r){e.push(r);continue}throw new Error(`Unexpected character '${t}' at ${this.line}:${this.column}`)}return e}readWhitespace(){let e=this.position(),t="";for(;!this.eof()&&this.isWhitespace(this.peek());)t+=this.next();return this.token("Whitespace",t,e)}readLineComment(){for(this.next(),this.next();!this.eof()&&this.peek()!==`
`;)this.next()}readBlockComment(){for(this.next(),this.next();!this.eof();){if(this.peek()==="*"&&this.peek(1)==="/"){this.next(),this.next();return}this.next()}}readIdentifier(){let e=this.position(),t="";for(;!this.eof()&&(this.isAlphaNumeric(this.peek())||this.peek()==="_"||this.peek()==="-");)t+=this.next();let r=ee[t];return r?this.token(r,t,e):this.token("Identifier",t,e)}readNumber(){let e=this.position(),t="";for(this.peek()==="-"&&(t+=this.next());!this.eof()&&this.isDigit(this.peek());)t+=this.next();if(this.peek()===".")for(t+=this.next();!this.eof()&&this.isDigit(this.peek());)t+=this.next();return this.token("Number",t,e)}readString(){let e=this.next(),t=this.position(),r="";for(;!this.eof();){let s=this.next();if(s==="\\"){let i=this.next();r+=i;continue}if(s===e)return this.token("String",r,t);r+=s}throw new Error(`Unterminated string at ${t.line}:${t.column}`)}readPunctuator(){let e=this.position(),t=this.peek(),r=this.peek(1);if(t==="="&&r==="=")return this.next(),this.next(),this.token("DoubleEquals","==",e);if(t==="="&&r===">")return this.next(),this.next(),this.token("Arrow","=>",e);if(t==="!"&&r==="=")return this.next(),this.next(),this.token("NotEquals","!=",e);if(t==="<"&&r==="=")return this.next(),this.next(),this.token("LessEqual","<=",e);if(t===">"&&r==="=")return this.next(),this.next(),this.token("GreaterEqual",">=",e);if(t==="&"&&r==="&")return this.next(),this.next(),this.token("And","&&",e);if(t==="|"&&r==="|")return this.next(),this.next(),this.token("Or","||",e);let i={"{":"LBrace","}":"RBrace","(":"LParen",")":"RParen","[":"LBracket","]":"RBracket",":":"Colon",";":"Semicolon",",":"Comma",".":"Dot","#":"Hash",">":"Greater","<":"Less","+":"Plus","-":"Minus","~":"Tilde","*":"Star","=":"Equals","!":"Bang","@":"At",$:"Dollar","?":"Question"}[t];return i?(this.next(),this.token(i,t,e)):null}token(e,t,r){return{type:e,value:t,start:r,end:this.position()}}position(){return{index:this.index,line:this.line,column:this.column}}peek(e=0){return this.input[this.index+e]??""}next(){let e=this.input[this.index++]??"";return e===`
`?(this.line+=1,this.column=1):this.column+=1,e}eof(){return this.index>=this.input.length}isWhitespace(e){return e===" "||e==="	"||e===`
`||e==="\r"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isDigit(e){return e>="0"&&e<="9"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}};var u=class{constructor(e){this.type=e}async prepare(e){}async evaluate(e){}},H=class extends u{constructor(t,r=[]){super("Program");this.behaviors=t;this.uses=r}},I=class extends u{constructor(t,r){super("Use");this.name=t;this.alias=r}},v=class extends u{constructor(t){super("Block");this.statements=t}async evaluate(t){for(let r of this.statements){if(t.returning)break;r&&typeof r.evaluate=="function"&&await r.evaluate(t)}}},T=class extends u{constructor(t){super("Selector");this.selectorText=t}},S=class extends u{constructor(t,r){super("Behavior");this.selector=t;this.body=r}},R=class extends u{constructor(t,r,s){super("StateEntry");this.name=t;this.value=r;this.important=s}},O=class extends u{constructor(t){super("StateBlock");this.entries=t}},N=class extends u{constructor(t,r,s,i=[]){super("OnBlock");this.eventName=t;this.args=r;this.body=s;this.modifiers=i}},A=class extends u{constructor(t,r){super("Assignment");this.target=t;this.value=r}async evaluate(t){if(!t.scope||!t.scope.setPath)return;let r;if(this.target instanceof m&&(r=this.target.name),!r)return;let s=await this.value.evaluate(t);return t.scope.setPath(r,s),s}},W=class extends u{constructor(t){super("Return");this.value=t}async evaluate(t){return t.returning||(t.returnValue=this.value?await this.value.evaluate(t):void 0,t.returning=!0),t.returnValue}},D=class extends u{constructor(t,r,s,i=!1){super("FunctionDeclaration");this.name=t;this.params=r;this.body=s;this.isAsync=i}},k=class extends u{constructor(t,r,s=!1){super("FunctionExpression");this.params=t;this.body=r;this.isAsync=s}async evaluate(t){let r=t.scope,s=t.globals,i=t.element;return async(...n)=>{let a={...r?{scope:r}:{},...s?{globals:s}:{},...i?{element:i}:{},returnValue:void 0,returning:!1};if(r){let p=new Map;for(let c=0;c<this.params.length;c+=1){let h=this.params[c];h&&(p.set(h,r.getPath(h)),r.setPath&&r.setPath(h,n[c]))}await this.body.evaluate(a);for(let c of this.params)!c||!r.setPath||r.setPath(c,p.get(c))}else await this.body.evaluate(a);return a.returnValue}}},L=class extends u{constructor(t,r,s,i,n){super("Declaration");this.target=t;this.operator=r;this.value=s;this.flags=i;this.flagArgs=n}},m=class extends u{constructor(t){super("Identifier");this.name=t}async evaluate(t){if(t.scope)return t.scope.getPath(this.name)}},E=class extends u{constructor(t){super("Literal");this.value=t}async evaluate(){return this.value}},P=class extends u{constructor(t,r){super("UnaryExpression");this.operator=t;this.argument=r}async evaluate(t){let r=await this.argument.evaluate(t);return this.operator==="!"?!r:this.operator==="-"?-r:r}},y=class extends u{constructor(t,r,s){super("BinaryExpression");this.operator=t;this.left=r;this.right=s}async evaluate(t){if(this.operator==="&&")return await this.left.evaluate(t)&&await this.right.evaluate(t);if(this.operator==="||")return await this.left.evaluate(t)||await this.right.evaluate(t);let r=await this.left.evaluate(t),s=await this.right.evaluate(t);if(this.operator==="+")return r+s;if(this.operator==="-")return r-s;if(this.operator==="==")return r==s;if(this.operator==="!=")return r!=s;if(this.operator==="<")return r<s;if(this.operator===">")return r>s;if(this.operator==="<=")return r<=s;if(this.operator===">=")return r>=s}},q=class extends u{constructor(t,r,s){super("TernaryExpression");this.test=t;this.consequent=r;this.alternate=s}async evaluate(t){return await this.test.evaluate(t)?this.consequent.evaluate(t):this.alternate.evaluate(t)}},U=class extends u{constructor(t,r){super("CallExpression");this.callee=t;this.args=r}async evaluate(t){let r=this.resolveCallee(t),s=r?.fn??await this.callee.evaluate(t);if(typeof s!="function")return;let i=[];for(let n of this.args)i.push(await n.evaluate(t));return s.apply(r?.thisArg,i)}resolveCallee(t){if(!(this.callee instanceof m))return;let r=this.callee.name,s=t.globals??{},i=r.split("."),n=i[0];if(!n||!(n in s)){if(i.length>1&&t.scope){let c=i.slice(0,-1).join("."),h=i[i.length-1];if(!h)return;let d=t.scope.getPath(c);return d==null?void 0:{fn:d?.[h],thisArg:d}}return}let a=s[n],p;for(let c=1;c<i.length;c+=1){p=a;let h=i[c];if(!h)return;a=a?.[h]}return{fn:a,thisArg:p}}},$=class extends u{constructor(t){super("ArrayExpression");this.elements=t}async evaluate(t){let r=[];for(let s of this.elements)r.push(await s.evaluate(t));return r}},z=class extends u{constructor(t,r){super("IndexExpression");this.target=t;this.index=r}async evaluate(t){let r=await this.target.evaluate(t);if(r==null)return;let s=await this.index.evaluate(t);if(s!=null)return r[s]}},g=class extends u{constructor(t,r){super("Directive");this.kind=t;this.name=r}async evaluate(t){let r=t.element;if(!r)return`${this.kind}:${this.name}`;if(this.kind==="attr")return this.name==="value"&&(r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement||r instanceof HTMLSelectElement)?r.value:this.name==="checked"&&r instanceof HTMLInputElement?r.checked:this.name==="html"&&r instanceof HTMLElement?r.innerHTML:r.getAttribute(this.name)??void 0;if(this.kind==="style"&&r instanceof HTMLElement)return r.style.getPropertyValue(this.name)??void 0}},V=class extends u{constructor(t){super("AwaitExpression");this.argument=t}async evaluate(t){return await await this.argument.evaluate(t)}},G=class extends u{constructor(t,r){super("Query");this.direction=t;this.selector=r}async evaluate(t){let r=this.selector.trim();if(!r)return[];if(this.direction==="ancestor"){let i=[],n=t.element?.parentElement;for(;n;)n.matches(r)&&i.push(n),n=n.parentElement;return i}let s=this.direction==="descendant"?t.element??(typeof document<"u"?document:void 0):typeof document<"u"?document:void 0;return!s||!("querySelectorAll"in s)?[]:Array.from(s.querySelectorAll(r))}};var K=class{constructor(e){this.tokens=e}index=0;peek(e=0){return this.tokens[this.index+e]??null}next(){let e=this.tokens[this.index++];if(!e)throw new Error("Unexpected end of input");return e}eof(){return this.index>=this.tokens.length}match(e){return this.peek()?.type===e?(this.next(),!0):!1}expect(e){let t=this.next();if(t.type!==e)throw new Error(`Expected ${e} but got ${t.type}`);return t}skipWhitespace(){for(;this.peek()?.type==="Whitespace";)this.next()}peekNonWhitespace(e=0){let t=0;for(let r=this.index;r<this.tokens.length;r++){let s=this.tokens[r];if(s.type!=="Whitespace"){if(t===e)return s;t+=1}}return null}};var b=class o{stream;source;customFlags;allowImplicitSemicolon=!1;awaitStack=[];constructor(e,t){this.source=e,this.customFlags=t?.customFlags??new Set;let r=new C(e);this.stream=new K(r.tokenize())}static parseInline(e){return new o(`{${e}}`).parseInlineBlock()}parseProgram(){return this.wrapErrors(()=>{let e=[],t=[];for(this.stream.skipWhitespace();!this.stream.eof();){let r=this.stream.peek();if(!r)break;r.type==="Use"?t.push(this.parseUseStatement()):e.push(this.parseBehavior()),this.stream.skipWhitespace()}return new H(e,t)})}parseInlineBlock(){return this.wrapErrors(()=>(this.stream.skipWhitespace(),this.allowImplicitSemicolon=!0,this.parseBlock({allowDeclarations:!1})))}parseBehavior(){return this.wrapErrors(()=>{this.stream.skipWhitespace(),this.stream.expect("Behavior");let e=this.parseSelector(),t=this.parseBlock({allowDeclarations:!0});return new S(e,t)})}parseSelector(){let e="",t=!1;for(;;){let r=this.stream.peek();if(!r||r.type==="LBrace")break;if(r.type==="Whitespace"){this.stream.next(),t&&e[e.length-1]!==" "&&(e+=" ");continue}t=!0,e+=this.stream.next().value}if(!e.trim())throw new Error("Behavior selector is required");return new T(e.trim())}parseUseStatement(){return this.wrapErrors(()=>{this.stream.expect("Use"),this.stream.skipWhitespace();let e=this.parseIdentifierPath();this.stream.skipWhitespace();let t=e,r=this.stream.peek();return r?.type==="Identifier"&&r.value==="as"&&(this.stream.next(),this.stream.skipWhitespace(),t=this.stream.expect("Identifier").value),this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new I(e,t)})}wrapErrors(e){try{return e()}catch(t){throw t instanceof Error&&!/\(line\s+\d+, column\s+\d+\)/i.test(t.message)?new Error(this.formatError(t.message)):t}}formatError(e){let t=this.stream.peek()??this.stream.peekNonWhitespace(0);if(!t)return`Parse error: ${e}`;let r=t.start.line,s=t.start.column,i=this.getLineSnippet(r,s);return`Parse error (line ${r}, column ${s}): ${e}
${i}`}getLineSnippet(e,t){let s=this.source.split(/\r?\n/)[e-1]??"",i=`${" ".repeat(Math.max(t-1,0))}^`;return`${s}
${i}`}parseBlock(e){let t=e?.allowDeclarations??!1;this.stream.skipWhitespace(),this.stream.expect("LBrace");let r=[],s=t,i=!1,n=!1;for(;;){this.stream.skipWhitespace();let a=this.stream.peek();if(!a)throw new Error("Unterminated block");if(a.type==="RBrace"){this.stream.next();break}if(t&&this.isFunctionDeclarationStart()){i||(n=!0),r.push(this.parseFunctionDeclaration());continue}if(t&&this.isFunctionExpressionAssignmentStart()){if(!s)throw new Error("Declarations must appear before blocks");r.push(this.parseAssignment());continue}if(this.isDeclarationStart()){if(!t)throw new Error("Declarations are only allowed at the behavior root");if(!s)throw new Error("Declarations must appear before blocks");r.push(this.parseDeclaration())}else{if(s&&(s=!1),t&&a.type==="On"&&!i&&(n=!0),t&&a.type==="Construct"){if(n)throw new Error("Construct blocks must appear before functions and on blocks");i=!0}r.push(this.parseStatement())}}return new v(r)}parseStatement(e){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unexpected end of input");let r=e?.allowBlocks??!0,s=e?.allowReturn??!1;if(t.type==="Return"){if(!s)throw new Error("Return is only allowed inside functions");return this.parseReturnStatement()}if(r&&t.type==="On")return this.parseOnBlock();if(r&&t.type==="Construct")return this.parseConstructBlock();if(r&&t.type==="Destruct")return this.parseDestructBlock();if(r&&t.type==="Behavior")return this.parseBehavior();if(this.isAwaitAllowed()&&t.type==="Identifier"&&t.value==="await")return this.parseExpressionStatement();if(this.isCallStart())return this.parseExpressionStatement();if(this.isAssignmentStart())return this.parseAssignment();throw new Error(`Unexpected token ${t.type}`)}parseStateBlock(){this.stream.expect("State"),this.stream.skipWhitespace(),this.stream.expect("LBrace");let e=[];for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unterminated state block");if(t.type==="RBrace"){this.stream.next();break}let r=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let s=this.parseExpression();this.stream.skipWhitespace();let i=!1;if(this.stream.peek()?.type==="Bang"){this.stream.next(),this.stream.skipWhitespace();let n=this.stream.next();if(n.type==="Identifier"&&n.value==="important")i=!0;else throw new Error("Expected 'important' after '!'")}this.stream.skipWhitespace(),this.stream.expect("Semicolon"),e.push(new R(r.value,s,i))}return new O(e)}parseOnBlock(){this.stream.expect("On"),this.stream.skipWhitespace();let e=this.parseIdentifierPath();this.stream.skipWhitespace(),this.stream.expect("LParen");let t=[];for(;;){this.stream.skipWhitespace();let i=this.stream.peek();if(!i)throw new Error("Unterminated on() arguments");if(i.type==="RParen"){this.stream.next();break}if(i.type==="Identifier"){t.push(this.stream.next().value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next();continue}throw new Error(`Unexpected token in on() args: ${i.type}`)}let r=this.parseOnModifiers(),s=this.parseBlock({allowDeclarations:!1});return new N(e,t,s,r)}parseOnModifiers(){let e=[];for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let t=this.stream.expect("Identifier").value;e.push(t)}return e}parseAssignment(){let e=this.parseAssignmentTarget();this.stream.skipWhitespace(),this.stream.expect("Equals"),this.stream.skipWhitespace();let t=this.parseExpression();return this.consumeStatementTerminator(),new A(e,t)}parseExpression(){return this.parseTernaryExpression()}parseTernaryExpression(){let e=this.parseLogicalOrExpression();if(this.stream.skipWhitespace(),this.stream.peek()?.type!=="Question")return e;this.stream.next(),this.stream.skipWhitespace();let t=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let r=this.parseExpression();return new q(e,t,r)}parseLogicalOrExpression(){let e=this.parseLogicalAndExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Or")break;this.stream.skipWhitespace(),this.stream.next(),this.stream.skipWhitespace();let r=this.parseLogicalAndExpression();this.stream.skipWhitespace(),e=new y("||",e,r)}return e}parseLogicalAndExpression(){let e=this.parseEqualityExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="And")break;this.stream.skipWhitespace(),this.stream.next(),this.stream.skipWhitespace();let r=this.parseEqualityExpression();this.stream.skipWhitespace(),e=new y("&&",e,r)}return e}parseEqualityExpression(){let e=this.parseComparisonExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="DoubleEquals"&&t.type!=="NotEquals")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseComparisonExpression();this.stream.skipWhitespace(),e=new y(r.type==="DoubleEquals"?"==":"!=",e,s)}return e}parseComparisonExpression(){let e=this.parseAdditiveExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Less"&&t.type!=="Greater"&&t.type!=="LessEqual"&&t.type!=="GreaterEqual")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseAdditiveExpression();this.stream.skipWhitespace();let i="<";r.type==="Greater"?i=">":r.type==="LessEqual"?i="<=":r.type==="GreaterEqual"&&(i=">="),e=new y(i,e,s)}return e}parseAdditiveExpression(){let e=this.parseUnaryExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Plus"&&t.type!=="Minus")break;this.stream.skipWhitespace();let r=this.stream.next();this.stream.skipWhitespace();let s=this.parseUnaryExpression();this.stream.skipWhitespace(),e=new y(r.type==="Plus"?"+":"-",e,s)}return e}parseUnaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="Bang"){this.stream.next();let t=this.parseUnaryExpression();return new P("!",t)}if(e.type==="Minus"){this.stream.next();let t=this.parseUnaryExpression();return new P("-",t)}if(this.isAwaitAllowed()&&e.type==="Identifier"&&e.value==="await"){this.stream.next();let t=this.parseUnaryExpression();return new V(t)}return this.parseCallExpression()}parseCallExpression(){let e=this.parsePrimaryExpression();for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)break;if(t.type==="LParen"){this.stream.next();let r=[];for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated call expression");if(s.type==="RParen"){this.stream.next();break}if(r.push(this.parseExpression()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in call arguments")}e=new U(e,r);continue}if(t.type==="LBracket"){this.stream.next(),this.stream.skipWhitespace();let r=this.parseExpression();this.stream.skipWhitespace(),this.stream.expect("RBracket"),e=new z(e,r);continue}break}return e}parsePrimaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new g(t,r.value)}if(e.type==="Question")return this.parseQueryExpression();if(e.type==="LBracket")return this.parseArrayExpression();if(e.type==="LParen"){if(this.isArrowFunctionStart())return this.parseArrowFunctionExpression();this.stream.next();let t=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("RParen"),t}if(e.type==="Identifier"){if(this.isAsyncToken(e)&&this.isAsyncArrowFunctionStart())return this.stream.next(),this.stream.skipWhitespace(),this.parseArrowFunctionExpression(!0);let t=this.parseIdentifierPath();return new m(t)}if(e.type==="Boolean")return new E(this.stream.next().value==="true");if(e.type==="Null")return this.stream.next(),new E(null);if(e.type==="Number")return new E(Number(this.stream.next().value));if(e.type==="String")return new E(this.stream.next().value);throw new Error(`Unsupported expression token ${e.type}`)}parseArrayExpression(){this.stream.expect("LBracket");let e=[];for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unterminated array literal");if(t.type==="RBracket"){this.stream.next();break}if(e.push(this.parseExpression()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){if(this.stream.next(),this.stream.skipWhitespace(),this.stream.peek()?.type==="RBracket"){this.stream.next();break}continue}if(this.stream.peek()?.type==="RBracket"){this.stream.next();break}throw new Error("Expected ',' or ']' in array literal")}return new $(e)}consumeStatementTerminator(){this.stream.skipWhitespace();let e=this.stream.peek();if(e?.type==="Semicolon"){this.stream.next();return}this.allowImplicitSemicolon&&e?.type==="RBrace"||this.stream.expect("Semicolon")}parseFunctionBlockWithAwait(e){this.stream.expect("LBrace");let t=[];this.awaitStack.push(e);try{for(;;){this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Unterminated function block");if(r.type==="RBrace"){this.stream.next();break}t.push(this.parseStatement({allowBlocks:!1,allowReturn:!0}))}}finally{this.awaitStack.pop()}return new v(t)}isAsyncToken(e){return e?.type==="Identifier"&&e.value==="async"}isAwaitAllowed(){return this.awaitStack.length===0?!1:this.awaitStack[this.awaitStack.length-1]===!0}parseArrowExpressionBody(e){this.awaitStack.push(e);try{let t=this.parseExpression();return new v([new W(t)])}finally{this.awaitStack.pop()}}parseAssignmentTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected assignment target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new g(t,r.value)}if(e.type==="Identifier")return new m(this.parseIdentifierPath());throw new Error(`Invalid assignment target ${e.type}`)}parseDeclaration(){let e=this.parseDeclarationTarget();this.stream.skipWhitespace();let t=this.parseDeclarationOperator();this.stream.skipWhitespace();let r=this.parseExpression(),{flags:s,flagArgs:i}=this.parseFlags();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new L(e,t,r,s,i)}parseDeclarationTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected declaration target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new g(t,r.value)}if(e.type==="Identifier")return new m(this.stream.next().value);throw new Error(`Invalid declaration target ${e.type}`)}parseDeclarationOperator(){this.stream.expect("Colon");let e=this.stream.peek();return e?e.type==="Equals"?(this.stream.next(),":="):e.type==="Less"?(this.stream.next(),":<"):e.type==="Greater"?(this.stream.next(),":>"):":":":"}parseFlags(){let e={},t={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let r=this.stream.expect("Identifier").value;if(r==="important")e.important=!0;else if(r==="trusted")e.trusted=!0;else if(r==="debounce")if(e.debounce=!0,this.stream.peek()?.type==="LParen"){this.stream.next(),this.stream.skipWhitespace();let s=this.stream.expect("Number");t.debounce=Number(s.value),this.stream.skipWhitespace(),this.stream.expect("RParen")}else t.debounce=200;else if(this.customFlags.has(r)){e[r]=!0;let s=this.parseCustomFlagArg();s!==void 0&&(t[r]=s)}else throw new Error(`Unknown flag ${r}`)}return{flags:e,flagArgs:t}}parseCustomFlagArg(){if(this.stream.peek()?.type!=="LParen")return;this.stream.next(),this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unterminated flag arguments");let t;if(e.type==="Number")t=Number(this.stream.next().value);else if(e.type==="String")t=this.stream.next().value;else if(e.type==="Boolean")t=this.stream.next().value==="true";else if(e.type==="Identifier")t=this.stream.next().value;else throw new Error(`Unsupported flag argument ${e.type}`);return this.stream.skipWhitespace(),this.stream.expect("RParen"),t}isDeclarationStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier")return this.stream.peekNonWhitespace(1)?.type==="Colon";if(e.type==="At"||e.type==="Dollar"){let t=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return t?.type==="Identifier"&&r?.type==="Colon"}return!1}isAssignmentStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier"){let t=1;for(;this.stream.peekNonWhitespace(t)?.type==="Dot"&&this.stream.peekNonWhitespace(t+1)?.type==="Identifier";)t+=2;return this.stream.peekNonWhitespace(t)?.type==="Equals"}if(e.type==="At"||e.type==="Dollar"){let t=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return t?.type==="Identifier"&&r?.type==="Equals"}return!1}isCallStart(){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Identifier")return!1;let t=1;for(;this.stream.peekNonWhitespace(t)?.type==="Dot"&&this.stream.peekNonWhitespace(t+1)?.type==="Identifier";)t+=2;return this.stream.peekNonWhitespace(t)?.type==="LParen"}isFunctionDeclarationStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;let t=0;if(this.isAsyncToken(e)){let s=this.stream.peekNonWhitespace(1);if(!s||s.type!=="Identifier")return!1;t=1}else if(e.type!=="Identifier")return!1;if(t+=1,this.stream.peekNonWhitespace(t)?.type!=="LParen")return!1;t+=1;let r=1;for(;;){let s=this.stream.peekNonWhitespace(t);if(!s)return!1;if(s.type==="LParen")r+=1;else if(s.type==="RParen"&&(r-=1,r===0)){t+=1;break}t+=1}return this.stream.peekNonWhitespace(t)?.type==="LBrace"}isArrowFunctionStart(){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="LParen")return!1;let t=1,r=1;for(;;){let s=this.stream.peekNonWhitespace(t);if(!s)return!1;if(s.type==="LParen")r+=1;else if(s.type==="RParen"&&(r-=1,r===0)){t+=1;break}t+=1}return this.stream.peekNonWhitespace(t)?.type==="Arrow"}isAsyncArrowFunctionStart(){let e=this.stream.peekNonWhitespace(0);if(!this.isAsyncToken(e)||this.stream.peekNonWhitespace(1)?.type!=="LParen")return!1;let t=2,r=1;for(;;){let s=this.stream.peekNonWhitespace(t);if(!s)return!1;if(s.type==="LParen")r+=1;else if(s.type==="RParen"&&(r-=1,r===0)){t+=1;break}t+=1}return this.stream.peekNonWhitespace(t)?.type==="Arrow"}isFunctionExpressionAssignmentStart(){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Identifier"||this.stream.peekNonWhitespace(1)?.type!=="Equals")return!1;let t=2;if(this.isAsyncToken(this.stream.peekNonWhitespace(t))&&(t+=1),this.stream.peekNonWhitespace(t)?.type!=="LParen")return!1;t+=1;let r=1;for(;;){let s=this.stream.peekNonWhitespace(t);if(!s)return!1;if(s.type==="LParen")r+=1;else if(s.type==="RParen"&&(r-=1,r===0)){t+=1;break}t+=1}return this.stream.peekNonWhitespace(t)?.type==="Arrow"}parseExpressionStatement(){let e=this.parseExpression();return this.consumeStatementTerminator(),e}parseConstructBlock(){this.stream.expect("Construct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Construct",e}parseDestructBlock(){this.stream.expect("Destruct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Destruct",e}parseQueryExpression(){this.stream.expect("Question");let e="self";this.stream.peek()?.type==="Greater"?(this.stream.next(),e="descendant"):this.stream.peek()?.type==="Less"&&(this.stream.next(),e="ancestor"),this.stream.skipWhitespace(),this.stream.expect("LParen");let t=this.readSelectorUntil("RParen");return new G(e,t)}parseFunctionDeclaration(){let e=!1,t=this.stream.peekNonWhitespace(0);this.isAsyncToken(t)&&(this.stream.next(),this.stream.skipWhitespace(),e=!0);let r=this.stream.expect("Identifier").value;this.stream.skipWhitespace(),this.stream.expect("LParen");let s=[];for(;;){this.stream.skipWhitespace();let n=this.stream.peek();if(!n)throw new Error("Unterminated function parameters");if(n.type==="RParen"){this.stream.next();break}let a=this.stream.expect("Identifier").value;if(s.push(a),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in function parameters")}this.stream.skipWhitespace();let i=this.parseFunctionBlockWithAwait(e);return new D(r,s,i,e)}parseFunctionBlock(){return this.parseFunctionBlockWithAwait(!1)}parseReturnStatement(){if(this.stream.expect("Return"),this.stream.skipWhitespace(),this.stream.peek()?.type==="Semicolon")return this.stream.next(),new W;let e=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new W(e)}parseArrowFunctionExpression(e=!1){this.stream.expect("LParen");let t=[];for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated function parameters");if(s.type==="RParen"){this.stream.next();break}let i=this.stream.expect("Identifier").value;if(t.push(i),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in function parameters")}if(this.stream.skipWhitespace(),this.stream.expect("Arrow"),this.stream.skipWhitespace(),this.stream.peek()?.type==="LBrace"){let s=this.parseFunctionBlockWithAwait(e);return new k(t,s,e)}let r=this.parseArrowExpressionBody(e);return new k(t,r,e)}readSelectorUntil(e){let t="",r=!1;for(;;){let s=this.stream.peek();if(!s)throw new Error("Unterminated selector");if(s.type===e){this.stream.next();break}if(s.type==="Whitespace"){this.stream.next(),r&&t[t.length-1]!==" "&&(t+=" ");continue}r=!0,t+=this.stream.next().value}return t.trim()}parseIdentifierPath(){let e=this.stream.expect("Identifier").value;for(;this.stream.peek()?.type==="Dot";){this.stream.next();let t=this.stream.expect("Identifier").value;e=`${e}.${t}`}return e}};var M=class{constructor(e){this.parent=e;this.root=e?e.root:this}data=new Map;root;listeners=new Map;anyListeners=new Set;get(e){return this.getPath(e)}set(e,t){this.setPath(e,t)}hasKey(e){let r=e.split(".")[0];return r?this.data.has(r):!1}getPath(e){let t=e.startsWith("parent.")||e.startsWith("root.")||e.startsWith("self."),{targetScope:r,targetPath:s}=this.resolveScope(e);if(!r||!s)return;let i=this.getLocalPathValue(r,s);if(t||i!==void 0)return i;let n=r.parent;for(;n;){let a=this.getLocalPathValue(n,s);if(a!==void 0)return a;n=n.parent}}setPath(e,t){let r=e.startsWith("parent.")||e.startsWith("root.")||e.startsWith("self."),{targetScope:s,targetPath:i}=this.resolveScope(e);if(!s||!i)return;let n=r?s:this.findNearestScopeWithKey(s,i)??s,a=i.split("."),p=a[0];if(!p)return;if(a.length===1){n.data.set(p,t),n.emitChange(i);return}let c=n.data.get(p);(c==null||typeof c!="object")&&(c={},n.data.set(p,c));let h=c;for(let f=1;f<a.length-1;f+=1){let x=a[f];if(!x)return;(h[x]==null||typeof h[x]!="object")&&(h[x]={}),h=h[x]}let d=a[a.length-1];d&&(h[d]=t,n.emitChange(i))}on(e,t){let r=e.trim();if(!r)return;let s=this.listeners.get(r)??new Set;s.add(t),this.listeners.set(r,s)}off(e,t){let r=e.trim(),s=this.listeners.get(r);s&&(s.delete(t),s.size===0&&this.listeners.delete(r))}onAny(e){this.anyListeners.add(e)}offAny(e){this.anyListeners.delete(e)}emitChange(e){let t=e.trim();if(!t)return;this.listeners.get(t)?.forEach(s=>s());let r=t.split(".")[0];r&&r!==t&&this.listeners.get(r)?.forEach(s=>s()),this.anyListeners.forEach(s=>s())}resolveScope(e){let t=this,r=e;for(;r.startsWith("parent.");)t=t?.parent,r=r.slice(7);for(r.startsWith("root.")&&(t=t?.root,r=r.slice(5));r.startsWith("self.");)t=t??this,r=r.slice(5);return{targetScope:t,targetPath:r}}getLocalPathValue(e,t){let r=t.split("."),s=r[0];if(!s)return;let i=e.data.get(s);for(let n=1;n<r.length;n+=1){if(i==null)return;let a=r[n];if(!a)return;i=i[a]}return i}findNearestScopeWithKey(e,t){let r=t.split(".")[0];if(!r)return;let s=e;for(;s;){if(s.data.has(r))return s;s=s.parent}}};function te(o){return o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement?o.value:o.textContent??""}function re(o,e){if(o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement){o.value=e,o.setAttribute("value",e);return}o instanceof HTMLElement&&o.querySelector("*")||(o.textContent=e)}function Q(o,e,t){let r=e.trim();if(!r)return;let s=te(o).trim();s!==""&&t.set(r,s)}function j(o,e,t){let r=e.trim();if(!r)return;let s=t.get(r);s!=null&&re(o,String(s))}function Y(o,e){let t=o.trim();return t?!!e.get(t):!1}function _(o,e,t){o.style.display=Y(e,t)?"":"none"}function Z(o,e,t){o.style.display=Y(e,t)?"":"none"}function se(o){return o.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"")}function w(o,e,t,r){let s=e.trim();if(!s)return;let i=t.get(s),n=i==null?"":String(i);o.innerHTML=r?n:se(n)}async function X(o,e,t,r){if(!globalThis.fetch)throw new Error("fetch is not available");let s=await globalThis.fetch(e.url);if(!s||!s.ok)return;let i=await s.text(),n=ie(o,e.targetSelector);if(!n){o.dispatchEvent(new CustomEvent("vsn:targetError",{detail:{selector:e.targetSelector}}));return}if(e.swap==="outer"){let a=document.createElement("div");w(a,"__html",{get:()=>i},e.trusted);let p=a.firstElementChild;p&&n.parentNode&&(n.parentNode.replaceChild(p,n),r?.(p));return}w(n,"__html",{get:()=>i},e.trusted),r?.(n)}function ie(o,e){return e?o.ownerDocument.querySelector(e):o}function B(o,e){let t;return(...r)=>{t&&clearTimeout(t),t=setTimeout(()=>{t=void 0,o(...r)},e)}}var F=class{scopes=new WeakMap;bindBindings=new WeakMap;ifBindings=new WeakMap;showBindings=new WeakMap;htmlBindings=new WeakMap;getBindings=new WeakMap;eachBindings=new WeakMap;lifecycleBindings=new WeakMap;behaviorRegistry=[];behaviorBindings=new WeakMap;behaviorListeners=new WeakMap;behaviorId=0;codeCache=new Map;behaviorCache=new Map;observer;attributeHandlers=[];globals={};importantFlags=new WeakMap;inlineDeclarations=new WeakMap;flagHandlers=new Map;pendingAdded=new Set;pendingRemoved=new Set;pendingUpdated=new Set;observerFlush;constructor(){this.registerGlobal("console",console),this.registerGlobal("list",{async map(e,t){if(!Array.isArray(e)||typeof t!="function")return[];let r=[];for(let s=0;s<e.length;s+=1)r.push(await t(e[s],s));return r},async filter(e,t){if(!Array.isArray(e)||typeof t!="function")return[];let r=[];for(let s=0;s<e.length;s+=1)await t(e[s],s)&&r.push(e[s]);return r},async reduce(e,t,r){if(!Array.isArray(e)||typeof t!="function")return r;let s=arguments.length>2,i=s?r:e[0],n=s?0:1;for(let a=n;a<e.length;a+=1)i=await t(i,e[a],a);return i}}),this.registerDefaultAttributeHandlers()}async mount(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let r of t){if(!this.hasVsnAttributes(r))continue;let s=this.findParentScope(r);this.getScope(r,s),this.attachAttributes(r),this.runConstruct(r)}await this.applyBehaviors(e),this.attachObserver(e)}unmount(e){this.runDestruct(e)}registerBehaviors(e){let t=new b(e,{customFlags:new Set(this.flagHandlers.keys())}).parseProgram();for(let r of t.uses){let s=this.resolveGlobalPath(r.name);if(s===void 0){console.warn(`vsn: global '${r.name}' not found`);continue}this.registerGlobal(r.alias,s)}for(let r of t.behaviors)this.collectBehavior(r)}registerGlobal(e,t){this.globals[e]=t}registerGlobals(e){Object.assign(this.globals,e)}registerFlag(e,t={}){if(new Set(["important","trusted","debounce"]).has(e))throw new Error(`Flag '${e}' is reserved`);this.flagHandlers.set(e,t)}getRegistryStats(){return{behaviorCount:this.behaviorRegistry.length,behaviorCacheSize:this.behaviorCache.size}}registerAttributeHandler(e){this.attributeHandlers.push(e)}resolveGlobalPath(e){let t=e.split("."),r=t[0];if(!r)return;let s=globalThis[r];for(let i=1;i<t.length;i+=1){let n=t[i];if(!n)return;s=s?.[n]}return s}getScope(e,t){let r=this.scopes.get(e);if(r)return r;let s=new M(t??this.findParentScope(e));return this.scopes.set(e,s),s}evaluate(e){let t=this.getScope(e),r=this.bindBindings.get(e);r&&(r.direction==="from"||r.direction==="both")&&j(e,r.expr,t);let s=this.ifBindings.get(e);s&&e instanceof HTMLElement&&_(e,s,t);let i=this.showBindings.get(e);i&&e instanceof HTMLElement&&Z(e,i,t);let n=this.htmlBindings.get(e);n&&e instanceof HTMLElement&&(w(e,n.expr,t,n.trusted),n.trusted&&this.handleTrustedHtml(e))}attachObserver(e){this.observer||(this.observerFlush=B(()=>this.flushObserverQueue(),10),this.observer=new MutationObserver(t=>{for(let r of t){r.type==="attributes"&&r.target instanceof Element&&this.pendingUpdated.add(r.target);for(let s of Array.from(r.addedNodes))s&&s.nodeType===1&&this.pendingAdded.add(s);for(let s of Array.from(r.removedNodes))s&&s.nodeType===1&&this.pendingRemoved.add(s)}this.observerFlush?.()}),this.observer.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}))}flushObserverQueue(){let e=Array.from(this.pendingRemoved);this.pendingRemoved.clear();for(let s of e)this.handleRemovedNode(s);let t=Array.from(this.pendingUpdated);this.pendingUpdated.clear();for(let s of t)this.handleUpdatedNode(s);let r=Array.from(this.pendingAdded);this.pendingAdded.clear();for(let s of r)this.handleAddedNode(s)}handleRemovedNode(e){this.lifecycleBindings.has(e)&&this.runDestruct(e),this.behaviorBindings.has(e)&&this.runBehaviorDestruct(e);for(let t of Array.from(e.querySelectorAll("*")))this.lifecycleBindings.has(t)&&this.runDestruct(t),this.behaviorBindings.has(t)&&this.runBehaviorDestruct(t)}handleAddedNode(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let r of t){if(!this.hasVsnAttributes(r))continue;let s=this.findParentScope(r);this.getScope(r,s),this.attachAttributes(r),this.runConstruct(r)}this.applyBehaviors(e)}handleUpdatedNode(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let r of t)this.reapplyBehaviorsForElement(r)}async applyBehaviors(e){if(this.behaviorRegistry.length===0)return;let t=[e,...Array.from(e.querySelectorAll("*"))];for(let r of t)await this.reapplyBehaviorsForElement(r)}async reapplyBehaviorsForElement(e){if(this.behaviorRegistry.length===0)return;let t=this.behaviorBindings.get(e)??new Set,r=this.getScope(e),s=this.behaviorRegistry.filter(n=>e.matches(n.selector)).sort((n,a)=>n.specificity!==a.specificity?n.specificity-a.specificity:n.order-a.order);for(let n of s)t.has(n.id)||await this.applyBehaviorForElement(n,e,r,t);let i=new Set(s.map(n=>n.id));for(let n of this.behaviorRegistry)t.has(n.id)&&!i.has(n.id)&&this.unbindBehaviorForElement(n,e,r,t);this.behaviorBindings.set(e,t)}async applyBehaviorForElement(e,t,r,s){s.add(e.id),this.applyBehaviorFunctions(t,r,e.functions),await this.applyBehaviorDeclarations(t,r,e.declarations),e.construct&&await this.executeBlock(e.construct,r,t);for(let i of e.onBlocks)this.attachBehaviorOnHandler(t,i.event,i.body,i.modifiers,e.id)}unbindBehaviorForElement(e,t,r,s){s.delete(e.id),e.destruct&&this.executeBlock(e.destruct,r,t);let i=this.behaviorListeners.get(t),n=i?.get(e.id);if(n){for(let a of n)t.removeEventListener(a.event,a.handler,a.options);i?.delete(e.id)}}runBehaviorDestruct(e){let t=this.behaviorBindings.get(e);if(!t)return;let r=this.getScope(e);for(let s of this.behaviorRegistry)!t.has(s.id)||!s.destruct||this.executeBlock(s.destruct,r,e)}attachAttributes(e){let t=this.getScope(e);for(let r of e.getAttributeNames()){if(!r.startsWith("vsn-"))continue;let s=e.getAttribute(r)??"";for(let i of this.attributeHandlers){if(!i.match(r))continue;if(i.handle(e,r,s,t)!==!1)break}}}setLifecycle(e,t){let r=this.lifecycleBindings.get(e)??{};this.lifecycleBindings.set(e,{...r,...t})}runConstruct(e){let t=this.lifecycleBindings.get(e);if(!t?.construct)return;let r=this.getScope(e);this.execute(t.construct,r,e)}runDestruct(e){let t=this.lifecycleBindings.get(e);if(!t?.destruct)return;let r=this.getScope(e);this.execute(t.destruct,r,e)}parseEachExpression(e){let[t,r]=e.split(/\s+as\s+/);if(!t||!r)return null;let s=t.trim(),i=r.split(",").map(p=>p.trim()).filter(Boolean);if(!s||i.length===0)return null;let n=i[0]??"",a=i[1];return{listExpr:s,itemName:n,...a?{indexName:a}:{}}}renderEach(e){let t=this.eachBindings.get(e);if(!t||!(e instanceof HTMLTemplateElement))return;let r=e.parentElement;if(!r)return;for(let a of t.rendered)this.handleRemovedNode(a),a.parentNode&&a.parentNode.removeChild(a);t.rendered=[];let s=this.getScope(e),i=s.get(t.listExpr);if(!Array.isArray(i))return;let n=[];i.forEach((a,p)=>{let c=e.content.cloneNode(!0),h=Array.from(c.children),d=new M(s);d.setPath(t.itemName,a),t.indexName&&d.setPath(t.indexName,p);for(let f of h)this.getScope(f,d);r.insertBefore(c,e);for(let f of h){n.push(f),this.handleAddedNode(f),this.evaluate(f);for(let x of Array.from(f.querySelectorAll("*")))this.evaluate(x)}}),t.rendered=n}attachBindInputHandler(e,t){if(!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement))return;let r=()=>{let s=this.getScope(e);Q(e,t,s)};e.addEventListener("input",r),e.addEventListener("change",r)}parseBindDirection(e){return e.includes(":from")?"from":e.includes(":to")?"to":"both"}hasVsnAttributes(e){return e.getAttributeNames().some(t=>t.startsWith("vsn-"))}markInlineDeclaration(e,t){let r=this.inlineDeclarations.get(e)??new Set;r.add(t),this.inlineDeclarations.set(e,r)}isInlineDeclaration(e,t){let r=this.inlineDeclarations.get(e);return r?r.has(t):!1}findParentScope(e){let t=e.parentElement;for(;t;){let r=this.scopes.get(t);if(r)return r;t=t.parentElement}}watch(e,t,r){let s=t.trim();if(!s)return;let i=s.split(".")[0];if(!i)return;let n=e;for(;n&&!n.hasKey(i);)n=n.parent;if(n){n.on(s,r);return}let a=e;for(;a;)a.on(s,r),a=a.parent}watchWithDebounce(e,t,r,s){s?this.watch(e,t,B(r,s)):this.watch(e,t,r)}watchAllScopes(e,t,r){let s=r?B(t,r):t,i=e;for(;i;)i.onAny(s),i=i.parent}parseOnAttribute(e,t){if(!e.startsWith("vsn-on:"))return null;let r=e.slice(7),[s,...i]=r.split("!");if(!s)return null;let n=this.parseEventDescriptor(s);if(!n.event)return null;let a,p=[];for(let h of i){if(h.startsWith("debounce")){let d=h.match(/debounce\((\d+)\)/);a=d?Number(d[1]):200;continue}p.push(h)}return{event:n.event,code:t,...a!==void 0?{debounceMs:a}:{},...p.length>0?{modifiers:p}:{},...n.keyModifiers.length>0?{keyModifiers:n.keyModifiers}:{}}}parseEventDescriptor(e){let t=e.split(".").map(s=>s.trim()).filter(Boolean);return{event:t.shift()??"",keyModifiers:t}}matchesKeyModifiers(e,t){if(!t||t.length===0)return!0;if(!(e instanceof KeyboardEvent))return!1;let r={shift:e.shiftKey,ctrl:e.ctrlKey,control:e.ctrlKey,alt:e.altKey,meta:e.metaKey},s={esc:"escape",escape:"escape",enter:"enter",tab:"tab",space:"space",spacebar:"space",up:"arrowup",down:"arrowdown",left:"arrowleft",right:"arrowright",arrowup:"arrowup",arrowdown:"arrowdown",arrowleft:"arrowleft",arrowright:"arrowright",delete:"delete",backspace:"backspace"},i=e.key?.toLowerCase()??"";i===" "&&(i="space");for(let n of t){let a=n.toLowerCase();if(a in r){if(!r[a])return!1;continue}let p=s[a]??a;if(i!==p)return!1}return!0}attachOnHandler(e,t){let r=async i=>{if(!this.matchesKeyModifiers(i,t.keyModifiers))return;this.applyEventModifiers(i,t.modifiers);let n=this.getScope(e);await this.execute(t.code,n,e),this.evaluate(e)},s=t.debounceMs?B(r,t.debounceMs):r;e.addEventListener(t.event,s,this.getListenerOptions(t.modifiers))}attachBehaviorOnHandler(e,t,r,s,i){let n=this.parseEventDescriptor(t),a=async d=>{if(!this.matchesKeyModifiers(d,n.keyModifiers))return;this.applyEventModifiers(d,s);let f=this.getScope(e);await this.executeBlock(r,f,e),this.evaluate(e)},p=this.getListenerOptions(s);e.addEventListener(n.event,a,p);let c=this.behaviorListeners.get(e)??new Map,h=c.get(i)??[];h.push({event:n.event,handler:a,options:p}),c.set(i,h),this.behaviorListeners.set(e,c)}attachGetHandler(e,t=!1){let r=async()=>{let s=this.getBindings.get(e);if(s)try{await X(e,s,this.getScope(e),i=>{s.trusted&&this.handleTrustedHtml(i)})}catch(i){console.warn("vsn:getError",i),e.dispatchEvent(new CustomEvent("vsn:getError",{detail:{error:i},bubbles:!0}))}};e.addEventListener("click",s=>{s.target===e&&r()}),t&&Promise.resolve().then(r)}applyEventModifiers(e,t){if(!(!e||!t||t.length===0))for(let r of t)r==="prevent"?e.preventDefault():r==="stop"&&e.stopPropagation()}getListenerOptions(e){if(!e||e.length===0)return;let t={};return e.includes("once")&&(t.once=!0),e.includes("passive")&&(t.passive=!0),e.includes("capture")&&(t.capture=!0),Object.keys(t).length>0?t:void 0}async execute(e,t,r){let s=this.codeCache.get(e);s||(s=b.parseInline(e),this.codeCache.set(e,s));let i={scope:t,globals:this.globals,...r?{element:r}:{}};await s.evaluate(i)}async executeBlock(e,t,r){let s={scope:t,globals:this.globals,...r?{element:r}:{}};await e.evaluate(s)}collectBehavior(e,t){let r=t?`${t} ${e.selector.selectorText}`:e.selector.selectorText,s=this.getCachedBehavior(e);this.behaviorRegistry.push({id:this.behaviorId+=1,selector:r,specificity:this.computeSpecificity(r),order:this.behaviorRegistry.length,...s});for(let i of e.body.statements)i instanceof S&&this.collectBehavior(i,r)}computeSpecificity(e){let t=e.match(/#[\w-]+/g)?.length??0,r=e.match(/\.[\w-]+/g)?.length??0,s=e.match(/\[[^\]]+\]/g)?.length??0,i=e.match(/:[\w-]+/g)?.length??0,n=e.match(/(^|[\s>+~])([a-zA-Z][\w-]*)/g)?.length??0;return t*100+(r+s+i)*10+n}getImportantKey(e){if(e.target instanceof m)return`state:${e.target.name}`;if(e.target instanceof g)return`${e.target.kind}:${e.target.name}`}isImportant(e,t){let r=this.importantFlags.get(e);return r?r.has(t):!1}markImportant(e,t){let r=this.importantFlags.get(e)??new Set;r.add(t),this.importantFlags.set(e,r)}extractLifecycle(e){let t,r;for(let s of e.statements)s instanceof v&&(s.type==="Construct"?t=s:s.type==="Destruct"&&(r=s));return{...t?{construct:t}:{},...r?{destruct:r}:{}}}extractOnBlocks(e){let t=[];for(let r of e.statements)r instanceof N&&t.push({event:r.eventName,body:r.body,modifiers:r.modifiers});return t}extractDeclarations(e){let t=[];for(let r of e.statements)r instanceof L&&t.push(r);return t}extractFunctionDeclarations(e){let t=[];for(let r of e.statements){if(r instanceof D){t.push({name:r.name,params:r.params,body:r.body});continue}r instanceof A&&r.target instanceof m&&r.value instanceof k&&t.push({name:r.target.name,params:r.value.params,body:r.value.body})}return t}getCachedBehavior(e){let t=this.hashBehavior(e),r=this.behaviorCache.get(t);if(r)return r;let s=this.extractLifecycle(e.body),i={onBlocks:this.extractOnBlocks(e.body),declarations:this.extractDeclarations(e.body),functions:this.extractFunctionDeclarations(e.body),...s};return this.behaviorCache.set(t,i),i}hashBehavior(e){let t=this.normalizeNode(e),r=JSON.stringify(t);return this.hashString(r)}normalizeNode(e){if(!e||typeof e!="object")return e;let t=e.type??"Unknown";return t==="Behavior"?{type:t,selector:e.selector?.selectorText??"",body:this.normalizeNode(e.body)}:t==="Selector"?{type:t,selectorText:e.selectorText??""}:t==="Block"||t==="Construct"||t==="Destruct"?{type:t,statements:Array.isArray(e.statements)?e.statements.map(r=>this.normalizeNode(r)):[]}:t==="OnBlock"?{type:t,eventName:e.eventName??"",args:Array.isArray(e.args)?e.args:[],body:this.normalizeNode(e.body)}:t==="Declaration"?{type:t,target:this.normalizeNode(e.target),operator:e.operator??"",value:this.normalizeNode(e.value),flags:e.flags??{},flagArgs:e.flagArgs??{}}:t==="Assignment"?{type:t,target:this.normalizeNode(e.target),value:this.normalizeNode(e.value)}:t==="StateBlock"?{type:t,entries:Array.isArray(e.entries)?e.entries.map(r=>this.normalizeNode(r)):[]}:t==="StateEntry"?{type:t,name:e.name??"",value:this.normalizeNode(e.value),important:!!e.important}:t==="FunctionDeclaration"?{type:t,name:e.name??"",params:Array.isArray(e.params)?e.params:[],body:this.normalizeNode(e.body),isAsync:!!e.isAsync}:t==="FunctionExpression"?{type:t,params:Array.isArray(e.params)?e.params:[],body:this.normalizeNode(e.body),isAsync:!!e.isAsync}:t==="Return"?{type:t,value:this.normalizeNode(e.value??null)}:t==="Identifier"?{type:t,name:e.name??""}:t==="Literal"?{type:t,value:e.value}:t==="UnaryExpression"?{type:t,operator:e.operator??"",argument:this.normalizeNode(e.argument)}:t==="BinaryExpression"?{type:t,operator:e.operator??"",left:this.normalizeNode(e.left),right:this.normalizeNode(e.right)}:t==="TernaryExpression"?{type:t,test:this.normalizeNode(e.test),consequent:this.normalizeNode(e.consequent),alternate:this.normalizeNode(e.alternate)}:t==="CallExpression"?{type:t,callee:this.normalizeNode(e.callee),args:Array.isArray(e.args)?e.args.map(r=>this.normalizeNode(r)):[]}:t==="AwaitExpression"?{type:t,argument:this.normalizeNode(e.argument)}:t==="Directive"?{type:t,kind:e.kind??"",name:e.name??""}:t==="Query"?{type:t,direction:e.direction??"",selector:e.selector??""}:t==="ArrayExpression"?{type:t,elements:Array.isArray(e.elements)?e.elements.map(r=>this.normalizeNode(r)):[]}:t==="IndexExpression"?{type:t,target:this.normalizeNode(e.target),index:this.normalizeNode(e.index)}:{type:t}}hashString(e){let t=5381;for(let r=0;r<e.length;r+=1)t=(t<<5)+t+e.charCodeAt(r),t|=0;return(t>>>0).toString(16)}applyBehaviorFunctions(e,t,r){for(let s of r)this.applyBehaviorFunction(e,t,s)}applyBehaviorFunction(e,t,r){let s=t.getPath(r.name);if(s!==void 0&&typeof s!="function")throw new Error(`Cannot override non-function '${r.name}' with a function`);let i=async(...n)=>{let a={scope:t,globals:this.globals,element:e,returnValue:void 0,returning:!1},p=new Map;for(let c=0;c<r.params.length;c+=1){let h=r.params[c];h&&(p.set(h,t.getPath(h)),t.setPath(h,n[c]))}await r.body.evaluate(a);for(let c of r.params)c&&t.setPath(c,p.get(c));return a.returnValue};t.setPath(r.name,i)}async applyBehaviorDeclarations(e,t,r){for(let s of r)await this.applyBehaviorDeclaration(e,t,s)}async applyBehaviorDeclaration(e,t,r){let s={scope:t,element:e},i=r.operator,n=r.flags.debounce?r.flagArgs.debounce??200:void 0,a=this.getImportantKey(r);if(!r.flags.important&&a&&this.isImportant(e,a)||a&&this.isInlineDeclaration(e,a))return;if(this.applyCustomFlags(e,t,r),r.target instanceof m){let d=await r.value.evaluate(s);t.setPath(r.target.name,d),r.flags.important&&a&&this.markImportant(e,a);return}if(!(r.target instanceof g))return;let p=r.target,c=r.value instanceof m?r.value.name:void 0;if(i===":>"){c&&this.applyDirectiveToScope(e,p,c,t,n),r.flags.important&&a&&this.markImportant(e,a);return}if(i===":="&&c&&this.applyDirectiveToScope(e,p,c,t,n),!c){let d=await r.value.evaluate(s);this.setDirectiveValue(e,p,d,r.flags.trusted),(i===":<"||i===":=")&&this.applyDirectiveFromExpression(e,p,r.value,t,r.flags.trusted,n),r.flags.important&&a&&this.markImportant(e,a);return}let h=i===":<"||i===":=";this.applyDirectiveFromScope(e,p,c,t,r.flags.trusted,n,h),r.flags.important&&a&&this.markImportant(e,a)}applyCustomFlags(e,t,r){if(this.flagHandlers.size!==0)for(let[s,i]of this.flagHandlers)r.flags[s]&&i.onApply?.({name:s,args:r.flagArgs[s],element:e,scope:t,declaration:r})}applyDirectiveFromScope(e,t,r,s,i,n,a=!0){if(t.kind==="attr"&&t.name==="html"&&e instanceof HTMLElement){let c=()=>w(e,r,s,!!i);c(),i&&this.handleTrustedHtml(e),a&&this.watchWithDebounce(s,r,c,n);return}let p=()=>{let c=s.get(r);c!=null&&this.setDirectiveValue(e,t,c,i)};p(),a&&this.watchWithDebounce(s,r,p,n)}applyDirectiveFromExpression(e,t,r,s,i,n){let a=async()=>{let p={scope:s,element:e},c=await r.evaluate(p);this.setDirectiveValue(e,t,c,i)};a(),this.watchAllScopes(s,()=>{a()},n)}applyDirectiveToScope(e,t,r,s,i){if(t.kind==="attr"&&t.name==="value"){this.applyValueBindingToScope(e,r,i);return}if(t.kind==="attr"&&t.name==="checked"){this.applyCheckedBindingToScope(e,r,i);return}let n=this.getDirectiveValue(e,t);n!=null&&s.set(r,n)}applyCheckedBindingToScope(e,t,r){if(!(e instanceof HTMLInputElement))return;let s=()=>{let n=this.getScope(e);n&&n.set(t,e.checked)},i=r?B(s,r):s;i(),e.addEventListener("change",i),e.addEventListener("input",i)}applyValueBindingToScope(e,t,r){if(!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement))return;let s=()=>{let n=this.getScope(e);Q(e,t,n)},i=r?B(s,r):s;i(),e.addEventListener("input",i),e.addEventListener("change",i)}setDirectiveValue(e,t,r,s){if(t.kind==="attr"&&t.name==="html"&&e instanceof HTMLElement){let i=r==null?"":String(r);e.innerHTML=s?i:i.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,""),s&&this.handleTrustedHtml(e);return}if(t.kind==="attr"){if(t.name==="value"){if(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement){e.value=r==null?"":String(r),e.setAttribute("value",e.value);return}if(e instanceof HTMLSelectElement){e.value=r==null?"":String(r);return}}if(t.name==="checked"&&e instanceof HTMLInputElement){let i=r===!0||r==="true"||r===1||r==="1";e.checked=i,i?e.setAttribute("checked",""):e.removeAttribute("checked");return}e.setAttribute(t.name,r==null?"":String(r));return}t.kind==="style"&&e instanceof HTMLElement&&e.style.setProperty(t.name,r==null?"":String(r))}getDirectiveValue(e,t){if(t.kind==="attr")return t.name==="value"&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)?e.value:t.name==="checked"&&e instanceof HTMLInputElement?e.checked:e.getAttribute(t.name)??void 0;if(t.kind==="style"&&e instanceof HTMLElement)return e.style.getPropertyValue(t.name)??void 0}handleTrustedHtml(e){let t=Array.from(e.querySelectorAll('script[type="text/vsn"]'));if(t.length===0)return;let r=t.map(s=>s.textContent??"").join(`
`);r.trim()&&(this.registerBehaviors(r),this.applyBehaviors(e))}registerDefaultAttributeHandlers(){this.registerAttributeHandler({id:"vsn-bind",match:e=>e.startsWith("vsn-bind"),handle:(e,t,r,s)=>{let i=this.parseBindDirection(t);this.bindBindings.set(e,{expr:r,direction:i}),(i==="to"||i==="both")&&this.markInlineDeclaration(e,`state:${r}`),(i==="to"||i==="both")&&(Q(e,r,s),this.attachBindInputHandler(e,r)),(i==="from"||i==="both")&&this.watch(s,r,()=>j(e,r,s))}}),this.registerAttributeHandler({id:"vsn-if",match:e=>e==="vsn-if",handle:(e,t,r,s)=>{this.ifBindings.set(e,r),e instanceof HTMLElement&&_(e,r,s),this.watch(s,r,()=>this.evaluate(e))}}),this.registerAttributeHandler({id:"vsn-show",match:e=>e==="vsn-show",handle:(e,t,r,s)=>{this.showBindings.set(e,r),e instanceof HTMLElement&&Z(e,r,s),this.watch(s,r,()=>this.evaluate(e))}}),this.registerAttributeHandler({id:"vsn-html",match:e=>e.startsWith("vsn-html"),handle:(e,t,r,s)=>{let i=t.includes("!trusted");this.htmlBindings.set(e,{expr:r,trusted:i}),this.markInlineDeclaration(e,"attr:html"),e instanceof HTMLElement&&(w(e,r,s,i),i&&this.handleTrustedHtml(e)),this.watch(s,r,()=>this.evaluate(e))}}),this.registerAttributeHandler({id:"vsn-each",match:e=>e==="vsn-each",handle:(e,t,r,s)=>{let i=this.parseEachExpression(r);i&&(this.eachBindings.set(e,{...i,rendered:[]}),this.renderEach(e),this.watch(s,i.listExpr,()=>this.renderEach(e)))}}),this.registerAttributeHandler({id:"vsn-get",match:e=>e.startsWith("vsn-get"),handle:(e,t)=>{let r=t.includes("!trusted"),s=t.includes("!load"),i=e.getAttribute(t)??"",n=e.getAttribute("vsn-target")??void 0,a=e.getAttribute("vsn-swap")??"inner",p={url:i,swap:a,trusted:r,...n?{targetSelector:n}:{}};this.getBindings.set(e,p),this.attachGetHandler(e,s)}}),this.registerAttributeHandler({id:"vsn-construct",match:e=>e==="vsn-construct",handle:(e,t,r)=>{this.setLifecycle(e,{construct:r})}}),this.registerAttributeHandler({id:"vsn-destruct",match:e=>e==="vsn-destruct",handle:(e,t,r)=>{this.setLifecycle(e,{destruct:r})}}),this.registerAttributeHandler({id:"vsn-on",match:e=>e.startsWith("vsn-on:"),handle:(e,t,r)=>{let s=this.parseOnAttribute(t,r);s&&this.attachOnHandler(e,s)}})}};var ne="0.1.0";function $e(o){return new b(o).parseProgram()}function ae(o=document){if(typeof document>"u")return null;let e=new F,t=typeof performance<"u"&&performance.now?performance.now():Date.now(),r=()=>{let s=o instanceof Document?o.body:o;if(s){let i=Array.from(document.querySelectorAll('script[type="text/vsn"]')).map(p=>p.textContent??"").join(`
`);i.trim()&&e.registerBehaviors(i),e.mount(s);let n=typeof performance<"u"&&performance.now?performance.now():Date.now(),a=Math.round(n-t);console.log(`Took ${a}ms to start up VSN.js. https://www.vsnjs.com/ v${ne}`)}};return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",r,{once:!0}):r(),e}typeof document<"u"&&document.querySelector("script[auto-mount]")&&ae();export{$ as ArrayExpression,A as AssignmentNode,V as AwaitExpression,u as BaseNode,S as BehaviorNode,y as BinaryExpression,v as BlockNode,U as CallExpression,L as DeclarationNode,g as DirectiveExpression,F as Engine,D as FunctionDeclarationNode,k as FunctionExpression,m as IdentifierExpression,z as IndexExpression,C as Lexer,E as LiteralExpression,N as OnBlockNode,b as Parser,H as ProgramNode,G as QueryExpression,W as ReturnNode,T as SelectorNode,O as StateBlockNode,R as StateEntryNode,q as TernaryExpression,J as TokenType,P as UnaryExpression,I as UseNode,ne as VERSION,ae as autoMount,$e as parseCFS};
//# sourceMappingURL=index.min.js.map