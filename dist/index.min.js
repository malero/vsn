var H=(a=>(a.Whitespace="Whitespace",a.Identifier="Identifier",a.Number="Number",a.String="String",a.Boolean="Boolean",a.Null="Null",a.Behavior="Behavior",a.State="State",a.On="On",a.Construct="Construct",a.Destruct="Destruct",a.LBrace="LBrace",a.RBrace="RBrace",a.LParen="LParen",a.RParen="RParen",a.LBracket="LBracket",a.RBracket="RBracket",a.Colon="Colon",a.Semicolon="Semicolon",a.Comma="Comma",a.Dot="Dot",a.Hash="Hash",a.Greater="Greater",a.Less="Less",a.Plus="Plus",a.Tilde="Tilde",a.Star="Star",a.Equals="Equals",a.Bang="Bang",a.At="At",a.Dollar="Dollar",a.Question="Question",a))(H||{});var $={behavior:"Behavior",state:"State",on:"On",construct:"Construct",destruct:"Destruct",true:"Boolean",false:"Boolean",null:"Null"},x=class{constructor(t){this.input=t}index=0;line=1;column=1;tokenize(){let t=[];for(;!this.eof();){let e=this.peek();if(this.isWhitespace(e)){t.push(this.readWhitespace());continue}if(e==="/"&&this.peek(1)==="/"){this.readLineComment();continue}if(e==="/"&&this.peek(1)==="*"){this.readBlockComment();continue}if(this.isAlpha(e)||e==="_"){t.push(this.readIdentifier());continue}if(this.isDigit(e)||e==="-"&&this.isDigit(this.peek(1))){t.push(this.readNumber());continue}if(e==='"'||e==="'"){t.push(this.readString());continue}let r=this.readPunctuator();if(r){t.push(r);continue}throw new Error(`Unexpected character '${e}' at ${this.line}:${this.column}`)}return t}readWhitespace(){let t=this.position(),e="";for(;!this.eof()&&this.isWhitespace(this.peek());)e+=this.next();return this.token("Whitespace",e,t)}readLineComment(){for(this.next(),this.next();!this.eof()&&this.peek()!==`
`;)this.next()}readBlockComment(){for(this.next(),this.next();!this.eof();){if(this.peek()==="*"&&this.peek(1)==="/"){this.next(),this.next();return}this.next()}}readIdentifier(){let t=this.position(),e="";for(;!this.eof()&&(this.isAlphaNumeric(this.peek())||this.peek()==="_"||this.peek()==="-");)e+=this.next();let r=$[e];return r?this.token(r,e,t):this.token("Identifier",e,t)}readNumber(){let t=this.position(),e="";for(this.peek()==="-"&&(e+=this.next());!this.eof()&&this.isDigit(this.peek());)e+=this.next();if(this.peek()===".")for(e+=this.next();!this.eof()&&this.isDigit(this.peek());)e+=this.next();return this.token("Number",e,t)}readString(){let t=this.next(),e=this.position(),r="";for(;!this.eof();){let s=this.next();if(s==="\\"){let i=this.next();r+=i;continue}if(s===t)return this.token("String",r,e);r+=s}throw new Error(`Unterminated string at ${e.line}:${e.column}`)}readPunctuator(){let t=this.position(),e=this.peek(),s={"{":"LBrace","}":"RBrace","(":"LParen",")":"RParen","[":"LBracket","]":"RBracket",":":"Colon",";":"Semicolon",",":"Comma",".":"Dot","#":"Hash",">":"Greater","<":"Less","+":"Plus","~":"Tilde","*":"Star","=":"Equals","!":"Bang","@":"At",$:"Dollar","?":"Question"}[e];return s?(this.next(),this.token(s,e,t)):null}token(t,e,r){return{type:t,value:e,start:r,end:this.position()}}position(){return{index:this.index,line:this.line,column:this.column}}peek(t=0){return this.input[this.index+t]??""}next(){let t=this.input[this.index++]??"";return t===`
`?(this.line+=1,this.column=1):this.column+=1,t}eof(){return this.index>=this.input.length}isWhitespace(t){return t===" "||t==="	"||t===`
`||t==="\r"}isAlpha(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"}isDigit(t){return t>="0"&&t<="9"}isAlphaNumeric(t){return this.isAlpha(t)||this.isDigit(t)}};var p=class{constructor(t){this.type=t}async prepare(t){}async evaluate(t){}},g=class extends p{constructor(e){super("Program");this.behaviors=e}},v=class extends p{constructor(e){super("Block");this.statements=e}},k=class extends p{constructor(e){super("Selector");this.selectorText=e}},w=class extends p{constructor(e,r){super("Behavior");this.selector=e;this.body=r}},y=class extends p{constructor(e,r,s){super("StateEntry");this.name=e;this.value=r;this.important=s}},b=class extends p{constructor(e){super("StateBlock");this.entries=e}},E=class extends p{constructor(e,r,s){super("OnBlock");this.eventName=e;this.args=r;this.body=s}},B=class extends p{constructor(e,r){super("Assignment");this.target=e;this.value=r}},S=class extends p{constructor(e,r,s,i,o){super("Declaration");this.target=e;this.operator=r;this.value=s;this.flags=i;this.flagArgs=o}},m=class extends p{constructor(e){super("Identifier");this.name=e}},h=class extends p{constructor(e){super("Literal");this.value=e}async evaluate(){return this.value}},D=class extends p{constructor(e,r){super("UnaryExpression");this.operator=e;this.argument=r}},f=class extends p{constructor(e,r){super("Directive");this.kind=e;this.name=r}},W=class extends p{constructor(e,r){super("Query");this.direction=e;this.selector=r}};var N=class{constructor(t){this.tokens=t}index=0;peek(t=0){return this.tokens[this.index+t]??null}next(){let t=this.tokens[this.index++];if(!t)throw new Error("Unexpected end of input");return t}eof(){return this.index>=this.tokens.length}match(t){return this.peek()?.type===t?(this.next(),!0):!1}expect(t){let e=this.next();if(e.type!==t)throw new Error(`Expected ${t} but got ${e.type}`);return e}skipWhitespace(){for(;this.peek()?.type==="Whitespace";)this.next()}peekNonWhitespace(t=0){let e=0;for(let r=this.index;r<this.tokens.length;r++){let s=this.tokens[r];if(s.type!=="Whitespace"){if(e===t)return s;e+=1}}return null}};var A=class{stream;constructor(t){let e=new x(t);this.stream=new N(e.tokenize())}parseProgram(){let t=[];for(this.stream.skipWhitespace();!this.stream.eof();)t.push(this.parseBehavior()),this.stream.skipWhitespace();return new g(t)}parseBehavior(){this.stream.skipWhitespace(),this.stream.expect("Behavior");let t=this.parseSelector(),e=this.parseBlock({allowDeclarations:!0});return new w(t,e)}parseSelector(){let t="",e=!1;for(;;){let r=this.stream.peek();if(!r||r.type==="LBrace")break;if(r.type==="Whitespace"){this.stream.next(),e&&t[t.length-1]!==" "&&(t+=" ");continue}e=!0,t+=this.stream.next().value}if(!t.trim())throw new Error("Behavior selector is required");return new k(t.trim())}parseBlock(t){let e=t?.allowDeclarations??!1;this.stream.skipWhitespace(),this.stream.expect("LBrace");let r=[],s=e;for(;;){this.stream.skipWhitespace();let i=this.stream.peek();if(!i)throw new Error("Unterminated block");if(i.type==="RBrace"){this.stream.next();break}if(this.isDeclarationStart()){if(!e)throw new Error("Declarations are only allowed at the behavior root");if(!s)throw new Error("Declarations must appear before blocks");r.push(this.parseDeclaration())}else s&&(s=!1),r.push(this.parseStatement())}return new v(r)}parseStatement(){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unexpected end of input");if(t.type==="On")return this.parseOnBlock();if(t.type==="Construct")return this.parseConstructBlock();if(t.type==="Destruct")return this.parseDestructBlock();if(t.type==="Behavior")return this.parseBehavior();if(this.isAssignmentStart())return this.parseAssignment();throw new Error(`Unexpected token ${t.type}`)}parseStateBlock(){this.stream.expect("State"),this.stream.skipWhitespace(),this.stream.expect("LBrace");let t=[];for(;;){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unterminated state block");if(e.type==="RBrace"){this.stream.next();break}let r=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let s=this.parseExpression();this.stream.skipWhitespace();let i=!1;if(this.stream.peek()?.type==="Bang"){this.stream.next(),this.stream.skipWhitespace();let o=this.stream.next();if(o.type==="Identifier"&&o.value==="important")i=!0;else throw new Error("Expected 'important' after '!'")}this.stream.skipWhitespace(),this.stream.expect("Semicolon"),t.push(new y(r.value,s,i))}return new b(t)}parseOnBlock(){this.stream.expect("On"),this.stream.skipWhitespace();let t=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("LParen");let e=[];for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated on() arguments");if(s.type==="RParen"){this.stream.next();break}if(s.type==="Identifier"){e.push(this.stream.next().value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next();continue}throw new Error(`Unexpected token in on() args: ${s.type}`)}let r=this.parseBlock({allowDeclarations:!1});return new E(t.value,e,r)}parseAssignment(){let t=this.parseAssignmentTarget();this.stream.skipWhitespace(),this.stream.expect("Equals"),this.stream.skipWhitespace();let e=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new B(t,e)}parseExpression(){let t=this.stream.peek();if(!t)throw new Error("Expected expression");if(t.type==="Bang"){this.stream.next();let e=this.parseExpression();return new D("!",e)}if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new f(e,r.value)}if(t.type==="Question")return this.parseQueryExpression();if(t.type==="Identifier")return new m(this.parseIdentifierPath());if(t.type==="Boolean")return new h(this.stream.next().value==="true");if(t.type==="Null")return this.stream.next(),new h(null);if(t.type==="Number")return new h(Number(this.stream.next().value));if(t.type==="String")return new h(this.stream.next().value);throw new Error(`Unsupported expression token ${t.type}`)}parseAssignmentTarget(){let t=this.stream.peek();if(!t)throw new Error("Expected assignment target");if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new f(e,r.value)}if(t.type==="Identifier")return new m(this.parseIdentifierPath());throw new Error(`Invalid assignment target ${t.type}`)}isAssignmentStart(){let t=this.stream.peekNonWhitespace(0);if(!t)return!1;if(t.type==="Identifier"){let e=this.stream.peekNonWhitespace(1);return e?.type==="Equals"||e?.type==="Dot"}if(t.type==="At"||t.type==="Dollar"){let e=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return e?.type==="Identifier"&&r?.type==="Equals"}return!1}parseIdentifierPath(){let t=this.stream.expect("Identifier").value;for(;this.stream.peek()?.type==="Dot";){this.stream.next();let e=this.stream.expect("Identifier").value;t=`${t}.${e}`}return t}parseQueryExpression(){this.stream.expect("Question");let t="self";this.stream.peek()?.type==="Greater"?(this.stream.next(),t="descendant"):this.stream.peek()?.type==="Less"&&(this.stream.next(),t="ancestor"),this.stream.skipWhitespace(),this.stream.expect("LParen");let e=this.readSelectorUntil("RParen");return new W(t,e)}readSelectorUntil(t){let e="",r=!1;for(;;){let s=this.stream.peek();if(!s)throw new Error("Unterminated selector");if(s.type===t){this.stream.next();break}if(s.type==="Whitespace"){this.stream.next(),r&&e[e.length-1]!==" "&&(e+=" ");continue}r=!0,e+=this.stream.next().value}return e.trim()}parseDeclaration(){let t=this.parseDeclarationTarget();this.stream.skipWhitespace();let e=this.parseDeclarationOperator();this.stream.skipWhitespace();let r=this.parseExpression(),{flags:s,flagArgs:i}=this.parseFlags();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new S(t,e,r,s,i)}parseDeclarationTarget(){let t=this.stream.peek();if(!t)throw new Error("Expected declaration target");if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new f(e,r.value)}if(t.type==="Identifier")return new m(this.stream.next().value);throw new Error(`Invalid declaration target ${t.type}`)}parseDeclarationOperator(){this.stream.expect("Colon");let t=this.stream.peek();return t?t.type==="Equals"?(this.stream.next(),":="):t.type==="Less"?(this.stream.next(),":<"):t.type==="Greater"?(this.stream.next(),":>"):":":":"}parseFlags(){let t={},e={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let r=this.stream.expect("Identifier").value;if(r==="important")t.important=!0;else if(r==="trusted")t.trusted=!0;else if(r==="debounce")if(t.debounce=!0,this.stream.peek()?.type==="LParen"){this.stream.next(),this.stream.skipWhitespace();let s=this.stream.expect("Number");e.debounce=Number(s.value),this.stream.skipWhitespace(),this.stream.expect("RParen")}else e.debounce=200;else throw new Error(`Unknown flag ${r}`)}return{flags:t,flagArgs:e}}isDeclarationStart(){let t=this.stream.peekNonWhitespace(0);if(!t)return!1;if(t.type==="Identifier")return this.stream.peekNonWhitespace(1)?.type==="Colon";if(t.type==="At"||t.type==="Dollar"){let e=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return e?.type==="Identifier"&&r?.type==="Colon"}return!1}parseConstructBlock(){this.stream.expect("Construct");let t=this.parseBlock({allowDeclarations:!1});return t.type="Construct",t}parseDestructBlock(){this.stream.expect("Destruct");let t=this.parseBlock({allowDeclarations:!1});return t.type="Destruct",t}};var C=class{data=new Map;get(t){return this.getPath(t)}set(t,e){this.setPath(t,e)}getPath(t){let e=t.split("."),r=e[0];if(!r)return;let s=this.data.get(r);for(let i=1;i<e.length;i+=1){if(s==null)return;let o=e[i];if(!o)return;s=s[o]}return s}setPath(t,e){let r=t.split("."),s=r[0];if(!s)return;if(r.length===1){this.data.set(s,e);return}let i=this.data.get(s);(i==null||typeof i!="object")&&(i={},this.data.set(s,i));let o=i;for(let l=1;l<r.length-1;l+=1){let u=r[l];if(!u)return;(o[u]==null||typeof o[u]!="object")&&(o[u]={}),o=o[u]}let c=r[r.length-1];c&&(o[c]=e)}};function M(n,t,e){let r=t.trim();if(!r)return;if(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement){let i=n.value;i!==void 0&&i!==""&&e.set(r,i);return}let s=n.textContent?.trim();s&&e.set(r,s)}function O(n,t){let e=n.trim();return e?!!t.get(e):!1}function L(n,t,e){n.style.display=O(t,e)?"":"none"}function P(n,t,e){n.style.display=O(t,e)?"":"none"}function F(n){return n.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"")}function d(n,t,e,r){let s=t.trim();if(!s)return;let i=e.get(s),o=i==null?"":String(i);n.innerHTML=r?o:F(o)}async function R(n,t,e){if(!globalThis.fetch)throw new Error("fetch is not available");let r=await globalThis.fetch(t.url);if(!r||!r.ok)return;let s=await r.text(),i=U(n,t.targetSelector);if(!i){n.dispatchEvent(new CustomEvent("vsn:targetError",{detail:{selector:t.targetSelector}}));return}if(t.swap==="outer"){let o=document.createElement("div");d(o,"__html",{get:()=>s},t.trusted);let c=o.firstElementChild;c&&i.parentNode&&i.parentNode.replaceChild(c,i);return}d(i,"__html",{get:()=>s},t.trusted)}function U(n,t){return t?n.ownerDocument.querySelector(t):n}var I=class{scopes=new WeakMap;ifBindings=new WeakMap;showBindings=new WeakMap;htmlBindings=new WeakMap;getBindings=new WeakMap;async mount(t){let e=[t,...Array.from(t.querySelectorAll("*"))];for(let r of e)this.attachAttributes(r)}getScope(t){let e=this.scopes.get(t);if(e)return e;let r=new C;return this.scopes.set(t,r),r}evaluate(t){let e=this.getScope(t),r=this.ifBindings.get(t);r&&t instanceof HTMLElement&&L(t,r,e);let s=this.showBindings.get(t);s&&t instanceof HTMLElement&&P(t,s,e);let i=this.htmlBindings.get(t);i&&t instanceof HTMLElement&&d(t,i.expr,e,i.trusted)}attachAttributes(t){let e=this.getScope(t);for(let r of t.getAttributeNames()){if(r==="vsn-bind"){let i=t.getAttribute(r)??"";M(t,i,e);continue}if(r==="vsn-if"){let i=t.getAttribute(r)??"";this.ifBindings.set(t,i),t instanceof HTMLElement&&L(t,i,e);continue}if(r==="vsn-show"){let i=t.getAttribute(r)??"";this.showBindings.set(t,i),t instanceof HTMLElement&&P(t,i,e);continue}if(r.startsWith("vsn-html")){let i=r.includes("!trusted"),o=t.getAttribute(r)??"";this.htmlBindings.set(t,{expr:o,trusted:i}),t instanceof HTMLElement&&d(t,o,e,i);continue}if(r.startsWith("vsn-get")){let i=r.includes("!trusted"),o=t.getAttribute(r)??"",c=t.getAttribute("vsn-target")??void 0,l=t.getAttribute("vsn-swap")??"inner",u={url:o,swap:l,trusted:i,...c?{targetSelector:c}:{}};this.getBindings.set(t,u),this.attachGetHandler(t);continue}let s=this.getOnEventName(r,null,null);if(s){let i=t.getAttribute(r)??"";this.attachOnHandler(t,s,i)}}}getOnEventName(t,e,r){return t.startsWith("vsn-on:")?t.slice(7):e==="vsn-on"&&r?r:null}attachOnHandler(t,e,r){t.addEventListener(e,()=>{let s=this.getScope(t);this.execute(r,s),this.evaluate(t)})}attachGetHandler(t){t.addEventListener("click",async()=>{let e=this.getBindings.get(t);e&&await R(t,e,this.getScope(t))})}execute(t,e){let r=t.split(";").map(s=>s.trim()).filter(Boolean);for(let s of r){let i=s.match(/^([_a-zA-Z][_a-zA-Z0-9.]+)\s*=\s*(.+)$/);if(i){let o=i[1],c=i[2];if(!o||!c)continue;let l=this.evaluateExpression(c,e);e.setPath(o,l);continue}this.evaluateExpression(s,e)}}evaluateExpression(t,e){let r=t.split("+").map(i=>i.trim()).filter(Boolean);if(r.length>1)return r.reduce((i,o)=>{let c=this.evaluateExpression(o,e);return i+c},0);let s=r[0];if(s)return s==="true"?!0:s==="false"?!1:s==="null"?null:/^-?\d+(?:\.\d+)?$/.test(s)?Number(s):s.startsWith('"')&&s.endsWith('"')||s.startsWith("'")&&s.endsWith("'")?s.slice(1,-1):e.getPath(s)}};var mt="0.1.0";function dt(n){return new A(n).parseProgram()}export{B as AssignmentNode,p as BaseNode,w as BehaviorNode,v as BlockNode,S as DeclarationNode,f as DirectiveExpression,I as Engine,m as IdentifierExpression,x as Lexer,h as LiteralExpression,E as OnBlockNode,A as Parser,g as ProgramNode,W as QueryExpression,k as SelectorNode,b as StateBlockNode,y as StateEntryNode,H as TokenType,D as UnaryExpression,mt as VERSION,dt as parseCFS};
//# sourceMappingURL=index.min.js.map