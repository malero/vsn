var H=(a=>(a.Whitespace="Whitespace",a.Identifier="Identifier",a.Number="Number",a.String="String",a.Boolean="Boolean",a.Null="Null",a.Behavior="Behavior",a.State="State",a.On="On",a.Construct="Construct",a.Destruct="Destruct",a.LBrace="LBrace",a.RBrace="RBrace",a.LParen="LParen",a.RParen="RParen",a.LBracket="LBracket",a.RBracket="RBracket",a.Colon="Colon",a.Semicolon="Semicolon",a.Comma="Comma",a.Dot="Dot",a.Hash="Hash",a.Greater="Greater",a.Less="Less",a.Plus="Plus",a.Tilde="Tilde",a.Star="Star",a.Equals="Equals",a.Bang="Bang",a.At="At",a.Dollar="Dollar",a.Question="Question",a))(H||{});var G={behavior:"Behavior",state:"State",on:"On",construct:"Construct",destruct:"Destruct",true:"Boolean",false:"Boolean",null:"Null"},x=class{constructor(t){this.input=t}index=0;line=1;column=1;tokenize(){let t=[];for(;!this.eof();){let e=this.peek();if(this.isWhitespace(e)){t.push(this.readWhitespace());continue}if(e==="/"&&this.peek(1)==="/"){this.readLineComment();continue}if(e==="/"&&this.peek(1)==="*"){this.readBlockComment();continue}if(this.isAlpha(e)||e==="_"){t.push(this.readIdentifier());continue}if(this.isDigit(e)||e==="-"&&this.isDigit(this.peek(1))){t.push(this.readNumber());continue}if(e==='"'||e==="'"){t.push(this.readString());continue}let r=this.readPunctuator();if(r){t.push(r);continue}throw new Error(`Unexpected character '${e}' at ${this.line}:${this.column}`)}return t}readWhitespace(){let t=this.position(),e="";for(;!this.eof()&&this.isWhitespace(this.peek());)e+=this.next();return this.token("Whitespace",e,t)}readLineComment(){for(this.next(),this.next();!this.eof()&&this.peek()!==`
`;)this.next()}readBlockComment(){for(this.next(),this.next();!this.eof();){if(this.peek()==="*"&&this.peek(1)==="/"){this.next(),this.next();return}this.next()}}readIdentifier(){let t=this.position(),e="";for(;!this.eof()&&(this.isAlphaNumeric(this.peek())||this.peek()==="_"||this.peek()==="-");)e+=this.next();let r=G[e];return r?this.token(r,e,t):this.token("Identifier",e,t)}readNumber(){let t=this.position(),e="";for(this.peek()==="-"&&(e+=this.next());!this.eof()&&this.isDigit(this.peek());)e+=this.next();if(this.peek()===".")for(e+=this.next();!this.eof()&&this.isDigit(this.peek());)e+=this.next();return this.token("Number",e,t)}readString(){let t=this.next(),e=this.position(),r="";for(;!this.eof();){let s=this.next();if(s==="\\"){let i=this.next();r+=i;continue}if(s===t)return this.token("String",r,e);r+=s}throw new Error(`Unterminated string at ${e.line}:${e.column}`)}readPunctuator(){let t=this.position(),e=this.peek(),s={"{":"LBrace","}":"RBrace","(":"LParen",")":"RParen","[":"LBracket","]":"RBracket",":":"Colon",";":"Semicolon",",":"Comma",".":"Dot","#":"Hash",">":"Greater","<":"Less","+":"Plus","~":"Tilde","*":"Star","=":"Equals","!":"Bang","@":"At",$:"Dollar","?":"Question"}[e];return s?(this.next(),this.token(s,e,t)):null}token(t,e,r){return{type:t,value:e,start:r,end:this.position()}}position(){return{index:this.index,line:this.line,column:this.column}}peek(t=0){return this.input[this.index+t]??""}next(){let t=this.input[this.index++]??"";return t===`
`?(this.line+=1,this.column=1):this.column+=1,t}eof(){return this.index>=this.input.length}isWhitespace(t){return t===" "||t==="	"||t===`
`||t==="\r"}isAlpha(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"}isDigit(t){return t>="0"&&t<="9"}isAlphaNumeric(t){return this.isAlpha(t)||this.isDigit(t)}};var l=class{constructor(t){this.type=t}async prepare(t){}async evaluate(t){}},k=class extends l{constructor(e){super("Program");this.behaviors=e}},b=class extends l{constructor(e){super("Block");this.statements=e}},y=class extends l{constructor(e){super("Selector");this.selectorText=e}},E=class extends l{constructor(e,r){super("Behavior");this.selector=e;this.body=r}},w=class extends l{constructor(e,r,s){super("StateEntry");this.name=e;this.value=r;this.important=s}},S=class extends l{constructor(e){super("StateBlock");this.entries=e}},B=class extends l{constructor(e,r,s){super("OnBlock");this.eventName=e;this.args=r;this.body=s}},D=class extends l{constructor(e,r){super("Assignment");this.target=e;this.value=r}},W=class extends l{constructor(e,r,s,i,o){super("Declaration");this.target=e;this.operator=r;this.value=s;this.flags=i;this.flagArgs=o}},h=class extends l{constructor(e){super("Identifier");this.name=e}},f=class extends l{constructor(e){super("Literal");this.value=e}async evaluate(){return this.value}},A=class extends l{constructor(e,r){super("UnaryExpression");this.operator=e;this.argument=r}},d=class extends l{constructor(e,r){super("Directive");this.kind=e;this.name=r}},N=class extends l{constructor(e,r){super("Query");this.direction=e;this.selector=r}};var C=class{constructor(t){this.tokens=t}index=0;peek(t=0){return this.tokens[this.index+t]??null}next(){let t=this.tokens[this.index++];if(!t)throw new Error("Unexpected end of input");return t}eof(){return this.index>=this.tokens.length}match(t){return this.peek()?.type===t?(this.next(),!0):!1}expect(t){let e=this.next();if(e.type!==t)throw new Error(`Expected ${t} but got ${e.type}`);return e}skipWhitespace(){for(;this.peek()?.type==="Whitespace";)this.next()}peekNonWhitespace(t=0){let e=0;for(let r=this.index;r<this.tokens.length;r++){let s=this.tokens[r];if(s.type!=="Whitespace"){if(e===t)return s;e+=1}}return null}};var P=class{stream;constructor(t){let e=new x(t);this.stream=new C(e.tokenize())}parseProgram(){let t=[];for(this.stream.skipWhitespace();!this.stream.eof();)t.push(this.parseBehavior()),this.stream.skipWhitespace();return new k(t)}parseBehavior(){this.stream.skipWhitespace(),this.stream.expect("Behavior");let t=this.parseSelector(),e=this.parseBlock({allowDeclarations:!0});return new E(t,e)}parseSelector(){let t="",e=!1;for(;;){let r=this.stream.peek();if(!r||r.type==="LBrace")break;if(r.type==="Whitespace"){this.stream.next(),e&&t[t.length-1]!==" "&&(t+=" ");continue}e=!0,t+=this.stream.next().value}if(!t.trim())throw new Error("Behavior selector is required");return new y(t.trim())}parseBlock(t){let e=t?.allowDeclarations??!1;this.stream.skipWhitespace(),this.stream.expect("LBrace");let r=[],s=e;for(;;){this.stream.skipWhitespace();let i=this.stream.peek();if(!i)throw new Error("Unterminated block");if(i.type==="RBrace"){this.stream.next();break}if(this.isDeclarationStart()){if(!e)throw new Error("Declarations are only allowed at the behavior root");if(!s)throw new Error("Declarations must appear before blocks");r.push(this.parseDeclaration())}else s&&(s=!1),r.push(this.parseStatement())}return new b(r)}parseStatement(){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unexpected end of input");if(t.type==="On")return this.parseOnBlock();if(t.type==="Construct")return this.parseConstructBlock();if(t.type==="Destruct")return this.parseDestructBlock();if(t.type==="Behavior")return this.parseBehavior();if(this.isAssignmentStart())return this.parseAssignment();throw new Error(`Unexpected token ${t.type}`)}parseStateBlock(){this.stream.expect("State"),this.stream.skipWhitespace(),this.stream.expect("LBrace");let t=[];for(;;){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unterminated state block");if(e.type==="RBrace"){this.stream.next();break}let r=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let s=this.parseExpression();this.stream.skipWhitespace();let i=!1;if(this.stream.peek()?.type==="Bang"){this.stream.next(),this.stream.skipWhitespace();let o=this.stream.next();if(o.type==="Identifier"&&o.value==="important")i=!0;else throw new Error("Expected 'important' after '!'")}this.stream.skipWhitespace(),this.stream.expect("Semicolon"),t.push(new w(r.value,s,i))}return new S(t)}parseOnBlock(){this.stream.expect("On"),this.stream.skipWhitespace();let t=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("LParen");let e=[];for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated on() arguments");if(s.type==="RParen"){this.stream.next();break}if(s.type==="Identifier"){e.push(this.stream.next().value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next();continue}throw new Error(`Unexpected token in on() args: ${s.type}`)}let r=this.parseBlock({allowDeclarations:!1});return new B(t.value,e,r)}parseAssignment(){let t=this.parseAssignmentTarget();this.stream.skipWhitespace(),this.stream.expect("Equals"),this.stream.skipWhitespace();let e=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new D(t,e)}parseExpression(){let t=this.stream.peek();if(!t)throw new Error("Expected expression");if(t.type==="Bang"){this.stream.next();let e=this.parseExpression();return new A("!",e)}if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new d(e,r.value)}if(t.type==="Question")return this.parseQueryExpression();if(t.type==="Identifier"){let e=this.parseIdentifierPath();return e==="self"||e==="parent"||e==="root"?new h(e):new h(e)}if(t.type==="Boolean")return new f(this.stream.next().value==="true");if(t.type==="Null")return this.stream.next(),new f(null);if(t.type==="Number")return new f(Number(this.stream.next().value));if(t.type==="String")return new f(this.stream.next().value);throw new Error(`Unsupported expression token ${t.type}`)}parseAssignmentTarget(){let t=this.stream.peek();if(!t)throw new Error("Expected assignment target");if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new d(e,r.value)}if(t.type==="Identifier")return new h(this.parseIdentifierPath());throw new Error(`Invalid assignment target ${t.type}`)}isAssignmentStart(){let t=this.stream.peekNonWhitespace(0);if(!t)return!1;if(t.type==="Identifier"){let e=this.stream.peekNonWhitespace(1);return e?.type==="Equals"||e?.type==="Dot"}if(t.type==="At"||t.type==="Dollar"){let e=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return e?.type==="Identifier"&&r?.type==="Equals"}return!1}parseIdentifierPath(){let t=this.stream.expect("Identifier").value;for(;this.stream.peek()?.type==="Dot";){this.stream.next();let e=this.stream.expect("Identifier").value;t=`${t}.${e}`}return t}parseQueryExpression(){this.stream.expect("Question");let t="self";this.stream.peek()?.type==="Greater"?(this.stream.next(),t="descendant"):this.stream.peek()?.type==="Less"&&(this.stream.next(),t="ancestor"),this.stream.skipWhitespace(),this.stream.expect("LParen");let e=this.readSelectorUntil("RParen");return new N(t,e)}readSelectorUntil(t){let e="",r=!1;for(;;){let s=this.stream.peek();if(!s)throw new Error("Unterminated selector");if(s.type===t){this.stream.next();break}if(s.type==="Whitespace"){this.stream.next(),r&&e[e.length-1]!==" "&&(e+=" ");continue}r=!0,e+=this.stream.next().value}return e.trim()}parseDeclaration(){let t=this.parseDeclarationTarget();this.stream.skipWhitespace();let e=this.parseDeclarationOperator();this.stream.skipWhitespace();let r=this.parseExpression(),{flags:s,flagArgs:i}=this.parseFlags();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new W(t,e,r,s,i)}parseDeclarationTarget(){let t=this.stream.peek();if(!t)throw new Error("Expected declaration target");if(t.type==="At"||t.type==="Dollar"){let e=t.type==="At"?"attr":"style";this.stream.next();let r=this.stream.expect("Identifier");return new d(e,r.value)}if(t.type==="Identifier")return new h(this.stream.next().value);throw new Error(`Invalid declaration target ${t.type}`)}parseDeclarationOperator(){this.stream.expect("Colon");let t=this.stream.peek();return t?t.type==="Equals"?(this.stream.next(),":="):t.type==="Less"?(this.stream.next(),":<"):t.type==="Greater"?(this.stream.next(),":>"):":":":"}parseFlags(){let t={},e={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let r=this.stream.expect("Identifier").value;if(r==="important")t.important=!0;else if(r==="trusted")t.trusted=!0;else if(r==="debounce")if(t.debounce=!0,this.stream.peek()?.type==="LParen"){this.stream.next(),this.stream.skipWhitespace();let s=this.stream.expect("Number");e.debounce=Number(s.value),this.stream.skipWhitespace(),this.stream.expect("RParen")}else e.debounce=200;else throw new Error(`Unknown flag ${r}`)}return{flags:t,flagArgs:e}}isDeclarationStart(){let t=this.stream.peekNonWhitespace(0);if(!t)return!1;if(t.type==="Identifier")return this.stream.peekNonWhitespace(1)?.type==="Colon";if(t.type==="At"||t.type==="Dollar"){let e=this.stream.peekNonWhitespace(1),r=this.stream.peekNonWhitespace(2);return e?.type==="Identifier"&&r?.type==="Colon"}return!1}parseConstructBlock(){this.stream.expect("Construct");let t=this.parseBlock({allowDeclarations:!1});return t.type="Construct",t}parseDestructBlock(){this.stream.expect("Destruct");let t=this.parseBlock({allowDeclarations:!1});return t.type="Destruct",t}};var L=class{constructor(t){this.parent=t;this.root=t?t.root:this}data=new Map;root;get(t){return this.getPath(t)}set(t,e){this.setPath(t,e)}getPath(t){let{targetScope:e,targetPath:r}=this.resolveScope(t);if(!e||!r)return;let s=r.split("."),i=s[0];if(!i)return;let o=e.data.get(i);for(let c=1;c<s.length;c+=1){if(o==null)return;let p=s[c];if(!p)return;o=o[p]}return o}setPath(t,e){let{targetScope:r,targetPath:s}=this.resolveScope(t);if(!r||!s)return;let i=s.split("."),o=i[0];if(!o)return;if(i.length===1){r.data.set(o,e);return}let c=r.data.get(o);(c==null||typeof c!="object")&&(c={},r.data.set(o,c));let p=c;for(let I=1;I<i.length-1;I+=1){let g=i[I];if(!g)return;(p[g]==null||typeof p[g]!="object")&&(p[g]={}),p=p[g]}let u=i[i.length-1];u&&(p[u]=e)}resolveScope(t){return t.startsWith("parent.")?{targetScope:this.parent,targetPath:t.slice(7)}:t.startsWith("root.")?{targetScope:this.root,targetPath:t.slice(5)}:t.startsWith("self.")?{targetScope:this,targetPath:t.slice(5)}:{targetScope:this,targetPath:t}}};function q(n){return n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement?n.value:n.textContent??""}function Q(n,t){if(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement){n.value=t,n.setAttribute("value",t);return}n.textContent=t}function O(n,t,e){let r=t.trim();if(!r)return;let s=q(n).trim();s!==""&&e.set(r,s)}function R(n,t,e){let r=t.trim();if(!r)return;let s=e.get(r);s!=null&&Q(n,String(s))}function $(n,t){let e=n.trim();return e?!!t.get(e):!1}function M(n,t,e){n.style.display=$(t,e)?"":"none"}function T(n,t,e){n.style.display=$(t,e)?"":"none"}function _(n){return n.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"")}function m(n,t,e,r){let s=t.trim();if(!s)return;let i=e.get(s),o=i==null?"":String(i);n.innerHTML=r?o:_(o)}async function F(n,t,e){if(!globalThis.fetch)throw new Error("fetch is not available");let r=await globalThis.fetch(t.url);if(!r||!r.ok)return;let s=await r.text(),i=z(n,t.targetSelector);if(!i){n.dispatchEvent(new CustomEvent("vsn:targetError",{detail:{selector:t.targetSelector}}));return}if(t.swap==="outer"){let o=document.createElement("div");m(o,"__html",{get:()=>s},t.trusted);let c=o.firstElementChild;c&&i.parentNode&&i.parentNode.replaceChild(c,i);return}m(i,"__html",{get:()=>s},t.trusted)}function z(n,t){return t?n.ownerDocument.querySelector(t):n}function U(n,t){let e;return(...r)=>{e&&clearTimeout(e),e=setTimeout(()=>{e=void 0,n(...r)},t)}}var v=class{scopes=new WeakMap;bindBindings=new WeakMap;ifBindings=new WeakMap;showBindings=new WeakMap;htmlBindings=new WeakMap;getBindings=new WeakMap;async mount(t){let e=[t,...Array.from(t.querySelectorAll("*"))];for(let r of e){if(!this.hasVsnAttributes(r))continue;let s=this.findParentScope(r);this.getScope(r,s),this.attachAttributes(r)}}getScope(t,e){let r=this.scopes.get(t);if(r)return r;let s=new L(e??this.findParentScope(t));return this.scopes.set(t,s),s}evaluate(t){let e=this.getScope(t),r=this.bindBindings.get(t);r&&(r.direction==="from"||r.direction==="both")&&R(t,r.expr,e);let s=this.ifBindings.get(t);s&&t instanceof HTMLElement&&M(t,s,e);let i=this.showBindings.get(t);i&&t instanceof HTMLElement&&T(t,i,e);let o=this.htmlBindings.get(t);o&&t instanceof HTMLElement&&m(t,o.expr,e,o.trusted)}attachAttributes(t){let e=this.getScope(t);for(let r of t.getAttributeNames()){if(r.startsWith("vsn-bind")){let i=t.getAttribute(r)??"",o=this.parseBindDirection(r);this.bindBindings.set(t,{expr:i,direction:o}),(o==="to"||o==="both")&&O(t,i,e);continue}if(r==="vsn-if"){let i=t.getAttribute(r)??"";this.ifBindings.set(t,i),t instanceof HTMLElement&&M(t,i,e);continue}if(r==="vsn-show"){let i=t.getAttribute(r)??"";this.showBindings.set(t,i),t instanceof HTMLElement&&T(t,i,e);continue}if(r.startsWith("vsn-html")){let i=r.includes("!trusted"),o=t.getAttribute(r)??"";this.htmlBindings.set(t,{expr:o,trusted:i}),t instanceof HTMLElement&&m(t,o,e,i);continue}if(r.startsWith("vsn-get")){let i=r.includes("!trusted"),o=t.getAttribute(r)??"",c=t.getAttribute("vsn-target")??void 0,p=t.getAttribute("vsn-swap")??"inner",u={url:o,swap:p,trusted:i,...c?{targetSelector:c}:{}};this.getBindings.set(t,u),this.attachGetHandler(t);continue}let s=this.parseOnAttribute(r,t.getAttribute(r)??"");s&&this.attachOnHandler(t,s)}}parseBindDirection(t){return t.includes(":from")?"from":t.includes(":to")?"to":"both"}hasVsnAttributes(t){return t.getAttributeNames().some(e=>e.startsWith("vsn-"))}findParentScope(t){let e=t.parentElement;for(;e;){let r=this.scopes.get(e);if(r)return r;e=e.parentElement}}parseOnAttribute(t,e){if(!t.startsWith("vsn-on:"))return null;let r=t.slice(7),[s,...i]=r.split("!");if(!s)return null;let o;for(let p of i){if(!p.startsWith("debounce"))continue;let u=p.match(/debounce\((\d+)\)/);o=u?Number(u[1]):200}return{event:s,code:e,...o!==void 0?{debounceMs:o}:{}}}attachOnHandler(t,e){let r=()=>{let i=this.getScope(t);this.execute(e.code,i),this.evaluate(t)},s=e.debounceMs?U(r,e.debounceMs):r;t.addEventListener(e.event,s)}attachGetHandler(t){t.addEventListener("click",async()=>{let e=this.getBindings.get(t);e&&await F(t,e,this.getScope(t))})}execute(t,e){let r=t.split(";").map(s=>s.trim()).filter(Boolean);for(let s of r){let i=s.match(/^([_a-zA-Z][_a-zA-Z0-9.]+)\s*=\s*(.+)$/);if(i){let o=i[1],c=i[2];if(!o||!c)continue;let p=this.evaluateExpression(c,e);e.setPath(o,p);continue}this.evaluateExpression(s,e)}}evaluateExpression(t,e){let r=t.split("+").map(i=>i.trim()).filter(Boolean);if(r.length>1)return r.reduce((i,o)=>{let c=this.evaluateExpression(o,e);return i+c},0);let s=r[0];if(s)return s==="true"?!0:s==="false"?!1:s==="null"?null:/^-?\d+(?:\.\d+)?$/.test(s)?Number(s):s.startsWith('"')&&s.endsWith('"')||s.startsWith("'")&&s.endsWith("'")?s.slice(1,-1):e.getPath(s)}};var wt="0.1.0";function Dt(n){return new P(n).parseProgram()}function V(n=document){if(console.log("auto mounting"),typeof document>"u")return null;let t=new v,e=()=>{let r=n instanceof Document?n.body:n;r&&t.mount(r)};return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),t}typeof document<"u"&&document.querySelector("script[auto-mount]")&&V();export{D as AssignmentNode,l as BaseNode,E as BehaviorNode,b as BlockNode,W as DeclarationNode,d as DirectiveExpression,v as Engine,h as IdentifierExpression,x as Lexer,f as LiteralExpression,B as OnBlockNode,P as Parser,k as ProgramNode,N as QueryExpression,y as SelectorNode,S as StateBlockNode,w as StateEntryNode,H as TokenType,A as UnaryExpression,wt as VERSION,V as autoMount,Dt as parseCFS};
//# sourceMappingURL=index.min.js.map