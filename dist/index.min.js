var F=(a=>(a.Whitespace="Whitespace",a.Identifier="Identifier",a.Number="Number",a.String="String",a.Boolean="Boolean",a.Null="Null",a.Behavior="Behavior",a.State="State",a.On="On",a.Construct="Construct",a.Destruct="Destruct",a.LBrace="LBrace",a.RBrace="RBrace",a.LParen="LParen",a.RParen="RParen",a.LBracket="LBracket",a.RBracket="RBracket",a.Colon="Colon",a.Semicolon="Semicolon",a.Comma="Comma",a.Dot="Dot",a.Hash="Hash",a.Greater="Greater",a.Less="Less",a.Plus="Plus",a.Minus="Minus",a.Tilde="Tilde",a.Star="Star",a.Equals="Equals",a.Bang="Bang",a.At="At",a.Dollar="Dollar",a.Question="Question",a))(F||{});var V={behavior:"Behavior",state:"State",on:"On",construct:"Construct",destruct:"Destruct",true:"Boolean",false:"Boolean",null:"Null"},w=class{constructor(e){this.input=e}index=0;line=1;column=1;tokenize(){let e=[];for(;!this.eof();){let t=this.peek();if(this.isWhitespace(t)){e.push(this.readWhitespace());continue}if(t==="/"&&this.peek(1)==="/"){this.readLineComment();continue}if(t==="/"&&this.peek(1)==="*"){this.readBlockComment();continue}if(this.isAlpha(t)||t==="_"){e.push(this.readIdentifier());continue}if(this.isDigit(t)||t==="-"&&this.isDigit(this.peek(1))){e.push(this.readNumber());continue}if(t==='"'||t==="'"){e.push(this.readString());continue}let i=this.readPunctuator();if(i){e.push(i);continue}throw new Error(`Unexpected character '${t}' at ${this.line}:${this.column}`)}return e}readWhitespace(){let e=this.position(),t="";for(;!this.eof()&&this.isWhitespace(this.peek());)t+=this.next();return this.token("Whitespace",t,e)}readLineComment(){for(this.next(),this.next();!this.eof()&&this.peek()!==`
`;)this.next()}readBlockComment(){for(this.next(),this.next();!this.eof();){if(this.peek()==="*"&&this.peek(1)==="/"){this.next(),this.next();return}this.next()}}readIdentifier(){let e=this.position(),t="";for(;!this.eof()&&(this.isAlphaNumeric(this.peek())||this.peek()==="_"||this.peek()==="-");)t+=this.next();let i=V[t];return i?this.token(i,t,e):this.token("Identifier",t,e)}readNumber(){let e=this.position(),t="";for(this.peek()==="-"&&(t+=this.next());!this.eof()&&this.isDigit(this.peek());)t+=this.next();if(this.peek()===".")for(t+=this.next();!this.eof()&&this.isDigit(this.peek());)t+=this.next();return this.token("Number",t,e)}readString(){let e=this.next(),t=this.position(),i="";for(;!this.eof();){let r=this.next();if(r==="\\"){let s=this.next();i+=s;continue}if(r===e)return this.token("String",i,t);i+=r}throw new Error(`Unterminated string at ${t.line}:${t.column}`)}readPunctuator(){let e=this.position(),t=this.peek(),r={"{":"LBrace","}":"RBrace","(":"LParen",")":"RParen","[":"LBracket","]":"RBracket",":":"Colon",";":"Semicolon",",":"Comma",".":"Dot","#":"Hash",">":"Greater","<":"Less","+":"Plus","-":"Minus","~":"Tilde","*":"Star","=":"Equals","!":"Bang","@":"At",$:"Dollar","?":"Question"}[t];return r?(this.next(),this.token(r,t,e)):null}token(e,t,i){return{type:e,value:t,start:i,end:this.position()}}position(){return{index:this.index,line:this.line,column:this.column}}peek(e=0){return this.input[this.index+e]??""}next(){let e=this.input[this.index++]??"";return e===`
`?(this.line+=1,this.column=1):this.column+=1,e}eof(){return this.index>=this.input.length}isWhitespace(e){return e===" "||e==="	"||e===`
`||e==="\r"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isDigit(e){return e>="0"&&e<="9"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}};var l=class{constructor(e){this.type=e}async prepare(e){}async evaluate(e){}},D=class extends l{constructor(t){super("Program");this.behaviors=t}},x=class extends l{constructor(t){super("Block");this.statements=t}async evaluate(t){for(let i of this.statements)i&&typeof i.evaluate=="function"&&await i.evaluate(t)}},N=class extends l{constructor(t){super("Selector");this.selectorText=t}},y=class extends l{constructor(t,i){super("Behavior");this.selector=t;this.body=i}},A=class extends l{constructor(t,i,r){super("StateEntry");this.name=t;this.value=i;this.important=r}},W=class extends l{constructor(t){super("StateBlock");this.entries=t}},k=class extends l{constructor(t,i,r){super("OnBlock");this.eventName=t;this.args=i;this.body=r}},C=class extends l{constructor(t,i){super("Assignment");this.target=t;this.value=i}async evaluate(t){if(!t.scope||!t.scope.setPath)return;let i;if(this.target instanceof u&&(i=this.target.name),!i)return;let r=await this.value.evaluate(t);return t.scope.setPath(i,r),r}},b=class extends l{constructor(t,i,r,s,o){super("Declaration");this.target=t;this.operator=i;this.value=r;this.flags=s;this.flagArgs=o}},u=class extends l{constructor(t){super("Identifier");this.name=t}async evaluate(t){if(t.scope)return t.scope.getPath(this.name)}},m=class extends l{constructor(t){super("Literal");this.value=t}async evaluate(){return this.value}},B=class extends l{constructor(t,i){super("UnaryExpression");this.operator=t;this.argument=i}async evaluate(t){let i=await this.argument.evaluate(t);return this.operator==="!"?!i:this.operator==="-"?-i:i}},L=class extends l{constructor(t,i,r){super("BinaryExpression");this.operator=t;this.left=i;this.right=r}async evaluate(t){let i=await this.left.evaluate(t),r=await this.right.evaluate(t);if(this.operator==="+")return i+r;if(this.operator==="-")return i-r}},P=class extends l{constructor(t,i){super("CallExpression");this.callee=t;this.args=i}async evaluate(t){let i=this.resolveCallee(t),r=i?.fn??await this.callee.evaluate(t);if(typeof r!="function")return;let s=[];for(let o of this.args)s.push(await o.evaluate(t));return r.apply(i?.thisArg,s)}resolveCallee(t){if(!(this.callee instanceof u))return;let i=this.callee.name,r=t.globals??{},s=i.split("."),o=s[0];if(!o||!(o in r))return;let c=r[o],p;for(let h=1;h<s.length;h+=1){p=c;let d=s[h];if(!d)return;c=c?.[d]}return{fn:c,thisArg:p}}},f=class extends l{constructor(t,i){super("Directive");this.kind=t;this.name=i}async evaluate(){return`${this.kind}:${this.name}`}},H=class extends l{constructor(t,i){super("Query");this.direction=t;this.selector=i}};var T=class{constructor(e){this.tokens=e}index=0;peek(e=0){return this.tokens[this.index+e]??null}next(){let e=this.tokens[this.index++];if(!e)throw new Error("Unexpected end of input");return e}eof(){return this.index>=this.tokens.length}match(e){return this.peek()?.type===e?(this.next(),!0):!1}expect(e){let t=this.next();if(t.type!==e)throw new Error(`Expected ${e} but got ${t.type}`);return t}skipWhitespace(){for(;this.peek()?.type==="Whitespace";)this.next()}peekNonWhitespace(e=0){let t=0;for(let i=this.index;i<this.tokens.length;i++){let r=this.tokens[i];if(r.type!=="Whitespace"){if(t===e)return r;t+=1}}return null}};var g=class n{stream;constructor(e){let t=new w(e);this.stream=new T(t.tokenize())}static parseInline(e){return new n(`{${e}}`).parseInlineBlock()}parseProgram(){let e=[];for(this.stream.skipWhitespace();!this.stream.eof();)e.push(this.parseBehavior()),this.stream.skipWhitespace();return new D(e)}parseInlineBlock(){return this.stream.skipWhitespace(),this.parseBlock({allowDeclarations:!1})}parseBehavior(){this.stream.skipWhitespace(),this.stream.expect("Behavior");let e=this.parseSelector(),t=this.parseBlock({allowDeclarations:!0});return new y(e,t)}parseSelector(){let e="",t=!1;for(;;){let i=this.stream.peek();if(!i||i.type==="LBrace")break;if(i.type==="Whitespace"){this.stream.next(),t&&e[e.length-1]!==" "&&(e+=" ");continue}t=!0,e+=this.stream.next().value}if(!e.trim())throw new Error("Behavior selector is required");return new N(e.trim())}parseBlock(e){let t=e?.allowDeclarations??!1;this.stream.skipWhitespace(),this.stream.expect("LBrace");let i=[],r=t;for(;;){this.stream.skipWhitespace();let s=this.stream.peek();if(!s)throw new Error("Unterminated block");if(s.type==="RBrace"){this.stream.next();break}if(this.isDeclarationStart()){if(!t)throw new Error("Declarations are only allowed at the behavior root");if(!r)throw new Error("Declarations must appear before blocks");i.push(this.parseDeclaration())}else r&&(r=!1),i.push(this.parseStatement())}return new x(i)}parseStatement(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Unexpected end of input");if(e.type==="On")return this.parseOnBlock();if(e.type==="Construct")return this.parseConstructBlock();if(e.type==="Destruct")return this.parseDestructBlock();if(e.type==="Behavior")return this.parseBehavior();if(this.isCallStart())return this.parseExpressionStatement();if(this.isAssignmentStart())return this.parseAssignment();throw new Error(`Unexpected token ${e.type}`)}parseStateBlock(){this.stream.expect("State"),this.stream.skipWhitespace(),this.stream.expect("LBrace");let e=[];for(;;){this.stream.skipWhitespace();let t=this.stream.peek();if(!t)throw new Error("Unterminated state block");if(t.type==="RBrace"){this.stream.next();break}let i=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("Colon"),this.stream.skipWhitespace();let r=this.parseExpression();this.stream.skipWhitespace();let s=!1;if(this.stream.peek()?.type==="Bang"){this.stream.next(),this.stream.skipWhitespace();let o=this.stream.next();if(o.type==="Identifier"&&o.value==="important")s=!0;else throw new Error("Expected 'important' after '!'")}this.stream.skipWhitespace(),this.stream.expect("Semicolon"),e.push(new A(i.value,r,s))}return new W(e)}parseOnBlock(){this.stream.expect("On"),this.stream.skipWhitespace();let e=this.stream.expect("Identifier");this.stream.skipWhitespace(),this.stream.expect("LParen");let t=[];for(;;){this.stream.skipWhitespace();let r=this.stream.peek();if(!r)throw new Error("Unterminated on() arguments");if(r.type==="RParen"){this.stream.next();break}if(r.type==="Identifier"){t.push(this.stream.next().value),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"&&this.stream.next();continue}throw new Error(`Unexpected token in on() args: ${r.type}`)}let i=this.parseBlock({allowDeclarations:!1});return new k(e.value,t,i)}parseAssignment(){let e=this.parseAssignmentTarget();this.stream.skipWhitespace(),this.stream.expect("Equals"),this.stream.skipWhitespace();let t=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new C(e,t)}parseExpression(){return this.parseAdditiveExpression()}parseAdditiveExpression(){let e=this.parseUnaryExpression();for(this.stream.skipWhitespace();;){let t=this.stream.peekNonWhitespace(0);if(!t||t.type!=="Plus"&&t.type!=="Minus")break;this.stream.skipWhitespace();let i=this.stream.next();this.stream.skipWhitespace();let r=this.parseUnaryExpression();this.stream.skipWhitespace(),e=new L(i.type==="Plus"?"+":"-",e,r)}return e}parseUnaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="Bang"){this.stream.next();let t=this.parseUnaryExpression();return new B("!",t)}if(e.type==="Minus"){this.stream.next();let t=this.parseUnaryExpression();return new B("-",t)}return this.parseCallExpression()}parseCallExpression(){let e=this.parsePrimaryExpression();for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="LParen";){this.stream.next();let t=[];for(;;){this.stream.skipWhitespace();let i=this.stream.peek();if(!i)throw new Error("Unterminated call expression");if(i.type==="RParen"){this.stream.next();break}if(t.push(this.parseExpression()),this.stream.skipWhitespace(),this.stream.peek()?.type==="Comma"){this.stream.next();continue}if(this.stream.peek()?.type==="RParen"){this.stream.next();break}throw new Error("Expected ',' or ')' in call arguments")}e=new P(e,t)}return e}parsePrimaryExpression(){this.stream.skipWhitespace();let e=this.stream.peek();if(!e)throw new Error("Expected expression");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let i=this.stream.expect("Identifier");return new f(t,i.value)}if(e.type==="Question")return this.parseQueryExpression();if(e.type==="LParen"){this.stream.next();let t=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("RParen"),t}if(e.type==="Identifier"){let t=this.parseIdentifierPath();return new u(t)}if(e.type==="Boolean")return new m(this.stream.next().value==="true");if(e.type==="Null")return this.stream.next(),new m(null);if(e.type==="Number")return new m(Number(this.stream.next().value));if(e.type==="String")return new m(this.stream.next().value);throw new Error(`Unsupported expression token ${e.type}`)}parseAssignmentTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected assignment target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let i=this.stream.expect("Identifier");return new f(t,i.value)}if(e.type==="Identifier")return new u(this.parseIdentifierPath());throw new Error(`Invalid assignment target ${e.type}`)}parseDeclaration(){let e=this.parseDeclarationTarget();this.stream.skipWhitespace();let t=this.parseDeclarationOperator();this.stream.skipWhitespace();let i=this.parseExpression(),{flags:r,flagArgs:s}=this.parseFlags();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),new b(e,t,i,r,s)}parseDeclarationTarget(){let e=this.stream.peek();if(!e)throw new Error("Expected declaration target");if(e.type==="At"||e.type==="Dollar"){let t=e.type==="At"?"attr":"style";this.stream.next();let i=this.stream.expect("Identifier");return new f(t,i.value)}if(e.type==="Identifier")return new u(this.stream.next().value);throw new Error(`Invalid declaration target ${e.type}`)}parseDeclarationOperator(){this.stream.expect("Colon");let e=this.stream.peek();return e?e.type==="Equals"?(this.stream.next(),":="):e.type==="Less"?(this.stream.next(),":<"):e.type==="Greater"?(this.stream.next(),":>"):":":":"}parseFlags(){let e={},t={};for(;this.stream.skipWhitespace(),this.stream.peek()?.type==="Bang";){this.stream.next();let i=this.stream.expect("Identifier").value;if(i==="important")e.important=!0;else if(i==="trusted")e.trusted=!0;else if(i==="debounce")if(e.debounce=!0,this.stream.peek()?.type==="LParen"){this.stream.next(),this.stream.skipWhitespace();let r=this.stream.expect("Number");t.debounce=Number(r.value),this.stream.skipWhitespace(),this.stream.expect("RParen")}else t.debounce=200;else throw new Error(`Unknown flag ${i}`)}return{flags:e,flagArgs:t}}isDeclarationStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier")return this.stream.peekNonWhitespace(1)?.type==="Colon";if(e.type==="At"||e.type==="Dollar"){let t=this.stream.peekNonWhitespace(1),i=this.stream.peekNonWhitespace(2);return t?.type==="Identifier"&&i?.type==="Colon"}return!1}isAssignmentStart(){let e=this.stream.peekNonWhitespace(0);if(!e)return!1;if(e.type==="Identifier"){let t=1;for(;this.stream.peekNonWhitespace(t)?.type==="Dot"&&this.stream.peekNonWhitespace(t+1)?.type==="Identifier";)t+=2;return this.stream.peekNonWhitespace(t)?.type==="Equals"}if(e.type==="At"||e.type==="Dollar"){let t=this.stream.peekNonWhitespace(1),i=this.stream.peekNonWhitespace(2);return t?.type==="Identifier"&&i?.type==="Equals"}return!1}isCallStart(){let e=this.stream.peekNonWhitespace(0);if(!e||e.type!=="Identifier")return!1;let t=1;for(;this.stream.peekNonWhitespace(t)?.type==="Dot"&&this.stream.peekNonWhitespace(t+1)?.type==="Identifier";)t+=2;return this.stream.peekNonWhitespace(t)?.type==="LParen"}parseExpressionStatement(){let e=this.parseExpression();return this.stream.skipWhitespace(),this.stream.expect("Semicolon"),e}parseConstructBlock(){this.stream.expect("Construct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Construct",e}parseDestructBlock(){this.stream.expect("Destruct");let e=this.parseBlock({allowDeclarations:!1});return e.type="Destruct",e}parseQueryExpression(){this.stream.expect("Question");let e="self";this.stream.peek()?.type==="Greater"?(this.stream.next(),e="descendant"):this.stream.peek()?.type==="Less"&&(this.stream.next(),e="ancestor"),this.stream.skipWhitespace(),this.stream.expect("LParen");let t=this.readSelectorUntil("RParen");return new H(e,t)}readSelectorUntil(e){let t="",i=!1;for(;;){let r=this.stream.peek();if(!r)throw new Error("Unterminated selector");if(r.type===e){this.stream.next();break}if(r.type==="Whitespace"){this.stream.next(),i&&t[t.length-1]!==" "&&(t+=" ");continue}i=!0,t+=this.stream.next().value}return t.trim()}parseIdentifierPath(){let e=this.stream.expect("Identifier").value;for(;this.stream.peek()?.type==="Dot";){this.stream.next();let t=this.stream.expect("Identifier").value;e=`${e}.${t}`}return e}};var M=class{constructor(e){this.parent=e;this.root=e?e.root:this}data=new Map;root;listeners=new Map;get(e){return this.getPath(e)}set(e,t){this.setPath(e,t)}getPath(e){let{targetScope:t,targetPath:i}=this.resolveScope(e);if(!t||!i)return;let r=i.split("."),s=r[0];if(!s)return;let o=t.data.get(s);for(let c=1;c<r.length;c+=1){if(o==null)return;let p=r[c];if(!p)return;o=o[p]}return o}setPath(e,t){let{targetScope:i,targetPath:r}=this.resolveScope(e);if(!i||!r)return;let s=r.split("."),o=s[0];if(!o)return;if(s.length===1){i.data.set(o,t),i.emitChange(r);return}let c=i.data.get(o);(c==null||typeof c!="object")&&(c={},i.data.set(o,c));let p=c;for(let d=1;d<s.length-1;d+=1){let E=s[d];if(!E)return;(p[E]==null||typeof p[E]!="object")&&(p[E]={}),p=p[E]}let h=s[s.length-1];h&&(p[h]=t,this.emitChange(e))}on(e,t){let i=e.trim();if(!i)return;let r=this.listeners.get(i)??new Set;r.add(t),this.listeners.set(i,r)}off(e,t){let i=e.trim(),r=this.listeners.get(i);r&&(r.delete(t),r.size===0&&this.listeners.delete(i))}emitChange(e){let t=e.trim();if(!t)return;this.listeners.get(t)?.forEach(r=>r());let i=t.split(".")[0];i&&i!==t&&this.listeners.get(i)?.forEach(r=>r())}resolveScope(e){return e.startsWith("parent.")?{targetScope:this.parent,targetPath:e.slice(7)}:e.startsWith("root.")?{targetScope:this.root,targetPath:e.slice(5)}:e.startsWith("self.")?{targetScope:this,targetPath:e.slice(5)}:{targetScope:this,targetPath:e}}};function _(n){return n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement?n.value:n.textContent??""}function Q(n,e){if(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement){n.value=e,n.setAttribute("value",e);return}n.textContent=e}function I(n,e,t){let i=e.trim();if(!i)return;let r=_(n).trim();r!==""&&t.set(i,r)}function O(n,e,t){let i=e.trim();if(!i)return;let r=t.get(i);r!=null&&Q(n,String(r))}function G(n,e){let t=n.trim();return t?!!e.get(t):!1}function U(n,e,t){n.style.display=G(e,t)?"":"none"}function $(n,e,t){n.style.display=G(e,t)?"":"none"}function j(n){return n.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"")}function v(n,e,t,i){let r=e.trim();if(!r)return;let s=t.get(r),o=s==null?"":String(s);n.innerHTML=i?o:j(o)}async function q(n,e,t){if(!globalThis.fetch)throw new Error("fetch is not available");let i=await globalThis.fetch(e.url);if(!i||!i.ok)return;let r=await i.text(),s=z(n,e.targetSelector);if(!s){n.dispatchEvent(new CustomEvent("vsn:targetError",{detail:{selector:e.targetSelector}}));return}if(e.swap==="outer"){let o=document.createElement("div");v(o,"__html",{get:()=>r},e.trusted);let c=o.firstElementChild;c&&s.parentNode&&s.parentNode.replaceChild(c,s);return}v(s,"__html",{get:()=>r},e.trusted)}function z(n,e){return e?n.ownerDocument.querySelector(e):n}function R(n,e){let t;return(...i)=>{t&&clearTimeout(t),t=setTimeout(()=>{t=void 0,n(...i)},e)}}var S=class{scopes=new WeakMap;bindBindings=new WeakMap;ifBindings=new WeakMap;showBindings=new WeakMap;htmlBindings=new WeakMap;getBindings=new WeakMap;lifecycleBindings=new WeakMap;behaviorRegistry=[];behaviorBindings=new WeakMap;behaviorId=0;codeCache=new Map;observer;attributeHandlers=[];globals={};constructor(){this.registerGlobal("console",console),this.registerDefaultAttributeHandlers()}async mount(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let i of t){if(!this.hasVsnAttributes(i))continue;let r=this.findParentScope(i);this.getScope(i,r),this.attachAttributes(i),this.runConstruct(i)}await this.applyBehaviors(e),this.attachObserver(e)}unmount(e){this.runDestruct(e)}registerBehaviors(e){let t=new g(e).parseProgram();for(let i of t.behaviors)this.collectBehavior(i)}registerGlobal(e,t){this.globals[e]=t}registerGlobals(e){Object.assign(this.globals,e)}registerAttributeHandler(e){this.attributeHandlers.push(e)}getScope(e,t){let i=this.scopes.get(e);if(i)return i;let r=new M(t??this.findParentScope(e));return this.scopes.set(e,r),r}evaluate(e){let t=this.getScope(e),i=this.bindBindings.get(e);i&&(i.direction==="from"||i.direction==="both")&&O(e,i.expr,t);let r=this.ifBindings.get(e);r&&e instanceof HTMLElement&&U(e,r,t);let s=this.showBindings.get(e);s&&e instanceof HTMLElement&&$(e,s,t);let o=this.htmlBindings.get(e);o&&e instanceof HTMLElement&&v(e,o.expr,t,o.trusted)}attachObserver(e){this.observer||(this.observer=new MutationObserver(t=>{for(let i of t){for(let r of Array.from(i.addedNodes))r&&r.nodeType===1&&this.handleAddedNode(r);for(let r of Array.from(i.removedNodes))r&&r.nodeType===1&&this.handleRemovedNode(r)}}),this.observer.observe(e,{childList:!0,subtree:!0}))}handleRemovedNode(e){this.lifecycleBindings.has(e)&&this.runDestruct(e),this.behaviorBindings.has(e)&&this.runBehaviorDestruct(e);for(let t of Array.from(e.querySelectorAll("*")))this.lifecycleBindings.has(t)&&this.runDestruct(t),this.behaviorBindings.has(t)&&this.runBehaviorDestruct(t)}handleAddedNode(e){let t=[e,...Array.from(e.querySelectorAll("*"))];for(let i of t){if(!this.hasVsnAttributes(i))continue;let r=this.findParentScope(i);this.getScope(i,r),this.attachAttributes(i),this.runConstruct(i)}this.applyBehaviors(e)}async applyBehaviors(e){if(this.behaviorRegistry.length!==0)for(let t of this.behaviorRegistry){let i=[];e.matches(t.selector)&&i.push(e),i.push(...Array.from(e.querySelectorAll(t.selector)));for(let r of i){let s=this.behaviorBindings.get(r)??new Set;if(s.has(t.id))continue;s.add(t.id),this.behaviorBindings.set(r,s);let o=this.getScope(r);await this.applyBehaviorDeclarations(r,o,t.declarations),t.construct&&await this.executeBlock(t.construct,o);for(let c of t.onBlocks)this.attachBehaviorOnHandler(r,c.event,c.body)}}}runBehaviorDestruct(e){let t=this.behaviorBindings.get(e);if(!t)return;let i=this.getScope(e);for(let r of this.behaviorRegistry)!t.has(r.id)||!r.destruct||this.executeBlock(r.destruct,i)}attachAttributes(e){let t=this.getScope(e);for(let i of e.getAttributeNames()){if(!i.startsWith("vsn-"))continue;let r=e.getAttribute(i)??"";for(let s of this.attributeHandlers){if(!s.match(i))continue;if(s.handle(e,i,r,t)!==!1)break}}}setLifecycle(e,t){let i=this.lifecycleBindings.get(e)??{};this.lifecycleBindings.set(e,{...i,...t})}runConstruct(e){let t=this.lifecycleBindings.get(e);if(!t?.construct)return;let i=this.getScope(e);this.execute(t.construct,i)}runDestruct(e){let t=this.lifecycleBindings.get(e);if(!t?.destruct)return;let i=this.getScope(e);this.execute(t.destruct,i)}attachBindInputHandler(e,t){if(!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement))return;let i=()=>{let r=this.getScope(e);I(e,t,r)};e.addEventListener("input",i),e.addEventListener("change",i)}parseBindDirection(e){return e.includes(":from")?"from":e.includes(":to")?"to":"both"}hasVsnAttributes(e){return e.getAttributeNames().some(t=>t.startsWith("vsn-"))}findParentScope(e){let t=e.parentElement;for(;t;){let i=this.scopes.get(t);if(i)return i;t=t.parentElement}}watch(e,t,i){let r=t.trim();r&&e.on(r,i)}watchWithDebounce(e,t,i,r){r?this.watch(e,t,R(i,r)):this.watch(e,t,i)}parseOnAttribute(e,t){if(!e.startsWith("vsn-on:"))return null;let i=e.slice(7),[r,...s]=i.split("!");if(!r)return null;let o;for(let p of s){if(!p.startsWith("debounce"))continue;let h=p.match(/debounce\((\d+)\)/);o=h?Number(h[1]):200}return{event:r,code:t,...o!==void 0?{debounceMs:o}:{}}}attachOnHandler(e,t){let i=async()=>{let s=this.getScope(e);await this.execute(t.code,s),this.evaluate(e)},r=t.debounceMs?R(i,t.debounceMs):i;e.addEventListener(t.event,r)}attachBehaviorOnHandler(e,t,i){let r=async()=>{let s=this.getScope(e);await this.executeBlock(i,s),this.evaluate(e)};e.addEventListener(t,r)}attachGetHandler(e){e.addEventListener("click",async()=>{let t=this.getBindings.get(e);t&&await q(e,t,this.getScope(e))})}async execute(e,t){let i=this.codeCache.get(e);i||(i=g.parseInline(e),this.codeCache.set(e,i));let r={scope:t,globals:this.globals};await i.evaluate(r)}async executeBlock(e,t){let i={scope:t,globals:this.globals};await e.evaluate(i)}collectBehavior(e,t){let i=t?`${t} ${e.selector.selectorText}`:e.selector.selectorText,r=this.extractLifecycle(e.body);this.behaviorRegistry.push({id:this.behaviorId+=1,selector:i,onBlocks:this.extractOnBlocks(e.body),declarations:this.extractDeclarations(e.body),...r});for(let s of e.body.statements)s instanceof y&&this.collectBehavior(s,i)}extractLifecycle(e){let t,i;for(let r of e.statements)r instanceof x&&(r.type==="Construct"?t=r:r.type==="Destruct"&&(i=r));return{...t?{construct:t}:{},...i?{destruct:i}:{}}}extractOnBlocks(e){let t=[];for(let i of e.statements)i instanceof k&&t.push({event:i.eventName,body:i.body});return t}extractDeclarations(e){let t=[];for(let i of e.statements)i instanceof b&&t.push(i);return t}async applyBehaviorDeclarations(e,t,i){for(let r of i)await this.applyBehaviorDeclaration(e,t,r)}async applyBehaviorDeclaration(e,t,i){let r={scope:t},s=i.operator,o=i.flags.debounce?i.flagArgs.debounce??200:void 0;if(i.target instanceof u){let d=await i.value.evaluate(r);t.setPath(i.target.name,d);return}if(!(i.target instanceof f))return;let c=i.target,p=i.value instanceof u?i.value.name:void 0;if(s===":>"){p&&this.applyDirectiveToScope(e,c,p,t,o);return}if(s===":="&&p&&this.applyDirectiveToScope(e,c,p,t,o),!p){let d=await i.value.evaluate(r);this.setDirectiveValue(e,c,d,i.flags.trusted);return}let h=s===":<"||s===":=";this.applyDirectiveFromScope(e,c,p,t,i.flags.trusted,o,h)}applyDirectiveFromScope(e,t,i,r,s,o,c=!0){if(t.kind==="attr"&&t.name==="html"&&e instanceof HTMLElement){let h=()=>v(e,i,r,!!s);h(),c&&this.watchWithDebounce(r,i,h,o);return}let p=()=>{let h=r.get(i);h!=null&&this.setDirectiveValue(e,t,h,s)};p(),c&&this.watchWithDebounce(r,i,p,o)}applyDirectiveToScope(e,t,i,r,s){if(t.kind==="attr"&&t.name==="value"){this.applyValueBindingToScope(e,i,s);return}let o=this.getDirectiveValue(e,t);o!=null&&r.set(i,o)}applyValueBindingToScope(e,t,i){if(!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement))return;let r=()=>{let o=this.getScope(e);I(e,t,o)},s=i?R(r,i):r;s(),e.addEventListener("input",s),e.addEventListener("change",s)}setDirectiveValue(e,t,i,r){if(t.kind==="attr"&&t.name==="html"&&e instanceof HTMLElement){let s=i==null?"":String(i);e.innerHTML=r?s:s.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gi,"");return}if(t.kind==="attr"){if(t.name==="value"){if(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement){e.value=i==null?"":String(i),e.setAttribute("value",e.value);return}if(e instanceof HTMLSelectElement){e.value=i==null?"":String(i);return}}if(t.name==="checked"&&e instanceof HTMLInputElement){let s=!!i;e.checked=s,s?e.setAttribute("checked",""):e.removeAttribute("checked");return}e.setAttribute(t.name,i==null?"":String(i));return}t.kind==="style"&&e instanceof HTMLElement&&e.style.setProperty(t.name,i==null?"":String(i))}getDirectiveValue(e,t){if(t.kind==="attr")return t.name==="value"&&(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)?e.value:t.name==="checked"&&e instanceof HTMLInputElement?e.checked?"true":"false":e.getAttribute(t.name)??void 0;if(t.kind==="style"&&e instanceof HTMLElement)return e.style.getPropertyValue(t.name)??void 0}registerDefaultAttributeHandlers(){this.registerAttributeHandler({id:"vsn-bind",match:e=>e.startsWith("vsn-bind"),handle:(e,t,i,r)=>{let s=this.parseBindDirection(t);this.bindBindings.set(e,{expr:i,direction:s}),(s==="to"||s==="both")&&(I(e,i,r),this.attachBindInputHandler(e,i)),(s==="from"||s==="both")&&this.watch(r,i,()=>O(e,i,r))}}),this.registerAttributeHandler({id:"vsn-if",match:e=>e==="vsn-if",handle:(e,t,i,r)=>{this.ifBindings.set(e,i),e instanceof HTMLElement&&U(e,i,r),this.watch(r,i,()=>this.evaluate(e))}}),this.registerAttributeHandler({id:"vsn-show",match:e=>e==="vsn-show",handle:(e,t,i,r)=>{this.showBindings.set(e,i),e instanceof HTMLElement&&$(e,i,r),this.watch(r,i,()=>this.evaluate(e))}}),this.registerAttributeHandler({id:"vsn-html",match:e=>e.startsWith("vsn-html"),handle:(e,t,i,r)=>{let s=t.includes("!trusted");this.htmlBindings.set(e,{expr:i,trusted:s}),e instanceof HTMLElement&&v(e,i,r,s),this.watch(r,i,()=>this.evaluate(e))}}),this.registerAttributeHandler({id:"vsn-get",match:e=>e.startsWith("vsn-get"),handle:(e,t)=>{let i=t.includes("!trusted"),r=e.getAttribute(t)??"",s=e.getAttribute("vsn-target")??void 0,o=e.getAttribute("vsn-swap")??"inner",c={url:r,swap:o,trusted:i,...s?{targetSelector:s}:{}};this.getBindings.set(e,c),this.attachGetHandler(e)}}),this.registerAttributeHandler({id:"vsn-construct",match:e=>e==="vsn-construct",handle:(e,t,i)=>{this.setLifecycle(e,{construct:i})}}),this.registerAttributeHandler({id:"vsn-destruct",match:e=>e==="vsn-destruct",handle:(e,t,i)=>{this.setLifecycle(e,{destruct:i})}}),this.registerAttributeHandler({id:"vsn-on",match:e=>e.startsWith("vsn-on:"),handle:(e,t,i)=>{let r=this.parseOnAttribute(t,i);r&&this.attachOnHandler(e,r)}})}};var Ae="0.1.0";function Le(n){return new g(n).parseProgram()}function K(n=document){if(typeof document>"u")return null;let e=new S,t=()=>{let i=n instanceof Document?n.body:n;if(i){let r=Array.from(document.querySelectorAll('script[type="text/vsn"]')).map(s=>s.textContent??"").join(`
`);r.trim()&&e.registerBehaviors(r),e.mount(i)}};return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t(),e}typeof document<"u"&&document.querySelector("script[auto-mount]")&&K();export{C as AssignmentNode,l as BaseNode,y as BehaviorNode,L as BinaryExpression,x as BlockNode,P as CallExpression,b as DeclarationNode,f as DirectiveExpression,S as Engine,u as IdentifierExpression,w as Lexer,m as LiteralExpression,k as OnBlockNode,g as Parser,D as ProgramNode,H as QueryExpression,N as SelectorNode,W as StateBlockNode,A as StateEntryNode,F as TokenType,B as UnaryExpression,Ae as VERSION,K as autoMount,Le as parseCFS};
//# sourceMappingURL=index.min.js.map